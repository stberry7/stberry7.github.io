<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ê°œì¸ ê³¨í”„ ë°ì´í„° ë¶„ì„ ëŒ€ì‹œë³´ë“œ (BoxPlot + Slope + Per-Club Cutoff)</title>

  <!-- Chart.js & Plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Box/Violin plugin for Chart.js v4 -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-box-and-violin-plot@4.3.3/build/index.umd.min.js"></script>
  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    /* ===== ë‹¤í¬ í…Œë§ˆ & ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ===== */
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --bg-primary:#0f1419;--bg-secondary:#1a1f27;--bg-card:#1e242c;
      --text-primary:#e8eaed;--text-secondary:#9aa0a6;
      --accent:#4ade80;--accent2:#60a5fa;--border:#2d3339;
    }
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      background:linear-gradient(135deg,var(--bg-primary) 0%,var(--bg-secondary) 100%);
      color:var(--text-primary);min-height:100vh;line-height:1.6}
    .container{max-width:1400px;margin:0 auto;padding:0 20px}

    /* ì—…ë¡œë“œ */
    .upload-section{min-height:100vh;display:flex;align-items:center;justify-content:center}
    .main-title{font-size:2.4rem;text-align:center;margin-bottom:1rem;
      background:linear-gradient(135deg,var(--accent) 0%,#22c55e 100%);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .subtitle{text-align:center;color:var(--text-secondary);margin-bottom:2rem;font-size:1.05rem}
    .upload-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.2rem;margin-bottom:1.5rem}
    .upload-card{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;padding:1.4rem;text-align:center;transition:.2s}
    .upload-card:hover{transform:translateY(-3px)}
    .upload-icon{font-size:2.2rem;margin-bottom:.6rem}
    input[type="file"]{display:none}
    .file-label{display:inline-block;padding:.6rem 1.4rem;background:var(--bg-secondary);
      border:2px solid var(--accent);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600}
    .file-label:hover{background:var(--accent);color:#0b0f14}
    .file-status{margin-top:.6rem;font-size:.9rem;color:var(--text-secondary);min-height:20px}
    .file-status.success{color:#4ade80}.file-status.warn{color:#fbbf24}
    .analyze-btn{display:block;margin:10px auto 0 auto;padding:.9rem 2.2rem;
      background:linear-gradient(135deg,var(--accent) 0%,#22c55e 100%);
      border:none;border-radius:12px;color:#0b0f14;font-weight:700;cursor:pointer}
    .analyze-btn:disabled{opacity:.5;cursor:not-allowed}

    /* ëŒ€ì‹œë³´ë“œ í—¤ë” */
    .dashboard-section{padding:24px 0}
    .dashboard-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .dashboard-header h1{font-size:1.8rem;background:linear-gradient(135deg,var(--accent) 0%,#22c55e 100%);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .back-btn{padding:.45rem 1.2rem;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);cursor:pointer}

    /* í•„í„° ë°” */
    .filter-bar{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:18px}
    .filter-grid{display:grid;grid-template-columns:2fr 2fr 2fr 2fr;gap:10px}
    .filter-group label{display:block;font-size:.85rem;color:var(--text-secondary);margin-bottom:6px}
    .select, .input, .btn{width:100%;padding:.6rem;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary)}
    .check-row{display:flex;gap:10px;flex-wrap:wrap}
    .check-row label{display:flex;align-items:center;gap:6px;background:var(--bg-secondary);border:1px solid var(--border);padding:.35rem .6rem;border-radius:8px}
    .apply-btn{padding:.6rem 1rem;background:var(--accent2);color:#0b0f14;border:none;border-radius:8px;font-weight:700;cursor:pointer}

    /* KPI */
    .kpi-section{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:14px 0 20px}
    .kpi-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1rem;text-align:center}
    .kpi-label{color:var(--text-secondary);font-size:.9rem;margin-bottom:.4rem}
    .kpi-value{font-size:1.8rem;font-weight:800;color:var(--accent)}

    /* ì°¨íŠ¸ */
    .chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px}
    .chart-container{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .chart-container h3{margin-bottom:8px;font-size:1.05rem}
    .full-width{grid-column:span 2}
    canvas{max-height:320px}

    /* ë°•ìŠ¤ì°¨íŠ¸ ì»¨íŠ¸ë¡¤ */
    .boxbar{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    .multiselect{min-width:220px;height:36px}

    /* ìƒì„¸ */
    .round-details{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .round-select{width:100%;max-width:480px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid var(--border);padding:.6rem;text-align:center}
    th{background:var(--bg-secondary);color:var(--accent)}
    .mode-row{display:flex;gap:12px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .mode-row label{display:flex;align-items:center;gap:6px;background:var(--bg-secondary);border:1px solid var(--border);padding:.35rem .6rem;border-radius:8px}
    .muted{color:var(--text-secondary);font-size:.9rem}

    /* í•˜ë‹¨ ë©”ëª¨/ìš”ì•½ */
    .bottom-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:18px}
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .card h3{margin-bottom:8px;font-size:1.05rem}
    .memo-item{border-top:1px dashed var(--border);padding-top:8px;margin-top:8px}

    @media (max-width: 1024px){.filter-grid{grid-template-columns:1fr 1fr}}
    @media (max-width: 768px){.chart-grid{grid-template-columns:1fr}.full-width{grid-column:span 1}}
    @media (max-width: 700px){.bottom-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- ì—…ë¡œë“œ ì„¹ì…˜ -->
  <div class="upload-section" id="uploadSection">
    <div class="container">
      <h1 class="main-title">â›³ ê°œì¸ ê³¨í”„ ë°ì´í„° ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
      <p class="subtitle">ë¼ìš´ë“œ/í™€/ìƒ· CSV 3ê°œë¥¼ ì—…ë¡œë“œí•˜ê³ , ë°•ìŠ¤ì°¨íŠ¸Â·ìŠ¬ë¡œí”„ ë³´ì •Â·êµ°ë³„ ì»·ì˜¤í”„ë¡œ ì‹¬ì¸µ ë¶„ì„í•˜ì„¸ìš”. (ê±°ë¦¬ ë‹¨ìœ„: <b>yd</b>)</p>

      <div class="upload-grid">
        <div class="upload-card">
          <div class="upload-icon">ğŸ“Š</div>
          <h3>ë¼ìš´ë“œ ê¸°ë¡</h3>
          <input type="file" id="roundsFile" accept=".csv"/>
          <label class="file-label" for="roundsFile">íŒŒì¼ ì„ íƒ</label>
          <div id="roundsStatus" class="file-status"></div>
        </div>
        <div class="upload-card">
          <div class="upload-icon">ğŸŒï¸</div>
          <h3>í™€ë³„ ê¸°ë¡</h3>
          <input type="file" id="holesFile" accept=".csv"/>
          <label class="file-label" for="holesFile">íŒŒì¼ ì„ íƒ</label>
          <div id="holesStatus" class="file-status"></div>
        </div>
        <div class="upload-card">
          <div class="upload-icon">ğŸ¯</div>
          <h3>ìƒ· ê¸°ë¡</h3>
          <input type="file" id="shotsFile" accept=".csv"/>
          <label class="file-label" for="shotsFile">íŒŒì¼ ì„ íƒ</label>
          <div id="shotsStatus" class="file-status"></div>
        </div>
      </div>

      <button id="analyzeBtn" class="analyze-btn" disabled>ë¶„ì„ ëŒ€ì‹œë³´ë“œ ë³´ê¸°</button>
      <div id="savedDataBar" style="text-align:center;margin-top:10px;display:none">
        <button id="loadSavedBtn" class="apply-btn" style="display:inline-block">ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button id="clearSavedBtn" class="back-btn" style="display:inline-block">ì €ì¥ ë°ì´í„° ì‚­ì œ</button>
        <div id="savedMeta" class="muted" style="margin-top:6px"></div>
      </div>

      <p class="muted" style="text-align:center;margin-top:8px">
        * ë¼ìš´ë“œ ì—°ê²° í‚¤: <code>date</code> + <code>course name</code>
      </p>
    </div>
  </div>

  <!-- ëŒ€ì‹œë³´ë“œ -->
  <div class="dashboard-section" id="dashboardSection" style="display:none;">
    <div class="container">
      <div class="dashboard-header">
        <h1>ê³¨í”„ í¼í¬ë¨¼ìŠ¤ ëŒ€ì‹œë³´ë“œ</h1>
        <button id="backBtn" class="back-btn">ìƒˆë¡œìš´ ë°ì´í„° ì—…ë¡œë“œ</button>
      </div>

      <!-- í•„í„° ë°” -->
      <div class="filter-bar">
        <div class="filter-grid">
          <div class="filter-group">
            <label>ê³¨í”„ì¥ ì„ íƒ</label>
            <select id="courseSelect" class="select"></select>
          </div>

          <div class="filter-group">
            <label>í™€ íƒ€ì… ì„ íƒ</label>
            <div class="check-row">
              <label><input type="checkbox" class="parCheck" value="3" checked>Par 3</label>
              <label><input type="checkbox" class="parCheck" value="4" checked>Par 4</label>
              <label><input type="checkbox" class="parCheck" value="5" checked>Par 5</label>
            </div>
          </div>

          <div class="filter-group">
            <label>ê¸°ê°„ ë³´ê¸°</label>
            <select id="periodMode" class="select">
              <option value="round">ë¼ìš´ë“œë³„</option>
              <option value="month">ì›”ë³„</option>
              <option value="quarter">ë¶„ê¸°ë³„</option>
            </select>
          </div>

          <div class="filter-group">
            <label>ë‚ ì§œ ë²”ìœ„(ì›” ë‹¨ìœ„)</label>
            <div style="display:flex;gap:8px">
              <input type="month" id="startMonth" class="input"/>
              <input type="month" id="endMonth" class="input"/>
            </div>
          </div>

          <div class="filter-group">
            <label>ë¼ìš´ë“œ ê¸¸ì´</label>
            <select id="roundLength" class="select">
              <option value="all">ì „ì²´</option>
              <option value="9">9í™€ë§Œ</option>
              <option value="18">18í™€ë§Œ</option>
            </select>
          </div>

          <div class="filter-group">
            <label>ìŠ¬ë¡œí”„ ë³´ì • ì‚¬ìš©</label>
            <label class="check-row"><input type="checkbox" id="useSlope"> rounds CSVì˜ <em>slope</em>/<em>course rating</em> ì‚¬ìš©</label>
          </div>

          <div class="filter-group">
            <label>ì»·ì˜¤í”„ ëª¨ë“œ</label>
            <select id="cutoffMode" class="select">
              <option value="global" selected>ì „ì—­ ì»·ì˜¤í”„</option>
              <option value="percat">í´ëŸ½êµ°ë³„ ì»·ì˜¤í”„</option>
            </select>
          </div>

          <div class="filter-group" id="globalCutoffGroup">
            <label>ë…¸ì´ì¦ˆ ì»·ì˜¤í”„ (yd, â‰¥ ì œì™¸)</label>
            <input type="number" id="globalCutoff" class="input" value="300" min="100" max="600" step="10"/>
          </div>

          <div class="filter-group" id="perCatWrap" style="grid-column:span 2; display:none">
            <label>êµ°ë³„ ì»·ì˜¤í”„ (yd, â‰¥ ì œì™¸)</label>
            <div class="check-row" style="gap:8px">
              <span>Driver</span><input type="number" id="cutD" class="input" value="330" style="width:90px">
              <span>Wood</span><input type="number" id="cutW" class="input" value="300" style="width:90px">
              <span>Hybrid</span><input type="number" id="cutH" class="input" value="280" style="width:90px">
              <span>Iron</span><input type="number" id="cutI" class="input" value="260" style="width:90px">
              <span>Wedge</span><input type="number" id="cutG" class="input" value="200" style="width:90px">
            </div>
          </div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
          <button id="applyFilters" class="apply-btn">í•„í„° ì ìš©</button>
        </div>
      </div>

      <!-- KPI -->
      <div class="kpi-section">
        <div class="kpi-card"><div class="kpi-label">í‰ê·  ìŠ¤ì½”ì–´<span id="slopeBadge" class="muted"></span></div><div id="avgScore" class="kpi-value">-</div></div>
        <div class="kpi-card"><div class="kpi-label">í˜ì–´ì›¨ì´ ì•ˆì°©ë¥ </div><div id="fairwayRate" class="kpi-value">-</div></div>
        <div class="kpi-card"><div class="kpi-label">ê·¸ë¦° ì ì¤‘ë¥ </div><div id="girRate" class="kpi-value">-</div></div>
        <div class="kpi-card"><div class="kpi-label">í‰ê·  í¼íŒ…</div><div id="avgPutts" class="kpi-value">-</div></div>
      </div>

      <!-- ì°¨íŠ¸ ê·¸ë¦¬ë“œ 1 -->
      <div class="chart-grid">
        <div class="chart-container">
          <h3>ìŠ¤ì½”ì–´ íŠ¸ë Œë“œ</h3>
          <canvas id="scoreTrendChart"></canvas>
        </div>
        <div class="chart-container">
          <h3>ë¼ìš´ë“œë‹¹ í‰ê·  í¼íŒ… íŠ¸ë Œë“œ</h3>
          <canvas id="puttTrendChart"></canvas>
        </div>

        <div class="chart-container">
          <h3>ì½”ìŠ¤ ê²½í—˜ ë¹„êµ: ì²« ë°©ë¬¸ vs ì´í›„ í‰ê· </h3>
          <canvas id="courseFirstVsLaterChart"></canvas>
        </div>
        <div class="chart-container">
          <h3>ë°©ë¬¸ íšŸìˆ˜(1,2,3...)ë³„ í‰ê·  ìŠ¤ì½”ì–´</h3>
          <canvas id="visitCountTrendChart"></canvas>
        </div>
      </div>

      <!-- í™€/ë“œë¼ì´ë¹™/ì–´í”„ë¡œì¹˜/í´ëŸ½ -->
      <div class="chart-grid">
        <div class="chart-container">
          <h3>í™€ íƒ€ì…ë³„ ì„±ì  (ë²„ë””/íŒŒ/ë³´ê¸°/ë”ë¸”/íŠ¸ë¦¬í”Œ/ì¿¼ë“œ+)</h3>
          <canvas id="parTypeRatesChart"></canvas>
        </div>

        <div class="chart-container">
          <h3>ë“œë¼ì´ë¹™ ë¶„ì„ (Hit / Left / Right)</h3>
          <canvas id="drivingDoughnutChart"></canvas>
        </div>

        <div class="chart-container full-width">
          <h3>ì–´í”„ë¡œì¹˜ ê±°ë¦¬ëŒ€ë³„ On-Green ì„±ê³µë¥ </h3>
          <canvas id="approachBinsChart"></canvas>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <span class="muted">ê±°ë¦¬ëŒ€ ìƒì„¸:</span>
            <select id="approachBinSelect" class="select" style="max-width:320px"></select>
          </div>
        </div>

        <div class="chart-container">
          <h3>ì„ íƒ ê±°ë¦¬ëŒ€ Â· ì§€ë°°ì  í´ëŸ½ ê²°ê³¼ ë¶„í¬</h3>
          <canvas id="approachOutcomePie"></canvas>
        </div>
        <div class="chart-container">
          <h3>í´ëŸ½ë³„ ë¹„ê±°ë¦¬ (í‰ê·  & ìµœëŒ€, ì»·ì˜¤í”„ ì ìš©)</h3>
          <canvas id="clubDistanceChart"></canvas>
          <div id="clubAvgTableContainer" class="muted" style="margin-top:6px"></div>
        </div>
      </div>

      <!-- ë°•ìŠ¤ì°¨íŠ¸: í´ëŸ½êµ° ë¶„í¬ -->
      <div class="chart-container">
        <div class="boxbar">
          <h3 style="margin:0">í´ëŸ½êµ°ë³„ ë¹„ê±°ë¦¬ ë¶„í¬(Box)</h3>
          <span class="muted">í‘œì‹œí•  í´ëŸ½êµ° ì„ íƒ:</span>
          <select id="clubMulti" class="select multiselect" multiple>
            <option value="driver" selected>Driver</option>
            <option value="wood">Wood</option>
            <option value="hybrid">Hybrid</option>
            <option value="iron" selected>Iron</option>
            <option value="wedge">Wedge</option>
          </select>
        </div>
        <canvas id="clubBoxChart"></canvas>
        <div class="muted" style="margin-top:6px">â€» ê° ë¼ìš´ë“œ(ë‚ ì§œ)ë§ˆë‹¤ ì„ íƒ êµ°ì˜ ìƒ· ë¶„í¬ë¥¼ ìƒìê·¸ë¦¼ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤. ì»·ì˜¤í”„(yd, â‰¥ ì œì™¸) ì ìš©.</div>
      </div>

      <!-- ìƒì„¸ ë¼ìš´ë“œ -->
      <div class="round-details" style="margin-top:16px">
        <h3>ìƒì„¸ ë¼ìš´ë“œ ê¸°ë¡</h3>
        <select id="roundSelect" class="select round-select">
          <option value="">ë¼ìš´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
        <div class="mode-row">
          <label><input type="radio" name="detailMode" id="viewSingle" value="single" checked>ì„ íƒ ë¼ìš´ë“œë§Œ</label>
          <label><input type="radio" name="detailMode" id="viewCourseAgg" value="course">ê°™ì€ ì½”ìŠ¤ ì „ì²´ ë¼ìš´ë“œ(í•„í„° ì ìš©)</label>
        </div>
        <div id="selectedRoundMemo" class="muted" style="margin-top:6px"></div>
        <ul id="selectedRoundSummary" style="margin-top:6px"></ul>
        <div id="roundTableContainer"></div>
      </div>

      <!-- í•˜ë‹¨: ë©”ëª¨ & ë¼ìš´ë“œ ìš”ì•½(í•„í„° í›„ í‘œì‹œ) -->
      <div class="bottom-grid">
        <div class="card">
          <h3>ë©”ëª¨ (í•„í„° ì ìš© ê²°ê³¼)</h3>
          <div id="memoContainer" class="muted">í•„í„°ëœ ë¼ìš´ë“œì˜ ë©”ëª¨ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
        <div class="card">
          <h3>ë¼ìš´ë“œ ìš”ì•½ (í•„í„° ì ìš© ì‹œ í‘œì‹œ)</h3>
          <div id="roundSummariesContainer" class="muted"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* =====================
       ì „ì—­ ìƒíƒœ & ìœ í‹¸
    ===================== */
    let roundsData=null, holesData=null, shotsData=null;
    let golfData=[];                // [{courseName, date, visitCount, totalScore, slope, cr, memo, holes:[...]}]
    let charts={};
    let shotsByRound = new Map();   // key(round) -> all shots[]
    let firstFilterApplied = false; // ë¼ìš´ë“œìš”ì•½ì€ ì²« í•„í„° ì´í›„ ë…¸ì¶œ

    const distanceBins=[
      {name:'10â€“30m (11â€“33yd)',  min:11,  max:33},
      {name:'30â€“50m (33â€“55yd)',  min:33,  max:55},
      {name:'50â€“70m (55â€“77yd)',  min:55,  max:77},
      {name:'70â€“90m (77â€“99yd)',  min:77,  max:99},
      {name:'90â€“120m (99â€“131yd)',min:99,  max:131},
      {name:'120â€“150m (131â€“164yd)',min:131,max:164},
    ];
    const n = (v)=> (typeof v==='number' && !isNaN(v)) ? v : (v? parseFloat(v): 0) || 0;
    const normalize = (s)=> (s??'').toString().trim().toLowerCase();
    const toBool = (v)=>{
      if (typeof v==='boolean') return v;
      if (typeof v==='number') return v!==0;
      const s=(v??'').toString().trim().toLowerCase();
      return ['y','yes','true','t','1','o','ok','gir','fw','hit'].includes(s);
    };
    const isPutter = (club)=> (club??'').toString().toLowerCase().includes('put');
    const parseDateSafe = (d)=>{ const dt=new Date(d); return isNaN(dt.getTime())? null: dt; };
    const fmtYM = (d)=> `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const fmtQ = (d)=> `${d.getFullYear()}-Q${Math.floor(d.getMonth()/3)+1}`;
    const rk = (r)=> `${normalize(r.date)}__${normalize(r.courseName)}`;
    const rkRaw = (date, course)=> `${normalize(date)}__${normalize(course)}`;

    const catList = ['driver','wood','hybrid','iron','wedge'];

    /* =====================
       ë¡œì»¬ ì €ì¥ì†Œ (localStorage) - ë°ì´í„° ê¸°ì–µí•˜ê¸°
    ===================== */
    const STORAGE_KEY = 'golf_dashboard_saved_v1';

    function hasSaved(){
      try { return !!localStorage.getItem(STORAGE_KEY); } catch(e){ return false; }
    }
    function updateSavedMeta(){
      const meta = document.getElementById('savedMeta'); if (!meta) return;
      try{
        const raw = localStorage.getItem(STORAGE_KEY); if (!raw){ meta.textContent=''; return; }
        const p = JSON.parse(raw);
        const r = Array.isArray(p.rounds)? p.rounds.length : 0;
        const h = Array.isArray(p.holes)?  p.holes.length : 0;
        const s = Array.isArray(p.shots)?  p.shots.length : 0;
        const when = p.savedAt ? new Date(p.savedAt).toLocaleString() : '';
        meta.textContent = `ì €ì¥ëœ ë°ì´í„°: ë¼ìš´ë“œ ${r} Â· í™€ ${h} Â· ìƒ· ${s}${when? ' (ì €ì¥ì¼ì‹œ: '+when+')':''}`;
      }catch(e){ meta.textContent=''; }
    }
    function showSavedBarIfAny(){
      const bar = document.getElementById('savedDataBar'); if (!bar) return;
      if (hasSaved()){ bar.style.display='block'; updateSavedMeta(); }
    }
    function saveToStorage(){
      try{
        const payload = { rounds: roundsData, holes: holesData, shots: shotsData, savedAt: new Date().toISOString() };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        const bar = document.getElementById('savedDataBar'); if (bar) bar.style.display='block';
        updateSavedMeta();
      }catch(e){
        console.warn('ë¡œì»¬ ì €ì¥ ì‹¤íŒ¨ (ìš©ëŸ‰ ë˜ëŠ” ê¶Œí•œ ë¬¸ì œì¼ ìˆ˜ ìˆìŒ):', e);
      }
    }
    function trySaveAll(){
      if (roundsData && holesData && shotsData){ saveToStorage(); }
    }
    function loadSaved(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw){ alert('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
        const p = JSON.parse(raw);
        roundsData = p.rounds || null;
        holesData  = p.holes  || null;
        shotsData  = p.shots  || null;
        updateStatus('rounds', `${roundsData? roundsData.length:0}ê°œ í–‰ (ì €ì¥ë¨)`, 'success');
        updateStatus('holes',  `${holesData? holesData.length:0}ê°œ í–‰ (ì €ì¥ë¨)`, 'success');
        updateStatus('shots',  `${shotsData? shotsData.length:0}ê°œ í–‰ (ì €ì¥ë¨)`, 'success');
        document.getElementById('analyzeBtn').disabled = !(roundsData && holesData && shotsData);
      }catch(e){
        console.error(e);
        alert('ì €ì¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }
    function clearSaved(){
      try{
        localStorage.removeItem(STORAGE_KEY);
        const bar = document.getElementById('savedDataBar');
        if (bar) { bar.style.display='none'; }
        const meta = document.getElementById('savedMeta'); if (meta) meta.textContent='';
      }catch(e){
        console.warn('ì €ì¥ ë°ì´í„° ì œê±° ì‹¤íŒ¨:', e);
      }
    }


    function updateStatus(fileType, message, css=''){ const el=document.getElementById(`${fileType}Status`); el.textContent=message; el.className=`file-status ${css}`; }

    /* =====================
       CSV íŒŒì„œ
    ===================== */
    document.getElementById('roundsFile').addEventListener('change',(e)=>handleFileUpload(e,'rounds'));
    document.getElementById('holesFile').addEventListener('change',(e)=>handleFileUpload(e,'holes'));
    document.getElementById('shotsFile').addEventListener('change',(e)=>handleFileUpload(e,'shots'));
    document.getElementById('analyzeBtn').addEventListener('click', startAnalysis);
    document.getElementById('backBtn').addEventListener('click', resetApp);
    document.getElementById('applyFilters').addEventListener('click', ()=>{ firstFilterApplied = true; applyFiltersAndRender(); });
    document.getElementById('roundSelect').addEventListener('change', onRoundSelectChange);
    document.getElementById('approachBinSelect').addEventListener('change', renderApproachOutcomePie);
    document.getElementById('viewSingle').addEventListener('change', renderRoundDetails);
    document.getElementById('viewCourseAgg').addEventListener('change', renderRoundDetails);

    document.getElementById('cutoffMode').addEventListener('change', onCutoffModeChange);
    document.getElementById('clubMulti').addEventListener('change', renderClubBoxChart);

    // ì €ì¥ ë°ì´í„° UI ì´ë²¤íŠ¸ ë° ì´ˆê¸° í‘œì‹œ
    document.getElementById('loadSavedBtn')?.addEventListener('click', loadSaved);
    document.getElementById('clearSavedBtn')?.addEventListener('click', ()=>{
      if (confirm('ì €ì¥ëœ ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”? (ë¸Œë¼ìš°ì € ë¡œì»¬ ì €ì¥ì†Œ)')) clearSaved();
    });
    showSavedBarIfAny();


    function onCutoffModeChange(){
      const mode=document.getElementById('cutoffMode').value;
      document.getElementById('globalCutoffGroup').style.display = (mode==='global')? 'block':'none';
      document.getElementById('perCatWrap').style.display = (mode==='percat')? 'block':'none';
    }

    async function handleFileUpload(event, fileType){
      const file = event.target.files[0]; if (!file) return;
      try{
        const parsed = await parseCSVSmart(file);
        const data = parsed.data;
        if (!data.length){ updateStatus(fileType,'íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨ (ë¹ˆ ë°ì´í„°)'); return; }
        const fields=(parsed.meta?.fields||[]).map(f=>normalize(f));
        const hasKey = fields.includes('date') && fields.includes('course name');
        if (!hasKey){
          const any = data.some(r=> r['date']!=null && r['course name']!=null);
          if (!any){ updateStatus(fileType,'íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨ (í•„ìˆ˜ í—¤ë”: date, course name)'); return; }
        }
        const errCount = parsed.errors?.length || 0;
        const badge = errCount? 'success warn':'success';
        const note  = errCount? ` (ê²½ê³  ${errCount}ê±´)`: '';
        if (fileType==='rounds') roundsData=data;
        if (fileType==='holes')  holesData=data;
        if (fileType==='shots')  shotsData=data;
        updateStatus(fileType, `${data.length}ê°œ í–‰ ë¡œë“œë¨${note}`, badge);
        \1 trySaveAll();
      }catch(e){ console.error(e); updateStatus(fileType,'íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨'); }
    }

    async function parseCSVSmart(file){
      let text = await readAsText(file); let out=tryParseAll(text); if (isGood(out)) return out;
      out=tryParseAll(preprocessCSVText(text)); if (isGood(out)) return out;
      const textKR = await readAsText(file,'euc-kr');
      out=tryParseAll(textKR); if (isGood(out)) return out;
      out=tryParseAll(preprocessCSVText(textKR)); return out;
    }
    function isGood(parsed){ return parsed && (parsed.data||[]).length>0; }
    function tryParseAll(text){
      const base={header:true,dynamicTyping:true,skipEmptyLines:'greedy',transformHeader:h=>h.trim()};
      let p=Papa.parse(text,{...base,delimitersToGuess:[',',';','\t','|']}); if (isGood(p)) return p;
      const d=detectDelimiterFromHeader(text); if (d){ p=Papa.parse(text,{...base,delimiter:d}); if (isGood(p)) return p; }
      for (const c of [',',';','\t','|']){ p=Papa.parse(text,{...base,delimiter:c}); if (isGood(p)) return p; }
      return p;
    }
    function preprocessCSVText(t){ if(!t)return t; t=t.replace(/^\uFEFF/,'').replace(/\r\n?/g,'\n'); const lines=t.split('\n');
      const idx=lines.findIndex(line=> line.toLowerCase().includes('date') && line.toLowerCase().includes('course') && line.toLowerCase().includes('name'));
      return idx>0? lines.slice(idx).join('\n') : t;
    }
    function detectDelimiterFromHeader(text){
      const first=(text.split(/\r?\n/).find(l=>l.trim().length>0)||'');
      const cnt=(s,re)=>(s.match(re)||[]).length;
      const counts={',':cnt(first,/,/g), ';':cnt(first,/;/g), '\t':cnt(first,/\t/g), '|':cnt(first,/\|/g)};
      const best=Object.entries(counts).sort((a,b)=>b[1]-a[1])[0]; return (best && best[1]>0)? best[0]:null;
    }
    function readAsText(file,enc){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; enc? fr.readAsText(file,enc): fr.readAsText(file); }); }

    /* =====================
       ë¶„ì„ ì‹œì‘: CSVâ†’golfData (+ shotsByRound)
    ===================== */
    function startAnalysis(){
      buildGolfData();
      initFiltersFromData();
      document.getElementById('uploadSection').style.display='none';
      document.getElementById('dashboardSection').style.display='block';
      // ì´ˆê¸° ë Œë”(ìš”ì•½ì€ í‘œì‹œí•˜ì§€ ì•ŠìŒ)
      applyFiltersAndRender();
    }

    function resetApp(){
      Object.values(charts).forEach(c=>{try{c.destroy()}catch(e){}});
      charts={}; golfData=[]; shotsByRound.clear(); firstFilterApplied=false;
      document.getElementById('dashboardSection').style.display='none';
      document.getElementById('uploadSection').style.display='flex';
      document.getElementById('analyzeBtn').disabled=true;
      document.getElementById('roundSummariesContainer').innerHTML='';
    }

    function pickNum(obj, keys){
      for (const k of keys){ if (obj[k]!=null && !isNaN(parseFloat(obj[k]))) return parseFloat(obj[k]); }
      return null;
    }

    function buildGolfData(){
      golfData=[]; shotsByRound = new Map();
      const keyToRound = new Map(); // key -> {courseName,date,totalScore,slope,cr,memo,holes:[]}
      const key = (o)=> rkRaw(o['date'], o['course name']);

      // rounds: ì ìˆ˜/ë©”ëª¨/ìŠ¬ë¡œí”„/CR
      (roundsData||[]).forEach(r=>{
        const k=key(r);
        if (!keyToRound.has(k)) keyToRound.set(k,{courseName:r['course name'], date:r['date'], totalScore:null, slope:null, cr:null, memo:[], holes:[]});
        const obj=keyToRound.get(k);
        if (n(r['gross score'])>0) obj.totalScore = n(r['gross score']);
        const memo = r['memo']?? r['notes']?? r['note']?? r['comment']?? r['comments'];
        if (memo){ obj.memo.push(String(memo)); }
        // slope & course rating
        obj.slope = pickNum(r, ['slope','slope rating','slope_rating','Slope','Slope Rating']);
        obj.cr    = pickNum(r, ['course rating','course_rating','CR','Course Rating']);
      });

      // holes: ìŠ¤íƒ¯/ë©”ëª¨
      (holesData||[]).forEach(h=>{
        if (!h['date'] || !h['course name']) return;
        const k=key(h);
        if (!keyToRound.has(k)) keyToRound.set(k,{courseName:h['course name'], date:h['date'], totalScore:null, slope:null, cr:null, memo:[], holes:[]});
        const memo = h['memo']?? h['notes']?? h['note']?? h['comment']?? h['comments'];
        keyToRound.get(k).holes.push({
          hole:n(h['hole number']), par:n(h['hole par']), score:n(h['total strokes']),
          putts:n(h['putts']), fairway:(h['fairway']??'').toString(),
          gir: toBool(h['GIR'] ?? h['gir'] ?? h['GIRs'] ?? h['GIR?']),
          approachDist:null, approachClub:null, // ìƒˆ ê·œì¹™ìœ¼ë¡œ ì•„ë˜ì—ì„œ ì±„ì›€
          memo: memo? String(memo): null
        });
        if (memo){ keyToRound.get(k).memo.push(`Hole ${n(h['hole number'])}: ${String(memo)}`); }
      });

      // shots ì¸ë±ìŠ¤: key(date,course,hole) -> shots[]
      const shotsIndex = new Map();
      (shotsData||[]).forEach(s=>{
        if (!s['date'] || !s['course name']) return;
        const k=`${rkRaw(s['date'], s['course name'])}__${n(s['hole number'])}`;
        if (!shotsIndex.has(k)) shotsIndex.set(k,[]);
        shotsIndex.get(k).push(s);
      });
      shotsIndex.forEach(a=> a.sort((a,b)=> n(a['shot number']) - n(b['shot number'])));

      // ì–´í”„ë¡œì¹˜ ìƒ· ê·œì¹™ ê°œì„  + roundë³„ shotsByRound
      keyToRound.forEach(r=>{
        const allShots=[];
        r.holes.forEach(h=>{
          const hk=`${rkRaw(r.date, r.courseName)}__${h.hole}`;
          const shots = shotsIndex.get(hk)||[];
          allShots.push(...shots);

          const ap = determineApproach(shots, h.par);
          if (ap){
            h.approachClub = ap.club;
            h.approachDist = ap.dist>0? ap.dist: null;
          }
        });
        shotsByRound.set(rkRaw(r.date, r.courseName), allShots);
      });

      // ì´ìŠ¤ì½”ì–´ ë³´ì •
      keyToRound.forEach(r=>{
        if (r.totalScore==null && r.holes.length){
          r.totalScore = r.holes.reduce((s,h)=> s + (n(h.score)||0), 0);
        }
      });

      // ë°©ë¬¸ì°¨ìˆ˜(ì½”ìŠ¤ë³„ ì˜¤ë¦„ì°¨ìˆœ)
      const byCourse = {};
      keyToRound.forEach(r=>{
        const d=parseDateSafe(r.date);
        if (!byCourse[r.courseName]) byCourse[r.courseName]=[];
        byCourse[r.courseName].push({r, t: d? d.getTime(): Number.MAX_SAFE_INTEGER});
      });
      Object.values(byCourse).forEach(list=> list.sort((a,b)=> a.t-b.t));
      Object.values(byCourse).forEach(list=>{
        let cnt=0; list.forEach(w=>{ w.r.visitCount=(++cnt); });
      });

      // ë°°ì—´í™”
      keyToRound.forEach(r=>{
        golfData.push({
          courseName:r.courseName,
          date:r.date,
          visitCount:r.visitCount||1,
          totalScore:r.totalScore||0,
          slope:r.slope, cr:r.cr,
          memo: r.memo,
          holes:r.holes
        });
      });
      golfData.sort((a,b)=> (parseDateSafe(a.date)-parseDateSafe(b.date)));
    }

    // ì–´í”„ë¡œì¹˜ íŒì •: Par3=í‹°ìƒ·, Par4/5=í‹°ìƒ· ì œì™¸í•˜ê³  í¼íŒ… ì „ ìƒ· ì¤‘ 30~200ydì˜ "ë§ˆì§€ë§‰" ìƒ·, ì—†ìœ¼ë©´ ë§ˆì§€ë§‰ ë¹„í¼íŒ… ìƒ·
    function determineApproach(shots, par){
      if (!shots || !shots.length) return null;
      const firstPuttIdx = shots.findIndex(s=> isPutter(s['club']));
      const cutoffIdx = (firstPuttIdx>=0? firstPuttIdx: shots.length);
      // í›„ë³´: ë¹„í¼íŒ… & í¼íŒ… ì „
      let cand = shots.filter((s,i)=> !isPutter(s['club']) && i < cutoffIdx);
      if (par>=4){
        // í‹°ìƒ· ì œì™¸ (lieê°€ Teeì´ê±°ë‚˜ shot number==1)
        cand = cand.filter((s,i)=> {
          const lie=(s['lie']||'').toString().toLowerCase();
          const sn = n(s['shot number']);
          return !(lie==='tee' || sn===1);
        });
      }
      if (!cand.length) return null;
      // 30~200yd ë²”ìœ„ì˜ ë§ˆì§€ë§‰ ìƒ·
      let preferred = [...cand].reverse().find(s=> {
        const d=n(s['shot length yards']); return d>=30 && d<=200;
      });
      if (!preferred) preferred = cand[cand.length-1];
      return {dist:n(preferred['shot length yards']), club:(preferred['club']||'').toString()};
    }

    /* =====================
       í•„í„° ì´ˆê¸°í™” & ì ìš©
    ===================== */
    function initFiltersFromData(){
      const courses = Array.from(new Set(golfData.map(g=>g.courseName))).sort((a,b)=>a.localeCompare(b));
      const courseSel=document.getElementById('courseSelect');
      courseSel.innerHTML = `<option value="__ALL__">ì „ì²´</option>` + courses.map(c=>`<option value="${c}">${c}</option>`).join('');

      // ë‚ ì§œ ë²”ìœ„(ì›”)
      const dates = golfData.map(g=>parseDateSafe(g.date)).filter(Boolean);
      if (dates.length){
        const minD = new Date(Math.min(...dates)), maxD = new Date(Math.max(...dates));
        document.getElementById('startMonth').value = fmtYM(minD);
        document.getElementById('endMonth').value   = fmtYM(maxD);
      }

      // ì–´í”„ë¡œì¹˜ ê±°ë¦¬ëŒ€ ì…€ë ‰íŠ¸
      const sel=document.getElementById('approachBinSelect');
      sel.innerHTML = distanceBins.map((b,i)=>`<option value="${i}">${b.name}</option>`).join('');
    }

    function currentFilter(){
      const course = document.getElementById('courseSelect').value;
      const period = document.getElementById('periodMode').value; // round|month|quarter
      const startM = document.getElementById('startMonth').value;
      const endM   = document.getElementById('endMonth').value;
      const pars = Array.from(document.querySelectorAll('.parCheck:checked')).map(c=>parseInt(c.value,10));
      const rlen = document.getElementById('roundLength').value;  // all|9|18
      const useSlope = document.getElementById('useSlope').checked;

      const cutoffMode = document.getElementById('cutoffMode').value;
      const cut = {
        mode: cutoffMode,
        global: parseInt(document.getElementById('globalCutoff').value||'300',10),
        D: parseInt(document.getElementById('cutD').value||'330',10),
        W: parseInt(document.getElementById('cutW').value||'300',10),
        H: parseInt(document.getElementById('cutH').value||'280',10),
        I: parseInt(document.getElementById('cutI').value||'260',10),
        G: parseInt(document.getElementById('cutG').value||'200',10),
      };
      return {course, period, startM, endM, pars, rlen, useSlope, cut};
    }

    function getRoundHolesType(r){ const len = r.holes.length||0; return (len<=9)? 9:18; }

    function getCatByClub(club){
      const s=(club||'').toString().toUpperCase().replace(/\s+/g,'');
      if (!s || isPutter(s)) return null;
      if (['D','DR','DRIVER'].includes(s)) return 'driver';
      if (['3W','4W','5W','7W','9W'].includes(s)) return 'wood';
      if (/^\d+H$/.test(s)) return 'hybrid';
      if (/^\d+I$/.test(s)) return 'iron';
      if (['PW','GW','SW','LW'].includes(s)) return 'wedge';
      if (/^(48|50|52|54|56|58|60|62|64)$/.test(s)) return 'wedge';
      return null;
    }

    function cutoffForClub(club, cut){
      if (cut.mode==='global') return cut.global;
      const cat=getCatByClub(club);
      if (cat==='driver') return cut.D;
      if (cat==='wood')   return cut.W;
      if (cat==='hybrid') return cut.H;
      if (cat==='iron')   return cut.I;
      if (cat==='wedge')  return cut.G;
      return cut.global;
    }

    function adjustedScore(r, useSlope){
      if (!useSlope) return n(r.totalScore);
      const slope = r.slope, cr = r.cr;
      if (!slope || !cr) return n(r.totalScore);
      // Equivalent gross at slope 113:
      return cr + (n(r.totalScore)-cr) * 113 / slope;
    }

    function applyFiltersAndRender(){
      const {course, period, startM, endM, pars, rlen, useSlope, cut} = currentFilter();
      document.getElementById('slopeBadge').textContent = useSlope? ' (Slope ë³´ì •)': '';

      // ë‚ ì§œ ë²”ìœ„
      const startDate = startM? new Date(startM+'-01'): null;
      const endDate   = endM? new Date(endM+'-01'): null;
      if (endDate){ endDate.setMonth(endDate.getMonth()+1); endDate.setDate(0); }

      // ë¼ìš´ë“œ í•„í„°(ì½”ìŠ¤Â·ë‚ ì§œÂ·ê¸¸ì´)
      let rounds = golfData.filter(g=>{
        if (course!=='__ALL__' && g.courseName!==course) return false;
        const d=parseDateSafe(g.date); if (!d) return false;
        if (startDate && d<startDate) return false;
        if (endDate && d>endDate) return false;
        if (rlen==='9'  && getRoundHolesType(g)!==9)  return false;
        if (rlen==='18' && getRoundHolesType(g)!==18) return false;
        return true;
      });

      // í™€ í•„í„°(í™€íƒ€ì…)
      let holes=[];
      rounds.forEach(g=>{ holes.push(...g.holes.filter(h=> pars.includes(h.par))); });

      // ===== KPI & ì°¨íŠ¸ =====
      renderKPIs(rounds, holes, useSlope);
      renderScoreTrend(rounds, period, useSlope);
      renderPuttTrend(rounds, period);
      renderCourseFirstVsLater(rounds, (course!=='__ALL__')? course: null, useSlope);
      renderVisitCountTrend(rounds, (course!=='__ALL__')? course: null, useSlope);
      renderParTypeRates(holes);
      renderDrivingDoughnut(holes);
      renderApproachBins(rounds, holes); // ê°œì„ ëœ ì–´í”„ë¡œì¹˜ ê·œì¹™ ë°˜ì˜
      renderApproachOutcomePie();
      renderClubDistance(rounds, cut);   // ì–´í”„ë¡œì¹˜ ê¸°ë°˜ í‰ê· /ìµœëŒ€ (ì»·ì˜¤í”„ ì ìš©)
      renderClubBoxChart(rounds, cut);   // ìƒ· ì „ìˆ˜ ë°•ìŠ¤ì°¨íŠ¸ (ì»·ì˜¤í”„/ë©€í‹°ì…€ë ‰íŠ¸ ì ìš©)

      // ìƒì„¸ ë¼ìš´ë“œ
      populateRoundSelect(rounds);
      document.getElementById('selectedRoundMemo').textContent = '';
      document.getElementById('selectedRoundSummary').innerHTML = '';
      document.getElementById('roundTableContainer').innerHTML = '<p class="muted">ë¼ìš´ë“œë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ í…Œì´ë¸”ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>';

      // í•˜ë‹¨ ë©”ëª¨ & ë¼ìš´ë“œ ìš”ì•½
      renderMemos(rounds);
      if (firstFilterApplied) renderRoundSummaries(rounds, useSlope);
      else document.getElementById('roundSummariesContainer').innerHTML = '<span class="muted">í•„í„°ë¥¼ ì ìš©í•˜ë©´ ìš”ì•½ì´ í‘œì‹œë©ë‹ˆë‹¤.</span>';
    }

    /* =====================
       KPI
    ===================== */
    function renderKPIs(rounds, holes, useSlope){
      const avgScore = rounds.length? (rounds.reduce((s,r)=>s+adjustedScore(r,useSlope),0)/rounds.length):0;
      document.getElementById('avgScore').textContent = rounds.length? avgScore.toFixed(1): '-';

      const roundPutts = rounds.map(r=> r.holes.reduce((s,h)=>s+n(h.putts),0));
      const avgPutts = roundPutts.length? (roundPutts.reduce((a,b)=>a+b,0)/roundPutts.length):0;
      document.getElementById('avgPutts').textContent = roundPutts.length? avgPutts.toFixed(1): '-';

      const fwHoles = holes.filter(h=> h.par!==3 && h.fairway!=null);
      const fwHit = fwHoles.filter(h=> normalize(h.fairway)==='hit').length;
      document.getElementById('fairwayRate').textContent = fwHoles.length? (fwHit/fwHoles.length*100).toFixed(1)+'%':'-';

      const girHit = holes.filter(h=> h.gir===true).length;
      document.getElementById('girRate').textContent = holes.length? (girHit/holes.length*100).toFixed(1)+'%':'-';
    }

    /* =====================
       ê·¸ë£¹í•‘ & ê³µí†µ ì°¨íŠ¸
    ===================== */
    function groupRounds(rounds, mode, useSlope){ // round|month|quarter
      if (mode==='round'){
        const labels = rounds.map(r=> `${r.date}`);
        const scoreAvg = rounds.map(r=> adjustedScore(r,useSlope));
        const puttAvg = rounds.map(r=> r.holes.reduce((s,h)=>s+n(h.putts),0));
        return {labels, scoreAvg, puttAvg};
      }
      const map = new Map(); // key-> {scores[], putts[]}
      rounds.forEach(r=>{
        const d=parseDateSafe(r.date); if(!d) return;
        const key = (mode==='month')? fmtYM(d): fmtQ(d);
        if (!map.has(key)) map.set(key,{scores:[], putts:[]});
        map.get(key).scores.push(adjustedScore(r,useSlope));
        map.get(key).putts.push(r.holes.reduce((s,h)=>s+n(h.putts),0));
      });
      const labels = Array.from(map.keys()).sort();
      const scoreAvg = labels.map(k=> {
        const arr=map.get(k).scores; return arr.reduce((a,b)=>a+b,0)/arr.length;
      });
      const puttAvg = labels.map(k=> {
        const arr=map.get(k).putts; return arr.reduce((a,b)=>a+b,0)/arr.length;
      });
      return {labels, scoreAvg, puttAvg};
    }

    function renderScoreTrend(rounds, period, useSlope){
      const ctx = document.getElementById('scoreTrendChart').getContext('2d');
      const g = groupRounds(rounds, period, useSlope);
      if (charts.scoreTrend) charts.scoreTrend.destroy();
      charts.scoreTrend = new Chart(ctx,{
        type:'line',
        data:{labels:g.labels, datasets:[{label:'ìŠ¤ì½”ì–´', data:g.scoreAvg, borderColor:'#4ade80', backgroundColor:'rgba(74,222,128,.12)', tension:.35, pointRadius:3}]},
        options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:'#e8eaed'}}},
          scales:{x:{ticks:{color:'#9aa0a6'},grid:{color:'rgba(255,255,255,.08)'}}, y:{ticks:{color:'#9aa0a6'},grid:{color:'rgba(255,255,255,.08)'}}}
        }
      });
    }
    function renderPuttTrend(rounds, period){
      const ctx = document.getElementById('puttTrendChart').getContext('2d');
      const g = groupRounds(rounds, period, false);
      if (charts.puttTrend) charts.puttTrend.destroy();
      charts.puttTrend = new Chart(ctx,{
        type:'line',
        data:{labels:g.labels, datasets:[{label:'ë¼ìš´ë“œ í‰ê·  í¼íŒ…', data:g.puttAvg, borderColor:'#fbbf24', backgroundColor:'rgba(251,191,36,.12)', tension:.35, pointRadius:3}]},
        options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:'#e8eaed'}}},
          scales:{x:{ticks:{color:'#9aa0a6'},grid:{color:'rgba(255,255,255,.08)'}}, y:{ticks:{color:'#9aa0a6'},grid:{color:'rgba(255,255,255,.08)'}}}
        }
      });
    }

    function renderCourseFirstVsLater(rounds, course, useSlope){
      const ctx = document.getElementById('courseFirstVsLaterChart').getContext('2d');
      let list = course? rounds.filter(r=> r.courseName===course): rounds;
      const first = list.filter(r=> r.visitCount===1).map(r=>adjustedScore(r,useSlope));
      const later = list.filter(r=> r.visitCount>=2).map(r=>adjustedScore(r,useSlope));
      const firstAvg = first.length? first.reduce((a,b)=>a+b,0)/first.length : 0;
      const laterAvg = later.length? later.reduce((a,b)=>a+b,0)/later.length : 0;

      if (charts.firstLater) charts.firstLater.destroy();
      charts.firstLater = new Chart(ctx,{
        type:'bar',
        data:{labels:['ì²« ë°©ë¬¸','ì´í›„ í‰ê· '],
          datasets:[{label:'í‰ê·  ìŠ¤ì½”ì–´', data:[firstAvg, laterAvg], backgroundColor:['rgba(96,165,250,.7)','rgba(74,222,128,.7)'], borderColor:'#2d3339', borderWidth:1}]},
        options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:'#e8eaed'}}},
          scales:{x:{ticks:{color:'#9aa0a6'}}, y:{ticks:{color:'#9aa0a6'}}}
        }
      });
    }

    function renderVisitCountTrend(rounds, course, useSlope){
      const ctx = document.getElementById('visitCountTrendChart').getContext('2d');
      let list = course? rounds.filter(r=> r.courseName===course): rounds;
      const map=new Map(); // visitCount -> scores[]
      list.forEach(r=>{
        if (!map.has(r.visitCount)) map.set(r.visitCount,[]);
        map.get(r.visitCount).push(adjustedScore(r,useSlope));
      });
      const visits = Array.from(map.keys()).sort((a,b)=>a-b);
      const avg = visits.map(v=> {
        const arr=map.get(v); return arr.reduce((a,b)=>a+b,0)/arr.length;
      });

      if (charts.visitTrend) charts.visitTrend.destroy();
      charts.visitTrend = new Chart(ctx,{
        type:'line',
        data:{labels:visits.map(String), datasets:[{label:'í‰ê·  ìŠ¤ì½”ì–´', data:avg, borderColor:'#60a5fa', backgroundColor:'rgba(96,165,250,.12)', tension:.35, pointRadius:3}]},
        options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:'#e8eaed'}}},
          scales:{x:{ticks:{color:'#9aa0a6'}}, y:{ticks:{color:'#9aa0a6'}}}
        }
      });
    }

    /* =====================
       í™€ íƒ€ì… ì„±ì (ì„¸ë¶„í™”)
    ===================== */
    function renderParTypeRates(holes){
      const ctx = document.getElementById('parTypeRatesChart').getContext('2d');
      const acc = {3:{b:0,p:0,b1:0,d2:0,t3:0,q4:0,t:0}, 4:{b:0,p:0,b1:0,d2:0,t3:0,q4:0,t:0}, 5:{b:0,p:0,b1:0,d2:0,t3:0,q4:0,t:0}};
      holes.forEach(h=>{
        if (![3,4,5].includes(h.par)) return;
        const diff = (h.score && h.par)? (h.score - h.par): null;
        if (diff==null) return;
        const x=acc[h.par]; x.t+=1;
        if (diff<=-1) x.b+=1;
        else if (diff===0) x.p+=1;
        else if (diff===1) x.b1+=1;
        else if (diff===2) x.d2+=1;
        else if (diff===3) x.t3+=1;
        else if (diff>=4) x.q4+=1;
      });
      const labels=['Par 3','Par 4','Par 5'];
      const toPct=(k)=> labels.map((_,i)=> {const o=acc[i+3]; return o.t? +(o[k]/o.t*100).toFixed(1):0;});
      const bird = toPct('b'), par = toPct('p'), bog = toPct('b1'), dbl = toPct('d2'), tri = toPct('t3'), quad = toPct('q4');

      if (charts.parRates) charts.parRates.destroy();
      charts.parRates = new Chart(ctx,{
        type:'bar',
        data:{labels, datasets:[
          {label:'ë²„ë””(%)',   data:bird, backgroundColor:'rgba(34,197,94,.85)'},
          {label:'íŒŒ(%)',     data:par,  backgroundColor:'rgba(148,163,184,.85)'},
          {label:'ë³´ê¸°(%)',   data:bog,  backgroundColor:'rgba(234,179,8,.85)'},
          {label:'ë”ë¸”(%)',   data:dbl,  backgroundColor:'rgba(249,115,22,.85)'},
          {label:'íŠ¸ë¦¬í”Œ(%)', data:tri,  backgroundColor:'rgba(244,63,94,.85)'},
          {label:'ì¿¼ë“œ+(%)',  data:quad, backgroundColor:'rgba(99,102,241,.85)'}
        ]},
        options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:'#e8eaed'}}},
          scales:{x:{stacked:true,ticks:{color:'#9aa0a6'}}, y:{stacked:true,ticks:{color:'#9aa0a6'}, suggestedMax:100}}
        }
      });
    }

    /* =====================
       ë“œë¼ì´ë¹™ ë„ë„›
    ===================== */
    function renderDrivingDoughnut(holes){
      const d = {Hit:0, Left:0, Right:0};
      holes.filter(h=> h.par!==3).forEach(h=>{
        const f=normalize(h.fairway);
        if (f==='hit') d.Hit += 1;
        else if (f==='left') d.Left += 1;
        else if (f==='right') d.Right += 1;
      });
      const ctx = document.getElementById('drivingDoughnutChart').getContext('2d');
      if (charts.drive) charts.drive.destroy();
      charts.drive = new Chart(ctx,{
        type:'doughnut',
        data:{labels:['Hit','Left','Right'], datasets:[{data:[d.Hit,d.Left,d.Right], backgroundColor:['rgba(74,222,128,.85)','rgba(248,113,113,.85)','rgba(59,130,246,.85)']}]},
        options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:'#e8eaed'}}}}
      });
    }

    /* =====================
       ì–´í”„ë¡œì¹˜
    ===================== */
    function renderApproachBins(rounds, _holes){
      const holes = groupHolesWithRoundKey(rounds).filter(h=> h.approachDist!=null);
      const succ = distanceBins.map(_=>({hit:0, tot:0}));
      holes.forEach(h=>{
        const d=h.approachDist;
        distanceBins.forEach((bin,i)=>{
          if (d>=bin.min && d<bin.max){
            succ[i].tot += 1;
            if (h.gir===true) succ[i].hit += 1; // ì„±ê³µ=GIR
          }
        });
      });
      const labels = distanceBins.map(b=>b.name);
      const values = succ.map(s=> s.tot? +(s.hit/s.tot*100).toFixed(1):0);

      const ctx = document.getElementById('approachBinsChart').getContext('2d');
      if (charts.apprBins) charts.apprBins.destroy();
      charts.apprBins = new Chart(ctx,{
        type:'bar',
        data:{labels, datasets:[{label:'On-Green ì„±ê³µë¥ (%)', data:values, backgroundColor:'rgba(96,165,250,.85)', borderColor:'#2d3339', borderWidth:1}]},
        options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:'#e8eaed'}}},
          scales:{x:{ticks:{color:'#9aa0a6'}}, y:{ticks:{color:'#9aa0a6'}, suggestedMax:100}}
        }
      });

      // ê°€ì¥ í‘œë³¸ ë§ì€ ê±°ë¦¬ëŒ€ë¥¼ ê¸°ë³¸ ì„ íƒ
      const maxIdx = succ.map(s=>s.tot).reduce((best,cur,i,arr)=> cur>(arr[best]||0)? i:best, 0);
      const sel=document.getElementById('approachBinSelect');
      if (sel.options.length>0){ sel.selectedIndex = maxIdx; }
    }

    function renderApproachOutcomePie(){
      const {course, startM, endM, pars} = currentFilter();
      const startDate = startM? new Date(startM+'-01'): null;
      const endDate   = endM? new Date(endM+'-01'): null; if (endDate){ endDate.setMonth(endDate.getMonth()+1); endDate.setDate(0); }
      const rounds = golfData.filter(g=>{
        if (course!=='__ALL__' && g.courseName!==course) return false;
        const d=parseDateSafe(g.date); if (!d) return false;
        if (startDate && d<startDate) return false;
        if (endDate && d>endDate) return false;
        return true;
      });
      const holes = groupHolesWithRoundKey(rounds).filter(h=> h.approachDist!=null && pars.includes(h.par));

      const binIdx = parseInt(document.getElementById('approachBinSelect').value||'0',10);
      const bin = distanceBins[binIdx];
      const inBin = holes.filter(h=> h.approachDist>=bin.min && h.approachDist<bin.max);

      // ì§€ë°°ì  í´ëŸ½
      const countByClub = {};
      inBin.forEach(h=>{
        const c=(h.approachClub||'Unknown').toString();
        countByClub[c]=(countByClub[c]||0)+1;
      });
      const domClub = Object.entries(countByClub).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'Unknown';
      const subset = inBin.filter(h=> (h.approachClub||'Unknown')===domClub);

      const cats = ['On-Green','Short','Long','Left','Right','Other','Unknown'];
      const cnt = Object.fromEntries(cats.map(c=>[c,0]));
      subset.forEach(h=>{
        // approachResult ì—†ìœ¼ë©´ GIRë¡œ ì¹˜í™˜
        const r=(h.approachResult|| (h.gir?'On-Green':'Other')).toString();
        cnt[cats.includes(r)? r:'Other'] += 1;
      });

      const ctx = document.getElementById('approachOutcomePie').getContext('2d');
      if (charts.apprPie) charts.apprPie.destroy();
      charts.apprPie = new Chart(ctx,{
        type:'pie',
        data:{labels:cats, datasets:[{data:cats.map(c=>cnt[c]), backgroundColor:[
          'rgba(74,222,128,.85)','rgba(248,113,113,.85)','rgba(59,130,246,.85)','rgba(250,204,21,.85)',
          'rgba(147,51,234,.85)','rgba(148,163,184,.85)','rgba(107,114,128,.85)'
        ]}]},
        options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:'#e8eaed'}, position:'bottom'},
          title:{display:true,text:`ê±°ë¦¬ëŒ€: ${bin.name} Â· í´ëŸ½: ${domClub}`, color:'#e8eaed'}}}
      });
    }

    /* =====================
       í´ëŸ½ë³„ ë¹„ê±°ë¦¬ (ì–´í”„ë¡œì¹˜ ê¸°ë°˜, ì»·ì˜¤í”„ ì ìš©)
    ===================== */
    function clubOrderIndex(name){
      const s=(name||'').toString().toUpperCase().replace(/\s+/g,'');
      if (['D','DR','DRIVER'].includes(s)) return 0;
      const wood={'3W':1,'4W':2,'5W':3,'7W':4,'9W':5}; if (wood[s]!=null) return wood[s];
      const h=s.match(/^(\d+)H$/); if (h) return 10 + (+h[1]);
      const i=s.match(/^(\d+)I$/); if (i) return 30 + (+i[1]);
      const wedge={'PW':50,'GW':51,'SW':52,'LW':53}; if (wedge[s]!=null) return wedge[s];
      const deg=s.match(/^(48|50|52|54|56|58|60|62|64)$/); if (deg) return 51+ (+deg[1])/10;
      return 100;
    }
    function renderClubDistance(rounds, cut){
      const clubAgg=new Map(); // club -> {sum,cnt,max}
      rounds.forEach(r=>{
        r.holes.forEach(h=>{
          const c=(h.approachClub||'').toString().trim(); const d=n(h.approachDist);
          if (!c || !d || d<=0 || isPutter(c)) return;
          const thr = cutoffForClub(c, cut);
          if (thr && d>=thr) return; // ë…¸ì´ì¦ˆ ì œê±°
          if (!clubAgg.has(c)) clubAgg.set(c,{sum:0,cnt:0,max:0});
          const g=clubAgg.get(c); g.sum+=d; g.cnt+=1; if (d>g.max) g.max=d;
        });
      });
      const clubs=Array.from(clubAgg.keys()).sort((a,b)=> clubOrderIndex(a)-clubOrderIndex(b) || a.localeCompare(b));
      const avg=clubs.map(c=> (clubAgg.get(c).sum/clubAgg.get(c).cnt).toFixed(1));
      const max=clubs.map(c=> (clubAgg.get(c).max).toFixed(1));

      const ctx = document.getElementById('clubDistanceChart').getContext('2d');
      if (charts.club) charts.club.destroy();
      charts.club = new Chart(ctx,{
        type:'bar',
        data:{labels:clubs, datasets:[
          {label:'í‰ê· (yd)', data:avg, backgroundColor:'rgba(74,222,128,.8)', borderColor:'#2d3339', borderWidth:1},
          {label:'ìµœëŒ€(yd)', data:max, backgroundColor:'rgba(59,130,246,.7)', borderColor:'#2d3339', borderWidth:1}
        ]},
        options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:'#e8eaed'}}},
          scales:{x:{ticks:{color:'#9aa0a6'}}, y:{ticks:{color:'#9aa0a6'}}}
        }
      });

      // ìš”ì•½ í…Œì´ë¸”
      const tbl = `<table><thead><tr><th>í´ëŸ½</th><th>ìƒ· ìˆ˜</th><th>í‰ê· (yd)</th><th>ìµœëŒ€(yd)</th></tr></thead>
        <tbody>${clubs.map((c,i)=>`<tr><td>${c}</td><td>${clubAgg.get(c).cnt}</td><td>${avg[i]}</td><td>${max[i]}</td></tr>`).join('')}</tbody></table>`;
      document.getElementById('clubAvgTableContainer').innerHTML = tbl || '<span class="muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
    }

    /* =====================
       ë°•ìŠ¤ì°¨íŠ¸: í´ëŸ½êµ° ë¶„í¬(ìƒ· ì „ìˆ˜, ì»·ì˜¤í”„/ë©€í‹°ì…€ë ‰íŠ¸)
    ===================== */
    function renderClubBoxChart(rounds, cut){
      const ctx = document.getElementById('clubBoxChart').getContext('2d');
      const labels = rounds.map(r=> r.date);
      const selected = Array.from(document.getElementById('clubMulti').selectedOptions).map(o=>o.value);
      // ë¼ìš´ë“œë³„ ìƒ· ë¶„í¬ (ì„ íƒ êµ°)
      const mkData = (cat)=>{
        return rounds.map(r=>{
          const shots = shotsByRound.get(rk(r))||[];
          const arr = shots.filter(s=>{
            const catS = getCatByClub(s['club']);
            const d=n(s['shot length yards']);
            if (catS!==cat) return false;
            if (!d || d<=0) return false;
            const thr = cutoffForClub(s['club'], cut);
            if (thr && d>=thr) return false;
            return true;
          }).map(s=> n(s['shot length yards']));
          return arr; // ë°•ìŠ¤í”ŒëŸ¬ê·¸ì¸ì€ ê° ë¼ë²¨ì— ë°°ì—´ì„ í—ˆìš©
        });
      };
      const colorMap = {driver:'#f87171', wood:'#60a5fa', hybrid:'#34d399', iron:'#fbbf24', wedge:'#a78bfa'};
      const datasets = selected.map(cat=> ({
        label: cat.charAt(0).toUpperCase()+cat.slice(1),
        data: mkData(cat),
        backgroundColor: colorMap[cat]+'66',
        borderColor: colorMap[cat],
        borderWidth: 1,
        outlierBackgroundColor: colorMap[cat],
        itemRadius: 0,
      }));

      if (charts.clubBox) charts.clubBox.destroy();
      charts.clubBox = new Chart(ctx,{
        type:'boxplot',
        data:{labels, datasets},
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{legend:{labels:{color:'#e8eaed'}}},
          scales:{x:{ticks:{color:'#9aa0a6'}}, y:{ticks:{color:'#9aa0a6'}}},
          elements:{boxplot:{outlierRadius:2}}
        }
      });
    }

    /* =====================
       ìƒì„¸ ë¼ìš´ë“œ
    ===================== */
    function populateRoundSelect(rounds){
      const sel=document.getElementById('roundSelect');
      sel.innerHTML='<option value="">ë¼ìš´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
      rounds.forEach(r=>{
        const label = `${r.date} Â· ${r.courseName} (${getRoundHolesType(r)}H, ${r.visitCount}íšŒì°¨)`;
        const opt=document.createElement('option'); opt.value=rk(r); opt.textContent=label; sel.appendChild(opt);
      });
    }
    function onRoundSelectChange(){ renderRoundDetails(); }
    function renderRoundDetails(){
      const key=document.getElementById('roundSelect').value;
      const mode = document.getElementById('viewCourseAgg').checked? 'course':'single';
      const memoBox = document.getElementById('selectedRoundMemo');
      const sumList = document.getElementById('selectedRoundSummary');
      const container=document.getElementById('roundTableContainer');
      memoBox.textContent=''; sumList.innerHTML=''; container.innerHTML='';

      if (!key){ container.innerHTML='<p class="muted">ë¼ìš´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>'; return; }
      const r0 = golfData.find(g=> rk(g)===key);
      if (!r0){ container.innerHTML='<p class="muted">ë¼ìš´ë“œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }

      if (mode==='single'){
        memoBox.textContent = (r0.memo && r0.memo.length)? `ë©”ëª¨: ${r0.memo.join(' | ')}` : 'ë©”ëª¨ ì—†ìŒ';
        sumList.innerHTML = `<li>${summarizeRound(r0, document.getElementById('useSlope').checked)}</li>`;
        renderRoundTable([r0], container, false);
      } else {
        const {startM, endM, rlen} = currentFilter();
        const startDate = startM? new Date(startM+'-01'): null;
        const endDate   = endM? new Date(endM+'-01'): null;
        if (endDate){ endDate.setMonth(endDate.getMonth()+1); endDate.setDate(0); }
        let same = golfData.filter(g=> g.courseName===r0.courseName);
        same = same.filter(g=>{
          const d=parseDateSafe(g.date);
          if (startDate && d<startDate) return false;
          if (endDate && d>endDate) return false;
          if (rlen==='9'  && getRoundHolesType(g)!==9)  return false;
          if (rlen==='18' && getRoundHolesType(g)!==18) return false;
          return true;
        });
        const allMemos = same.flatMap(r=>r.memo||[]);
        memoBox.textContent = allMemos.length? `ë©”ëª¨(ì½”ìŠ¤ ì „ì²´): ${allMemos.join(' | ')}` : 'ë©”ëª¨ ì—†ìŒ';
        sumList.innerHTML = same.map(r=> `<li>${r.date}: ${summarizeRound(r, document.getElementById('useSlope').checked)}</li>`).join('');
        renderRoundTable(same, container, true);
      }
    }

    function renderRoundTable(roundList, container, aggregate=false){
      if (!roundList.length){ container.innerHTML='<p class="muted">í‘œì‹œí•  ë¼ìš´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
      const byHole = new Map();
      roundList.forEach(r=>{
        r.holes.forEach(h=>{
          const hh={...h, __course:r.courseName, __date:r.date};
          if (!byHole.has(hh.hole)) byHole.set(hh.hole,[]);
          byHole.get(hh.hole).push(hh);
        });
      });
      const holeNos = Array.from(byHole.keys()).sort((a,b)=> a-b);
      const table=document.createElement('table');
      table.innerHTML = aggregate? `
        <thead><tr><th>í™€</th><th>ëŒ€í‘œ íŒŒ</th><th>í‰ê·  ìŠ¤ì½”ì–´(Â±)</th><th>í‰ê·  í¼íŒ…</th><th>FW Hit%</th><th>GIR%</th><th>í‰ê·  ì ‘ê·¼(yd)</th></tr></thead><tbody></tbody>
      `: `
        <thead><tr><th>í™€</th><th>íŒŒ</th><th>ìŠ¤ì½”ì–´(Â±)</th><th>í¼íŒ…</th><th>FW</th><th>GIR</th><th>ì ‘ê·¼(yd)</th><th>í´ëŸ½</th></tr></thead><tbody></tbody>
      `;
      const tb=table.querySelector('tbody');

      if (!aggregate){
        const r = roundList[0];
        const holes=[...r.holes].sort((a,b)=> a.hole-b.hole);
        holes.forEach(h=>{
          const diff=(h.score && h.par)? h.score-h.par: null;
          const fw = (h.par!==3)? (normalize(h.fairway)==='hit'?'Hit': (h.fairway||'N')):'-';
          tb.insertAdjacentHTML('beforeend',`
            <tr>
              <td>${h.hole}</td>
              <td>${h.par}</td>
              <td>${h.score}${diff!=null? ` (${diff>0? '+'+diff: diff})` : ''}</td>
              <td>${h.putts||0}</td>
              <td>${fw}</td>
              <td>${h.gir?'Y':'N'}</td>
              <td>${h.approachDist!=null? h.approachDist.toFixed(0): '-'}</td>
              <td>${h.approachClub||'-'}</td>
            </tr>
          `);
        });
      } else {
        holeNos.forEach(no=>{
          const arr=byHole.get(no);
          const parMode = (()=>{const freq={}; arr.forEach(x=>freq[x.par]=(freq[x.par]||0)+1); return +Object.entries(freq).sort((a,b)=>b[1]-a[1])[0][0];})();
          const avgScore = arr.reduce((s,h)=>s+n(h.score),0)/arr.length;
          const diff = avgScore - parMode;
          const avgPutts = arr.reduce((s,h)=>s+n(h.putts),0)/arr.length;
          const fwHoles = arr.filter(h=> h.par!==3 && h.fairway!=null);
          const fwRate  = fwHoles.length? fwHoles.filter(h=> normalize(h.fairway)==='hit').length / fwHoles.length * 100 : null;
          const girRate = arr.filter(h=> h.gir===true).length / arr.length * 100;
          const appr = arr.filter(h=> h.approachDist!=null);
          const apprAvg = appr.length? appr.reduce((s,h)=>s+n(h.approachDist),0)/appr.length : null;

          tb.insertAdjacentHTML('beforeend',`
            <tr>
              <td>${no}</td>
              <td>${parMode}</td>
              <td>${avgScore.toFixed(1)} (${diff>0? '+'+diff.toFixed(1): diff.toFixed(1)})</td>
              <td>${avgPutts.toFixed(1)}</td>
              <td>${fwRate!=null? fwRate.toFixed(0)+'%':'-'}</td>
              <td>${girRate.toFixed(0)}%</td>
              <td>${apprAvg!=null? apprAvg.toFixed(1): '-'}</td>
            </tr>
          `);
        });
      }
      container.appendChild(table);
    }

    /* =====================
       ë©”ëª¨ & ë¼ìš´ë“œ ìš”ì•½(í•˜ë‹¨)
    ===================== */
    function renderMemos(rounds){
      const box=document.getElementById('memoContainer');
      const entries = rounds
        .map(r=> ({ key:rk(r), title:`${r.date} Â· ${r.courseName} (${getRoundHolesType(r)}H)`, memo:r.memo?.filter(Boolean)||[] }))
        .filter(e=> e.memo.length>0);
      if (!entries.length){ box.innerHTML='<span class="muted">í‘œì‹œí•  ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</span>'; return; }
      box.innerHTML='';
      entries.forEach(e=>{
        const div=document.createElement('div'); div.className='memo-item';
        div.innerHTML = `<b>${e.title}</b><ul style="margin-top:6px">${e.memo.map(m=>`<li>${m}</li>`).join('')}</ul>`;
        box.appendChild(div);
      });
    }

    function renderRoundSummaries(rounds, useSlope){
      const box=document.getElementById('roundSummariesContainer');
      if (!rounds.length){ box.innerHTML='<span class="muted">ë¼ìš´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</span>'; return; }
      const html = rounds.map(r=>{
        const sum = summarizeRound(r, useSlope);
        return `<div class="memo-item"><b>${r.date} Â· ${r.courseName} (${getRoundHolesType(r)}H, ${r.visitCount}íšŒì°¨)</b><div class="muted" style="margin-top:6px">${sum}</div></div>`;
      }).join('');
      box.innerHTML = html;
    }

    function summarizeRound(r, useSlope){
      const holes = r.holes;
      const parSum = holes.reduce((s,h)=>s+n(h.par),0);
      const dispScore = adjustedScore(r,useSlope);
      const diff = dispScore - parSum;
      const diffTxt = diff>0? `+${diff.toFixed(0)}`: `${diff.toFixed(0)}`;
      const bird = holes.filter(h=> h.score - h.par <= -1).length;
      const par  = holes.filter(h=> h.score - h.par === 0).length;
      const bog  = holes.filter(h=> h.score - h.par === 1).length;
      const dbl  = holes.filter(h=> h.score - h.par === 2).length;
      const tri  = holes.filter(h=> h.score - h.par === 3).length;
      const quad = holes.filter(h=> h.score - h.par >= 4).length;
      const fwH  = holes.filter(h=> h.par!==3 && normalize(h.fairway)==='hit').length;
      const fwT  = holes.filter(h=> h.par!==3 && h.fairway!=null).length;
      const girH = holes.filter(h=> h.gir===true).length;
      const putt = holes.reduce((s,h)=>s+n(h.putts),0);
      const apprTot = holes.filter(h=> h.approachDist!=null).length;
      const apprHit = holes.filter(h=> (h.approachDist!=null) && (h.gir===true)).length;
      const biasL = holes.filter(h=> h.par!==3 && normalize(h.fairway)==='left').length;
      const biasR = holes.filter(h=> h.par!==3 && normalize(h.fairway)==='right').length;
      const biasTxt = biasL>biasR? 'ì™¼ìª½ ë¯¸ìŠ¤ ê²½í–¥' : (biasR>biasL? 'ì˜¤ë¥¸ìª½ ë¯¸ìŠ¤ ê²½í–¥':'ì¢Œìš° ë°¸ëŸ°ìŠ¤');

      return `ìŠ¤ì½”ì–´ ${dispScore.toFixed(0)} (${diffTxt}), ë²„ë”” ${bird}, íŒŒ ${par}, ë³´ê¸° ${bog}, ë”ë¸” ${dbl}, íŠ¸ë¦¬í”Œ ${tri}, ì¿¼ë“œ+ ${quad}, `
           + `FW ${fwT? (fwH/fwT*100).toFixed(0)+'%':'-'}, GIR ${(girH/holes.length*100).toFixed(0)}%, `
           + `í¼íŒ… ${putt}, ì–´í”„ë¡œì¹˜ On-Green ${apprTot? (apprHit/apprTot*100).toFixed(0)+'%':'-'}, ë“œë¼ì´ë¹™ ${biasTxt}`;
    }

    /* =====================
       ë³´ì¡°: ë¼ìš´ë“œ/í™€ ê·¸ë£¹ íƒœê¹…
    ===================== */
    function groupHolesWithRoundKey(rounds){
      const holes=[];
      rounds.forEach(r=>{
        r.holes.forEach(h=>{
          const hh = {...h};
          hh.__roundKey = rk(r);
          hh.__course = r.courseName;
          hh.__date = r.date;
          hh.__visit = r.visitCount;
          holes.push(hh);
        });
      });
      return holes;
    }
  </script>
</body>
</html>
