<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>ê³¨í”„ ëŒ€ì‹œë³´ë“œ (ëª¨ë°”ì¼ ìµœì í™”)</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    /* ===== ë‹¤í¬ í…Œë§ˆ & ëª¨ë°”ì¼ ìµœì í™” ===== */
    :root{
      --bs-dark: #0d1117;
      --bs-dark-rgb: 13, 17, 23;
      --bs-body-bg: #0d1117;
      --bs-body-color: #f0f6fc;
      --bs-card-bg: #161b22;
      --bs-border-color: #30363d;
      --bs-primary: #238636;
      --bs-success: #238636;
      --bs-warning: #da8b26;
      --bs-danger: #f85149;
      --bs-info: #1f6feb;
      --bs-secondary: #6e7681;
      --kpi-text-color: #ffffff;
      --kpi-label-color: #e6edf3;
    }

    body {
      background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
      min-height: 100vh;
      color: var(--bs-body-color);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* PWA ìŠ¤íƒ€ì¼ ìºì‹œ ì•Œë¦¼ */
    .cache-notification {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 9999;
      max-width: 300px;
      background: var(--bs-success);
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }

    .cache-notification.show {
      transform: translateX(0);
    }

    /* ìºì‹œ ìƒíƒœ */
    .cache-status {
      background: var(--bs-card-bg);
      border: 1px solid var(--bs-border-color);
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }

    /* ì—…ë¡œë“œ ì„¹ì…˜ */
    .upload-section {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .main-title {
      background: linear-gradient(135deg, var(--bs-success) 0%, #2ea043 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      color: transparent;
      font-weight: 700;
    }

    .upload-card {
      background: var(--bs-card-bg);
      border: 1px solid var(--bs-border-color);
      border-radius: 12px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }

    .upload-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* íŒŒì¼ ì—…ë¡œë“œ */
    .file-label {
      border: 2px solid var(--bs-success);
      color: var(--bs-success);
      background: transparent;
      transition: all 0.2s ease;
      cursor: pointer;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      display: inline-block;
      text-decoration: none;
    }

    .file-label:hover {
      background: var(--bs-success);
      color: white;
    }

    /* ëŒ€ì‹œë³´ë“œ */
    .dashboard-header h1 {
      background: linear-gradient(135deg, var(--bs-success) 0%, #2ea043 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      color: transparent;
      font-weight: 700;
    }

    /* KPI ì¹´ë“œ - í…ìŠ¤íŠ¸ ê°€ì‹œì„± ê°œì„  */
    .kpi-card {
      background: var(--bs-card-bg);
      border: 1px solid var(--bs-border-color);
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }

    .kpi-value {
      color: var(--kpi-text-color) !important;
      font-weight: 800;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    .kpi-label {
      color: var(--kpi-label-color) !important;
      font-weight: 500;
    }

    /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
    .chart-container {
      background: var(--bs-card-bg);
      border: 1px solid var(--bs-border-color);
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }

    /* í•„í„° ë°” */
    .filter-bar {
      background: var(--bs-card-bg);
      border: 1px solid var(--bs-border-color);
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }

    /* ë°ìŠ¤í¬íƒ‘ ìµœì í™” */
    @media (min-width: 1200px) {
      .container-fluid {
        max-width: 1400px;
        margin: 0 auto;
      }
      
      .dashboard-section {
        padding: 2rem 0;
      }
      
      .chart-container canvas {
        max-height: 350px;
      }
      
      .kpi-section {
        max-width: 800px;
        margin: 0 auto 2rem auto;
      }
      
      .chart-grid-section {
        margin-bottom: 2rem;
      }
      
      /* 2ì—´ ë ˆì´ì•„ì›ƒ ìµœì í™” */
      .chart-2col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }
      
      .chart-3col {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }
    }

    @media (min-width: 992px) and (max-width: 1199px) {
      .container-fluid {
        max-width: 1140px;
        margin: 0 auto;
      }
      
      .chart-container canvas {
        max-height: 320px;
      }
    }

    /* íƒœë¸”ë¦¿ ìµœì í™” */
    @media (min-width: 768px) and (max-width: 991px) {
      .chart-container canvas {
        max-height: 300px;
      }
      
      .kpi-section .col-6 {
        margin-bottom: 1rem;
      }
    }

    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 767px) {
      .main-title {
        font-size: 1.8rem;
      }
      
      .dashboard-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }
      
      .dashboard-header h1 {
        font-size: 1.5rem;
      }
      
      .kpi-section .col-6 {
        margin-bottom: 1rem;
      }
      
      .chart-container {
        margin-bottom: 1rem;
      }
      
      .filter-bar .row > div {
        margin-bottom: 0.75rem;
      }
      
      canvas {
        max-height: 250px;
      }
      
      table {
        font-size: 0.85rem;
      }
      
      th, td {
        padding: 0.5rem 0.25rem;
        word-wrap: break-word;
      }

      .cache-notification {
        top: 10px;
        left: 10px;
        right: 10px;
        max-width: none;
        transform: translateY(-100%);
      }

      .cache-notification.show {
        transform: translateY(0);
      }
    }

    @media (max-width: 576px) {
      .main-title {
        font-size: 1.5rem;
      }
      
      .dashboard-header h1 {
        font-size: 1.3rem;
      }
      
      .kpi-section .col-6 .kpi-value {
        font-size: 1.5rem;
      }
      
      canvas {
        max-height: 200px;
      }
      
      .btn {
        font-size: 0.9rem;
      }
      
      .form-control, .form-select {
        font-size: 0.9rem;
      }
    }

    /* ì„¹ì…˜ êµ¬ë¶„ */
    .section-divider {
      margin: 2rem 0;
      border-top: 1px solid var(--bs-border-color);
      padding-top: 2rem;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: var(--bs-body-color);
      text-align: center;
      position: relative;
    }

    .section-title::after {
      content: '';
      position: absolute;
      bottom: -0.5rem;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 2px;
      background: var(--bs-success);
    }

    /* ë‹¤í¬ í…Œë§ˆ Bootstrap ì˜¤ë²„ë¼ì´ë“œ */
    .card {
      background: var(--bs-card-bg);
      border-color: var(--bs-border-color);
    }

    .form-control, .form-select {
      background: var(--bs-card-bg);
      border-color: var(--bs-border-color);
      color: var(--bs-body-color);
    }

    .form-control:focus, .form-select:focus {
      background: var(--bs-card-bg);
      border-color: var(--bs-success);
      box-shadow: 0 0 0 0.25rem rgba(35, 134, 54, 0.25);
      color: var(--bs-body-color);
    }

    .btn-success {
      --bs-btn-bg: var(--bs-success);
      --bs-btn-border-color: var(--bs-success);
    }

    .btn-outline-success {
      --bs-btn-color: var(--bs-success);
      --bs-btn-border-color: var(--bs-success);
      --bs-btn-hover-bg: var(--bs-success);
    }

    .table-dark {
      --bs-table-bg: var(--bs-card-bg);
      --bs-table-border-color: var(--bs-border-color);
    }

    /* í„°ì¹˜ ì¹œí™”ì  */
    .btn, .form-control, .form-select, .file-label {
      min-height: 44px;
      touch-action: manipulation;
    }

    /* ìŠ¤í¬ë¡¤ë°” */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bs-dark);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--bs-secondary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--bs-body-color);
    }

    /* ë¡œë”© ìƒíƒœ */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    /* PWA ì„¤ì¹˜ ë²„íŠ¼ */
    .pwa-install {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      display: none;
    }

    /* ì ‘ê·¼ì„± ê°œì„  */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
  <!-- ìºì‹œ ì•Œë¦¼ -->
  <div id="cacheNotification" class="cache-notification">
    <i class="fas fa-check-circle"></i>
    <span id="cacheMessage">ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</span>
  </div>

  <!-- PWA ì„¤ì¹˜ ë²„íŠ¼ -->
  <button id="pwaInstall" class="pwa-install btn btn-success rounded-circle" style="width: 56px; height: 56px;">
    <i class="fas fa-download"></i>
  </button>

  <!-- ì—…ë¡œë“œ ì„¹ì…˜ -->
  <div class="upload-section" id="uploadSection">
    <div class="container-fluid px-3">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
          <h1 class="main-title text-center mb-3">â›³ ê³¨í”„ ëŒ€ì‹œë³´ë“œ</h1>
          <p class="text-center text-muted mb-4">3ê°œ CSV íŒŒì¼ì„ í•œ ë²ˆ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ì €ì¥ë˜ì–´ ë‹¤ìŒë²ˆì— ë¹ ë¥´ê²Œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤!</p>

          <!-- ìºì‹œ ìƒíƒœ í‘œì‹œ -->
          <div class="cache-status p-4 mb-4 d-none" id="cacheStatus">
            <div class="fs-1 mb-3">ğŸ“±</div>
            <h4 class="mb-3">ì €ì¥ëœ ë°ì´í„° ë°œê²¬!</h4>
            <div class="text-muted mb-2">ë§ˆì§€ë§‰ ì €ì¥: <span id="lastUploadDate"></span></div>
            <div class="text-muted mb-3">íŒŒì¼ ì •ë³´: <span id="cacheSize"></span></div>
            <div class="d-flex gap-2 flex-wrap justify-content-center">
              <button id="useCacheBtn" class="btn btn-success">
                <i class="fas fa-rocket"></i> ë¹ ë¥¸ ì‹œì‘
              </button>
              <button id="uploadNewBtn" class="btn btn-outline-warning">
                <i class="fas fa-sync"></i> ìƒˆ ë°ì´í„°
              </button>
              <button id="clearCacheBtn" class="btn btn-outline-danger">
                <i class="fas fa-trash"></i> ì‚­ì œ
              </button>
            </div>
          </div>

          <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ -->
          <div id="uploadArea">
            <div class="card upload-card p-4 text-center">
              <div class="fs-1 mb-3">ğŸ“¦</div>
              <h4 class="mb-3">ê³¨í”„ ë°ì´í„° ì—…ë¡œë“œ</h4>
              <p class="text-muted mb-3">ë¼ìš´ë“œ, í™€ë³„, ìƒ·ë³„ ë°ì´í„° 3ê°œ CSV íŒŒì¼</p>
              <input type="file" id="allFiles" accept=".csv" multiple class="d-none"/>
              <label class="file-label fw-bold" for="allFiles">
                <i class="fas fa-upload"></i> íŒŒì¼ 3ê°œ ì„ íƒ
              </label>
              <div id="allStatus" class="mt-3 text-muted"></div>
            </div>

            <div class="text-center mt-4">
              <button id="analyzeBtn" class="btn btn-success btn-lg px-5" disabled>
                <i class="fas fa-chart-line"></i> ë¶„ì„ ì‹œì‘í•˜ê¸°
              </button>
              <p class="text-muted mt-2 small">
                * ë¼ìš´ë“œ ì—°ê²° í‚¤: <code>date</code> + <code>course name</code>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ëŒ€ì‹œë³´ë“œ -->
  <div class="dashboard-section d-none" id="dashboardSection">
    <div class="container-fluid px-3">
      <div class="dashboard-header d-flex justify-content-between align-items-center mb-4">
        <h1>ê³¨í”„ í¼í¬ë¨¼ìŠ¤ ëŒ€ì‹œë³´ë“œ <small class="text-muted">(ì €ì¥ë¨)</small></h1>
        <button id="backBtn" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left"></i> ìƒˆ ë°ì´í„°
        </button>
      </div>

      <!-- í•„í„° ë°” -->
      <div class="filter-bar card p-3 mb-4">
        <div class="row g-3">
          <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label small">ê³¨í”„ì¥ ì„ íƒ</label>
            <select id="courseSelect" class="form-select"></select>
          </div>

          <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label small">í™€ íƒ€ì…</label>
            <div class="d-flex gap-2 flex-wrap">
              <div class="form-check">
                <input type="checkbox" class="form-check-input parCheck" value="3" checked id="par3">
                <label class="form-check-label small" for="par3">Par 3</label>
              </div>
              <div class="form-check">
                <input type="checkbox" class="form-check-input parCheck" value="4" checked id="par4">
                <label class="form-check-label small" for="par4">Par 4</label>
              </div>
              <div class="form-check">
                <input type="checkbox" class="form-check-input parCheck" value="5" checked id="par5">
                <label class="form-check-label small" for="par5">Par 5</label>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label small">ê¸°ê°„ ë³´ê¸°</label>
            <select id="periodMode" class="form-select">
              <option value="round">ë¼ìš´ë“œë³„</option>
              <option value="month">ì›”ë³„</option>
              <option value="quarter">ë¶„ê¸°ë³„</option>
            </select>
          </div>

          <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label small">ë¼ìš´ë“œ ê¸¸ì´</label>
            <select id="roundLength" class="form-select">
              <option value="all">ì „ì²´</option>
              <option value="9">9í™€ë§Œ</option>
              <option value="18" selected>18í™€ë§Œ</option>
            </select>
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label small">ë‚ ì§œ ë²”ìœ„</label>
            <div class="row g-2">
              <div class="col">
                <input type="month" id="startMonth" class="form-control"/>
              </div>
              <div class="col">
                <input type="month" id="endMonth" class="form-control"/>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label small">ì˜µì…˜</label>
            <div class="d-flex gap-3 flex-wrap">
              <div class="form-check">
                <input type="checkbox" id="useSlope" class="form-check-input">
                <label class="form-check-label small" for="useSlope">ìŠ¬ë¡œí”„ ë³´ì •</label>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label small">ì»·ì˜¤í”„ ëª¨ë“œ</label>
            <select id="cutoffMode" class="form-select">
              <option value="global" selected>ì „ì—­ ì»·ì˜¤í”„</option>
              <option value="percat">í´ëŸ½êµ°ë³„ ì»·ì˜¤í”„</option>
            </select>
          </div>

          <div class="col-12 col-md-6 col-lg-3" id="globalCutoffGroup">
            <label class="form-label small">ë…¸ì´ì¦ˆ ì»·ì˜¤í”„ (yd)</label>
            <input type="number" id="globalCutoff" class="form-control" value="300" min="100" max="600" step="10"/>
          </div>

          <div class="col-12 d-none" id="perCatWrap">
            <label class="form-label small">êµ°ë³„ ì»·ì˜¤í”„ (yd)</label>
            <div class="row g-2">
              <div class="col-4 col-sm-2">
                <label class="form-label small">Driver</label>
                <input type="number" id="cutD" class="form-control" value="330">
              </div>
              <div class="col-4 col-sm-2">
                <label class="form-label small">Wood</label>
                <input type="number" id="cutW" class="form-control" value="300">
              </div>
              <div class="col-4 col-sm-2">
                <label class="form-label small">Hybrid</label>
                <input type="number" id="cutH" class="form-control" value="280">
              </div>
              <div class="col-4 col-sm-2">
                <label class="form-label small">Iron</label>
                <input type="number" id="cutI" class="form-control" value="260">
              </div>
              <div class="col-4 col-sm-2">
                <label class="form-label small">Wedge</label>
                <input type="number" id="cutG" class="form-control" value="200">
              </div>
            </div>
          </div>
        </div>
        
        <div class="mt-3 text-end">
          <button id="applyFilters" class="btn btn-info">
            <i class="fas fa-filter"></i> í•„í„° ì ìš©
          </button>
        </div>
      </div>

      <!-- KPI ì„¹ì…˜ -->
      <h3 class="section-title" style="margin-top: 1rem;">ğŸ“Š ì£¼ìš” ì§€í‘œ</h3>
      <div class="kpi-section row g-3 mb-4">
        <div class="col-6 col-lg-3">
          <div class="kpi-card card text-center p-3">
            <div class="card-body p-0">
              <div class="kpi-label small mb-1">
                í‰ê·  ìŠ¤ì½”ì–´<span id="slopeBadge"></span><br>
                <span class="small">(18í™€ë§Œ ê³„ì‚°)</span>
              </div>
              <div id="avgScore" class="kpi-value fs-3 fw-bold">-</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="kpi-card card text-center p-3">
            <div class="card-body p-0">
              <div class="kpi-label small mb-1">í˜ì–´ì›¨ì´ ì•ˆì°©ë¥ </div>
              <div id="fairwayRate" class="kpi-value fs-3 fw-bold">-</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="kpi-card card text-center p-3">
            <div class="card-body p-0">
              <div class="kpi-label small mb-1">ê·¸ë¦° ì ì¤‘ë¥ </div>
              <div id="girRate" class="kpi-value fs-3 fw-bold">-</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="kpi-card card text-center p-3">
            <div class="card-body p-0">
              <div class="kpi-label small mb-1">í‰ê·  í¼íŒ…</div>
              <div id="avgPutts" class="kpi-value fs-3 fw-bold">-</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì„±ê³¼ íŠ¸ë Œë“œ ì„¹ì…˜ -->
      <div class="section-divider">
        <h3 class="section-title">ğŸ“ˆ ì„±ê³¼ íŠ¸ë Œë“œ ë¶„ì„</h3>
        <div class="row g-3 mb-4">
          <div class="col-12 col-lg-6">
            <div class="chart-container card p-3">
              <h6 class="card-title">ìŠ¤ì½”ì–´ íŠ¸ë Œë“œ (18H â‰¤ 70 ì œì™¸)</h6>
              <canvas id="scoreTrendChart"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="chart-container card p-3">
              <h6 class="card-title">ë¼ìš´ë“œë‹¹ í‰ê·  í¼íŒ… íŠ¸ë Œë“œ</h6>
              <canvas id="puttTrendChart"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="chart-container card p-3">
              <h6 class="card-title">ë¼ìš´ë“œë‹¹ í‰ê·  ì›¨ì§€ ì‚¬ìš©íšŒìˆ˜</h6>
              <canvas id="wedgeTrendChart"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="chart-container card p-3">
              <h6 class="card-title">ì½”ìŠ¤ ê²½í—˜ ë¹„êµ: ì²« ë°©ë¬¸ vs ì´í›„ í‰ê· </h6>
              <canvas id="courseFirstVsLaterChart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="row g-3 mb-4">
          <div class="col-12">
            <div class="chart-container card p-3">
              <h6 class="card-title">ë°©ë¬¸ íšŸìˆ˜ë³„ í‰ê·  ìŠ¤ì½”ì–´</h6>
              <canvas id="visitCountTrendChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- ê¸°ìˆ  ë¶„ì„ ì„¹ì…˜ -->
      <div class="section-divider">
        <h3 class="section-title">â›³ ê¸°ìˆ  ë¶„ì„</h3>
        <div class="row g-3 mb-4">
          <div class="col-12 col-lg-6">
            <div class="chart-container card p-3">
              <h6 class="card-title">í™€ íƒ€ì…ë³„ ì„±ì </h6>
              <canvas id="parTypeRatesChart"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="chart-container card p-3">
              <h6 class="card-title">ë“œë¼ì´ë¹™ ë¶„ì„</h6>
              <canvas id="drivingDoughnutChart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="row g-3 mb-4">
          <div class="col-12">
            <div class="chart-container card p-3">
              <h6 class="card-title">í´ëŸ½ë³„ ë¹„ê±°ë¦¬ (í‰ê·  & ìµœëŒ€)</h6>
              <canvas id="clubDistanceChart"></canvas>
              <div id="clubAvgTableContainer" class="mt-3"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ìƒì„¸ ê¸°ë¡ ì„¹ì…˜ -->
      <div class="section-divider">
        <h3 class="section-title">ğŸ“‹ ìƒì„¸ ë¼ìš´ë“œ ê¸°ë¡</h3>
        <div class="card p-3">
          <div class="row g-3">
            <div class="col-12 col-lg-8">
              <select id="roundSelect" class="form-select">
                <option value="">ë¼ìš´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
              </select>
            </div>
            <div class="col-12 col-lg-4">
              <div class="d-flex gap-3 justify-content-lg-end">
                <div class="form-check">
                  <input type="radio" name="detailMode" id="viewSingle" value="single" checked class="form-check-input">
                  <label class="form-check-label small" for="viewSingle">ì„ íƒ ë¼ìš´ë“œë§Œ</label>
                </div>
                <div class="form-check">
                  <input type="radio" name="detailMode" id="viewCourseAgg" value="course" class="form-check-input">
                  <label class="form-check-label small" for="viewCourseAgg">ê°™ì€ ì½”ìŠ¤ ì „ì²´</label>
                </div>
              </div>
            </div>
          </div>
          <div id="selectedRoundMemo" class="text-muted mt-3"></div>
          <ul id="selectedRoundSummary" class="mt-2"></ul>
          <div id="roundTableContainer" class="mt-3 table-responsive">
            <p class="text-muted text-center py-4">ë¼ìš´ë“œë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ í…Œì´ë¸”ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    /* =====================
       PWA & ìºì‹œ ê´€ë¦¬
    ===================== */
    const CACHE_KEY = 'golf_dashboard_cache_v3';
    const CACHE_EXPIRY_DAYS = 30;

    // PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('pwaInstall').style.display = 'block';
    });

    document.getElementById('pwaInstall').addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const result = await deferredPrompt.userChoice;
        deferredPrompt = null;
        document.getElementById('pwaInstall').style.display = 'none';
      }
    });

    // ìºì‹œ ì•Œë¦¼ í‘œì‹œ
    function showCacheNotification(message, duration = 3000) {
      const notification = document.getElementById('cacheNotification');
      const messageSpan = document.getElementById('cacheMessage');
      messageSpan.textContent = message;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }

    function saveFilesToCache(roundsData, holesData, shotsData) {
      try {
        const cacheData = {
          timestamp: Date.now(),
          rounds: roundsData,
          holes: holesData,
          shots: shotsData,
          filesInfo: {
            roundsCount: roundsData?.length || 0,
            holesCount: holesData?.length || 0,
            shotsCount: shotsData?.length || 0
          }
        };
        
        // ëª¨ë°”ì¼ì—ì„œ localStorage ìš©ëŸ‰ ì²´í¬
        const dataStr = JSON.stringify(cacheData);
        const dataSize = new Blob([dataStr]).size;
        
        if (dataSize > 5 * 1024 * 1024) { // 5MB ì œí•œ
          throw new Error('ë°ì´í„° í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤');
        }
        
        localStorage.setItem(CACHE_KEY, dataStr);
        console.log(`âœ… íŒŒì¼ ë°ì´í„°ê°€ ìºì‹œì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (${(dataSize/1024).toFixed(1)}KB)`);
        showCacheNotification('ğŸ“± ë°ì´í„°ê°€ ê¸°ê¸°ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        return true;
      } catch (e) {
        console.error('âŒ ìºì‹œ ì €ì¥ ì‹¤íŒ¨:', e);
        showCacheNotification('âš ï¸ ì €ì¥ ì‹¤íŒ¨: ìš©ëŸ‰ ë¶€ì¡±ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤');
        return false;
      }
    }

    function loadFilesFromCache() {
      try {
        const cached = localStorage.getItem(CACHE_KEY);
        if (!cached) return null;
        
        const data = JSON.parse(cached);
        const ageInDays = (Date.now() - data.timestamp) / (1000 * 60 * 60 * 24);
        
        if (ageInDays > CACHE_EXPIRY_DAYS) {
          localStorage.removeItem(CACHE_KEY);
          console.log('â° ìºì‹œ ë§Œë£Œë¡œ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.');
          return null;
        }
        
        console.log(`ğŸ“‚ ìºì‹œì—ì„œ ë°ì´í„° ë¡œë“œ (${ageInDays.toFixed(1)}ì¼ ì „ ì €ì¥)`);
        return data;
      } catch (e) {
        console.error('âŒ ìºì‹œ ë¡œë“œ ì‹¤íŒ¨:', e);
        return null;
      }
    }

    function clearCache() {
      localStorage.removeItem(CACHE_KEY);
      console.log('ğŸ—‘ï¸ ìºì‹œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      showCacheNotification('ğŸ—‘ï¸ ì €ì¥ëœ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      hideCacheStatus();
    }

    function showCacheStatus(cacheData) {
      const lastDate = new Date(cacheData.timestamp).toLocaleString('ko-KR');
      const info = cacheData.filesInfo;
      const size = `ë¼ìš´ë“œ: ${info.roundsCount}ê°œ, í™€: ${info.holesCount}ê°œ, ìƒ·: ${info.shotsCount}ê°œ`;
      
      document.getElementById('lastUploadDate').textContent = lastDate;
      document.getElementById('cacheSize').textContent = size;
      document.getElementById('cacheStatus').classList.remove('d-none');
      document.getElementById('uploadArea').style.display = 'none';
      
      showCacheNotification('ğŸ“± ì €ì¥ëœ ë°ì´í„°ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!');
    }

    function hideCacheStatus() {
      document.getElementById('cacheStatus').classList.add('d-none');
      document.getElementById('uploadArea').style.display = 'block';
    }

    function useCachedData() {
      const cached = loadFilesFromCache();
      if (!cached) {
        alert('ìºì‹œëœ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      roundsData = cached.rounds;
      holesData = cached.holes;
      shotsData = cached.shots;
      
      console.log('ğŸ’¾ ìºì‹œëœ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
      showCacheNotification('ğŸš€ ì €ì¥ëœ ë°ì´í„°ë¡œ ë¹ ë¥´ê²Œ ì‹œì‘í•©ë‹ˆë‹¤!');
      startAnalysis();
    }

    /* =====================
       ì „ì—­ ìƒíƒœ & ìœ í‹¸
    ===================== */
    let roundsData=null, holesData=null, shotsData=null;
    let golfData=[];
    let charts={};
    let firstFilterApplied = false;

    const n = (v)=> (typeof v==='number' && !isNaN(v)) ? v : (v? parseFloat(v): 0) || 0;
    const normalize = (s)=> (s??'').toString().trim().toLowerCase();
    const toBool = (v)=>{
      if (typeof v==='boolean') return v;
      if (typeof v==='number') return v!==0;
      const s=(v??'').toString().trim().toLowerCase();
      return ['y','yes','true','t','1','o','ok','gir','fw','hit'].includes(s);
    };
    const isPutter = (club)=> (club??'').toString().toLowerCase().includes('put');
    const parseDateSafe = (d)=>{ const dt=new Date(d); return isNaN(dt.getTime())? null: dt; };
    const fmtYM = (d)=> `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const fmtQ = (d)=> `${d.getFullYear()}-Q${Math.floor(d.getMonth()/3)+1}`;
    const rk = (r)=> `${normalize(r.date)}__${normalize(r.courseName)}`;
    const rkRaw = (date, course)=> `${normalize(date)}__${normalize(course)}`;

    function updateStatusAll(message, css='') { 
      const el=document.getElementById('allStatus'); 
      el.textContent=message; 
      el.className=`mt-3 ${css ? 'text-'+css : 'text-muted'}`; 
    }

    /* =====================
       ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    ===================== */
    document.addEventListener('DOMContentLoaded', function() {
      // ìºì‹œ í™•ì¸
      const cached = loadFilesFromCache();
      if (cached) {
        showCacheStatus(cached);
      }
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
      document.getElementById('allFiles').addEventListener('change', handleAllFilesUpload);
      document.getElementById('analyzeBtn').addEventListener('click', startAnalysis);
      document.getElementById('backBtn').addEventListener('click', resetApp);
      document.getElementById('useCacheBtn').addEventListener('click', useCachedData);
      document.getElementById('uploadNewBtn').addEventListener('click', hideCacheStatus);
      document.getElementById('clearCacheBtn').addEventListener('click', clearCache);
      document.getElementById('applyFilters').addEventListener('click', ()=>{ firstFilterApplied = true; applyFiltersAndRender(); });
      document.getElementById('roundSelect').addEventListener('change', onRoundSelectChange);
      document.getElementById('viewSingle').addEventListener('change', renderRoundDetails);
      document.getElementById('viewCourseAgg').addEventListener('change', renderRoundDetails);
      document.getElementById('cutoffMode').addEventListener('change', onCutoffModeChange);
    });

    function onCutoffModeChange(){
      const mode=document.getElementById('cutoffMode').value;
      document.getElementById('globalCutoffGroup').style.display = (mode==='global')? 'block':'none';
      document.getElementById('perCatWrap').classList.toggle('d-none', mode !== 'percat');
    }

    /* =====================
       CSV íŒŒì„œ (ì¼ê´„ ì—…ë¡œë“œ)
    ===================== */
    async function handleAllFilesUpload(event){
      const files = Array.from(event.target.files||[]);
      if (!files.length){ updateStatusAll('ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }

      // ë¡œë”© ìƒíƒœ í‘œì‹œ
      const btn = document.querySelector('.file-label');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì²˜ë¦¬ì¤‘...';
      btn.style.pointerEvents = 'none';

      roundsData = null; holesData = null; shotsData = null;
      const logs = [];

      for (const file of files){
        try{
          const parsed = await parseCSVSmart(file);
          const kind = identifyCSVKind(file, parsed);
          if (kind==='rounds') roundsData = parsed.data;
          else if (kind==='holes') holesData = parsed.data;
          else if (kind==='shots') shotsData = parsed.data;
          logs.push(`${file.name} â†’ ${kind} (${parsed.data.length}í–‰)`);
        }catch(e){
          console.error(e);
          logs.push(`${file.name} â†’ íŒŒì‹± ì‹¤íŒ¨`);
        }
      }

      const missing=[];
      if (!roundsData) missing.push('ë¼ìš´ë“œ');
      if (!holesData)  missing.push('í™€ë³„');
      if (!shotsData)  missing.push('ìƒ·');

      const ok = missing.length===0;
      const statusClass = ok ? 'success' : 'warning';
      updateStatusAll(
        (ok? 'âœ… 3ê°œ ì„¸íŠ¸ ë¡œë“œ ì™„ë£Œ\n' : 'âš ï¸ ë¡œë“œ ê²°ê³¼ (ëˆ„ë½ ìˆìŒ)\n') + 
        logs.join('\n') + 
        (ok? '' : `\nëˆ„ë½: ${missing.join(', ')}`), 
        statusClass
      );
      
      document.getElementById('analyzeBtn').disabled = !ok;
      
      // ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ë©´ ìºì‹œì— ì €ì¥
      if (ok) {
        saveFilesToCache(roundsData, holesData, shotsData);
      }

      // ë¡œë”© ìƒíƒœ í•´ì œ
      btn.innerHTML = originalText;
      btn.style.pointerEvents = 'auto';
    }

    async function parseCSVSmart(file){
      let text = await readAsText(file); let out=tryParseAll(text); if (isGood(out)) return out;
      out=tryParseAll(preprocessCSVText(text)); if (isGood(out)) return out;
      const textKR = await readAsText(file,'euc-kr');
      out=tryParseAll(textKR); if (isGood(out)) return out;
      out=tryParseAll(preprocessCSVText(textKR)); return out;
    }
    function isGood(parsed){ return parsed && (parsed.data||[]).length>0; }
    function tryParseAll(text){
      const base={header:true,dynamicTyping:true,skipEmptyLines:'greedy',transformHeader:h=>h.trim()};
      let p=Papa.parse(text,{...base,delimitersToGuess:[',',';','\t','|']}); if (isGood(p)) return p;
      const d=detectDelimiterFromHeader(text); if (d){ p=Papa.parse(text,{...base,delimiter:d}); if (isGood(p)) return p; }
      for (const c of [',',';','\t','|']){ p=Papa.parse(text,{...base,delimiter:c}); if (isGood(p)) return p; }
      return p;
    }
    function preprocessCSVText(t){ if(!t)return t; t=t.replace(/^\uFEFF/,'').replace(/\r\n?/g,'\n'); const lines=t.split('\n');
      const idx=lines.findIndex(line=> line.toLowerCase().includes('date') && line.toLowerCase().includes('course') && line.toLowerCase().includes('name'));
      return idx>0? lines.slice(idx).join('\n') : t;
    }
    function detectDelimiterFromHeader(text){
      const first=(text.split(/\r?\n/).find(l=>l.trim().length>0)||'');
      const cnt=(s,re)=>(s.match(re)||[]).length;
      const counts={',':cnt(first,/,/g), ';':cnt(first,/;/g), '\t':cnt(first,/\t/g), '|':cnt(first,/\|/g)};
      const best=Object.entries(counts).sort((a,b)=>b[1]-a[1])[0]; return (best && best[1]>0)? best[0]:null;
    }
    function readAsText(file,enc){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; enc? fr.readAsText(file,enc): fr.readAsText(file); }); }

    function identifyCSVKind(file, parsed){
      const fields = (parsed.meta?.fields||[]).map(f=>normalize(f));
      const name = (file?.name||'').toLowerCase();
      const has = (key)=> fields.includes(key);
      const any = (...keys)=> keys.some(k=> fields.includes(k));

      const looksLikeShots = any('shot number','club','shot length yards','lie');
      const hasHoleNo = has('hole number');
      const looksLikeHoles = hasHoleNo && any('total strokes','putts','fairway','gir','girs','gir?');
      const looksLikeRounds = any('gross score','slope','slope rating','course rating','cr');

      if (looksLikeShots) return 'shots';
      if (looksLikeHoles) return 'holes';
      if (looksLikeRounds && !hasHoleNo) return 'rounds';

      if (name.includes('round')) return 'rounds';
      if (name.includes('hole'))  return 'holes';
      if (name.includes('shot'))  return 'shots';
      return 'rounds';
    }

    /* =====================
       ë¶„ì„ ì‹œì‘: CSVâ†’golfData
    ===================== */
    function startAnalysis(){
      // ë¡œë”© í‘œì‹œ
      document.body.classList.add('loading');
      
      setTimeout(() => {
        buildGolfData();
        initFiltersFromData();
        document.getElementById('uploadSection').style.display='none';
        document.getElementById('dashboardSection').classList.remove('d-none');
        applyFiltersAndRender();
        
        // ë¡œë”© í•´ì œ
        document.body.classList.remove('loading');
        showCacheNotification('ğŸ“Š ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
      }, 100);
    }

    function resetApp(){
      Object.values(charts).forEach(c=>{try{c.destroy()}catch(e){}});
      charts={}; golfData=[]; firstFilterApplied=false;
      document.getElementById('dashboardSection').classList.add('d-none');
      document.getElementById('uploadSection').style.display='flex';
      document.getElementById('analyzeBtn').disabled=true;
      document.getElementById('allFiles').value='';
      updateStatusAll('');
      
      // ìºì‹œ ìƒíƒœ ë‹¤ì‹œ í™•ì¸
      const cached = loadFilesFromCache();
      if (cached) {
        showCacheStatus(cached);
      } else {
        hideCacheStatus();
      }
    }

    function pickNum(obj, keys){
      for (const k of keys){ if (obj[k]!=null && !isNaN(parseFloat(obj[k]))) return parseFloat(obj[k]); }
      return null;
    }

    function buildGolfData(){
      golfData=[];
      const keyToRound = new Map();
      const key = (o)=> rkRaw(o['date'], o['course name']);

      (roundsData||[]).forEach(r=>{
        const k=key(r);
        if (!keyToRound.has(k)) keyToRound.set(k,{courseName:r['course name'], date:r['date'], totalScore:null, slope:null, cr:null, memo:[], holes:[]});
        const obj=keyToRound.get(k);
        if (n(r['gross score'])>0) obj.totalScore = n(r['gross score']);
        const memo = r['memo']?? r['notes']?? r['note']?? r['comment']?? r['comments'];
        if (memo){ obj.memo.push(String(memo)); }
        obj.slope = pickNum(r, ['slope','slope rating','slope_rating','Slope','Slope Rating']);
        obj.cr    = pickNum(r, ['course rating','course_rating','CR','Course Rating']);
      });

      (holesData||[]).forEach(h=>{
        if (!h['date'] || !h['course name']) return;
        const k=key(h);
        if (!keyToRound.has(k)) keyToRound.set(k,{courseName:h['course name'], date:h['date'], totalScore:null, slope:null, cr:null, memo:[], holes:[]});
        const memo = h['memo']?? h['notes']?? h['note']?? h['comment']?? h['comments'];
        keyToRound.get(k).holes.push({
          hole:n(h['hole number']), par:n(h['hole par']), score:n(h['total strokes']),
          putts:n(h['putts']), fairway:(h['fairway']??'').toString(),
          gir: toBool(h['GIR'] ?? h['gir'] ?? h['GIRs'] ?? h['GIR?']),
          approachDist:null, approachClub:null,
          memo: memo? String(memo): null
        });
        if (memo){ keyToRound.get(k).memo.push(`Hole ${n(h['hole number'])}: ${String(memo)}`); }
      });

      const shotsIndex = new Map();
      (shotsData||[]).forEach(s=>{
        if (!s['date'] || !s['course name']) return;
        const k=`${rkRaw(s['date'], s['course name'])}__${n(s['hole number'])}`;
        if (!shotsIndex.has(k)) shotsIndex.set(k,[]);
        shotsIndex.get(k).push(s);
      });
      shotsIndex.forEach(a=> a.sort((a,b)=> n(a['shot number']) - n(b['shot number'])));

      keyToRound.forEach(r=>{
        r.holes.forEach(h=>{
          const hk=`${rkRaw(r.date, r.courseName)}__${h.hole}`;
          const shots = shotsIndex.get(hk)||[];
          const ap = determineApproach(shots, h.par);
          if (ap){ h.approachClub = ap.club; h.approachDist = ap.dist>0? ap.dist: null; }
        });
      });

      keyToRound.forEach(r=>{
        if (r.totalScore==null && r.holes.length){ r.totalScore = r.holes.reduce((s,h)=> s + (n(h.score)||0), 0); }
      });

      const byCourse = {};
      keyToRound.forEach(r=>{
        const d=parseDateSafe(r.date);
        // ì •ê·œí™”ëœ ì½”ìŠ¤ ì´ë¦„ì„ í‚¤ë¡œ ì‚¬ìš©
        const normalizedName = normalizeCourse(r.courseName);
        if (!byCourse[normalizedName]) byCourse[normalizedName]=[];
        byCourse[normalizedName].push({r, t: d? d.getTime(): Number.MAX_SAFE_INTEGER});
      });
      Object.values(byCourse).forEach(list=> list.sort((a,b)=> a.t-b.t));
      Object.values(byCourse).forEach(list=>{ let cnt=0; list.forEach(w=>{ w.r.visitCount=(++cnt); }); });

      keyToRound.forEach(r=>{
        golfData.push({
          courseName:r.courseName,
          date:r.date,
          visitCount:r.visitCount||1,
          totalScore:r.totalScore||0,
          slope:r.slope, cr:r.cr,
          memo: r.memo,
          holes:r.holes
        });
      });
      golfData.sort((a,b)=> (parseDateSafe(a.date)-parseDateSafe(b.date)));
    }

    function determineApproach(shots, par){
      if (!shots || !shots.length) return null;
      const firstPuttIdx = shots.findIndex(s=> isPutter(s['club']));
      const cutoffIdx = (firstPuttIdx>=0? firstPuttIdx: shots.length);
      let cand = shots.filter((s,i)=> !isPutter(s['club']) && i < cutoffIdx);
      if (par>=4){
        cand = cand.filter((s,i)=> {
          const lie=(s['lie']||'').toString().toLowerCase();
          const sn = n(s['shot number']);
          return !(lie==='tee' || sn===1);
        });
      }
      if (!cand.length) return null;
      let preferred = [...cand].reverse().find(s=> { const d=n(s['shot length yards']); return d>=30 && d<=200; });
      if (!preferred) preferred = cand[cand.length-1];
      return {dist:n(preferred['shot length yards']), club:(preferred['club']||'').toString()};
    }

    // ì½”ìŠ¤ëª… ì •ê·œí™” í•¨ìˆ˜
    function normalizeCourse(name) {
      const cleaned = name.trim()
        .replace(/\s+/g, ' ')  // ì—°ì†ëœ ê³µë°±ì„ í•˜ë‚˜ë¡œ
        .replace(/\s?GC$/i, '') // ëì˜ GC ì œê±° (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì•ˆí•¨)
        .replace(/\s?Golf\s+Club$/i, '') // Golf Club ì œê±°
        .replace(/\s?Golf\s+Course$/i, '') // Golf Course ì œê±°
        .replace(/\s?Golf\s+Cource$/i, '') // Golf Cource (ì˜¤íƒ€) ì œê±°
        .replace(/\s?Country\s+Club$/i, '') // Country Club ì œê±°
        .replace(/\s?\(.*?\)/g, '') // ê´„í˜¸ì™€ ë‚´ìš© ì œê±° (ì˜ˆ: (Bluff), (Peaks))
        .trim();
      
      // ì¼ë°˜ì ì¸ ì¶•ì•½ì–´ ì •ê·œí™”
      return cleaned
        .replace(/Metro\s+Park$/i, 'MetroPark')
        .replace(/Metropolitan\s+Park$/i, 'MetroPark')
        .toLowerCase();
    }

    // ì½”ìŠ¤ë³„ ë¼ìš´ë“œ ê·¸ë£¹í™”
    function groupCoursesByName(golfData) {
      const courseGroups = new Map();
      
      golfData.forEach(round => {
        const normalized = normalizeCourse(round.courseName);
        if (!courseGroups.has(normalized)) {
          courseGroups.set(normalized, {
            displayName: round.courseName, // ì²« ë²ˆì§¸ë¡œ ë‚˜íƒ€ë‚˜ëŠ” ì´ë¦„ì„ ëŒ€í‘œë¡œ ì‚¬ìš©
            rounds: []
          });
        }
        courseGroups.get(normalized).rounds.push(round);
      });
      
      return courseGroups;
    }

    function initFiltersFromData(){
      // ì •ê·œí™”ëœ ì½”ìŠ¤ ê·¸ë£¹ ìƒì„±
      const courseGroups = groupCoursesByName(golfData);
      
      // ê·¸ë£¹ë³„ë¡œ ëŒ€í‘œ ì´ë¦„ê³¼ ë¼ìš´ë“œ ìˆ˜ í‘œì‹œ
      const courseOptions = Array.from(courseGroups.entries())
        .map(([normalized, group]) => ({
          value: normalized,
          displayName: group.displayName,
          roundCount: group.rounds.length
        }))
        .sort((a, b) => a.displayName.localeCompare(b.displayName));
      
      const courseSel = document.getElementById('courseSelect');
      courseSel.innerHTML = `<option value="__ALL__">ì „ì²´</option>` + 
        courseOptions.map(c => 
          `<option value="${c.value}">${c.displayName} (${c.roundCount}ë¼ìš´ë“œ)</option>`
        ).join('');

      const dates = golfData.map(g=>parseDateSafe(g.date)).filter(Boolean);
      if (dates.length){
        const minD = new Date(Math.min(...dates)), maxD = new Date(Math.max(...dates));
        document.getElementById('startMonth').value = fmtYM(minD);
        document.getElementById('endMonth').value   = fmtYM(maxD);
      }
    }

    function currentFilter(){
      const course = document.getElementById('courseSelect').value;
      const period = document.getElementById('periodMode').value;
      const startM = document.getElementById('startMonth').value;
      const endM   = document.getElementById('endMonth').value;
      const pars = Array.from(document.querySelectorAll('.parCheck:checked')).map(c=>parseInt(c.value,10));
      const rlen = document.getElementById('roundLength').value;
      const useSlope = document.getElementById('useSlope').checked;

      const cutoffMode = document.getElementById('cutoffMode').value;
      const cut = {
        mode: cutoffMode,
        global: parseInt(document.getElementById('globalCutoff').value||'300',10),
        D: parseInt(document.getElementById('cutD').value||'330',10),
        W: parseInt(document.getElementById('cutW').value||'300',10),
        H: parseInt(document.getElementById('cutH').value||'280',10),
        I: parseInt(document.getElementById('cutI').value||'260',10),
        G: parseInt(document.getElementById('cutG').value||'200',10),
      };
      return {course, period, startM, endM, pars, rlen, useSlope, cut};
    }

    function getRoundHolesType(r){ const len = r.holes.length||0; return (len<=9)? 9:18; }

    function getCatByClub(club){
      const s=(club||'').toString().toUpperCase().replace(/\s+/g,'');
      if (!s || isPutter(s)) return null;
      if (['D','DR','DRIVER'].includes(s)) return 'driver';
      if (['3W','4W','5W','7W','9W'].includes(s)) return 'wood';
      if (/^\d+H$/.test(s)) return 'hybrid';
      if (/^\d+I$/.test(s)) return 'iron';
      if (['PW','GW','SW','LW'].includes(s)) return 'wedge';
      if (/^(48|50|52|54|56|58|60|62|64)$/.test(s)) return 'wedge';
      return null;
    }

    function cutoffForClub(club, cut){
      if (cut.mode==='global') return cut.global;
      const cat=getCatByClub(club);
      if (cat==='driver') return cut.D;
      if (cat==='wood')   return cut.W;
      if (cat==='hybrid') return cut.H;
      if (cat==='iron')   return cut.I;
      if (cat==='wedge')  return cut.G;
      return cut.global;
    }

    function adjustedScore(r, useSlope){
      if (!useSlope) return n(r.totalScore);
      const slope = r.slope, cr = r.cr;
      if (!slope || !cr) return n(r.totalScore);
      return cr + (n(r.totalScore)-cr) * 113 / slope;
    }

    function applyFiltersAndRender(){
      const {course, period, startM, endM, pars, rlen, useSlope, cut} = currentFilter();
      document.getElementById('slopeBadge').textContent = useSlope? ' (Slope ë³´ì •)': '';

      const startDate = startM? new Date(startM+'-01'): null;
      const endDate   = endM? new Date(endM+'-01'): null;
      if (endDate){ endDate.setMonth(endDate.getMonth()+1); endDate.setDate(0); }

      let rounds = golfData.filter(g=>{
        // ì½”ìŠ¤ í•„í„°ë§: ì •ê·œí™”ëœ ì´ë¦„ìœ¼ë¡œ ë¹„êµ
        if (course !== '__ALL__') {
          const normalized = normalizeCourse(g.courseName);
          if (normalized !== course) return false;
        }
        
        const d=parseDateSafe(g.date); if (!d) return false;
        if (startDate && d<startDate) return false;
        if (endDate && d>endDate) return false;
        if (rlen==='9'  && getRoundHolesType(g)!==9)  return false;
        if (rlen==='18' && getRoundHolesType(g)!==18) return false;
        return true;
      });

      let holes=[]; rounds.forEach(g=>{ holes.push(...g.holes.filter(h=> pars.includes(h.par))); });

      renderKPIs(rounds, holes, useSlope);
      renderScoreTrend(rounds, period, useSlope);
      renderPuttTrend(rounds, period);
      renderWedgeTrend(rounds, cut);
      renderCourseFirstVsLater(rounds, (course!=='__ALL__')? course: null, useSlope);
      renderVisitCountTrend(rounds, (course!=='__ALL__')? course: null, useSlope);
      renderParTypeRates(holes);
      renderDrivingDoughnut(holes);
      renderClubDistance(rounds, cut);

      populateRoundSelect(rounds);
      document.getElementById('selectedRoundMemo').textContent = '';
      document.getElementById('selectedRoundSummary').innerHTML = '';
      document.getElementById('roundTableContainer').innerHTML = '<p class="text-muted">ë¼ìš´ë“œë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ í…Œì´ë¸”ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>';
    }

    /* =====================
       KPI (í‰ê·  ìŠ¤ì½”ì–´ëŠ” 18í™€ë§Œ)
    ===================== */
    function renderKPIs(rounds, holes, useSlope){
      const rounds18 = rounds.filter(r=> getRoundHolesType(r)===18);
      const avgScore = rounds18.length? (rounds18.reduce((s,r)=>s+adjustedScore(r,useSlope),0)/rounds18.length):null;
      document.getElementById('avgScore').textContent = (avgScore!=null)? avgScore.toFixed(1): '-';

      const roundPutts = rounds.map(r=> r.holes.reduce((s,h)=>s+n(h.putts),0));
      const avgPutts = roundPutts.length? (roundPutts.reduce((a,b)=>a+b,0)/roundPutts.length):0;
      document.getElementById('avgPutts').textContent = roundPutts.length? avgPutts.toFixed(1): '-';

      const fwHoles = holes.filter(h=> h.par!==3 && h.fairway!=null);
      const fwHit = fwHoles.filter(h=> normalize(h.fairway)==='hit').length;
      document.getElementById('fairwayRate').textContent = fwHoles.length? (fwHit/fwHoles.length*100).toFixed(1)+'%':'-';

      const girHit = holes.filter(h=> h.gir===true).length;
      document.getElementById('girRate').textContent = holes.length? (girHit/holes.length*100).toFixed(1)+'%':'-';
    }

    /* =====================
       ê·¸ë£¹í•‘ & ê³µí†µ ì°¨íŠ¸
    ===================== */
    function groupRounds(rounds, mode, useSlope){
      const isOutlier = (r)=> (getRoundHolesType(r)===18 && adjustedScore(r,useSlope) <= 70);

      if (mode==='round'){
        const labels = []; const scoreAvg=[]; const puttAvg=[];
        rounds.forEach(r=>{
          if (isOutlier(r)) return;
          labels.push(`${r.date}`);
          scoreAvg.push(adjustedScore(r,useSlope));
          puttAvg.push(r.holes.reduce((s,h)=>s+n(h.putts),0));
        });
        return {labels, scoreAvg, puttAvg};
      }
      const map = new Map();
      rounds.forEach(r=>{
        if (isOutlier(r)) return;
        const d=parseDateSafe(r.date); if(!d) return;
        const key = (mode==='month')? fmtYM(d): fmtQ(d);
        if (!map.has(key)) map.set(key,{scores:[], putts:[]});
        map.get(key).scores.push(adjustedScore(r,useSlope));
        map.get(key).putts.push(r.holes.reduce((s,h)=>s+n(h.putts),0));
      });
      const labels = Array.from(map.keys()).sort();
      const scoreAvg = labels.map(k=> { const arr=map.get(k).scores; return arr.reduce((a,b)=>a+b,0)/arr.length; });
      const puttAvg = labels.map(k=> { const arr=map.get(k).putts; return arr.reduce((a,b)=>a+b,0)/arr.length; });
      return {labels, scoreAvg, puttAvg};
    }

    const chartDefaults = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: {
            color: '#f0f6fc',
            font: { size: 12 }
          }
        }
      },
      scales: {
        x: {
          ticks: { color: '#9aa0a6', font: { size: 11 } },
          grid: { color: 'rgba(255,255,255,.08)' }
        },
        y: {
          ticks: { color: '#9aa0a6', font: { size: 11 } },
          grid: { color: 'rgba(255,255,255,.08)' }
        }
      }
    };

    function renderScoreTrend(rounds, period, useSlope){
      const ctx = document.getElementById('scoreTrendChart').getContext('2d');
      const g = groupRounds(rounds, period, useSlope);
      if (charts.scoreTrend) charts.scoreTrend.destroy();
      charts.scoreTrend = new Chart(ctx,{
        type:'line',
        data:{
          labels:g.labels, 
          datasets:[{
            label:'ìŠ¤ì½”ì–´', 
            data:g.scoreAvg, 
            borderColor:'#238636', 
            backgroundColor:'rgba(35,134,54,.12)', 
            tension:.35, 
            pointRadius:3,
            fill: true
          }]
        },
        options: chartDefaults
      });
    }

    function renderPuttTrend(rounds, period){
      const ctx = document.getElementById('puttTrendChart').getContext('2d');
      const g = groupRounds(rounds, period, false);
      if (charts.puttTrend) charts.puttTrend.destroy();
      charts.puttTrend = new Chart(ctx,{
        type:'line',
        data:{
          labels:g.labels, 
          datasets:[{
            label:'ë¼ìš´ë“œ í‰ê·  í¼íŒ…', 
            data:g.puttAvg, 
            borderColor:'#da8b26', 
            backgroundColor:'rgba(218,139,38,.12)', 
            tension:.35, 
            pointRadius:3,
            fill: true
          }]
        },
        options: chartDefaults
      });
    }

    // ì›¨ì§€ ì‚¬ìš©íšŒìˆ˜ë¡œ ë³€ê²½
    function renderWedgeTrend(rounds, cut){
      const ctx = document.getElementById('wedgeTrendChart').getContext('2d');
      const labels = []; const values = [];
      rounds.forEach(r=>{
        const wedgeCount = r.holes
          .filter(h=> h.approachClub && getCatByClub(h.approachClub)==='wedge')
          .length;
        labels.push(r.date);
        values.push(wedgeCount);
      });
      if (charts.wedgeTrend) charts.wedgeTrend.destroy();
      charts.wedgeTrend = new Chart(ctx,{
        type:'line',
        data:{
          labels, 
          datasets:[{
            label:'ì›¨ì§€ ì‚¬ìš©íšŒìˆ˜', 
            data:values, 
            borderColor:'#1f6feb', 
            backgroundColor:'rgba(31,111,235,.12)', 
            tension:.35, 
            pointRadius:3,
            fill: true
          }]
        },
        options: chartDefaults
      });
    }

    function renderCourseFirstVsLater(rounds, course, useSlope){
      const ctx = document.getElementById('courseFirstVsLaterChart').getContext('2d');
      let list = course? rounds.filter(r=> normalizeCourse(r.courseName) === course): rounds;
      const first = list.filter(r=> r.visitCount===1).map(r=>adjustedScore(r,useSlope));
      const later = list.filter(r=> r.visitCount>=2).map(r=>adjustedScore(r,useSlope));
      const firstAvg = first.length? first.reduce((a,b)=>a+b,0)/first.length : 0;
      const laterAvg = later.length? later.reduce((a,b)=>a+b,0)/later.length : 0;

      if (charts.firstLater) charts.firstLater.destroy();
      charts.firstLater = new Chart(ctx,{
        type:'bar',
        data:{
          labels:['ì²« ë°©ë¬¸','ì´í›„ í‰ê· '],
          datasets:[{
            label:'í‰ê·  ìŠ¤ì½”ì–´', 
            data:[firstAvg, laterAvg], 
            backgroundColor:['rgba(31,111,235,.7)','rgba(35,134,54,.7)'], 
            borderColor:'#30363d', 
            borderWidth:1
          }]
        },
        options: chartDefaults
      });
    }

    function renderVisitCountTrend(rounds, course, useSlope){
      const ctx = document.getElementById('visitCountTrendChart').getContext('2d');
      let list = course? rounds.filter(r=> normalizeCourse(r.courseName) === course): rounds;
      const map=new Map();
      list.forEach(r=>{ if (!map.has(r.visitCount)) map.set(r.visitCount,[]); map.get(r.visitCount).push(adjustedScore(r,useSlope)); });
      const visits = Array.from(map.keys()).sort((a,b)=>a-b);
      const avg = visits.map(v=> { const arr=map.get(v); return arr.reduce((a,b)=>a+b,0)/arr.length; });

      if (charts.visitTrend) charts.visitTrend.destroy();
      charts.visitTrend = new Chart(ctx,{
        type:'line',
        data:{
          labels:visits.map(String), 
          datasets:[{
            label:'í‰ê·  ìŠ¤ì½”ì–´', 
            data:avg, 
            borderColor:'#1f6feb', 
            backgroundColor:'rgba(31,111,235,.12)', 
            tension:.35, 
            pointRadius:3,
            fill: true
          }]
        },
        options: chartDefaults
      });
    }

    // í™€íƒ€ì…ë³„ ì„±ì  ìƒ‰ìƒ ê°œì„ 
    function renderParTypeRates(holes){
      const ctx = document.getElementById('parTypeRatesChart').getContext('2d');
      const acc = {3:{b:0,p:0,b1:0,d2:0,t3:0,q4:0,t:0}, 4:{b:0,p:0,b1:0,d2:0,t3:0,q4:0,t:0}, 5:{b:0,p:0,b1:0,d2:0,t3:0,q4:0,t:0}};
      holes.forEach(h=>{
        if (![3,4,5].includes(h.par)) return;
        const diff = (h.score && h.par)? (h.score - h.par): null;
        if (diff==null) return;
        const x=acc[h.par]; x.t+=1;
        if (diff<=-1) x.b+=1;
        else if (diff===0) x.p+=1;
        else if (diff===1) x.b1+=1;
        else if (diff===2) x.d2+=1;
        else if (diff===3) x.t3+=1;
        else if (diff>=4) x.q4+=1;
      });
      const labels=['Par 3','Par 4','Par 5'];
      const toPct=(k)=> labels.map((_,i)=> {const o=acc[i+3]; return o.t? +(o[k]/o.t*100).toFixed(1):0;});
      const bird = toPct('b'), par = toPct('p'), bog = toPct('b1'), dbl = toPct('d2'), tri = toPct('t3'), quad = toPct('q4');

      if (charts.parRates) charts.parRates.destroy();
      charts.parRates = new Chart(ctx,{
        type:'bar',
        data:{
          labels, 
          datasets:[
            {label:'ë²„ë””(%)',   data:bird, backgroundColor:'#22c55e'}, // ì•„ì£¼ ë°ì€ ì´ˆë¡ìƒ‰
            {label:'íŒŒ(%)',     data:par,  backgroundColor:'#16a34a'}, // ì´ˆë¡ìƒ‰
            {label:'ë³´ê¸°(%)',   data:bog,  backgroundColor:'#eab308'}, // ë…¸ë€ìƒ‰
            {label:'ë”ë¸”(%)',   data:dbl,  backgroundColor:'#f97316'}, // ì£¼í™©ìƒ‰ (ë¹¨ê°• ê³„ì—´ ì‹œì‘)
            {label:'íŠ¸ë¦¬í”Œ(%)', data:tri,  backgroundColor:'#dc2626'}, // ë¹¨ê°„ìƒ‰
            {label:'ì¿¼ë“œ+(%)',  data:quad, backgroundColor:'#b91c1c'}  // ì•„ì£¼ ë¹¨ê°„ìƒ‰
          ]
        },
        options:{
          ...chartDefaults,
          scales:{
            ...chartDefaults.scales,
            x:{...chartDefaults.scales.x, stacked:true}, 
            y:{...chartDefaults.scales.y, stacked:true, suggestedMax:100}
          }
        }
      });
    }

    function renderDrivingDoughnut(holes){
      const d = {Hit:0, Left:0, Right:0};
      holes.filter(h=> h.par!==3).forEach(h=>{
        const f=normalize(h.fairway);
        if (f==='hit') d.Hit += 1;
        else if (f==='left') d.Left += 1;
        else if (f==='right') d.Right += 1;
      });
      const ctx = document.getElementById('drivingDoughnutChart').getContext('2d');
      if (charts.drive) charts.drive.destroy();
      charts.drive = new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:['Hit','Left','Right'], 
          datasets:[{
            data:[d.Hit,d.Left,d.Right], 
            backgroundColor:['rgba(35,134,54,.85)','rgba(248,81,73,.85)','rgba(31,111,235,.85)']
          }]
        },
        options:{
          responsive:true, 
          maintainAspectRatio:false, 
          plugins:{legend:{labels:{color:'#f0f6fc', font: { size: 12 }}}}
        }
      });
    }

    function clubOrderIndex(name){
      const s=(name||'').toString().toUpperCase().replace(/\s+/g,'');
      if (['D','DR','DRIVER'].includes(s)) return 0;
      const wood={'3W':1,'4W':2,'5W':3,'7W':4,'9W':5}; if (wood[s]!=null) return wood[s];
      const h=s.match(/^(\d+)H$/); if (h) return 10 + (+h[1]);
      const i=s.match(/^(\d+)I$/); if (i) return 30 + (+i[1]);
      const wedge={'PW':50,'GW':51,'SW':52,'LW':53}; if (wedge[s]!=null) return wedge[s];
      const deg=s.match(/^(48|50|52|54|56|58|60|62|64)$/); if (deg) return 51+ (+deg[1])/10;
      return 100;
    }

    function renderClubDistance(rounds, cut){
      const clubAgg=new Map();
      rounds.forEach(r=>{
        r.holes.forEach(h=>{
          const c=(h.approachClub||'').toString().trim(); const d=n(h.approachDist);
          if (!c || !d || d<=0 || isPutter(c)) return;
          const thr = cutoffForClub(c, cut);
          if (thr && d>=thr) return;
          if (!clubAgg.has(c)) clubAgg.set(c,{sum:0,cnt:0,max:0});
          const g=clubAgg.get(c); g.sum+=d; g.cnt+=1; if (d>g.max) g.max=d;
        });
      });
      const clubs=Array.from(clubAgg.keys()).sort((a,b)=> clubOrderIndex(a)-clubOrderIndex(b) || a.localeCompare(b));
      const avg=clubs.map(c=> (clubAgg.get(c).sum/clubAgg.get(c).cnt).toFixed(1));
      const max=clubs.map(c=> (clubAgg.get(c).max).toFixed(1));

      const ctx = document.getElementById('clubDistanceChart').getContext('2d');
      if (charts.club) charts.club.destroy();
      charts.club = new Chart(ctx,{
        type:'bar',
        data:{
          labels:clubs, 
          datasets:[
            {label:'í‰ê· (yd)', data:avg, backgroundColor:'rgba(35,134,54,.8)', borderColor:'#30363d', borderWidth:1},
            {label:'ìµœëŒ€(yd)', data:max, backgroundColor:'rgba(31,111,235,.7)', borderColor:'#30363d', borderWidth:1}
          ]
        },
        options: chartDefaults
      });

      const tbl = `<div class="table-responsive"><table class="table table-dark table-sm"><thead><tr><th>í´ëŸ½</th><th>ìƒ· ìˆ˜</th><th>í‰ê· (yd)</th><th>ìµœëŒ€(yd)</th></tr></thead>
        <tbody>${clubs.map((c,i)=>`<tr><td>${c}</td><td>${clubAgg.get(c).cnt}</td><td>${avg[i]}</td><td>${max[i]}</td></tr>`).join('')}</tbody></table></div>`;
      document.getElementById('clubAvgTableContainer').innerHTML = tbl || '<span class="text-muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
    }

    function populateRoundSelect(rounds){
      const sel=document.getElementById('roundSelect');
      sel.innerHTML='<option value="">ë¼ìš´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
      rounds.forEach(r=>{
        const label = `${r.date} Â· ${r.courseName} (${getRoundHolesType(r)}H, ${r.visitCount}íšŒì°¨)`;
        const opt=document.createElement('option'); opt.value=rk(r); opt.textContent=label; sel.appendChild(opt);
      });
    }

    function onRoundSelectChange(){ renderRoundDetails(); }

    function renderRoundDetails(){
      const key=document.getElementById('roundSelect').value;
      const mode = document.getElementById('viewCourseAgg').checked? 'course':'single';
      const memoBox = document.getElementById('selectedRoundMemo');
      const sumList = document.getElementById('selectedRoundSummary');
      const container=document.getElementById('roundTableContainer');
      memoBox.textContent=''; sumList.innerHTML=''; container.innerHTML='';

      if (!key){ container.innerHTML='<p class="text-muted">ë¼ìš´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>'; return; }
      const r0 = golfData.find(g=> rk(g)===key);
      if (!r0){ container.innerHTML='<p class="text-muted">ë¼ìš´ë“œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }

      if (mode==='single'){
        memoBox.textContent = (r0.memo && r0.memo.length)? `ë©”ëª¨: ${r0.memo.join(' | ')}` : 'ë©”ëª¨ ì—†ìŒ';
        sumList.innerHTML = `<li>${summarizeRound(r0, document.getElementById('useSlope').checked)}</li>`;
        renderRoundTable([r0], container, false);
      } else {
        const {startM, endM, rlen} = currentFilter();
        const startDate = startM? new Date(startM+'-01'): null;
        const endDate   = endM? new Date(endM+'-01'): null;
        if (endDate){ endDate.setMonth(endDate.getMonth()+1); endDate.setDate(0); }
        let same = golfData.filter(g=> normalizeCourse(g.courseName) === normalizeCourse(r0.courseName));
        same = same.filter(g=>{
          const d=parseDateSafe(g.date);
          if (startDate && d<startDate) return false;
          if (endDate && d>endDate) return false;
          if (rlen==='9'  && getRoundHolesType(g)!==9)  return false;
          if (rlen==='18' && getRoundHolesType(g)!==18) return false;
          return true;
        });
        const allMemos = same.flatMap(r=>r.memo||[]);
        memoBox.textContent = allMemos.length? `ë©”ëª¨(ì½”ìŠ¤ ì „ì²´): ${allMemos.join(' | ')}` : 'ë©”ëª¨ ì—†ìŒ';
        sumList.innerHTML = same.map(r=> `<li>${r.date}: ${summarizeRound(r, document.getElementById('useSlope').checked)}</li>`).join('');
        renderRoundTable(same, container, true);
      }
    }

    function renderRoundTable(roundList, container, aggregate=false){
      if (!roundList.length){ container.innerHTML='<p class="text-muted">í‘œì‹œí•  ë¼ìš´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
      const byHole = new Map();
      roundList.forEach(r=>{ r.holes.forEach(h=>{ const hh={...h, __course:r.courseName, __date:r.date}; if (!byHole.has(hh.hole)) byHole.set(hh.hole,[]); byHole.get(hh.hole).push(hh); }); });
      const holeNos = Array.from(byHole.keys()).sort((a,b)=> a-b);
      const table=document.createElement('table');
      table.className = 'table table-dark table-sm';
      table.innerHTML = aggregate? `
        <thead><tr><th>í™€</th><th>ëŒ€í‘œ íŒŒ</th><th>í‰ê·  ìŠ¤ì½”ì–´(Â±)</th><th>í‰ê·  í¼íŒ…</th><th>FW Hit%</th><th>GIR%</th><th>í‰ê·  ì ‘ê·¼(yd)</th></tr></thead><tbody></tbody>
      `: `
        <thead><tr><th>í™€</th><th>íŒŒ</th><th>ìŠ¤ì½”ì–´(Â±)</th><th>í¼íŒ…</th><th>FW</th><th>GIR</th><th>ì ‘ê·¼(yd)</th><th>í´ëŸ½</th></tr></thead><tbody></tbody>
      `;
      const tb=table.querySelector('tbody');

      if (!aggregate){
        const r = roundList[0];
        const holes=[...r.holes].sort((a,b)=> a.hole-b.hole);
        holes.forEach(h=>{
          const diff=(h.score && h.par)? h.score-h.par: null;
          const fw = (h.par!==3)? (normalize(h.fairway)==='hit'?'Hit': (h.fairway||'N')):'-';
          tb.insertAdjacentHTML('beforeend',`
            <tr>
              <td>${h.hole}</td>
              <td>${h.par}</td>
              <td>${h.score}${diff!=null? ` (${diff>0? '+'+diff: diff})` : ''}</td>
              <td>${h.putts||0}</td>
              <td>${fw}</td>
              <td>${h.gir?'Y':'N'}</td>
              <td>${h.approachDist!=null? h.approachDist.toFixed(0): '-'}</td>
              <td>${h.approachClub||'-'}</td>
            </tr>
          `);
        });
      } else {
        holeNos.forEach(no=>{
          const arr=byHole.get(no);
          const parMode = (()=>{const freq={}; arr.forEach(x=>freq[x.par]=(freq[x.par]||0)+1); return +Object.entries(freq).sort((a,b)=>b[1]-a[1])[0][0];})();
          const avgScore = arr.reduce((s,h)=>s+n(h.score),0)/arr.length;
          const diff = avgScore - parMode;
          const avgPutts = arr.reduce((s,h)=>s+n(h.putts),0)/arr.length;
          const fwHoles = arr.filter(h=> h.par!==3 && h.fairway!=null);
          const fwRate  = fwHoles.length? fwHoles.filter(h=> normalize(h.fairway)==='hit').length / fwHoles.length * 100 : null;
          const girRate = arr.filter(h=> h.gir===true).length / arr.length * 100;
          const appr = arr.filter(h=> h.approachDist!=null);
          const apprAvg = appr.length? appr.reduce((s,h)=>s+n(h.approachDist),0)/appr.length : null;

          tb.insertAdjacentHTML('beforeend',`
            <tr>
              <td>${no}</td>
              <td>${parMode}</td>
              <td>${avgScore.toFixed(1)} (${diff>0? '+'+diff.toFixed(1): diff.toFixed(1)})</td>
              <td>${avgPutts.toFixed(1)}</td>
              <td>${fwRate!=null? fwRate.toFixed(0)+'%':'-'}</td>
              <td>${girRate.toFixed(0)}%</td>
              <td>${apprAvg!=null? apprAvg.toFixed(1): '-'}</td>
            </tr>
          `);
        });
      }
      container.appendChild(table);
    }

    function summarizeRound(r, useSlope){
      const holes = r.holes;
      const parSum = holes.reduce((s,h)=>s+n(h.par),0);
      const dispScore = adjustedScore(r,useSlope);
      const diff = dispScore - parSum;
      const diffTxt = diff>0? `+${diff.toFixed(0)}`: `${diff.toFixed(0)}`;
      const bird = holes.filter(h=> h.score - h.par <= -1).length;
      const par  = holes.filter(h=> h.score - h.par === 0).length;
      const bog  = holes.filter(h=> h.score - h.par === 1).length;
      const dbl  = holes.filter(h=> h.score - h.par === 2).length;
      const tri  = holes.filter(h=> h.score - h.par === 3).length;
      const quad = holes.filter(h=> h.score - h.par >= 4).length;
      const fwH  = holes.filter(h=> h.par!==3 && normalize(h.fairway)==='hit').length;
      const fwT  = holes.filter(h=> h.par!==3 && h.fairway!=null).length;
      const girH = holes.filter(h=> h.gir===true).length;
      const putt = holes.reduce((s,h)=>s+n(h.putts),0);
      const apprTot = holes.filter(h=> h.approachDist!=null).length;
      const apprHit = holes.filter(h=> (h.approachDist!=null) && (h.gir===true)).length;
      const biasL = holes.filter(h=> h.par!==3 && normalize(h.fairway)==='left').length;
      const biasR = holes.filter(h=> h.par!==3 && normalize(h.fairway)==='right').length;
      const biasTxt = biasL>biasR? 'ì™¼ìª½ ë¯¸ìŠ¤ ê²½í–¥' : (biasR>biasL? 'ì˜¤ë¥¸ìª½ ë¯¸ìŠ¤ ê²½í–¥':'ì¢Œìš° ë°¸ëŸ°ìŠ¤');

      return `ìŠ¤ì½”ì–´ ${dispScore.toFixed(0)} (${diffTxt}), ë²„ë”” ${bird}, íŒŒ ${par}, ë³´ê¸° ${bog}, ë”ë¸” ${dbl}, íŠ¸ë¦¬í”Œ ${tri}, ì¿¼ë“œ+ ${quad}, `
           + `FW ${fwT? (fwH/fwT*100).toFixed(0)+'%':'-'}, GIR ${(girH/holes.length*100).toFixed(0)}%, `
           + `í¼íŒ… ${putt}, ì–´í”„ë¡œì¹˜ On-Green ${apprTot? (apprHit/apprTot*100).toFixed(0)+'%':'-'}, ë“œë¼ì´ë¹™ ${biasTxt}`;
    }

  </script>
</body>
</html>