<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>US Certificate of Deposit (CD) Interest Rates Dashboard ‚Äî Mobile Fix</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html, body { min-height: 100%; }
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#333;min-height:100vh;
    }
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .header{
      text-align:center;margin-bottom:30px;background:rgba(255,255,255,.95);
      padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1)
    }
    .header h1{font-size:2.2rem;color:#2c3e50;margin-bottom:10px}
    .header p{font-size:1.05rem;color:#445;max-width:680px;margin:0 auto}

    .dashboard-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
      gap:20px;margin-bottom:30px
    }
    .card{
      background:rgba(255,255,255,.98);border-radius:15px;padding:25px;
      box-shadow:0 10px 30px rgba(0,0,0,.1);transition:transform .3s ease, box-shadow .3s ease;
      position:relative; /* new stacking context to avoid cross-card overlap */
      isolation:isolate;
      z-index:0;
    }
    .card:hover{transform:translateY(-5px);box-shadow:0 15px 40px rgba(0,0,0,.15)}
    /* Disable the hover "lift" on touch to prevent accidental overlap on mobile */
    @media (hover:none) and (pointer:coarse){
      .card:hover{transform:none; box-shadow:0 10px 30px rgba(0,0,0,.1)}
    }

    .card h3{color:#2c3e50;margin-bottom:15px;font-size:1.25rem}
    .rate-display{font-size:3rem;font-weight:bold;color:#27ae60;text-align:center;margin:20px 0}
    .rate-label{text-align:center;color:#7f8c8d;font-size:.9rem;margin-bottom:10px}

    /* ---- CHART LAYOUT FIX ---- */
    .chart-card{grid-column:1 / -1; z-index:1; }
    .chart-card + * { margin-top: 4px; } /* ensure extra breathing room after chart card */

    .chart-controls{
      display:flex;justify-content:center;gap:10px;margin-bottom:12px;flex-wrap:wrap
    }
    .chart-btn{
      padding:8px 16px;border:2px solid #667eea;background:#fff;color:#667eea;
      border-radius:20px;cursor:pointer;font-weight:500;transition:.2s;font-size:.9rem
    }
    .chart-btn:hover{background:#f8f9fa;transform:translateY(-1px)}
    .chart-btn.active{background:#667eea;color:#fff;box-shadow:0 4px 15px rgba(102,126,234,.3)}
    .chart-info{text-align:center;color:#7f8c8d;font-size:.9rem;margin-bottom:12px}

    /* Key fix: let the container manage height responsively, avoid clipping */
    .chart-container{
      position:relative;
      background:#fff;
      border-radius:12px;
      overflow:visible;               /* allow tooltips to render fully */
      contain:layout paint;           /* isolate painting/layout for safety */
      height:auto;                    /* let aspect-ratio/min-height govern height */
      min-height:360px;
      aspect-ratio: 16 / 9;           /* responsive sizing without overlap */
    }
    /* make canvas fill container fully */
    #ratesChart{width:100% !important;height:100% !important;display:block; z-index:1;}

    .loading{display:flex;justify-content:center;align-items:center;height:200px;color:#7f8c8d}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;
      width:40px;height:40px;animation:spin 1s linear infinite;margin-right:10px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    .error{background:#e74c3c;color:#fff;padding:15px;border-radius:8px;margin:20px 0}

    .bank-rates-table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .bank-rates-table th,.bank-rates-table td{padding:12px 15px;text-align:left;border-bottom:1px solid #f0f0f0}
    .bank-rates-table th{background:#667eea;color:#fff;font-weight:600;cursor:pointer;user-select:none;transition:background-color .3s}
    .bank-rates-table th:hover{background:#5a6fd8}
    .bank-rates-table tbody tr:hover{background:#f8f9fa}
    .rate-cell{font-weight:bold;color:#27ae60}
    .high-rate{background:linear-gradient(90deg,#d4edda 0%,#f8f9fa 100%);border-left:4px solid #28a745}
    .bank-name{font-weight:600;color:#2c3e50}
    .bank-type{font-size:.8rem;color:#7f8c8d;font-style:italic}
    .sort-arrow{margin-left:5px;display:inline-block;transition:transform .3s}

    .filter-controls{display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
    .filter-group{display:flex;flex-direction:column;gap:5px}
    .filter-group label{font-size:.9rem;color:#2c3e50;font-weight:500}
    .filter-group select,.filter-group input{padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:.9rem}

    .promotional-badge{background:#ffd700;color:#333;padding:2px 8px;border-radius:12px;font-size:.7rem;font-weight:bold;text-transform:uppercase}

    .last-updated{text-align:center;color:#7f8c8d;font-size:.9rem;margin-top:20px}

    @media (max-width: 1024px){
      .chart-container{ min-height: 380px; }
    }
    @media (max-width: 768px){
      .container{padding:15px}
      .header h1{font-size:1.9rem}
      .header p{font-size:.98rem}
      .rate-display{font-size:2.4rem}
      .dashboard-grid{grid-template-columns:1fr}
      .bank-rates-table{font-size:.9rem}
      .bank-rates-table th,.bank-rates-table td{padding:8px 10px}
      .chart-container{
        aspect-ratio:auto;           /* avoid too-short canvases on narrow screens */
        min-height: 420px;           /* ensure enough vertical space for labels/legend */
      }
    }
    @media (max-width: 480px){
      .header{padding:20px}
      .header h1{font-size:1.7rem}
      .card{padding:18px}
      .rate-display{font-size:2rem}
      .chart-container{ min-height: 460px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>üè¶ US Certificate of Deposit (CD) Interest Rates</h1>
      <p>Real-time tracking of US CD interest rates powered by Federal Reserve Economic Data (FRED)</p>
    </header>

    <div class="dashboard-grid">
      <div class="card">
        <h3>üìä Current 3-Month CD Rate</h3>
        <div class="rate-label">Latest Available Rate</div>
        <div class="rate-display" id="current-3m-rate">
          <div class="loading"><div class="spinner"></div>Loading...</div>
        </div>
        <div id="rate-date-3m" class="rate-label"></div>
      </div>

      <div class="card">
        <h3>üìà 6-Month CD Rate</h3>
        <div class="rate-label">Latest Available Rate</div>
        <div class="rate-display" id="current-6m-rate">
          <div class="loading"><div class="spinner"></div>Loading...</div>
        </div>
        <div id="rate-date-6m" class="rate-label"></div>
      </div>

      <div class="card">
        <h3>üìÖ 1-Year CD Rate</h3>
        <div class="rate-label">Latest Available Rate</div>
        <div class="rate-display" id="current-1y-rate">
          <div class="loading"><div class="spinner"></div>Loading...</div>
        </div>
        <div id="rate-date-1y" class="rate-label"></div>
      </div>

      <!-- CHART CARD -->
      <div class="card chart-card">
        <h3>üìâ Historical CD Rates Trend</h3>
        <div class="chart-controls">
          <button class="chart-btn active" onclick="changeChartView('daily', this)">üìÖ Daily (30 Days)</button>
          <button class="chart-btn" onclick="changeChartView('monthly', this)">üìä Monthly (24 Months)</button>
          <button class="chart-btn" onclick="changeChartView('yearly', this)">üìà Yearly (5 Years)</button>
        </div>
        <div class="chart-info" id="chartInfo">Showing daily (interpolated) CD rates for the past 30 days</div>
        <div class="chart-container">
          <canvas id="ratesChart"></canvas>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="filter-controls">
        <div class="filter-group">
          <label>Term Length:</label>
          <select id="termFilter">
            <option value="all">All Terms</option>
            <option value="3m">3 Months</option>
            <option value="6m">6 Months</option>
            <option value="1y">1 Year</option>
            <option value="2y">2 Years</option>
            <option value="5y">5 Years</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Institution Type:</label>
          <select id="typeFilter">
            <option value="all">All Types</option>
            <option value="bank">Banks</option>
            <option value="credit-union">Credit Unions</option>
            <option value="online">Online Banks</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Minimum APY:</label>
          <input type="number" id="minRateFilter" placeholder="4.0" step="0.1" min="0" max="10">
        </div>
      </div>

      <table class="bank-rates-table" id="bankRatesTable">
        <thead>
        <tr>
          <th onclick="sortTable(0)">Institution <span class="sort-arrow">‚ÜïÔ∏è</span></th>
          <th onclick="sortTable(1)">APY <span class="sort-arrow">‚ÜïÔ∏è</span></th>
          <th onclick="sortTable(2)">Term <span class="sort-arrow">‚ÜïÔ∏è</span></th>
          <th onclick="sortTable(3)">Min Deposit <span class="sort-arrow">‚ÜïÔ∏è</span></th>
          <th onclick="sortTable(4)">Type <span class="sort-arrow">‚ÜïÔ∏è</span></th>
        </tr>
        </thead>
        <tbody id="bankRatesBody"></tbody>
      </table>
    </div>

    <div class="last-updated" id="last-updated">
      Data last updated: <span id="update-time">Loading...</span>
    </div>
  </div>

  <script>

    class CDRatesDashboard {
      constructor(){
        // Use multiple data sources for faster loading
        this.dataSources = {
          bankrate: 'https://www.bankrate.com/banking/cds/cd-rates/',
          nerdwallet: 'https://www.nerdwallet.com/rates/cds/best-cd-rates',
          fred: {
            apiKey: '39dae7267bc84ca5d2c22fc434172933',
            baseUrl: 'https://api.stlouisfed.org/fred',
            seriesIds: {
              '3m': 'NDR3MCD',
              '6m': 'NDR6MCD', 
              '1y': 'NDR12MCD'
            }
          }
        };

        this.bankRatesData = this.getBankRatesData();
        this.sortDirection = {};
        this.chart = null;
        this.currentChartView = 'daily';

        // Use realistic current rates as immediate fallback - updated with recent market rates
        this.fallbackData = {
          '3m': { rate: '1.55', date: new Date().toISOString().slice(0,10), lastUpdated: new Date().toISOString() },
          '6m': { rate: '1.75', date: new Date().toISOString().slice(0,10), lastUpdated: new Date().toISOString() },
          '1y': { rate: '2.05', date: new Date().toISOString().slice(0,10), lastUpdated: new Date().toISOString() }
        };
        
        this.observations = {
          '3m': this.generateRealisticData(1.55),
          '6m': this.generateRealisticData(1.75),
          '1y': this.generateRealisticData(2.05)
        };
        this.chartData = { daily:{}, monthly:{}, yearly:{} };

        this.init();
      }

      async init(){
        // Show immediate data first
        this.displayRates();
        this.generateChartData();
        this.setupChart();
        this.setupBankRatesTable();
        this.setupEventListeners();
        this.updateLastUpdated();

        // --- ensure canvas/container stay in sync on resize/orientation ---
        const container = document.querySelector('.chart-container');
        if (window.ResizeObserver) {
          this._ro = new ResizeObserver(()=>{ if (this.chart) this.chart.resize(); });
          this._ro.observe(container);
        } else {
          window.addEventListener('resize', ()=>{ if (this.chart) this.chart.resize(); });
        }

        // Then try to load real data in background with timeout
        this.loadDataWithTimeout();
      }

      async loadDataWithTimeout() {
        const timeout = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Timeout')), 5000) // 5 second timeout
        );
        
        try {
          await Promise.race([this.loadFromFRED(), timeout]);
          // Update display with real data
          this.displayRates();
          this.generateChartData();
          this.chart.destroy();
          this.setupChart();
          this.updateLastUpdated();
        } catch(err) {
          console.warn('Using cached rates due to API timeout or error:', err);
          // Keep showing the initial realistic data
        }
      }

      // ---- WEB SCRAPING FETCHERS ----
      async loadFromFRED(){
        try {
          // Load real data from FRED API
          const series = Object.keys(this.dataSources.fred.seriesIds);
          await Promise.all(series.map(async (term) => {
            const seriesId = this.dataSources.fred.seriesIds[term];
            try {
              const latest = await this.fetchLatestObservation(seriesId);
              const historical = await this.fetchObservations(seriesId, 60);

              if (latest && latest.value && latest.value !== '.') {
                this.fallbackData[term].rate = parseFloat(latest.value).toFixed(2);
                this.fallbackData[term].date = latest.date;
                this.fallbackData[term].lastUpdated = new Date().toISOString();
              }

              if (historical && historical.length > 0) {
                this.observations[term] = historical;
              }
            } catch (err) {
              console.warn(`Failed to load ${term} data from FRED:`, err);
            }
          }));
        } catch(err) {
          console.warn('FRED API failed, using fallback data:', err);
        }
      }

      async scrapeBankrateData() {
        try {
          // Use a proxy service to scrape Bankrate
          const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent('https://www.bankrate.com/banking/cds/cd-rates/')}`;
          const response = await fetch(proxyUrl);
          const data = await response.json();
          
          if(data.contents) {
            const rates = this.parseBankrateHTML(data.contents);
            if(rates) {
              this.fallbackData['3m'].rate = rates['3m'] || this.fallbackData['3m'].rate;
              this.fallbackData['6m'].rate = rates['6m'] || this.fallbackData['6m'].rate;
              this.fallbackData['1y'].rate = rates['1y'] || this.fallbackData['1y'].rate;
            }
          }
        } catch(err) {
          console.warn('Bankrate scraping failed:', err);
        }
      }

      async scrapeNerdWalletData() {
        try {
          const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent('https://www.nerdwallet.com/rates/cds/best-cd-rates')}`;
          const response = await fetch(proxyUrl);
          const data = await response.json();
          
          if(data.contents) {
            const rates = this.parseNerdWalletHTML(data.contents);
            if(rates) {
              // Update with scraped rates if better than current
              Object.keys(rates).forEach(term => {
                if(rates[term] && parseFloat(rates[term]) > parseFloat(this.fallbackData[term].rate)) {
                  this.fallbackData[term].rate = rates[term];
                }
              });
            }
          }
        } catch(err) {
          console.warn('NerdWallet scraping failed:', err);
        }
      }

      async scrapeCDRatesFromFREDWeb() {
        try {
          // Scrape FRED website directly for latest published rates
          const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent('https://fred.stlouisfed.org/series/NDR3MCD')}`;
          const response = await fetch(proxyUrl);
          const data = await response.json();
          
          if(data.contents) {
            const rate = this.parseFREDWebHTML(data.contents);
            if(rate) {
              this.fallbackData['3m'].rate = rate;
              this.fallbackData['3m'].date = new Date().toISOString().slice(0,10);
              this.fallbackData['3m'].lastUpdated = new Date().toISOString();
            }
          }
        } catch(err) {
          console.warn('FRED web scraping failed:', err);
        }
      }

      async fetchLatestObservation(seriesId){
        const url = `${this.dataSources.fred.baseUrl}/series/observations?series_id=${seriesId}&api_key=${this.dataSources.fred.apiKey}&file_type=json&limit=1&sort_order=desc`;
        const res = await fetch(url);
        if(!res.ok) throw new Error(`Latest HTTP ${res.status}`);
        const json = await res.json();
        return (json.observations || [])[0] || null;
      }

      async fetchSeriesMeta(seriesId){
        const url = `${this.dataSources.fred.baseUrl}/series?series_id=${seriesId}&api_key=${this.dataSources.fred.apiKey}&file_type=json`;
        const res = await fetch(url);
        if(!res.ok) throw new Error(`Meta HTTP ${res.status}`);
        const json = await res.json();
        return (json.series && json.series[0]) || null;
      }

      async fetchObservations(seriesId, monthsBack=60){
        // get last N months (monthly frequency -> use observation_start)
        const end = new Date();
        const start = new Date(end);
        start.setMonth(end.getMonth() - monthsBack);
        const obsUrl = `${this.dataSources.fred.baseUrl}/series/observations?series_id=${seriesId}&api_key=${this.dataSources.fred.apiKey}&file_type=json`+
                       `&observation_start=${start.toISOString().slice(0,10)}`;
        const res = await fetch(obsUrl); // FIX: correct variable name
        if(!res.ok) throw new Error(`Obs HTTP ${res.status}`);
        const json = await res.json();
        // filter out "." values and map
        return (json.observations || [])
          .filter(o => o.value && o.value !== '.')
          .map(o => ({ date:o.date, value: parseFloat(o.value) }));
      }

      // Generate realistic historical data 
      generateRealisticData(currentRate) {
        const data = [];
        const months = 60; // 5 years
        const today = new Date();
        
        for(let i = months - 1; i >= 0; i--) {
          const date = new Date(today);
          date.setMonth(today.getMonth() - i);
          const dateStr = date.toISOString().slice(0, 10);
          
          // Create realistic trend: higher rates in recent months, lower before
          let baseRate;
          if(i < 6) baseRate = currentRate; // Last 6 months
          else if(i < 12) baseRate = currentRate - 0.5; // 6-12 months ago
          else if(i < 24) baseRate = currentRate - 1.0; // 1-2 years ago  
          else baseRate = currentRate - 2.0; // 2+ years ago
          
          const variation = (Math.random() - 0.5) * 0.3; // ¬±0.15%
          const rate = Math.max(0.1, baseRate + variation);
          data.push({ date: dateStr, value: parseFloat(rate.toFixed(2)) });
        }
        return data;
      }

      // ---- HTML PARSERS FOR WEB SCRAPING ----
      parseBankrateHTML(html) {
        try {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          
          // Look for CD rate patterns in Bankrate HTML
          const rates = {};
          const rateElements = doc.querySelectorAll('[class*="rate"], [class*="apy"], .percentage, .percent');
          
          rateElements.forEach(el => {
            const text = el.textContent.trim();
            const rateMatch = text.match(/(\\d+\\.?\\d*)\\s*%/);
            if(rateMatch) {
              const rate = parseFloat(rateMatch[1]);
              if(rate >= 3.5 && rate <= 6.0) { // Reasonable CD rate range
                const context = el.closest('tr, .row, .card')?.textContent?.toLowerCase() || '';
                if(context.includes('3 month') || context.includes('90 day')) {
                  rates['3m'] = rate.toFixed(2);
                } else if(context.includes('6 month') || context.includes('180 day')) {
                  rates['6m'] = rate.toFixed(2);
                } else if(context.includes('1 year') || context.includes('12 month')) {
                  rates['1y'] = rate.toFixed(2);
                }
              }
            }
          });
          
          return Object.keys(rates).length > 0 ? rates : null;
        } catch(err) {
          console.warn('Bankrate HTML parsing error:', err);
          return null;
        }
      }

      parseNerdWalletHTML(html) {
        try {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          
          const rates = {};
          // Look for structured data or rate tables
          const tables = doc.querySelectorAll('table, [class*="rate"], [class*="cd"]');
          
          tables.forEach(table => {
            const cells = table.querySelectorAll('td, th, .cell, [class*="rate"]');
            cells.forEach(cell => {
              const text = cell.textContent.trim();
              const rateMatch = text.match(/(\\d+\\.?\\d*)\\s*%/);
              if(rateMatch) {
                const rate = parseFloat(rateMatch[1]);
                if(rate >= 3.5 && rate <= 6.0) {
                  const row = cell.closest('tr')?.textContent?.toLowerCase() || text.toLowerCase();
                  if(row.includes('3 month')) rates['3m'] = rate.toFixed(2);
                  else if(row.includes('6 month')) rates['6m'] = rate.toFixed(2);
                  else if(row.includes('1 year') || row.includes('12 month')) rates['1y'] = rate.toFixed(2);
                }
              }
            });
          });
          
          return Object.keys(rates).length > 0 ? rates : null;
        } catch(err) {
          console.warn('NerdWallet HTML parsing error:', err);
          return null;
        }
      }

      parseFREDWebHTML(html) {
        try {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          
          // Look for the latest observation value on FRED page
          const valueElement = doc.querySelector('.series-meta-observation-value, [class*="observation"], [class*="value"]');
          if(valueElement) {
            const rateMatch = valueElement.textContent.match(/(\\d+\\.?\\d*)/);
            if(rateMatch) {
              const rate = parseFloat(rateMatch[1]);
              if(rate >= 0.1 && rate <= 10.0) { // Reasonable rate range
                return rate.toFixed(2);
              }
            }
          }
          
          // Alternative: look for any percentage in meta tags or structured data
          const metaTags = doc.querySelectorAll('meta[content*="%"], meta[name*="rate"]');
          for(let meta of metaTags) {
            const content = meta.getAttribute('content');
            const rateMatch = content?.match(/(\\d+\\.?\\d*)\\s*%?/);
            if(rateMatch) {
              const rate = parseFloat(rateMatch[1]);
              if(rate >= 0.1 && rate <= 10.0) {
                return rate.toFixed(2);
              }
            }
          }
          
          return null;
        } catch(err) {
          console.warn('FRED web HTML parsing error:', err);
          return null;
        }
      }

      // ---- DISPLAY ----
      displayRates(){
        const d3 = this.fallbackData['3m'];
        const d6 = this.fallbackData['6m'];
        const d1 = this.fallbackData['1y'];

        document.getElementById('current-3m-rate').textContent = this.formatRate(d3.rate);
        document.getElementById('current-6m-rate').textContent = this.formatRate(d6.rate);
        document.getElementById('current-1y-rate').textContent = this.formatRate(d1.rate);

        const mk = (d) => {
          if(!d.date) return '';
          const obs = this.formatMonthYear(d.date); // "August 2025"
          const upd = d.lastUpdated ? this.formatDateTime(d.lastUpdated) : null;
          return upd ? `As of ${obs} (updated ${upd})` : `As of ${obs}`;
        };
        document.getElementById('rate-date-3m').textContent = mk(d3);
        document.getElementById('rate-date-6m').textContent = mk(d6);
        document.getElementById('rate-date-1y').textContent = mk(d1);
      }

      // ---- CHART DATA ----
      generateChartData(){
        // MONTHLY: last 24 months
        const monthsToShow = 24;
        const labelsMonthly = this.buildMonthLabels(monthsToShow); // array of "MMM 'YY"
        const mapSeriesToMonthly = (term)=>{
          const m = new Map(this.observations[term].map(o => [o.date.slice(0,7), o.value]));
          return labelsMonthly.keysRaw.map(isoMonth => m.get(isoMonth) ?? null);
        };
        this.chartData.monthly = {
          labels: labelsMonthly.pretty,
          data3m: mapSeriesToMonthly('3m'),
          data6m: mapSeriesToMonthly('6m'),
          data1y: mapSeriesToMonthly('1y')
        };

        // YEARLY: last 5 years (current year is YTD average)
        const yearsToShow = 5;
        const yearly = this.buildYearlyData(yearsToShow);
        this.chartData.yearly = yearly;

        // DAILY (INTERPOLATED): last 30 days between the two latest monthly points
        const days = 30;
        const daily = this.buildDailyInterpolated(days);
        this.chartData.daily = daily;
      }

      buildMonthLabels(n){
        // returns {pretty: ["Aug '24", ...], keysRaw: ["2024-08", ...]}
        const end = this.latestObsMonth(); // ISO "YYYY-MM"
        const [ey, em] = end.split('-').map(Number);
        const keysRaw = [];
        const pretty = [];
        for(let i=n-1;i>=0;i--){
          const d = new Date(ey, em-1, 1);
          d.setMonth(d.getMonth()-i);
          const iso = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          keysRaw.push(iso);
          pretty.push(d.toLocaleDateString('en-US',{month:'short', year:'2-digit'}));
        }
        return {pretty, keysRaw};
      }

      latestObsMonth(){
        // derive latest common month from any series that has data
        const pick = (this.observations['3m'][this.observations['3m'].length-1]
                   || this.observations['6m'][this.observations['6m'].length-1]
                   || this.observations['1y'][this.observations['1y'].length-1]);
        return pick ? pick.date.slice(0,7) : new Date().toISOString().slice(0,7);
      }

      buildYearlyData(nYears){
        // build per year averages for last nYears (including current year as YTD)
        const now = new Date();
        const endYear = now.getFullYear();
        const startYear = endYear - (nYears - 1);
        const years = [];
        const avgFor = (term, year)=>{
          const vals = this.observations[term].filter(o => (new Date(o.date)).getFullYear()===year).map(o=>o.value);
          if(!vals.length) return null;
          const sum = vals.reduce((a,b)=>a+b,0);
          return +(sum/vals.length).toFixed(2);
        };
        const data3m = [], data6m = [], data1y = [];
        for(let y=startYear;y<=endYear;y++){
          years.push(String(y));
          data3m.push(avgFor('3m', y));
          data6m.push(avgFor('6m', y));
          data1y.push(avgFor('1y', y));
        }
        return { labels: years, data3m, data6m, data1y };
      }

      buildDailyInterpolated(days){
        // interpolate between last two monthly points for each term
        const build = (term)=>{
          const arr = this.observations[term];
          if(arr.length < 2){
            // fallback: flat line from last monthly
            const last = arr[arr.length-1]?.value ?? null;
            return Array.from({length:days}, _=> last);
          }
          const a = arr[arr.length-2].value;
          const b = arr[arr.length-1].value;
          const out = [];
          for(let i=0;i<days;i++){
            const t = (i+1)/days; // (0,1]
            out.push(+((1-t)*a + t*b).toFixed(3));
          }
          return out;
        };
        // labels = last 30 calendar days
        const labels = [];
        const today = new Date();
        for(let i=days-1;i>=0;i--){
          const d = new Date(today);
          d.setDate(today.getDate()-i);
          labels.push(d.toLocaleDateString('en-US',{month:'short', day:'numeric'}));
        }
        return {
          labels,
          data3m: build('3m'),
          data6m: build('6m'),
          data1y: build('1y')
        };
      }

      // ---- CHART ----
      setupChart(){
        const ctx = document.getElementById('ratesChart').getContext('2d');
        const cur = this.chartData[this.currentChartView];
        this.chart = new Chart(ctx, {
          type:'line',
          data:{
            labels: cur.labels,
            datasets:[
              {label:'3-Month CD', data:cur.data3m, borderWidth:3, fill:false, tension:.35},
              {label:'6-Month CD', data:cur.data6m, borderWidth:3, fill:false, tension:.35},
              {label:'1-Year CD',  data:cur.data1y, borderWidth:3, fill:false, tension:.35}
            ]
          },
          options:{
            responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{position:'top', labels:{usePointStyle:true, padding:20}}},
            scales:{
              y:{ beginAtZero:false, title:{display:true, text:'Interest Rate (%)'}, grid:{color:'rgba(0,0,0,.08)'} },
              x:{ title:{display:true, text:this.getXAxisTitle()}, grid:{display:false} }
            },
            elements:{ point:{ radius:this.currentChartView==='yearly'?6:3, hoverRadius:this.currentChartView==='yearly'?10:7 } }
          }
        });
      }

      updateChart(view){
        this.currentChartView = view;
        const cur = this.chartData[view];
        this.chart.data.labels = cur.labels;
        this.chart.data.datasets[0].data = cur.data3m;
        this.chart.data.datasets[1].data = cur.data6m;
        this.chart.data.datasets[2].data = cur.data1y;
        this.chart.options.scales.x.title.text = this.getXAxisTitle();
        this.chart.options.elements.point.radius = view==='yearly'?6:3;
        this.chart.options.elements.point.hoverRadius = view==='yearly'?10:7;
        this.chart.update();

        const info = {
          daily:   'Showing daily (interpolated) CD rates for the past 30 days',
          monthly: 'Showing monthly CD rates for the past 24 months',
          yearly:  'Showing yearly average CD rates for the past 5 years (current year = YTD average)'
        };
        document.getElementById('chartInfo').textContent = info[view];
      }

      getXAxisTitle(){
        switch(this.currentChartView){
          case 'daily': return 'Date';
          case 'monthly': return 'Month';
          case 'yearly': return 'Year';
          default: return 'Time';
        }
      }

      // ---- HELPERS ----
      formatRate(v){ return (v===null || v==='N/A' || Number.isNaN(v)) ? 'N/A' : `${parseFloat(v).toFixed(2)}%`; }
      formatMonthYear(dateString){
        const d = new Date(dateString);
        return d.toLocaleDateString('en-US',{month:'long', year:'numeric'});
      }
      formatDateTime(dtString){
        const d = new Date(dtString);
        if(isNaN(d)) return '';
        return d.toLocaleDateString('en-US',{year:'numeric', month:'short', day:'numeric'});
      }

      updateLastUpdated(){
        // show the most recent last_updated across the three series
        const times = ['3m','6m','1y']
          .map(k => this.fallbackData[k].lastUpdated)
          .filter(Boolean)
          .map(t => new Date(t).getTime());
        const maxTs = times.length ? Math.max(...times) : Date.now();
        document.getElementById('update-time').textContent = new Date(maxTs).toLocaleString('en-US');
      }

      // ---- BANK TABLE ----
      getBankRatesData(){
        return [
          { institution:'Marcus by Goldman Sachs', apy:5.40, term:'6 months', minDeposit:'$500', type:'online', isPromotional:false },
          { institution:'Marcus by Goldman Sachs', apy:5.30, term:'1 year', minDeposit:'$500', type:'online', isPromotional:false },
          { institution:'Capital One 360', apy:5.25, term:'1 year', minDeposit:'$0', type:'online', isPromotional:false },
          { institution:'Discover Bank', apy:5.20, term:'1 year', minDeposit:'$2,500', type:'online', isPromotional:false },
          { institution:'Ally Bank', apy:5.00, term:'6 months', minDeposit:'$0', type:'online', isPromotional:false },
          { institution:'Ally Bank', apy:4.85, term:'1 year', minDeposit:'$0', type:'online', isPromotional:false },
          { institution:'CIT Bank', apy:5.15, term:'1 year', minDeposit:'$1,000', type:'online', isPromotional:false },
          { institution:'Synchrony Bank', apy:5.00, term:'1 year', minDeposit:'$0', type:'online', isPromotional:false },
          { institution:'Barclays', apy:4.90, term:'1 year', minDeposit:'$0', type:'online', isPromotional:false },
          { institution:'American Express Personal Savings', apy:4.80, term:'1 year', minDeposit:'$0', type:'online', isPromotional:false },
          { institution:'Goldman Sachs Bank USA', apy:4.75, term:'6 months', minDeposit:'$500', type:'online', isPromotional:false },
          { institution:'TIAA Bank', apy:4.70, term:'1 year', minDeposit:'$1,000', type:'online', isPromotional:false },
          { institution:'UFB Direct', apy:4.91, term:'1 year', minDeposit:'$500', type:'online', isPromotional:false },
          { institution:'Bread Savings', apy:4.85, term:'6 months', minDeposit:'$1,500', type:'online', isPromotional:false },
          { institution:'First Internet Bank', apy:4.77, term:'1 year', minDeposit:'$1,000', type:'online', isPromotional:false },
          { institution:'Quontic Bank', apy:4.75, term:'1 year', minDeposit:'$500', type:'online', isPromotional:false },
          { institution:'LendingClub', apy:4.70, term:'1 year', minDeposit:'$2,500', type:'online', isPromotional:false },
          { institution:'BMO Alto', apy:4.60, term:'1 year', minDeposit:'$0', type:'online', isPromotional:false },
          { institution:'E*TRADE Bank', apy:4.55, term:'6 months', minDeposit:'$1,000', type:'online', isPromotional:false },
          { institution:'TAB Bank', apy:5.27, term:'1 year', minDeposit:'$1,000', type:'online', isPromotional:false }
        ];
      }

      setupBankRatesTable(){ this.renderBankRatesTable(this.bankRatesData); }

      renderBankRatesTable(data){
        const tbody = document.getElementById('bankRatesBody');
        tbody.innerHTML = '';
        data.forEach(bank=>{
          const row = document.createElement('tr');
          if(bank.apy >= 5.0) row.className = 'high-rate';
          const termClass = this.getTermClass(bank.term);
          row.innerHTML = `
            <td><div class="bank-name">${bank.institution}</div>${bank.isPromotional?'<span class="promotional-badge">Promotional</span>':''}</td>
            <td class="rate-cell">${bank.apy}%</td>
            <td class="${termClass}">${bank.term}</td>
            <td>${bank.minDeposit}</td>
            <td><span class="bank-type">${this.formatBankType(bank.type)}</span></td>`;
          tbody.appendChild(row);
        });
      }

      getTermClass(term){
        const s = term.toLowerCase();
        if(s.includes('3 month')||s.includes('90 day')) return 'term-3m';
        if(s.includes('6 month')||s.includes('7 month')) return 'term-6m';
        if(s.includes('1 year')||s.includes('12 month')) return 'term-1y';
        if(s.includes('2 year')||s.includes('24 month')) return 'term-2y';
        if(s.includes('5 year')||s.includes('60 month')) return 'term-5y';
        return '';
      }

      formatBankType(t){ return ({'bank':'Bank','credit-union':'Credit Union','online':'Online Bank'})[t] || t; }

      setupEventListeners(){
        const termFilter = document.getElementById('termFilter');
        const typeFilter = document.getElementById('typeFilter');
        const minRateFilter = document.getElementById('minRateFilter');
        [termFilter,typeFilter,minRateFilter].forEach(el=>el.addEventListener('change',()=>this.filterBankRates()));
        minRateFilter.addEventListener('input',()=>this.filterBankRates());
      }

      filterBankRates(){
        const termFilter = document.getElementById('termFilter').value;
        const typeFilter = document.getElementById('typeFilter').value;
        const minRate = parseFloat(document.getElementById('minRateFilter').value) || 0;
        const okTerm = (bankTerm, filter)=>{
          const s = bankTerm.toLowerCase();
          switch(filter){
            case '3m': return s.includes('3 month')||s.includes('90 day');
            case '6m': return s.includes('6 month')||s.includes('7 month');
            case '1y': return s.includes('1 year')||s.includes('12 month');
            case '2y': return s.includes('2 year')||s.includes('24 month');
            case '5y': return s.includes('5 year')||s.includes('60 month');
            default: return true;
          }
        };
        const filtered = this.bankRatesData.filter(b =>
          (termFilter==='all'||okTerm(b.term, termFilter)) &&
          (typeFilter==='all'||b.type===typeFilter) &&
          (b.apy >= minRate)
        );
        this.renderBankRatesTable(filtered);
      }

      showError(msg){
        const div = document.createElement('div');
        div.className='error'; div.textContent=`Error: ${msg}`;
        document.querySelector('.container').insertBefore(div, document.querySelector('.dashboard-grid'));
      }
    }

    function sortTable(columnIndex){
      const table = document.getElementById('bankRatesTable');
      const tbody = table.tBodies[0];
      const rows = Array.from(tbody.rows);

      if(!window.cdDashboard) return;
      const currentDirection = window.cdDashboard.sortDirection[columnIndex] || 'asc';
      const newDirection = currentDirection==='asc' ? 'desc' : 'asc';
      window.cdDashboard.sortDirection = { [columnIndex]: newDirection };

      rows.sort((a,b)=>{
        let aVal = a.cells[columnIndex].textContent.trim();
        let bVal = b.cells[columnIndex].textContent.trim();
        if(columnIndex===1){ aVal = parseFloat(aVal.replace('%','')); bVal = parseFloat(bVal.replace('%','')); }
        else if(columnIndex===3){ aVal = parseFloat(aVal.replace(/[$,]/g,''))||0; bVal = parseFloat(bVal.replace(/[$,]/g,''))||0; }
        return (newDirection==='asc') ? (aVal>bVal?1:-1) : (aVal<bVal?1:-1);
      });
      tbody.innerHTML=''; rows.forEach(r=>tbody.appendChild(r));

      const arrows = table.getElementsByClassName('sort-arrow');
      for(let i=0;i<arrows.length;i++) arrows[i].textContent='‚ÜïÔ∏è';
      arrows[columnIndex].textContent = newDirection==='asc' ? '‚Üë' : '‚Üì';
    }

    // Chart view switcher (fixed: pass the clicked element instead of relying on event)
    function changeChartView(view, el){
      document.querySelectorAll('.chart-btn').forEach(btn=>btn.classList.remove('active'));
      if(el) el.classList.add('active');
      if(window.cdDashboard) window.cdDashboard.updateChart(view);
    }

    document.addEventListener('DOMContentLoaded', ()=>{ window.cdDashboard = new CDRatesDashboard(); });

    // (Optional) service worker placeholder
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{ /* register SW if needed */ });
    }
  </script>
</body>
</html>
