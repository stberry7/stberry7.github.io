<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Global Human Ranking Calculator - Find Your World Rank Among 8.2 Billion People | Personal Wealth Position</title>
<meta content="Calculate your precise global ranking among 8.2 billion people worldwide. Discover where you stand globally based on wealth, income, education, health, and demographics. Free comprehensive analysis tool." name="description"/>
<meta content="global ranking, world population rank, wealth calculator, income percentile, global position, human ranking, world statistics, demographics calculator, population analysis, personal ranking tool" name="keywords"/>
<meta content="Global Ranking System" name="author"/>
<meta content="Global Human Ranking Calculator - Find Your World Position" property="og:title"/>
<meta content="Calculate your precise global ranking among 8.2 billion people. Free comprehensive analysis of your world position." property="og:description"/>
<meta content="website" property="og:type"/>
<meta content="summary_large_image" name="twitter:card"/>
<meta content="Global Human Ranking Calculator" name="twitter:title"/>
<meta content="Find your exact position among 8.2 billion people worldwide. Free ranking calculator." name="twitter:description"/>
<style>
:root{
  --bg:#0b0f14; --card:#10161d; --fg:#e6edf3; --muted:#96a1ad;
  --border:#22303c; --accent:#60a5fa; --green:#22c55e; --warn:#f59e0b;
  --success:#22c55e; --error:#ef4444; --purple:#8b5cf6;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
h1{margin:0 0 10px 0;font-size:clamp(20px,4vw,32px)}
.version{background:var(--purple);color:white;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:bold;margin-left:8px}
.sub{color:var(--muted);font-size:clamp(12px,2.5vw,14px);margin-bottom:16px;line-height:1.4}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:768px){.grid{gap:16px}}
@media(min-width:1080px){.grid{grid-template-columns:1.15fr .85fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
@media(min-width:768px){.card{border-radius:16px;padding:16px}}
.card h2{margin:0 0 12px 0;font-size:clamp(16px,3vw,18px)}
label{display:block;margin:8px 0 4px 0;color:var(--muted);font-size:clamp(11px,2.5vw,12px)}
input[type="text"],input[type="number"],select{
  width:100%;padding:10px 8px;border-radius:8px;border:1px solid var(--border);background:#0e141b;color:var(--fg);font-size:14px;
}
@media(min-width:768px){
  input[type="text"],input[type="number"],select{padding:11px 12px;border-radius:12px}
}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
@media(min-width:768px){.row{gap:10px}}
.col{flex:1;min-width:160px}
@media(min-width:768px){.col{min-width:210px}}
button{appearance:none;border:none;background:var(--accent);color:#031225;padding:12px 16px;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;width:100%;margin:4px 0}
@media(min-width:768px){button{padding:10px 14px;border-radius:12px;width:auto;margin:0}}
button.ghost{background:transparent;color:var(--fg);border:1px solid var(--border)}
button.success{background:var(--success)}
button.warn{background:var(--warn)}
button.error{background:var(--error)}
.small{font-size:clamp(11px,2.5vw,12px);color:var(--muted)}
.kbd{padding:1px 6px;border:1px solid var(--border);border-radius:6px;background:#0b1218;color:var(--muted)}
.resultBox{border:1px dashed var(--border);border-radius:8px;padding:12px;margin-top:10px}
@media(min-width:768px){.resultBox{border-radius:12px;padding:14px}}
.big{font-size:clamp(18px,4vw,22px);font-weight:900;line-height:1.2}
.progress{height:12px;background:#0b1218;border:1px solid var(--border);border-radius:999px;overflow:hidden}
@media(min-width:768px){.progress{height:14px}}
.progress>div{height:100%;background:linear-gradient(90deg,#0ea5e9,#22c55e);width:0%}
.flex{display:flex;justify-content:space-between;gap:6px;align-items:center;flex-wrap:wrap}
@media(min-width:768px){.flex{gap:8px;flex-wrap:nowrap}}
.table{width:100%;border-collapse:collapse;margin-top:8px;font-size:12px}
@media(min-width:768px){.table{font-size:13px}}
.table th,.table td{border-bottom:1px solid var(--border);padding:6px 4px}
@media(min-width:768px){.table th,.table td{padding:8px 6px}}
.badge{display:inline-block;background:#0b1218;border:1px solid var(--border);padding:3px 6px;border-radius:999px;color:var(--muted);font-size:10px;margin:2px 4px 2px 0}
@media(min-width:768px){.badge{padding:4px 8px;font-size:12px;margin-right:6px}}
.note{display:inline-block;margin-top:6px;padding:6px 8px;border:1px solid var(--border);border-radius:8px;color:var(--muted);font-size:clamp(10px,2.5vw,12px)}
@media(min-width:768px){.note{padding:6px 10px;border-radius:10px}}
.section{margin-top:10px;padding-top:8px;border-top:1px dashed var(--border)}
.notification{position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:8px;color:white;font-weight:bold;z-index:1000;max-width:300px}
.notification.success{background:var(--success)}
.notification.error{background:var(--error)}
.notification.info{background:var(--accent)}
</style>

<!-- SEO additions (non-visual): canonical, robots, OG/Twitter, JSON-LD. -->
<link href="https://stberry.us/rank" rel="canonical"/>
<meta content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1" name="robots"/>
<meta content="index,follow" name="googlebot"/>
<meta content="index,follow" name="bingbot"/>
<!-- Open Graph refinements -->
<meta content="https://stberry.us/rank" property="og:url"/>
<meta content="stberry.us" property="og:site_name"/>
<meta content="en_US" property="og:locale"/>
<!-- Twitter refinements -->
<meta content="@stberry_us" name="twitter:site"/>
<!-- Extra discoverability keywords (typo-safe) -->
<meta content="worldrank, world rank, global rank, wealth percentile, income percentile, worldrnk, worldrnak, wroldrank, wolrdrank, wordrank, world-bank, worldbnk, woldbank, wordbank, wolrdbank, worldban, worldbnak, world bnak, worldbak, world agbnk, world ank, worldbanck, worldbanlk, worldbqnk, worldbark, worldbznk, worldank" name="keywords"/>
<!-- JSON-LD: WebSite (SearchAction) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "stberry.us",
  "url": "https://stberry.us/",
  "potentialAction": {
    "@type": "SearchAction",
    "target": "https://stberry.us/search?q={search_term_string}",
    "query-input": "required name=search_term_string"
  }
}
</script>
<!-- JSON-LD: WebPage -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "Global Human Ranking Calculator - Find Your World Rank Among 8.2 Billion People",
  "url": "https://stberry.us/rank",
  "description": "Calculate your precise global ranking among 8.2 billion people worldwide. Discover where you stand globally based on wealth, income, education, health, and demographics."
}
</script>
<!-- JSON-LD: Breadcrumbs -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://stberry.us/" },
    { "@type": "ListItem", "position": 2, "name": "Rank", "item": "https://stberry.us/rank" }
  ]
}
</script>
</head>
<body>
<div class="wrap">
<header>
<h1>Global Human Ranking Calculator <span style="color:var(--accent)">üåç</span></h1>
<div class="sub">Discover your precise position among <b id="headerPopulation">8.25 billion</b> people worldwide. Find out where you rank globally based on wealth, demographics, and personal data.</div>
<!-- Real-time World Population Counter -->
<div style="background:#1a202c; border-radius:12px; padding:12px; margin:10px 0; border:1px solid var(--border)">
<div style="text-align:center">
<div style="font-size:clamp(11px,2.5vw,12px); color:var(--muted); margin-bottom:4px">üåç Current World Population</div>
<div id="worldPopulation" style="font-size:clamp(18px,4vw,24px); font-weight:bold; color:var(--accent); font-family:monospace; transition:transform 0.2s ease, text-shadow 0.2s ease">8,246,975,554</div>
<div style="font-size:clamp(10px,2vw,11px); color:var(--muted); margin-top:4px">
<span id="populationGrowth">+0</span> people since you opened this page
        </div>
</div>
<!-- Population Growth Statistics -->
<div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:10px; font-size:clamp(9px,2vw,10px); text-align:center">
<div style="padding:4px; background:#0e141b; border-radius:6px">
<div id="birthsToday" style="color:var(--accent); font-weight:bold">+0</div>
<div style="color:var(--muted)">üë∂ Births today</div>
</div>
<div style="padding:4px; background:#0e141b; border-radius:6px">
<div style="color:var(--green); font-weight:bold">+4.2/sec</div>
<div style="color:var(--muted)">üìà Growth rate</div>
</div>
<div style="padding:4px; background:#0e141b; border-radius:6px">
<div id="deathsToday" style="color:var(--warn); font-weight:bold">+0</div>
<div style="color:var(--muted)">üíÄ Deaths today</div>
</div>
</div>
</div>
<div>
<span class="badge">Real-time Analysis</span>
<span class="badge">Global Coverage</span>
<span class="badge">Wealth Data</span>
<span class="badge">Live Population</span>
</div>
<!-- Calculate Button at Top -->
<div style="margin:20px 0; text-align:center">
<button id="btnCalc" style="font-size:18px; padding:16px 32px; font-weight:bold; border-radius:16px; background:linear-gradient(135deg, var(--accent), #3b82f6); border:none; color:white; cursor:pointer; box-shadow:0 4px 12px rgba(96,165,250,0.3); transition:transform 0.2s ease">üéØ Calculate My Global Rank</button>
</div>
</header>
<section class="grid">
<div class="card">
<h2>Personal Information</h2>
<div class="row">
<div class="col">
<label>Country</label>
<input id="country" list="countryList" placeholder="e.g., South Korea, United States, Japan"/><datalist id="countryList"></datalist>
</div>
<div class="col">
<label>Gender</label>
<select id="sex">
<option value="male">Male</option>
<option value="female">Female</option>
<option value="other">Other / Prefer not to say</option>
</select>
</div>
<div class="col">
<label>Birth Date</label>
<div class="row" style="gap:6px">
<input id="birthYear" max="2025" min="1900" placeholder="Year" step="1" style="flex:2" type="number"/>
<select id="birthMonth" style="flex:1">
<option value="">Month</option>
<option value="1">Jan</option>
<option value="2">Feb</option>
<option value="3">Mar</option>
<option value="4">Apr</option>
<option value="5">May</option>
<option value="6">Jun</option>
<option value="7">Jul</option>
<option value="8">Aug</option>
<option value="9">Sep</option>
<option value="10">Oct</option>
<option value="11">Nov</option>
<option value="12">Dec</option>
</select>
<input id="birthDay" max="31" min="1" placeholder="Day" step="1" style="flex:1" type="number"/>
</div>
</div>
<div class="col" style="min-width:120px">
<label>Current Age</label>
<div id="calculatedAge" style="padding:11px 12px; border-radius:12px; border:1px solid var(--border); background:#0e141b; color:var(--accent); font-weight:bold; text-align:center">Enter birth date</div>
</div>
</div>
<div class="row">
<div class="col">
<label>Self-reported health</label>
<select id="health">
<option value="good">Good</option>
<option value="excellent">Excellent</option>
<option value="fair">Fair</option>
<option value="poor">Poor</option>
<option value="na">Prefer not to say</option>
</select>
</div>
<div class="col">
<label>Units</label>
<select id="units">
<option selected="" value="metric">Metric (cm, kg)</option>
<option value="imperial">Imperial (ft/in, lb)</option>
</select>
</div>
<div class="col metric-only">
<label>Height (cm)</label>
<input id="heightCm" max="250" min="80" placeholder="e.g., 175" step="0.1" type="number"/>
</div>
<div class="col metric-only">
<label>Weight (kg)</label>
<input id="weightKg" max="300" min="20" placeholder="e.g., 70" step="0.1" type="number"/>
</div>
<div class="col imperial-only" style="display:none">
<label>Height (ft + in)</label>
<div class="row" style="gap:6px">
<input id="heightFt" max="8" min="3" placeholder="ft" step="1" style="flex:1" type="number"/>
<input id="heightIn" max="11" min="0" placeholder="in" step="1" style="flex:1" type="number"/>
</div>
</div>
<div class="col imperial-only" style="display:none">
<label>Weight (lb)</label>
<input id="weightLb" max="600" min="50" placeholder="e.g., 154" step="0.1" type="number"/>
</div>
</div>
<div class="row">
<div class="col">
<label>Cash &amp; Savings (USD)</label>
<input id="cash" min="0" placeholder="e.g., 50000" step="100" type="number"/>
</div>
<div class="col">
<label>Real Estate Value (USD)</label>
<input id="realEstate" min="0" placeholder="e.g., 300000" step="1000" type="number"/>
</div>
<div class="col">
<label>Stock/Investment Value (USD)</label>
<input id="stocks" min="0" placeholder="e.g., 75000" step="100" type="number"/>
</div>
<div class="col">
<label>Total Debt (USD)</label>
<input id="debt" min="0" placeholder="e.g., 25000" step="100" type="number"/>
</div>
</div>
<div class="row">
<div class="col">
<label>Annual Income (USD)</label>
<input id="income" min="0" placeholder="e.g., 80000" step="100" type="number"/>
</div>
</div>
<div class="row">
<div class="col">
<label>Education</label>
<select id="education">
<option value="hs">High school or below</option>
<option value="somecollege">Some college</option>
<option value="bachelor">Bachelor's</option>
<option value="master">Master's</option>
<option value="doctorate">Doctorate</option>
</select>
</div>
<div class="col">
<label>University (optional, display-only)</label>
<input id="university" placeholder="e.g., University of Michigan" type="text"/>
</div>
<div class="col">
<label>Race / Ethnicity (not used in score)</label>
<select id="race">
<option value="na">Prefer not to say</option>
<option value="asian">Asian</option>
<option value="black">Black</option>
<option value="white">White</option>
<option value="latino">Hispanic / Latino</option>
<option value="mena">Middle Eastern / North African</option>
<option value="indigenous">Indigenous</option>
<option value="pi">Pacific Islander</option>
<option value="other">Other</option>
</select>
</div>
</div>
<div class="row">
<div class="col">
<label>Children</label>
<input id="children" max="12" min="0" step="1" type="number" value="0"/>
</div>
<div class="col">
<label>Expected Life Span (years) - Auto-calculated</label>
<input id="lifeExpectancy" max="120" min="50" placeholder="Auto-calculated" readonly="" step="1" style="background:#0b1218; color:var(--accent);" type="number"/>
<div class="small" style="margin-top:2px">
<label style="display:inline; margin:0; cursor:pointer">
<input id="lifeExpectancyManual" style="margin-right:4px" type="checkbox"/> Manual override
            </label>
</div>
</div>
<div class="col">
<label>Happiness Score (1-10) - Auto-estimated</label>
<input id="happiness" max="10" min="1" placeholder="Auto-calculated" readonly="" step="0.1" style="background:#0b1218; color:var(--accent);" type="number"/>
<div class="small" style="margin-top:2px">
<label style="display:inline; margin:0; cursor:pointer">
<input id="happinessManual" style="margin-right:4px" type="checkbox"/> Manual override
            </label>
</div>
</div>
</div>
<div class="row">
<div class="col">
<label>Father Status</label>
<select id="fatherStatus">
<option value="alive">Alive</option>
<option value="deceased">Deceased</option>
</select>
</div>
<div class="col" id="fatherAgeGroup">
<label id="fatherAgeLabel">Father's Current Age</label>
<input id="fatherAge" max="120" min="30" placeholder="e.g., 65" step="1" type="number"/>
</div>
<div class="col">
<label>Mother Status</label>
<select id="motherStatus">
<option value="alive">Alive</option>
<option value="deceased">Deceased</option>
</select>
</div>
<div class="col" id="motherAgeGroup">
<label id="motherAgeLabel">Mother's Current Age</label>
<input id="motherAge" max="120" min="30" placeholder="e.g., 62" step="1" type="number"/>
</div>
</div>
</div>
<div class="card">
<h2>Your Global Rank üéØ</h2>
<div class="resultBox" id="result">Enter inputs and click <span class="kbd">Calculate</span>.</div>
<!-- Enhanced Global Population Visualization -->
<div id="populationViz" style="display:none; margin:15px 0">
<div class="small" id="populationVizTitle" style="margin-bottom:8px; font-weight:bold">üåç Your Position Among 8.25 Billion People</div>
<div style="display:flex; align-items:center; gap:10px; margin-bottom:10px">
<div style="flex:1; height:24px; background:#1e293b; border-radius:12px; overflow:hidden; position:relative; border:1px solid var(--border)">
<div id="rankBar" style="height:100%; background:linear-gradient(90deg,#ef4444,#f97316,#eab308,#22c55e); border-radius:12px; width:0%; transition:width 0.8s ease"></div>
<div id="rankMarker" style="position:absolute; top:-2px; width:3px; height:28px; background:#fff; left:0%; transition:left 0.8s ease; box-shadow:0 0 8px rgba(255,255,255,0.6)"></div>
</div>
<div class="small" id="rankPosition" style="font-weight:bold; color:var(--accent)">You</div>
</div>
<div style="display:flex; justify-content:space-between; font-size:11px; color:var(--muted)">
<span>üë∂ Rank 8.25B (Bottom)</span>
<span>üëë Rank 1 (Top)</span>
</div>
<div id="rankDetails" style="margin-top:8px; padding:8px; background:#1a202c; border-radius:8px; font-size:11px"></div>
</div>
<!-- Enhanced Wealth Breakdown Chart -->
<div id="wealthChart" style="display:none; margin:15px 0">
<div class="small" style="margin-bottom:8px; font-weight:bold">üí∞ Your Wealth Breakdown</div>
<div id="wealthBars"></div>
<div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px; font-size:11px">
<div style="padding:4px 8px; background:#1a202c; border-radius:6px">
<div class="small" style="color:var(--muted)">Net Worth</div>
<div id="netWorthTotal" style="font-weight:bold; color:var(--green)">$0</div>
</div>
<div style="padding:4px 8px; background:#1a202c; border-radius:6px">
<div class="small" style="color:var(--muted)">Wealth Rank</div>
<div id="wealthRankDisplay" style="font-weight:bold; color:var(--accent)">-</div>
</div>
</div>
</div>
<!-- Enhanced Comparison Charts -->
<div id="comparisonCharts" style="display:none; margin:15px 0">
<div class="small" style="margin-bottom:8px; font-weight:bold">üìä How You Compare Globally</div>
<div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:12px">
<div>
<div class="small" style="margin-bottom:5px">üë• Age Distribution</div>
<div id="ageChart" style="height:60px; background:#1e293b; border-radius:8px; position:relative; overflow:hidden; border:1px solid var(--border)"></div>
</div>
<div>
<div class="small" style="margin-bottom:5px">üíµ Income Distribution</div>
<div id="incomeChart" style="height:60px; background:#1e293b; border-radius:8px; position:relative; overflow:hidden; border:1px solid var(--border)"></div>
</div>
</div>
<div style="display:grid; grid-template-columns:1fr 1fr; gap:15px">
<div>
<div class="small" style="margin-bottom:5px">üéì Education Level</div>
<div id="educationChart" style="height:60px; background:#1e293b; border-radius:8px; position:relative; overflow:hidden; border:1px solid var(--border)"></div>
</div>
<div>
<div class="small" style="margin-bottom:5px">üè• Health Status</div>
<div id="healthChart" style="height:60px; background:#1e293b; border-radius:8px; position:relative; overflow:hidden; border:1px solid var(--border)"></div>
</div>
</div>
</div>
<!-- Enhanced Fun Facts -->
<div id="funFacts" style="display:none; margin:15px 0; padding:12px; background:#1a202c; border-radius:10px; border:1px solid var(--border)">
<div class="small" style="margin-bottom:8px; font-weight:bold">üéâ Amazing Facts About Your Global Position</div>
<div id="factsContent" style="font-size:12px; line-height:1.4"></div>
<div id="comparisonFacts" style="margin-top:8px; padding-top:8px; border-top:1px solid var(--border); font-size:11px; color:var(--muted)"></div>
</div>
<!-- Enhanced Life Timeline -->
<div id="lifeTimeline" style="display:none; margin:15px 0">
<div class="small" style="margin-bottom:8px; font-weight:bold">‚è∞ Your Life Journey</div>
<div id="timelineViz" style="background:#1a202c; border-radius:10px; padding:12px; margin-bottom:8px; border:1px solid var(--border)">
<div style="display:flex; align-items:center; margin-bottom:8px">
<div style="width:60px; font-size:11px">Life</div>
<div style="flex:1; height:24px; background:#2a2a2a; border-radius:12px; overflow:hidden; position:relative; margin:0 8px">
<div id="lifeProgress" style="height:100%; background:linear-gradient(90deg,#22c55e,#eab308,#ef4444); border-radius:12px; width:0%; transition:width 0.8s ease"></div>
<div id="lifeMarker" style="position:absolute; top:-2px; width:3px; height:28px; background:#fff; left:0%; transition:left 0.8s ease"></div>
</div>
<div id="lifeYears" style="width:80px; font-size:11px; text-align:right">0 years</div>
</div>
<div style="display:flex; justify-content:space-between; font-size:10px; color:var(--muted)">
<span>üçº Birth</span>
<span id="currentLifeStage" style="color:var(--accent); font-weight:bold">Current</span>
<span>üíÄ Expected End</span>
</div>
</div>
<div id="parentAges" style="font-size:11px; color:var(--muted)"></div>
<div id="lifeStatsGrid" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; margin-top:8px; font-size:10px"></div>
</div>
<!-- Enhanced Happiness Visualization -->
<div id="happinessViz" style="display:none; margin:15px 0">
<div class="small" style="margin-bottom:8px; font-weight:bold">üòä Your Happiness &amp; Well-being</div>
<div style="background:#1a202c; border-radius:10px; padding:12px; border:1px solid var(--border)">
<div style="display:flex; align-items:center; margin-bottom:8px">
<div style="width:50px; font-size:11px">üò¢ 1</div>
<div style="flex:1; height:28px; background:#2a2a2a; border-radius:14px; overflow:hidden; position:relative; margin:0 8px">
<div id="happinessBar" style="height:100%; background:linear-gradient(90deg,#ef4444,#eab308,#22c55e); border-radius:14px; width:0%; transition:width 0.8s ease"></div>
<div id="happinessMarker" style="position:absolute; top:2px; width:24px; height:24px; background:rgba(255,255,255,0.95); border-radius:12px; left:0%; transition:left 0.8s ease; display:flex; align-items:center; justify-content:center; font-size:14px; border:2px solid #333">üòä</div>
</div>
<div style="width:50px; font-size:11px; text-align:right">üòÑ 10</div>
</div>
<div id="happinessText" style="text-align:center; font-size:12px; margin-bottom:6px">Your happiness: 0.0/10</div>
<div id="happinessComparison" style="text-align:center; font-size:10px; color:var(--muted)">World average: 5.4/10</div>
</div>
</div>
<!-- Test Results Panel -->
<div id="testResults" style="display:none; margin:15px 0; padding:12px; background:#1a202c; border-radius:10px; border:1px solid var(--border)">
<div class="small" style="margin-bottom:8px; font-weight:bold">üß™ Test Results</div>
<div id="testOutput" style="font-size:11px; line-height:1.4; font-family:monospace"></div>
</div>
</div>
</section>
<footer class="small" style="margin-top:20px; padding:16px; background:#1a202c; border-radius:12px; border:1px solid var(--border)">
<div style="text-align:center; line-height:1.5">
<div style="margin-bottom:8px; color:var(--accent); font-weight:bold">Global Human Ranking Calculator</div>
<div style="color:var(--muted)">Find your exact position among billions of people worldwide ‚Ä¢ Based on real economic data from 60 countries</div>
<div style="margin-top:8px; color:var(--muted); font-size:10px">
        Data sources: World Bank, IMF, National Statistics ‚Ä¢ Updated 2025
      </div>
</div>
</footer>
</div>
<script>
// =======================
// Version 2.0 Enhanced Global Ranking System
// Features: Auto-save, Advanced Visualizations, Comprehensive Testing
// =======================

const VERSION = "2.0";
const CACHE_KEY = "globalRankData_v2";

// =======================
// Data (Enhanced)
// =======================
const WORLD_TOTAL_BASE = 8_246_975_554;
const POPULATION_GROWTH_PER_SECOND = 2.5;
let WORLD_TOTAL = WORLD_TOTAL_BASE;
let pageStartTime = Date.now();

// =======================
// Notification System
// =======================
function showNotification(message, type = 'info', duration = 3000) {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);

  setTimeout(() => {
    notification.style.opacity = '0';
    setTimeout(() => notification.remove(), 300);
  }, duration);
}



// =======================
// Population System (Same as before but enhanced)
// =======================
function updateWorldPopulation() {
  const now = Date.now();
  const secondsElapsed = (now - pageStartTime) / 1000;
  const populationIncrease = Math.floor(secondsElapsed * POPULATION_GROWTH_PER_SECOND);

  WORLD_TOTAL = WORLD_TOTAL_BASE + populationIncrease;

  const today = new Date();
  const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const secondsSinceMidnight = (now - todayStart.getTime()) / 1000;

  const birthsPerSecond = 4.3;
  const deathsPerSecond = 1.8;

  const birthsToday = Math.floor(secondsSinceMidnight * birthsPerSecond);
  const deathsToday = Math.floor(secondsSinceMidnight * deathsPerSecond);

  const popElement = document.getElementById('worldPopulation');
  const growthElement = document.getElementById('populationGrowth');
  const birthsElement = document.getElementById('birthsToday');
  const deathsElement = document.getElementById('deathsToday');
  const headerPopElement = document.getElementById('headerPopulation');

  if (popElement) {
    popElement.textContent = WORLD_TOTAL.toLocaleString('en-US');

    if (populationIncrease > 0 && populationIncrease % Math.floor(POPULATION_GROWTH_PER_SECOND) === 0) {
      popElement.style.transform = 'scale(1.05)';
      popElement.style.textShadow = '0 0 10px var(--accent)';

      setTimeout(() => {
        popElement.style.transform = 'scale(1)';
        popElement.style.textShadow = 'none';
      }, 200);
    }
  }

  if (headerPopElement) {
    headerPopElement.textContent = `${(WORLD_TOTAL / 1000000000).toFixed(2)} billion`;
  }

  if (growthElement) {
    growthElement.textContent = populationIncrease > 0 ? `+${populationIncrease.toLocaleString('en-US')}` : '+0';
    growthElement.style.color = populationIncrease > 0 ? '#22c55e' : 'var(--muted)';
  }

  if (birthsElement) birthsElement.textContent = `+${birthsToday.toLocaleString('en-US')}`;
  if (deathsElement) deathsElement.textContent = `+${deathsToday.toLocaleString('en-US')}`;

  // Update any existing ranking if shown
  if (window.__lastResult) {
    const rank = Math.round(WORLD_TOTAL * (1 - window.__lastResult.composite_percentile));

    // Update main rank display
    const rankElement = document.querySelector('.big b[style*="color:var(--accent)"]');
    if (rankElement) {
      rankElement.textContent = `#${fmtInt(rank)}`;
    }

    // Update total population in main result
    const totalPopElement = document.querySelector('.big');
    if (totalPopElement) {
      totalPopElement.innerHTML = `üèÜ Global Rank: <b style="color:var(--accent)">#${fmtInt(rank)}</b> out of ~${fmtInt(WORLD_TOTAL)} people`;
    }

    // Update visualization elements
    const currentRankElement = document.getElementById('currentRank');
    if (currentRankElement) {
      currentRankElement.textContent = `#${fmtInt(rank)}`;
    }

    const peopleAboveElement = document.getElementById('peopleAbove');
    if (peopleAboveElement) {
      const peopleAbove = Math.round(WORLD_TOTAL * (1 - window.__lastResult.composite_percentile));
      peopleAboveElement.textContent = fmtInt(peopleAbove);
    }

    const populationVizTitle = document.getElementById('populationVizTitle');
    if (populationVizTitle) {
      populationVizTitle.textContent = `üåç Your Position Among ${(WORLD_TOTAL / 1000000000).toFixed(2)} Billion People`;
    }

    // Update country-specific ranking if available
    const countryRankElement = document.getElementById('countryRank');
    if (countryRankElement && window.__lastResult.country && ALL_COUNTRIES[window.__lastResult.country]) {
      const countryPopulation = getCurrentCountryPopulation(window.__lastResult.country);
      const countryRank = Math.round(countryPopulation * (1 - window.__lastResult.composite_percentile));
      countryRankElement.textContent = `#${fmtInt(countryRank)}`;
    }

    // Update country population display if available
    const countryPopulationElement = document.getElementById('countryPopulation');
    if (countryPopulationElement && window.__lastResult.country && POPULATION_PROJECTIONS[window.__lastResult.country]) {
      const countryPopulation = getCurrentCountryPopulation(window.__lastResult.country);
      const currentPop = (countryPopulation / 1000000).toFixed(1);
      const projectedPop2030 = POPULATION_PROJECTIONS[window.__lastResult.country].pop_2030;
      countryPopulationElement.textContent = `${currentPop}M (${projectedPop2030}M by 2030)`;
    }
  }
}

// =======================
// Country Data (Updated from GitHub CSV)
// =======================
const COUNTRY_RANK_DATA = {
  "Switzerland": {rank: 1, gdp: 878.3, gdp_per_capita: 99398, population: 8.8},
  "Japan": {rank: 2, gdp: 4264.6, gdp_per_capita: 34017, population: 125.4},
  "United States": {rank: 3, gdp: 27400.0, gdp_per_capita: 82034, population: 334.2},
  "Germany": {rank: 4, gdp: 4263.2, gdp_per_capita: 50794, population: 84.0},
  "United Kingdom": {rank: 5, gdp: 3130.7, gdp_per_capita: 46125, population: 67.9},
  "Singapore": {rank: 6, gdp: 404.0, gdp_per_capita: 65233, population: 6.2},
  "Canada": {rank: 7, gdp: 2090.0, gdp_per_capita: 54166, population: 38.6},
  "France": {rank: 8, gdp: 2940.0, gdp_per_capita: 43659, population: 67.3},
  "Netherlands": {rank: 9, gdp: 1013.6, gdp_per_capita: 57101, population: 17.8},
  "South Korea": {rank: 10, gdp: 1813.0, gdp_per_capita: 35196, population: 51.5},
  "Sweden": {rank: 11, gdp: 635.7, gdp_per_capita: 60239, population: 10.6},
  "Norway": {rank: 12, gdp: 482.2, gdp_per_capita: 89154, population: 5.4},
  "Australia": {rank: 13, gdp: 1553.0, gdp_per_capita: 59934, population: 25.9},
  "Denmark": {rank: 14, gdp: 395.0, gdp_per_capita: 67218, population: 5.9},
  "Israel": {rank: 15, gdp: 481.6, gdp_per_capita: 52170, population: 9.2},
  "Finland": {rank: 16, gdp: 300.2, gdp_per_capita: 54327, population: 5.5},
  "Austria": {rank: 17, gdp: 479.8, gdp_per_capita: 53268, population: 9.0},
  "Belgium": {rank: 18, gdp: 594.4, gdp_per_capita: 51247, population: 11.6},
  "New Zealand": {rank: 19, gdp: 249.9, gdp_per_capita: 48781, population: 5.1},
  "Ireland": {rank: 20, gdp: 499.0, gdp_per_capita: 99014, population: 5.0},
  "Luxembourg": {rank: 21, gdp: 86.6, gdp_per_capita: 132372, population: 0.654},
  "Iceland": {rank: 22, gdp: 28.8, gdp_per_capita: 73784, population: 0.394},
  "Italy": {rank: 23, gdp: 2107.7, gdp_per_capita: 35551, population: 59.3},
  "Spain": {rank: 24, gdp: 1394.1, gdp_per_capita: 29565, population: 47.2},
  "Estonia": {rank: 25, gdp: 38.6, gdp_per_capita: 29481, population: 1.3},
  "Czech Republic": {rank: 26, gdp: 295.7, gdp_per_capita: 27681, population: 10.7},
  "Slovenia": {rank: 27, gdp: 63.6, gdp_per_capita: 30693, population: 2.1},
  "Taiwan": {rank: 28, gdp: 790.7, gdp_per_capita: 33565, population: 23.6},
  "Portugal": {rank: 29, gdp: 253.0, gdp_per_capita: 24252, population: 10.4},
  "Poland": {rank: 30, gdp: 688.2, gdp_per_capita: 18341, population: 37.5},
  "Lithuania": {rank: 31, gdp: 71.0, gdp_per_capita: 26024, population: 2.7},
  "Slovakia": {rank: 32, gdp: 118.0, gdp_per_capita: 21694, population: 5.4},
  "Latvia": {rank: 33, gdp: 40.9, gdp_per_capita: 21685, population: 1.9},
  "Cyprus": {rank: 34, gdp: 32.2, gdp_per_capita: 36335, population: 0.896},
  "Chile": {rank: 35, gdp: 317.1, gdp_per_capita: 16265, population: 19.5},
  "Russia": {rank: 36, gdp: 2240.4, gdp_per_capita: 15345, population: 146.0},
  "Greece": {rank: 37, gdp: 219.1, gdp_per_capita: 20821, population: 10.5},
  "Uruguay": {rank: 38, gdp: 64.0, gdp_per_capita: 18397, population: 3.5},
  "Hungary": {rank: 39, gdp: 178.8, gdp_per_capita: 18728, population: 9.5},
  "China": {rank: 40, gdp: 17700.9, gdp_per_capita: 12541, population: 1412.0},
  "Turkey": {rank: 41, gdp: 819.0, gdp_per_capita: 9661, population: 84.8},
  "Costa Rica": {rank: 42, gdp: 68.4, gdp_per_capita: 13339, population: 5.1},
  "Malaysia": {rank: 43, gdp: 432.2, gdp_per_capita: 13315, population: 32.5},
  "Panama": {rank: 44, gdp: 75.5, gdp_per_capita: 17398, population: 4.3},
  "Romania": {rank: 45, gdp: 284.1, gdp_per_capita: 14858, population: 19.1},
  "Croatia": {rank: 46, gdp: 70.2, gdp_per_capita: 17685, population: 4.0},
  "Argentina": {rank: 47, gdp: 489.0, gdp_per_capita: 10729, population: 45.6},
  "Brazil": {rank: 48, gdp: 2055.5, gdp_per_capita: 9638, population: 215.3},
  "Montenegro": {rank: 49, gdp: 6.2, gdp_per_capita: 9929, population: 0.628},
  "Bulgaria": {rank: 50, gdp: 84.1, gdp_per_capita: 12221, population: 6.9},
  "Mexico": {rank: 51, gdp: 1293.0, gdp_per_capita: 10045, population: 128.9},
  "Thailand": {rank: 52, gdp: 534.8, gdp_per_capita: 7607, population: 70.2},
  "Serbia": {rank: 53, gdp: 63.1, gdp_per_capita: 9230, population: 6.8},
  "South Africa": {rank: 54, gdp: 419.0, gdp_per_capita: 7055, population: 59.4},
  "Colombia": {rank: 55, gdp: 343.6, gdp_per_capita: 6687, population: 51.4},
  "Peru": {rank: 56, gdp: 242.6, gdp_per_capita: 7126, population: 33.0},
  "India": {rank: 57, gdp: 3737.9, gdp_per_capita: 2612, population: 1430.0},
  "Indonesia": {rank: 58, gdp: 1319.1, gdp_per_capita: 4786, population: 275.5},
  "Ukraine": {rank: 59, gdp: 170.0, gdp_per_capita: 4830, population: 36.7},
  "Nigeria": {rank: 60, gdp: 440.8, gdp_per_capita: 2066, population: 223.8}
};

// Additional countries with estimated data for broader coverage
const ADDITIONAL_COUNTRIES = {
  "Afghanistan": {rank: 195, gdp: 14.8, gdp_per_capita: 363, population: 41.1},
  "Albania": {rank: 90, gdp: 18.3, gdp_per_capita: 6494, population: 2.8},
  "Algeria": {rank: 65, gdp: 191.9, gdp_per_capita: 4279, population: 44.9},
  "Angola": {rank: 85, gdp: 94.6, gdp_per_capita: 2790, population: 33.9},
  "Armenia": {rank: 95, gdp: 13.7, gdp_per_capita: 4622, population: 3.0},
  "Azerbaijan": {rank: 70, gdp: 54.6, gdp_per_capita: 5415, population: 10.1},
  "Bahrain": {rank: 45, gdp: 44.4, gdp_per_capita: 28433, population: 1.7},
  "Bangladesh": {rank: 110, gdp: 460.2, gdp_per_capita: 2688, population: 171.2},
  "Belarus": {rank: 80, gdp: 68.2, gdp_per_capita: 7240, population: 9.4},
  "Bolivia": {rank: 125, gdp: 40.9, gdp_per_capita: 3434, population: 11.9},
  "Bosnia and Herzegovina": {rank: 105, gdp: 24.5, gdp_per_capita: 7481, population: 3.3},
  "Botswana": {rank: 75, gdp: 18.3, gdp_per_capita: 7348, population: 2.4},
  "Cambodia": {rank: 130, gdp: 27.2, gdp_per_capita: 1625, population: 16.7},
  "Cameroon": {rank: 140, gdp: 42.1, gdp_per_capita: 1531, population: 27.5},
  "Dominican Republic": {rank: 85, gdp: 112.0, gdp_per_capita: 10230, population: 11.0},
  "Ecuador": {rank: 95, gdp: 115.0, gdp_per_capita: 6423, population: 17.9},
  "Egypt": {rank: 100, gdp: 469.1, gdp_per_capita: 4295, population: 109.3},
  "Ethiopia": {rank: 170, gdp: 111.3, gdp_per_capita: 925, population: 120.3},
  "Georgia": {rank: 100, gdp: 18.6, gdp_per_capita: 4979, population: 3.7},
  "Ghana": {rank: 120, gdp: 75.5, gdp_per_capita: 2328, population: 32.4},
  "Guatemala": {rank: 110, gdp: 85.3, gdp_per_capita: 4603, population: 18.5},
  "Iran": {rank: 115, gdp: 231.5, gdp_per_capita: 2673, population: 86.6},
  "Iraq": {rank: 105, gdp: 234.1, gdp_per_capita: 5415, population: 43.2},
  "Jamaica": {rank: 90, gdp: 16.5, gdp_per_capita: 5582, population: 3.0},
  "Jordan": {rank: 95, gdp: 47.7, gdp_per_capita: 4405, population: 10.8},
  "Kazakhstan": {rank: 60, gdp: 220.3, gdp_per_capita: 11216, population: 19.6},
  "Kenya": {rank: 135, gdp: 113.4, gdp_per_capita: 2006, population: 56.5},
  "Kuwait": {rank: 35, gdp: 175.4, gdp_per_capita: 40825, population: 4.3},
  "Lebanon": {rank: 120, gdp: 20.5, gdp_per_capita: 2955, population: 6.9},
  "Libya": {rank: 85, gdp: 45.8, gdp_per_capita: 6716, population: 6.8},
  "Morocco": {rank: 100, gdp: 134.0, gdp_per_capita: 3497, population: 38.3},
  "Myanmar": {rank: 140, gdp: 71.2, gdp_per_capita: 1299, population: 54.8},
  "Nepal": {rank: 150, gdp: 40.9, gdp_per_capita: 1336, population: 30.6},
  "North Korea": {rank: 180, gdp: 18.0, gdp_per_capita: 700, population: 25.7},
  "Oman": {rank: 55, gdp: 76.3, gdp_per_capita: 16415, population: 4.6},
  "Pakistan": {rank: 145, gdp: 383.0, gdp_per_capita: 1596, population: 240.5},
  "Paraguay": {rank: 115, gdp: 40.7, gdp_per_capita: 5821, population: 7.0},
  "Philippines": {rank: 120, gdp: 394.1, gdp_per_capita: 3499, population: 112.7},
  "Qatar": {rank: 25, gdp: 235.8, gdp_per_capita: 83891, population: 2.8},
  "Saudi Arabia": {rank: 50, gdp: 833.5, gdp_per_capita: 23186, population: 36.0},
  "Sri Lanka": {rank: 125, gdp: 84.0, gdp_per_capita: 3815, population: 22.0},
  "Tunisia": {rank: 105, gdp: 46.6, gdp_per_capita: 3807, population: 12.2},
  "United Arab Emirates": {rank: 30, gdp: 507.2, gdp_per_capita: 51475, population: 9.9},
  "Uzbekistan": {rank: 125, gdp: 80.2, gdp_per_capita: 2255, population: 35.6},
  "Venezuela": {rank: 160, gdp: 482.4, gdp_per_capita: 16745, population: 28.8},
  "Vietnam": {rank: 85, gdp: 408.8, gdp_per_capita: 4164, population: 98.2},
  "Yemen": {rank: 185, gdp: 21.6, gdp_per_capita: 676, population: 32.0},
  "Zimbabwe": {rank: 155, gdp: 28.4, gdp_per_capita: 1899, population: 15.0}
};

// =======================
// Population Projection Data (from GitHub CSV)
// =======================
const POPULATION_PROJECTIONS = {
  "China": {pop_2025: 1416.1, pop_2030: 1400.6},
  "India": {pop_2025: 1463.9, pop_2030: 1520.3},
  "United States": {pop_2025: 341.4, pop_2030: 348.1},
  "Indonesia": {pop_2025: 283.0, pop_2030: 290.9},
  "Pakistan": {pop_2025: 251.3, pop_2030: 273.8},
  "Nigeria": {pop_2025: 232.7, pop_2030: 269.1},
  "Brazil": {pop_2025: 220.8, pop_2030: 228.4},
  "Bangladesh": {pop_2025: 174.7, pop_2030: 180.9},
  "Russia": {pop_2025: 144.2, pop_2030: 142.1},
  "Mexico": {pop_2025: 133.5, pop_2030: 137.9},
  "Ethiopia": {pop_2025: 132.1, pop_2030: 150.2},
  "Japan": {pop_2025: 123.3, pop_2030: 120.8},
  "Philippines": {pop_2025: 118.6, pop_2030: 125.2},
  "Egypt": {pop_2025: 114.0, pop_2030: 123.0},
  "DR Congo": {pop_2025: 105.0, pop_2030: 119.5},
  "Vietnam": {pop_2025: 98.8, pop_2030: 100.3},
  "Turkey": {pop_2025: 86.3, pop_2030: 89.1},
  "Iran": {pop_2025: 86.8, pop_2030: 89.8},
  "Germany": {pop_2025: 83.4, pop_2030: 82.6},
  "Thailand": {pop_2025: 71.6, pop_2030: 72.2},
  "United Kingdom": {pop_2025: 68.3, pop_2030: 69.4},
  "France": {pop_2025: 68.5, pop_2030: 69.7},
  "Tanzania": {pop_2025: 68.1, pop_2030: 78.8},
  "South Africa": {pop_2025: 61.0, pop_2030: 63.8},
  "Italy": {pop_2025: 58.9, pop_2030: 57.9},
  "Kenya": {pop_2025: 57.1, pop_2030: 66.0},
  "Myanmar": {pop_2025: 55.2, pop_2030: 56.8},
  "South Korea": {pop_2025: 51.2, pop_2030: 50.4},
  "Colombia": {pop_2025: 52.9, pop_2030: 55.2},
  "Spain": {pop_2025: 47.8, pop_2030: 47.7},
  "Argentina": {pop_2025: 46.7, pop_2030: 48.4},
  "Algeria": {pop_2025: 46.8, pop_2030: 50.4},
  "Iraq": {pop_2025: 45.5, pop_2030: 52.2},
  "Afghanistan": {pop_2025: 43.3, pop_2030: 51.4},
  "Saudi Arabia": {pop_2025: 37.5, pop_2030: 40.1},
  "Uzbekistan": {pop_2025: 36.8, pop_2030: 39.5},
  "Ukraine": {pop_2025: 36.7, pop_2030: 34.9},
  "Morocco": {pop_2025: 38.8, pop_2030: 40.8},
  "Poland": {pop_2025: 37.3, pop_2030: 36.8},
  "Canada": {pop_2025: 40.1, pop_2030: 42.0},
  "Malaysia": {pop_2025: 34.4, pop_2030: 36.0},
  "Angola": {pop_2025: 37.9, pop_2030: 44.0},
  "Ghana": {pop_2025: 34.4, pop_2030: 38.8},
  "Mozambique": {pop_2025: 34.3, pop_2030: 39.6},
  "Yemen": {pop_2025: 35.0, pop_2030: 40.6},
  "Nepal": {pop_2025: 31.0, pop_2030: 32.6},
  "Australia": {pop_2025: 26.8, pop_2030: 28.2},
  "North Korea": {pop_2025: 26.1, pop_2030: 26.4},
  "Taiwan": {pop_2025: 23.4, pop_2030: 22.9},
  "Netherlands": {pop_2025: 17.6, pop_2030: 17.8},
  "Romania": {pop_2025: 18.8, pop_2030: 18.2},
  "Belgium": {pop_2025: 11.8, pop_2030: 12.0},
  "Greece": {pop_2025: 10.4, pop_2030: 10.2},
  "Czech Republic": {pop_2025: 10.8, pop_2030: 10.8},
  "Portugal": {pop_2025: 10.3, pop_2030: 10.2},
  "Sweden": {pop_2025: 10.6, pop_2030: 10.9},
  "Hungary": {pop_2025: 9.6, pop_2030: 9.4},
  "Austria": {pop_2025: 9.1, pop_2030: 9.2},
  "Switzerland": {pop_2025: 8.9, pop_2030: 9.1},
  "Israel": {pop_2025: 9.9, pop_2030: 10.7},
  "Denmark": {pop_2025: 5.9, pop_2030: 6.0},
  "Finland": {pop_2025: 5.6, pop_2030: 5.6},
  "Norway": {pop_2025: 5.5, pop_2030: 5.7},
  "Ireland": {pop_2025: 5.2, pop_2030: 5.4},
  "New Zealand": {pop_2025: 5.2, pop_2030: 5.5},
  "Singapore": {pop_2025: 6.0, pop_2030: 6.2}
};

// Combine both datasets
const ALL_COUNTRIES = {...COUNTRY_RANK_DATA, ...ADDITIONAL_COUNTRIES};

// =======================
// Population Calculation Functions
// =======================
function getCurrentCountryPopulation(country) {
  if (!POPULATION_PROJECTIONS[country]) {
    // Fallback to static data if no projection available
    return ALL_COUNTRIES[country] ? ALL_COUNTRIES[country].population * 1000000 : 0;
  }

  const currentDate = new Date();
  const currentYear = currentDate.getFullYear();
  const currentMonth = currentDate.getMonth() + 1; // 0-based to 1-based

  // Calculate progress through the year
  const yearProgress = (currentMonth - 1) / 12;

  let basePopulation, targetPopulation, baseYear, targetYear;

  if (currentYear <= 2025) {
    // Before or at 2025: interpolate between current and 2025
    baseYear = 2025;
    targetYear = 2030;
    basePopulation = POPULATION_PROJECTIONS[country].pop_2025;
    targetPopulation = POPULATION_PROJECTIONS[country].pop_2030;

    // If we're before 2025, use the 2025 projection
    if (currentYear < 2025) {
      return basePopulation * 1000000;
    }
  } else {
    // After 2025: interpolate between 2025 and 2030
    baseYear = 2025;
    targetYear = 2030;
    basePopulation = POPULATION_PROJECTIONS[country].pop_2025;
    targetPopulation = POPULATION_PROJECTIONS[country].pop_2030;
  }

  // Linear interpolation between the two years
  const totalYears = targetYear - baseYear;
  const yearsSince = currentYear - baseYear + yearProgress;
  const progress = Math.min(1, Math.max(0, yearsSince / totalYears));

  const currentPopulation = basePopulation + (targetPopulation - basePopulation) * progress;

  return Math.round(currentPopulation * 1000000); // Convert to actual population
}

// Extract country population data for compatibility
const COUNTRY_POP = {};
Object.keys(ALL_COUNTRIES).forEach(country => {
  COUNTRY_POP[country] = getCurrentCountryPopulation(country);
});

// =======================
// Wealth Ranking Data (from GitHub CSV)
// =======================
const WEALTH_RANK_DATA = [
  {percentile: 1, netWorth: 1080000, income: 200000},
  {percentile: 2, netWorth: 900000, income: 150000},
  {percentile: 3, netWorth: 750000, income: 120000},
  {percentile: 4, netWorth: 650000, income: 100000},
  {percentile: 5, netWorth: 580000, income: 90000},
  {percentile: 10, netWorth: 400000, income: 70000},
  {percentile: 15, netWorth: 300000, income: 55000},
  {percentile: 20, netWorth: 250000, income: 45000},
  {percentile: 25, netWorth: 200000, income: 40000},
  {percentile: 30, netWorth: 150000, income: 35000},
  {percentile: 35, netWorth: 120000, income: 30000},
  {percentile: 40, netWorth: 90000, income: 25000},
  {percentile: 45, netWorth: 70000, income: 22000},
  {percentile: 50, netWorth: 50000, income: 20000},
  {percentile: 55, netWorth: 35000, income: 18000},
  {percentile: 60, netWorth: 25000, income: 15000},
  {percentile: 65, netWorth: 18000, income: 12000},
  {percentile: 70, netWorth: 12000, income: 10000},
  {percentile: 75, netWorth: 8000, income: 8000},
  {percentile: 80, netWorth: 5000, income: 6000},
  {percentile: 85, netWorth: 3000, income: 4000},
  {percentile: 90, netWorth: 1500, income: 2500},
  {percentile: 95, netWorth: 500, income: 1000},
  {percentile: 99, netWorth: 0, income: 0},
  {percentile: 100, netWorth: 0, income: 0}
];

const COUNTRY_ALIASES = {
  "usa":"United States","us":"United States","u.s.":"United States","united states of america":"United States",
  "uk":"United Kingdom","great britain":"United Kingdom","britain":"United Kingdom",
  "korea":"South Korea","south korea":"South Korea","republic of korea":"South Korea",
  "russian federation":"Russia","czechia":"Czech Republic","czech republic":"Czech Republic",
  "roc":"Taiwan","republic of china":"Taiwan","chinese taipei":"Taiwan",
  "holland":"Netherlands","the netherlands":"Netherlands",
  "republic of ireland":"Ireland","eire":"Ireland",
  "costa rica":"Costa Rica","bosnia":"Bosnia and Herzegovina",
  "north macedonia":"Macedonia","fyrom":"Macedonia",
  "slovak republic":"Slovakia","slovak":"Slovakia",
  "serbian":"Serbia","srbija":"Serbia",
  "deutschland":"Germany","german":"Germany",
  "espana":"Spain","spanish":"Spain",
  "france":"France","french":"France","rep√∫blica francesa":"France",
  "italia":"Italy","italian":"Italy","repubblica italiana":"Italy",
  "polska":"Poland","polish":"Poland","republic of poland":"Poland",
  "√∂sterreich":"Austria","austrian":"Austria","republic of austria":"Austria",
  "schweiz":"Switzerland","swiss":"Switzerland","suisse":"Switzerland","svizzera":"Switzerland",
  "sverige":"Sweden","swedish":"Sweden","kingdom of sweden":"Sweden",
  "norge":"Norway","norwegian":"Norway","kingdom of norway":"Norway",
  "danmark":"Denmark","danish":"Denmark","kingdom of denmark":"Denmark",
  "suomi":"Finland","finnish":"Finland","republic of finland":"Finland",
  "slovenija":"Slovenia","slovene":"Slovenia","republic of slovenia":"Slovenia",
  "hrvatska":"Croatia","croatian":"Croatia","republic of croatia":"Croatia",
  "srbija":"Serbia","serbian":"Serbia","republic of serbia":"Serbia",
  "crna gora":"Montenegro","montenegrin":"Montenegro",
  "bulg√°ria":"Bulgaria","bulgarian":"Bulgaria","republic of bulgaria":"Bulgaria",
  "rom√¢nia":"Romania","romanian":"Romania",
  "—É–∫—Ä–∞–∏–Ω–∞":"Ukraine","ukrainian":"Ukraine",
  "ŒµŒªŒªŒ¨Œ¥Œ±":"Greece","hellenic":"Greece","hellenic republic":"Greece",
  "t√ºrkiye":"Turkey","turkish":"Turkey","republic of turkey":"Turkey",
  "—Ä–æ—Å—Å–∏—è":"Russia","russian":"Russia","russian federation":"Russia",
  "‰∏≠ÂõΩ":"China","chinese":"China","people's republic of china":"China","prc":"China",
  "Êó•Êú¨":"Japan","japanese":"Japan","nippon":"Japan","nihon":"Japan",
  "ÎåÄÌïúÎØºÍµ≠":"South Korea","ÌïúÍµ≠":"South Korea","republic of korea":"South Korea",
  "‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢":"Thailand","thai":"Thailand","kingdom of thailand":"Thailand",
  "malaysia":"Malaysia","malaysian":"Malaysia",
  "singapore":"Singapore","singaporean":"Singapore","republic of singapore":"Singapore",
  "indonesia":"Indonesia","indonesian":"Indonesia","republic of indonesia":"Indonesia",
  "india":"India","indian":"India","republic of india":"India","bharat":"India",
  "brasil":"Brazil","brazilian":"Brazil","federative republic of brazil":"Brazil",
  "argentina":"Argentina","argentinian":"Argentina","argentine republic":"Argentina",
  "m√©xico":"Mexico","mexican":"Mexico","united mexican states":"Mexico",
  "colombia":"Colombia","colombian":"Colombia","republic of colombia":"Colombia",
  "per√∫":"Peru","peruvian":"Peru","republic of peru":"Peru",
  "chile":"Chile","chilean":"Chile","republic of chile":"Chile",
  "uruguay":"Uruguay","uruguayan":"Uruguay","oriental republic of uruguay":"Uruguay",
  "costa rica":"Costa Rica","costa rican":"Costa Rica","republic of costa rica":"Costa Rica",
  "panam√°":"Panama","panamanian":"Panama","republic of panama":"Panama",
  "south africa":"South Africa","south african":"South Africa","republic of south africa":"South Africa",
  "nigeria":"Nigeria","nigerian":"Nigeria","federal republic of nigeria":"Nigeria",
  "australia":"Australia","australian":"Australia","commonwealth of australia":"Australia",
  "new zealand":"New Zealand","new zealander":"New Zealand","kiwi":"New Zealand",
  "canada":"Canada","canadian":"Canada",
  "israel":"Israel","israeli":"Israel","state of israel":"Israel",
  "luxembourg":"Luxembourg","luxembourgish":"Luxembourg","grand duchy of luxembourg":"Luxembourg",
  "iceland":"Iceland","icelandic":"Iceland","republic of iceland":"Iceland",
  "estonia":"Estonia","estonian":"Estonia","republic of estonia":"Estonia",
  "latvia":"Latvia","latvian":"Latvia","republic of latvia":"Latvia",
  "lithuania":"Lithuania","lithuanian":"Lithuania","republic of lithuania":"Lithuania",
  "cyprus":"Cyprus","cypriot":"Cyprus","republic of cyprus":"Cyprus"
};

// Populate country datalist alphabetically
(() => {
  const dl = document.getElementById('countryList');
  // Sort countries alphabetically
  const sortedCountries = Object.keys(ALL_COUNTRIES).sort();

  sortedCountries.forEach(country => {
    const option = document.createElement('option');
    option.value = country;
    dl.appendChild(option);
  });
})();

// =======================
// Utility Functions
// =======================
const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));
const fmtInt = (n) => n.toLocaleString('en-US');
const pct = (p) => Math.round(p*1000)/10;

function canonicalCountry(name){
  if(!name) return 'Other';
  const raw = name.trim();
  if(COUNTRY_POP[raw]) return raw;
  const low = raw.toLowerCase();
  if(COUNTRY_ALIASES[low]) return COUNTRY_ALIASES[low];
  const title = raw.replace(/\b\w/g, c=>c.toUpperCase());
  if(COUNTRY_POP[title]) return title;
  return 'Other';
}

function calculateAge(birthYear, birthMonth, birthDay) {
  if (!birthYear) return 0;

  const today = new Date();
  const birth = new Date(birthYear, (birthMonth || 1) - 1, birthDay || 1);

  let age = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();

  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
    age--;
  }

  return Math.max(0, age);
}

function updateAge() {
  const birthYear = +document.getElementById('birthYear').value;
  const birthMonth = +document.getElementById('birthMonth').value || null;
  const birthDay = +document.getElementById('birthDay').value || null;

  const age = calculateAge(birthYear, birthMonth, birthDay);
  const ageDisplay = document.getElementById('calculatedAge');

  if (birthYear && age >= 0) {
    ageDisplay.textContent = `${age} years old`;
    ageDisplay.style.color = 'var(--accent)';
  } else {
    ageDisplay.textContent = 'Enter birth date';
    ageDisplay.style.color = 'var(--muted)';
  }
}

function updateUnitsDisplay() {
  const units = document.getElementById('units').value;
  document.querySelectorAll('.metric-only').forEach(el=>el.style.display = units==='metric' ? 'block' : 'none');
  document.querySelectorAll('.imperial-only').forEach(el=>el.style.display = units==='imperial' ? 'block' : 'none');
}

function updateParentLabels() {
  const fatherStatus = document.getElementById('fatherStatus').value;
  const motherStatus = document.getElementById('motherStatus').value;

  document.getElementById('fatherAgeLabel').textContent =
    fatherStatus === 'deceased' ? 'Father\'s Age at Death' : 'Father\'s Current Age';
  document.getElementById('motherAgeLabel').textContent =
    motherStatus === 'deceased' ? 'Mother\'s Age at Death' : 'Mother\'s Current Age';
}

// =======================
// Auto-calculation Functions
// =======================
function calculateLifeExpectancy(country, sex, income, education, health) {
  let baseLifeExpectancy = 73; // World average

  // Country-based life expectancy adjustments
  if (ALL_COUNTRIES[country]) {
    const gdpPerCapita = ALL_COUNTRIES[country].gdp_per_capita;
    if (gdpPerCapita >= 80000) baseLifeExpectancy = 83;
    else if (gdpPerCapita >= 60000) baseLifeExpectancy = 81;
    else if (gdpPerCapita >= 40000) baseLifeExpectancy = 79;
    else if (gdpPerCapita >= 25000) baseLifeExpectancy = 77;
    else if (gdpPerCapita >= 15000) baseLifeExpectancy = 75;
    else if (gdpPerCapita >= 10000) baseLifeExpectancy = 73;
    else baseLifeExpectancy = 70;
  }

  // Gender adjustment
  if (sex === 'female') baseLifeExpectancy += 5;
  else if (sex === 'male') baseLifeExpectancy += 0;

  // Income adjustment
  if (income >= 100000) baseLifeExpectancy += 3;
  else if (income >= 50000) baseLifeExpectancy += 2;
  else if (income >= 25000) baseLifeExpectancy += 1;
  else if (income < 10000) baseLifeExpectancy -= 2;

  // Education adjustment
  switch(education) {
    case 'doctorate': baseLifeExpectancy += 4; break;
    case 'master': baseLifeExpectancy += 3; break;
    case 'bachelor': baseLifeExpectancy += 2; break;
    case 'somecollege': baseLifeExpectancy += 1; break;
    case 'hs': baseLifeExpectancy += 0; break;
  }

  // Health adjustment
  switch(health) {
    case 'excellent': baseLifeExpectancy += 5; break;
    case 'good': baseLifeExpectancy += 2; break;
    case 'fair': baseLifeExpectancy -= 2; break;
    case 'poor': baseLifeExpectancy -= 5; break;
  }

  return Math.max(50, Math.min(120, Math.round(baseLifeExpectancy)));
}

function calculateHappiness(country, income, education, health, netWorth) {
  let baseHappiness = 5.4; // World average

  // Country-based happiness adjustments
  if (ALL_COUNTRIES[country]) {
    const rank = ALL_COUNTRIES[country].rank;
    if (rank <= 10) baseHappiness += 2.0;
    else if (rank <= 20) baseHappiness += 1.5;
    else if (rank <= 30) baseHappiness += 1.0;
    else if (rank <= 40) baseHappiness += 0.5;
    else if (rank >= 50) baseHappiness -= 0.5;
  }

  // Income adjustment (diminishing returns)
  if (income >= 100000) baseHappiness += 1.5;
  else if (income >= 75000) baseHappiness += 1.2;
  else if (income >= 50000) baseHappiness += 1.0;
  else if (income >= 30000) baseHappiness += 0.7;
  else if (income >= 15000) baseHappiness += 0.3;
  else if (income < 5000) baseHappiness -= 1.0;

  // Net worth adjustment
  if (netWorth >= 500000) baseHappiness += 1.0;
  else if (netWorth >= 100000) baseHappiness += 0.7;
  else if (netWorth >= 50000) baseHappiness += 0.5;
  else if (netWorth >= 10000) baseHappiness += 0.2;
  else if (netWorth < 0) baseHappiness -= 0.8;

  // Education adjustment
  switch(education) {
    case 'doctorate': baseHappiness += 0.8; break;
    case 'master': baseHappiness += 0.6; break;
    case 'bachelor': baseHappiness += 0.4; break;
    case 'somecollege': baseHappiness += 0.2; break;
  }

  // Health adjustment
  switch(health) {
    case 'excellent': baseHappiness += 1.5; break;
    case 'good': baseHappiness += 0.8; break;
    case 'fair': baseHappiness -= 0.5; break;
    case 'poor': baseHappiness -= 1.5; break;
  }

  return Math.max(1.0, Math.min(10.0, Math.round(baseHappiness * 10) / 10));
}

function updateAutoCalculatedFields() {
  const country = canonicalCountry(document.getElementById('country').value);
  const sex = document.getElementById('sex').value;
  const income = +document.getElementById('income').value || 0;
  const education = document.getElementById('education').value;
  const health = document.getElementById('health').value;
  const cash = +document.getElementById('cash').value || 0;
  const realEstate = +document.getElementById('realEstate').value || 0;
  const stocks = +document.getElementById('stocks').value || 0;
  const debt = +document.getElementById('debt').value || 0;
  const netWorth = cash + realEstate + stocks - debt;

  // Update life expectancy if not manually overridden
  const lifeExpectancyManual = document.getElementById('lifeExpectancyManual').checked;
  if (!lifeExpectancyManual) {
    const lifeExpectancy = calculateLifeExpectancy(country, sex, income, education, health);
    document.getElementById('lifeExpectancy').value = lifeExpectancy;
  }

  // Update happiness if not manually overridden
  const happinessManual = document.getElementById('happinessManual').checked;
  if (!happinessManual) {
    const happiness = calculateHappiness(country, income, education, health, netWorth);
    document.getElementById('happiness').value = happiness;
  }
}

// =======================
// Percentile Calculation Functions (Enhanced)
// =======================
function countryCDFPercentile(country){
  // Use rank-based percentile from country data
  if(ALL_COUNTRIES[country]){
    const rank = ALL_COUNTRIES[country].rank;
    const totalCountries = Object.keys(ALL_COUNTRIES).length;
    // Convert rank to percentile (lower rank = higher percentile)
    const percentile = (totalCountries - rank + 1) / totalCountries;

    // Apply GDP per capita bonus for more accurate ranking
    const gdpPerCapita = ALL_COUNTRIES[country].gdp_per_capita;
    let bonus = 0;
    if(gdpPerCapita >= 80000) bonus = 0.15;
    else if(gdpPerCapita >= 60000) bonus = 0.12;
    else if(gdpPerCapita >= 40000) bonus = 0.08;
    else if(gdpPerCapita >= 25000) bonus = 0.05;
    else if(gdpPerCapita >= 15000) bonus = 0.02;

    return clamp(percentile + bonus, 0.2, 0.95);
  }

  // Fallback for countries not in data
  const sumKnown = Object.values(COUNTRY_POP).reduce((a,b)=>a+b,0);
  const others = Math.max(0, WORLD_TOTAL - sumKnown);
  const entries = Object.entries(COUNTRY_POP).concat([['Other', others]])
    .map(([k,v])=>({k,v}))
    .sort((a,b)=>b.v-a.v);
  let acc = 0;
  for(const e of entries){
    if(e.k === country){
      const mid = acc + e.v/2;
      return clamp(mid / WORLD_TOTAL, 0, 1);
    }
    acc += e.v;
  }
  return 0.50;
}

function sexPercentile(sex){
  if(sex==='male') return 0.505;
  if(sex==='female') return 0.495;
  return 0.500;
}

function agePercentile(age){
  const a = clamp(+age||0, 0, 110);
  if(a<=14) return 0.20*(a/14);
  if(a<=24) return 0.20 + 0.15*((a-24+14)/10);
  if(a<=34) return 0.35 + 0.15*((a-24)/10);
  if(a<=44) return 0.50 + 0.15*((a-34)/10);
  if(a<=54) return 0.65 + 0.15*((a-44)/10);
  if(a<=64) return 0.80 + 0.10*((a-54)/10);
  return 0.90 + 0.10*((a-64)/46);
}

function wealthPercentile(cash, realEstate, stocks, debt){
  const netWorth = (+cash||0) + (+realEstate||0) + (+stocks||0) - (+debt||0);

  // Use the detailed wealth ranking data from CSV
  for(let i = 0; i < WEALTH_RANK_DATA.length; i++){
    const entry = WEALTH_RANK_DATA[i];
    if(netWorth >= entry.netWorth){
      // Convert percentile to percentile from bottom (higher percentile = better)
      const percentile = (100 - entry.percentile) / 100;
      return clamp(percentile, 0.001, 0.999);
    }
  }

  // Fallback for extremely low values
  return 0.001;
}

function incomePercentile(inc){
  const x = +inc;
  if(isNaN(x)) return 0.5;

  // Use the detailed wealth ranking data from CSV for income as well
  for(let i = 0; i < WEALTH_RANK_DATA.length; i++){
    const entry = WEALTH_RANK_DATA[i];
    if(x >= entry.income){
      // Convert percentile to percentile from bottom (higher percentile = better)
      const percentile = (100 - entry.percentile) / 100;
      return clamp(percentile, 0.001, 0.999);
    }
  }

  // Fallback for extremely low values
  return 0.001;
}

function healthPercentile(h){
  if(h==='excellent') return 0.80;
  if(h==='good') return 0.65;
  if(h==='fair') return 0.45;
  if(h==='poor') return 0.25;
  return 0.50;
}

function bmiFromInputs(){
  const units = document.getElementById('units').value;
  if(units==='metric'){
    const hcm = +document.getElementById('heightCm').value;
    const wkg = +document.getElementById('weightKg').value;
    if(!hcm || !wkg) return null;
    const m = hcm/100;
    return wkg/(m*m);
  }else{
    const ft = +document.getElementById('heightFt').value;
    const inch = +document.getElementById('heightIn').value;
    const lb = +document.getElementById('weightLb').value;
    if(!ft && !inch || !lb) return null;
    const totalIn = (ft||0)*12 + (inch||0);
    if(totalIn<=0) return null;
    const m = totalIn*0.0254;
    const kg = lb*0.45359237;
    return kg/(m*m);
  }
}

function bmiPercentile(bmi){
  if(!bmi || !isFinite(bmi)) return 0.50;
  const diff = Math.abs(bmi - 22);
  const score = Math.max(0, 1 - diff/22);
  const p = 0.3 + 0.5*score;
  return clamp(p, 0.3, 0.8);
}

function educationPercentile(level){
  switch(level){
    case 'hs': return 0.50;
    case 'somecollege': return 0.65;
    case 'bachelor': return 0.85;
    case 'master': return 0.93;
    case 'doctorate': return 0.98;
    default: return 0.50;
  }
}

function familyPercentile(children, fatherStatus, fatherAge, motherStatus, motherAge, age){
  const k = Math.max(0, Math.min(12, Math.floor(+children || 0)));
  let childP;
  if(k===0) childP = 0.58;
  else if(k===1) childP = 0.66;
  else if(k===2) childP = 0.72;
  else if(k===3) childP = 0.62;
  else childP = 0.50;

  const a = clamp(+age||0,0,110);
  let parP = 0.50;

  let parentsAlive = 0;
  if(fatherStatus === 'alive' && fatherAge) parentsAlive++;
  if(motherStatus === 'alive' && motherAge) parentsAlive++;

  if(parentsAlive === 2) parP = 0.70 - (a>40?0.12:0) - (a>60?0.12:0);
  else if(parentsAlive === 1) parP = 0.52 - (a>70?0.05:0);
  else parP = 0.40 + (a>60?0.10:0);

  parP = clamp(parP, 0.25, 0.75);
  return clamp(0.65*childP + 0.35*parP, 0.25, 0.75);
}

function lifeExpectancyPercentile(lifeExp, age){
  if(!lifeExp || lifeExp <= 0) return 0.50;

  if(lifeExp < 50) return 0.05;
  if(lifeExp < 60) return 0.15;
  if(lifeExp < 65) return 0.25;
  if(lifeExp < 70) return 0.40;
  if(lifeExp < 73) return 0.50;
  if(lifeExp < 76) return 0.60;
  if(lifeExp < 80) return 0.72;
  if(lifeExp < 83) return 0.82;
  if(lifeExp < 87) return 0.90;
  if(lifeExp < 92) return 0.95;
  if(lifeExp < 97) return 0.98;
  return 0.995;
}

function happinessPercentile(happiness){
  if(!happiness || happiness <= 0) return 0.30;

  // Convert 1-10 scale to percentile
  const normalizedHappiness = (happiness - 1) / 9; // 0 to 1

  // Curve it so that higher happiness scores are more valuable
  return clamp(0.20 + normalizedHappiness * 0.75, 0.20, 0.95);
}

// Fixed weights (sum = 1.00)
const W = {
  wealth:0.50, income:0.20, education:0.08, lifeExp:0.08, happiness:0.06,
  country:0.04, health:0.02, family:0.02, age:0.00, bmi:0.00, sex:0.00, race:0.00, university:0.00
};

// =======================
// Enhanced Visualization Functions
// =======================
function updatePopulationVisualization(percentile, rank){
  const viz = document.getElementById('populationViz');
  const bar = document.getElementById('rankBar');
  const marker = document.getElementById('rankMarker');
  const position = document.getElementById('rankPosition');
  const details = document.getElementById('rankDetails');
  const title = document.getElementById('populationVizTitle');

  viz.style.display = 'block';

  // Update title with current population
  title.textContent = `üåç Your Position Among ${(WORLD_TOTAL / 1000000000).toFixed(2)} Billion People`;

  // FIXED: Use percentile directly for visualization (higher percentile = better position)
  bar.style.width = (percentile * 100) + '%';
  marker.style.left = (percentile * 100) + '%';
  position.textContent = `#${fmtInt(rank)}`;

  // Enhanced details
  const topPercent = pct(percentile);
  const peopleAbove = Math.round(WORLD_TOTAL * (1 - percentile));
  const peopleBelow = Math.round(WORLD_TOTAL * percentile);

  details.innerHTML = `
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; font-size:10px; text-align:center">
      <div style="padding:4px; background:#0e141b; border-radius:4px">
        <div style="color:var(--accent); font-weight:bold" id="currentRank">#${fmtInt(rank)}</div>
        <div style="color:var(--muted)">Your Rank</div>
      </div>
      <div style="padding:4px; background:#0e141b; border-radius:4px">
        <div style="color:var(--green); font-weight:bold">${topPercent}%</div>
        <div style="color:var(--muted)">Top Percentile</div>
      </div>
      <div style="padding:4px; background:#0e141b; border-radius:4px">
        <div style="color:var(--warn); font-weight:bold" id="peopleAbove">${fmtInt(peopleAbove)}</div>
        <div style="color:var(--muted)">Above You</div>
      </div>
    </div>
  `;
}

function updateWealthChart(cash, realEstate, stocks, debt, netWorth, wealthPercentile){
  const chart = document.getElementById('wealthChart');
  const bars = document.getElementById('wealthBars');
  const total = document.getElementById('netWorthTotal');
  const wealthRank = document.getElementById('wealthRankDisplay');

  chart.style.display = 'block';
  total.textContent = `$${fmtInt(netWorth)}`;

  // Calculate wealth rank
  const wealthOnlyRank = Math.round(WORLD_TOTAL * (1 - wealthPercentile));
  wealthRank.textContent = `#${fmtInt(wealthOnlyRank)}`;

  const assets = [
    {name: 'Cash', value: cash, color: '#22c55e'},
    {name: 'Real Estate', value: realEstate, color: '#3b82f6'},
    {name: 'Stocks', value: stocks, color: '#8b5cf6'},
    {name: 'Debt', value: -debt, color: '#ef4444'}
  ];

  const maxVal = Math.max(...assets.map(a => Math.abs(a.value)));
  bars.innerHTML = assets.map(asset => {
    const width = maxVal > 0 ? (Math.abs(asset.value) / maxVal * 100) : 0;
    return `
      <div style="display:flex; align-items:center; margin:3px 0; font-size:11px">
        <div style="width:70px; min-width:70px">${asset.name}</div>
        <div style="flex:1; height:18px; background:#0b1218; border-radius:9px; overflow:hidden; margin:0 6px; border:1px solid var(--border)">
          <div style="height:100%; background:${asset.color}; width:${width}%; border-radius:9px; transition:width 0.5s ease"></div>
        </div>
        <div style="width:80px; min-width:80px; text-align:right; font-weight:bold">${asset.value >= 0 ? '$' + fmtInt(asset.value) : '-$' + fmtInt(-asset.value)}</div>
      </div>
    `;
  }).join('');
}

function updateComparisonCharts(agePercentile, incomePercentile, educationPercentile, healthPercentile){
  const charts = document.getElementById('comparisonCharts');
  const ageChart = document.getElementById('ageChart');
  const incomeChart = document.getElementById('incomeChart');
  const educationChart = document.getElementById('educationChart');
  const healthChart = document.getElementById('healthChart');

  charts.style.display = 'block';

  // Enhanced visualizations with better graphics
  ageChart.innerHTML = `
    <div style="position:absolute; bottom:0; left:0; right:0; height:100%; background:linear-gradient(0deg, #1e293b 0%, #1e293b 70%, #0ea5e9 70%, #0ea5e9 100%); border-radius:8px"></div>
    <div style="position:absolute; bottom:0; left:${agePercentile*100}%; width:4px; height:100%; background:#22c55e; border-radius:2px; box-shadow:0 0 8px #22c55e"></div>
    <div style="position:absolute; top:4px; left:4px; font-size:9px; color:#94a3b8; background:rgba(0,0,0,0.7); padding:2px 4px; border-radius:4px; font-weight:bold">üë• You: ${pct(agePercentile)}%</div>
  `;

  incomeChart.innerHTML = `
    <div style="position:absolute; bottom:0; left:0; right:0; height:100%; background:linear-gradient(0deg, #1e293b 0%, #1e293b 75%, #f59e0b 75%, #f59e0b 100%); border-radius:8px"></div>
    <div style="position:absolute; bottom:0; left:${incomePercentile*100}%; width:4px; height:100%; background:#22c55e; border-radius:2px; box-shadow:0 0 8px #22c55e"></div>
    <div style="position:absolute; top:4px; left:4px; font-size:9px; color:#94a3b8; background:rgba(0,0,0,0.7); padding:2px 4px; border-radius:4px; font-weight:bold">üíµ You: ${pct(incomePercentile)}%</div>
  `;

  educationChart.innerHTML = `
    <div style="position:absolute; bottom:0; left:0; right:0; height:100%; background:linear-gradient(0deg, #1e293b 0%, #1e293b 65%, #8b5cf6 65%, #8b5cf6 100%); border-radius:8px"></div>
    <div style="position:absolute; bottom:0; left:${educationPercentile*100}%; width:4px; height:100%; background:#22c55e; border-radius:2px; box-shadow:0 0 8px #22c55e"></div>
    <div style="position:absolute; top:4px; left:4px; font-size:9px; color:#94a3b8; background:rgba(0,0,0,0.7); padding:2px 4px; border-radius:4px; font-weight:bold">üéì You: ${pct(educationPercentile)}%</div>
  `;

  healthChart.innerHTML = `
    <div style="position:absolute; bottom:0; left:0; right:0; height:100%; background:linear-gradient(0deg, #1e293b 0%, #1e293b 60%, #22c55e 60%, #22c55e 100%); border-radius:8px"></div>
    <div style="position:absolute; bottom:0; left:${healthPercentile*100}%; width:4px; height:100%; background:#fff; border-radius:2px; box-shadow:0 0 8px #fff"></div>
    <div style="position:absolute; top:4px; left:4px; font-size:9px; color:#94a3b8; background:rgba(0,0,0,0.7); padding:2px 4px; border-radius:4px; font-weight:bold">üè• You: ${pct(healthPercentile)}%</div>
  `;
}

function updateFunFacts(rank, percentile, country, age, netWorth, income){
  const facts = document.getElementById('funFacts');
  const content = document.getElementById('factsContent');
  const comparisonFacts = document.getElementById('comparisonFacts');

  facts.style.display = 'block';

  const peopleAbove = Math.round(WORLD_TOTAL * (1 - percentile));
  const peopleBelow = Math.round(WORLD_TOTAL * percentile);
  const topPercent = pct(percentile);

  const factsList = [
    `üéØ You outrank <b style="color:#22c55e">${fmtInt(peopleBelow)}</b> people worldwide`,
    `üèÜ Only <b style="color:#f59e0b">${fmtInt(peopleAbove)}</b> people rank higher than you`,
    `üìä You're in the top <b style="color:#60a5fa">${topPercent}%</b> of all humans`,
    `üí∞ Your net worth of <b style="color:#22c55e">$${fmtInt(netWorth)}</b> ${netWorth > 500000 ? 'puts you in the global elite' : netWorth > 100000 ? 'shows strong financial health' : 'represents your economic foundation'}`,
    `üåü ${percentile > 0.95 ? 'You are among the global elite!' : percentile > 0.90 ? 'You have achieved exceptional status!' : percentile > 0.80 ? 'You are in a privileged position globally!' : percentile > 0.70 ? 'You are well above average!' : 'You are building your position!'}`
  ];

  content.innerHTML = factsList.map(fact => `<div style="margin:4px 0; padding:4px 0; border-left:3px solid var(--accent); padding-left:8px">‚Ä¢ ${fact}</div>`).join('');

  // Additional comparison facts
  const timeComparisons = [
    `‚è∞ If you lined up all ${fmtInt(WORLD_TOTAL)} people, you'd be person #${fmtInt(rank)}`,
    `üèÉ Out of every 1000 people, only ${Math.round((1-percentile)*1000)} would rank higher than you`,
    `üåé In your country (${country}), your global ranking represents top-tier status`
  ];

  comparisonFacts.innerHTML = timeComparisons.join(' ‚Ä¢ ');
}

function updateLifeTimeline(age, lifeExpectancy, fatherStatus, fatherAge, motherStatus, motherAge){
  const timeline = document.getElementById('lifeTimeline');
  const progress = document.getElementById('lifeProgress');
  const marker = document.getElementById('lifeMarker');
  const years = document.getElementById('lifeYears');
  const parentAges = document.getElementById('parentAges');
  const currentStage = document.getElementById('currentLifeStage');
  const statsGrid = document.getElementById('lifeStatsGrid');

  timeline.style.display = 'block';

  if(lifeExpectancy && lifeExpectancy > 0){
    const lifeProgress = Math.min(age / lifeExpectancy * 100, 100);
    progress.style.width = lifeProgress + '%';
    marker.style.left = lifeProgress + '%';
    years.textContent = `${age}/${lifeExpectancy} years`;

    // Determine life stage
    let stage = '';
    if(age < 13) stage = 'üë∂ Childhood';
    else if(age < 20) stage = 'üßë Adolescence';
    else if(age < 30) stage = 'üí™ Young Adult';
    else if(age < 50) stage = 'üè¢ Prime Years';
    else if(age < 65) stage = 'üåü Mature Adult';
    else stage = 'üë¥ Senior Years';

    currentStage.textContent = stage;

    // Parent information
    let parentInfo = [];
    if(fatherAge){
      if(fatherStatus === 'deceased'){
        parentInfo.push(`üë® Father: Passed at ${fatherAge}`);
      } else {
        parentInfo.push(`üë® Father: ${fatherAge} years old`);
      }
    }
    if(motherAge){
      if(motherStatus === 'deceased'){
        parentInfo.push(`üë© Mother: Passed at ${motherAge}`);
      } else {
        parentInfo.push(`üë© Mother: ${motherAge} years old`);
      }
    }
    parentAges.innerHTML = parentInfo.join(' ‚Ä¢ ');

    // Life statistics
    const remainingYears = Math.max(0, lifeExpectancy - age);
    const livedPercent = Math.round((age / lifeExpectancy) * 100);
    const statsData = [
      { label: 'Years Lived', value: `${age}`, color: 'var(--green)' },
      { label: 'Remaining', value: `${remainingYears}`, color: 'var(--warn)' },
      { label: 'Life Progress', value: `${livedPercent}%`, color: 'var(--accent)' }
    ];

    statsGrid.innerHTML = statsData.map(stat => `
      <div style="padding:4px; background:#0e141b; border-radius:4px; text-align:center">
        <div style="color:${stat.color}; font-weight:bold; font-size:11px">${stat.value}</div>
        <div style="color:var(--muted); font-size:8px">${stat.label}</div>
      </div>
    `).join('');

  } else {
    progress.style.width = '0%';
    marker.style.left = '0%';
    years.textContent = `${age} years`;
    currentStage.textContent = 'Current';
    parentAges.innerHTML = '';
    statsGrid.innerHTML = '';
  }
}

function updateHappinessVisualization(happiness){
  const viz = document.getElementById('happinessViz');
  const bar = document.getElementById('happinessBar');
  const marker = document.getElementById('happinessMarker');
  const text = document.getElementById('happinessText');
  const comparison = document.getElementById('happinessComparison');

  viz.style.display = 'block';

  if(happiness && happiness > 0){
    const happinessPercent = (happiness - 1) / 9 * 100;
    bar.style.width = happinessPercent + '%';
    marker.style.left = `calc(${happinessPercent}% - 12px)`;
    text.textContent = `Your happiness: ${happiness}/10`;

    // Dynamic emoji based on happiness level
    if(happiness >= 9) marker.textContent = 'ü§©';
    else if(happiness >= 8) marker.textContent = 'üòÑ';
    else if(happiness >= 7) marker.textContent = 'üòä';
    else if(happiness >= 6) marker.textContent = 'üôÇ';
    else if(happiness >= 5) marker.textContent = 'üòê';
    else if(happiness >= 4) marker.textContent = 'üòï';
    else if(happiness >= 3) marker.textContent = 'üòû';
    else if(happiness >= 2) marker.textContent = 'üò¢';
    else marker.textContent = 'üò≠';

    // Comparison with world average
    const diff = happiness - 5.4;
    if(diff > 0){
      comparison.textContent = `${diff.toFixed(1)} points above world average (5.4/10)`;
      comparison.style.color = 'var(--green)';
    } else if(diff < 0){
      comparison.textContent = `${Math.abs(diff).toFixed(1)} points below world average (5.4/10)`;
      comparison.style.color = 'var(--warn)';
    } else {
      comparison.textContent = 'Exactly at world average (5.4/10)';
      comparison.style.color = 'var(--muted)';
    }

  } else {
    bar.style.width = '0%';
    marker.style.left = '0%';
    text.textContent = 'Your happiness: 0.0/10';
    marker.textContent = 'üòê';
    comparison.textContent = 'World average: 5.4/10';
    comparison.style.color = 'var(--muted)';
  }
}

// =======================
// Main Calculation Function (Enhanced)
// =======================
function compute(){
  const country = canonicalCountry(document.getElementById('country').value);
  const sex = document.getElementById('sex').value;
  const birthYear = +document.getElementById('birthYear').value;
  const birthMonth = +document.getElementById('birthMonth').value || null;
  const birthDay = +document.getElementById('birthDay').value || null;
  const age = calculateAge(birthYear, birthMonth, birthDay);
  const health = document.getElementById('health').value;
  const units = document.getElementById('units').value;
  const cash = +document.getElementById('cash').value || 0;
  const realEstate = +document.getElementById('realEstate').value || 0;
  const stocks = +document.getElementById('stocks').value || 0;
  const debt = +document.getElementById('debt').value || 0;
  const income = +document.getElementById('income').value || 0;
  const education = document.getElementById('education').value;
  const university = document.getElementById('university').value.trim();
  const race = document.getElementById('race').value;
  const children = +document.getElementById('children').value;
  const lifeExpectancy = +document.getElementById('lifeExpectancy').value || 0;
  const happiness = +document.getElementById('happiness').value || 0;
  const fatherStatus = document.getElementById('fatherStatus').value;
  const fatherAge = +document.getElementById('fatherAge').value || 0;
  const motherStatus = document.getElementById('motherStatus').value;
  const motherAge = +document.getElementById('motherAge').value || 0;

  const netWorth = cash + realEstate + stocks - debt;

  // Calculate all percentiles
  const pCountry = countryCDFPercentile(country);
  const pSex = sexPercentile(sex);
  const pAge = agePercentile(age);
  const pWealth = wealthPercentile(cash, realEstate, stocks, debt);
  const pIncome = incomePercentile(income);
  const pHealth = healthPercentile(health);
  const bmi = bmiFromInputs();
  const pBMI = bmiPercentile(bmi);
  const pEdu = educationPercentile(education);
  const pFamily = familyPercentile(children, fatherStatus, fatherAge, motherStatus, motherAge, age);
  const pLifeExp = lifeExpectancyPercentile(lifeExpectancy, age);
  const pHappiness = happinessPercentile(happiness);

  // Calculate weighted percentile
  const Wsum = Object.values(W).reduce((a,b)=>a+b,0);
  const P = clamp(
    (pWealth * W.wealth + pIncome * W.income + pEdu * W.education + pLifeExp * W.lifeExp +
     pHappiness * W.happiness + pCountry * W.country + pHealth * W.health + pFamily * W.family) / Wsum,
    0.0001, 0.9999
  );

  // FIXED: Calculate rank correctly - higher percentile = better (lower) rank
  const rank = Math.round(WORLD_TOTAL * (1 - P));
  const pctText = pct(P) + '%';

  // Update main result display
  const res = document.getElementById('result');
  const bmiTxt = (bmi && isFinite(bmi)) ? bmi.toFixed(1) : 'N/A';

  // Get country rank and economic data if available
  let countryInfo = '';
  const totalCountries = Object.keys(ALL_COUNTRIES).length;
  if (ALL_COUNTRIES[country]) {
    const countryData = ALL_COUNTRIES[country];
    // Calculate country-specific ranking using current population projection
    const countryPopulation = getCurrentCountryPopulation(country);
    const countryRank = Math.round(countryPopulation * (1 - P));

    // Get population projection info
    let populationDisplay = `${countryData.population}M`;
    if (POPULATION_PROJECTIONS[country]) {
      const currentPop = (countryPopulation / 1000000).toFixed(1);
      const projectedPop2030 = POPULATION_PROJECTIONS[country].pop_2030;
      populationDisplay = `${currentPop}M (${projectedPop2030}M by 2030)`;
    }

    countryInfo = `
      <div style="margin:6px 0; padding:6px 8px; background:#0e141b; border-radius:6px; font-size:11px; border-left:3px solid var(--accent)">
        üìä <b>${country}</b> Country Rank: <b>#${countryData.rank}/${totalCountries}</b> ¬∑
        GDP per capita: <b>$${countryData.gdp_per_capita.toLocaleString()}</b><br>
        Population: <b id="countryPopulation">${populationDisplay}</b> ¬∑
        Your rank in ${country}: <b id="countryRank">#${fmtInt(countryRank)}</b>
      </div>
    `;
  }

  res.innerHTML = `
    <div class="big">üèÜ Global Rank: <b style="color:var(--accent)">#${fmtInt(rank)}</b> out of ~${fmtInt(WORLD_TOTAL)} people</div>
    <div style="margin:8px 0; font-size:16px">You're in the top <b style="color:var(--green)">${pctText}</b> globally!</div>
    ${countryInfo}
    <div class="small" style="margin-top:10px; line-height:1.3; padding:8px; background:#1a202c; border-radius:8px">
      üåç <b>${country}</b> ¬∑ ${sex === 'male' ? 'üë®' : sex === 'female' ? 'üë©' : 'üßë'} <b>${sex}</b> ¬∑ üéÇ <b>${age}</b> years ¬∑
      üí∞ Net Worth: <b>$${fmtInt(netWorth)}</b> ¬∑ üíµ Income: <b>$${fmtInt(income)}</b> ¬∑ üìè BMI: <b>${bmiTxt}</b>
    </div>
  `;

  // Show all enhanced visualizations
  updatePopulationVisualization(P, rank);
  updateWealthChart(cash, realEstate, stocks, debt, netWorth, pWealth);
  updateComparisonCharts(pAge, pIncome, pEdu, pHealth);
  updateFunFacts(rank, P, country, age, netWorth, income);
  updateLifeTimeline(age, lifeExpectancy, fatherStatus, fatherAge, motherStatus, motherAge);
  updateHappinessVisualization(happiness);

  // Store result for export
  window.__lastResult = {
    version: VERSION,
    timestamp: Date.now(),
    country, sex, age, health, units,
    height_cm: units==='metric' ? +document.getElementById('heightCm').value : null,
    weight_kg: units==='metric' ? +document.getElementById('weightKg').value : null,
    height_ft: units==='imperial' ? +document.getElementById('heightFt').value : null,
    height_in: units==='imperial' ? +document.getElementById('heightIn').value : null,
    weight_lb: units==='imperial' ? +document.getElementById('weightLb').value : null,
    bmi, cash, realEstate, stocks, debt, net_worth: netWorth, income,
    education, university, race, children, life_expectancy: lifeExpectancy, happiness,
    father_status: fatherStatus, father_age: fatherAge, mother_status: motherStatus, mother_age: motherAge,
    percentiles:{ country:pCountry, sex:pSex, age:pAge, wealth:pWealth, income:pIncome, health:pHealth, bmi:pBMI, education:pEdu, family:pFamily, lifeExp:pLifeExp, happiness:pHappiness },
    weights: W, composite_percentile: P, world_total: WORLD_TOTAL, rank,
    country_population: ALL_COUNTRIES[country] ? getCurrentCountryPopulation(country) : null,
    country_projection_2030: POPULATION_PROJECTIONS[country] ? POPULATION_PROJECTIONS[country].pop_2030 : null
  };

  showNotification('Global ranking calculated successfully!', 'success');
}

// =======================
// Event Listeners Setup
// =======================
function setupEventListeners() {
  // Birth date listeners for real-time age update
  document.getElementById('birthYear').addEventListener('input', () => {
    updateAge();
    updateAutoCalculatedFields();
  });
  document.getElementById('birthMonth').addEventListener('change', () => {
    updateAge();
    updateAutoCalculatedFields();
  });
  document.getElementById('birthDay').addEventListener('input', () => {
    updateAge();
    updateAutoCalculatedFields();
  });

  // Auto-calculation triggers
  document.getElementById('country').addEventListener('input', updateAutoCalculatedFields);
  document.getElementById('sex').addEventListener('change', updateAutoCalculatedFields);
  document.getElementById('income').addEventListener('input', updateAutoCalculatedFields);
  document.getElementById('education').addEventListener('change', updateAutoCalculatedFields);
  document.getElementById('health').addEventListener('change', updateAutoCalculatedFields);
  document.getElementById('cash').addEventListener('input', updateAutoCalculatedFields);
  document.getElementById('realEstate').addEventListener('input', updateAutoCalculatedFields);
  document.getElementById('stocks').addEventListener('input', updateAutoCalculatedFields);
  document.getElementById('debt').addEventListener('input', updateAutoCalculatedFields);

  // Manual override toggles
  document.getElementById('lifeExpectancyManual').addEventListener('change', function() {
    const input = document.getElementById('lifeExpectancy');
    if (this.checked) {
      input.readonly = false;
      input.style.background = '#0e141b';
      input.style.color = 'var(--fg)';
    } else {
      input.readonly = true;
      input.style.background = '#0b1218';
      input.style.color = 'var(--accent)';
      updateAutoCalculatedFields();
    }
  });

  document.getElementById('happinessManual').addEventListener('change', function() {
    const input = document.getElementById('happiness');
    if (this.checked) {
      input.readonly = false;
      input.style.background = '#0e141b';
      input.style.color = 'var(--fg)';
    } else {
      input.readonly = true;
      input.style.background = '#0b1218';
      input.style.color = 'var(--accent)';
      updateAutoCalculatedFields();
    }
  });

  // Units toggle
  document.getElementById('units').addEventListener('change', updateUnitsDisplay);

  // Parent status toggles
  document.getElementById('fatherStatus').addEventListener('change', updateParentLabels);
  document.getElementById('motherStatus').addEventListener('change', updateParentLabels);

  // Main button
  document.getElementById('btnCalc').addEventListener('click', compute);
}



// =======================
// Initialization
// =======================
function initialize() {
  // Start population counter
  updateWorldPopulation();
  setInterval(updateWorldPopulation, 1000);

  // Setup event listeners
  setupEventListeners();

  // Initialize auto-calculated fields
  updateAutoCalculatedFields();

  showNotification('Global Human Ranking Calculator loaded! Enter your data to discover your world position.', 'success');
}

// Start the application
document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>