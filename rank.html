<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>My Global Rank — Extended (Just for Fun)</title>
<meta name="description" content="Playful global ranking with many inputs: country, gender, age, health, height, weight, race, education, university, income, wealth, real estate, stocks, children, parents.">
<style>
:root{
  --bg:#0b0f14; --card:#10161d; --fg:#e6edf3; --muted:#96a1ad;
  --border:#22303c; --accent:#60a5fa; --green:#22c55e; --warn:#f59e0b;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
h1{margin:0 0 10px 0;font-size:clamp(20px,4vw,30px)}
.sub{color:var(--muted);font-size:clamp(12px,2.5vw,14px);margin-bottom:16px;line-height:1.4}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:768px){.grid{gap:16px}}
@media(min-width:1080px){.grid{grid-template-columns:1.15fr .85fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
@media(min-width:768px){.card{border-radius:16px;padding:16px}}
.card h2{margin:0 0 12px 0;font-size:clamp(16px,3vw,18px)}
label{display:block;margin:8px 0 4px 0;color:var(--muted);font-size:clamp(11px,2.5vw,12px)}
input[type="text"],input[type="number"],select{
  width:100%;padding:10px 8px;border-radius:8px;border:1px solid var(--border);background:#0e141b;color:var(--fg);font-size:14px;
}
@media(min-width:768px){
  input[type="text"],input[type="number"],select{padding:11px 12px;border-radius:12px}
}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
@media(min-width:768px){.row{gap:10px}}
.col{flex:1;min-width:160px}
@media(min-width:768px){.col{min-width:210px}}
button{appearance:none;border:none;background:var(--accent);color:#031225;padding:12px 16px;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;width:100%;margin:4px 0}
@media(min-width:768px){button{padding:10px 14px;border-radius:12px;width:auto;margin:0}}
button.ghost{background:transparent;color:var(--fg);border:1px solid var(--border)}
.small{font-size:clamp(11px,2.5vw,12px);color:var(--muted)}
.kbd{padding:1px 6px;border:1px solid var(--border);border-radius:6px;background:#0b1218;color:var(--muted)}
.resultBox{border:1px dashed var(--border);border-radius:8px;padding:12px;margin-top:10px}
@media(min-width:768px){.resultBox{border-radius:12px;padding:14px}}
.big{font-size:clamp(18px,4vw,22px);font-weight:900;line-height:1.2}
.progress{height:12px;background:#0b1218;border:1px solid var(--border);border-radius:999px;overflow:hidden}
@media(min-width:768px){.progress{height:14px}}
.progress>div{height:100%;background:linear-gradient(90deg,#0ea5e9,#22c55e);width:0%}
.flex{display:flex;justify-content:space-between;gap:6px;align-items:center;flex-wrap:wrap}
@media(min-width:768px){.flex{gap:8px;flex-wrap:nowrap}}
.table{width:100%;border-collapse:collapse;margin-top:8px;font-size:12px}
@media(min-width:768px){.table{font-size:13px}}
.table th,.table td{border-bottom:1px solid var(--border);padding:6px 4px}
@media(min-width:768px){.table th,.table td{padding:8px 6px}}
.badge{display:inline-block;background:#0b1218;border:1px solid var(--border);padding:3px 6px;border-radius:999px;color:var(--muted);font-size:10px;margin:2px 4px 2px 0}
@media(min-width:768px){.badge{padding:4px 8px;font-size:12px;margin-right:6px}}
.note{display:inline-block;margin-top:6px;padding:6px 8px;border:1px solid var(--border);border-radius:8px;color:var(--muted);font-size:clamp(10px,2.5vw,12px)}
@media(min-width:768px){.note{padding:6px 10px;border-radius:10px}}
.section{margin-top:10px;padding-top:8px;border-top:1px dashed var(--border)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>My Global Rank <span style="color:var(--accent)">— Extended</span> 🎲</h1>
    <div class="sub">Calculate your precise global ranking among <b>8.25 billion</b> people based on comprehensive personal data analysis.</div>

    <!-- Real-time World Population Counter -->
    <div style="background:#1a202c; border-radius:12px; padding:12px; margin:10px 0; border:1px solid var(--border)">
      <div style="text-align:center">
        <div style="font-size:clamp(11px,2.5vw,12px); color:var(--muted); margin-bottom:4px">🌍 Current World Population</div>
        <div id="worldPopulation" style="font-size:clamp(18px,4vw,24px); font-weight:bold; color:var(--accent); font-family:monospace; transition:transform 0.2s ease, text-shadow 0.2s ease">8,246,975,554</div>
        <div style="font-size:clamp(10px,2vw,11px); color:var(--muted); margin-top:4px">
          <span id="populationGrowth">+0</span> people since you opened this page
        </div>
      </div>

      <!-- Population Growth Statistics -->
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:10px; font-size:clamp(9px,2vw,10px); text-align:center">
        <div style="padding:4px; background:#0e141b; border-radius:6px">
          <div style="color:var(--accent); font-weight:bold" id="birthsToday">+0</div>
          <div style="color:var(--muted)">👶 Births today</div>
        </div>
        <div style="padding:4px; background:#0e141b; border-radius:6px">
          <div style="color:var(--green); font-weight:bold">+4.2/sec</div>
          <div style="color:var(--muted)">📈 Growth rate</div>
        </div>
        <div style="padding:4px; background:#0e141b; border-radius:6px">
          <div style="color:var(--warn); font-weight:bold" id="deathsToday">+0</div>
          <div style="color:var(--muted)">💀 Deaths today</div>
        </div>
      </div>

      <!-- Continental Population Growth -->
      <div style="margin-top:12px; border-top:1px solid var(--border); padding-top:10px">
        <div style="font-size:clamp(10px,2.2vw,11px); color:var(--muted); margin-bottom:8px; text-align:center; font-weight:bold">🌏 Continental Growth (today)</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; font-size:clamp(8px,1.8vw,9px)">
          <div style="padding:3px 6px; background:#0e141b; border-radius:4px; display:flex; justify-content:space-between">
            <span>🌏 Asia</span>
            <span style="color:var(--accent); font-weight:bold" id="asiaGrowth">+0</span>
          </div>
          <div style="padding:3px 6px; background:#0e141b; border-radius:4px; display:flex; justify-content:space-between">
            <span>🌍 Africa</span>
            <span style="color:var(--green); font-weight:bold" id="africaGrowth">+0</span>
          </div>
          <div style="padding:3px 6px; background:#0e141b; border-radius:4px; display:flex; justify-content:space-between">
            <span>🌎 Americas</span>
            <span style="color:var(--warn); font-weight:bold" id="americasGrowth">+0</span>
          </div>
          <div style="padding:3px 6px; background:#0e141b; border-radius:4px; display:flex; justify-content:space-between">
            <span>🌍 Europe</span>
            <span style="color:#8b5cf6; font-weight:bold" id="europeGrowth">+0</span>
          </div>
        </div>
      </div>
    </div>

    <div><span class="badge">Single-file</span><span class="badge">Client-side only</span><span class="badge">Real-time Population</span></div>
  </header>

  <section class="grid">
    <div class="card">
      <h2>Inputs</h2>
      <div class="row">
        <div class="col">
          <label>Country</label>
          <input id="country" list="countryList" placeholder="e.g., South Korea, United States, Japan"><datalist id="countryList"></datalist>
        </div>
        <div class="col">
          <label>Gender</label>
          <select id="sex">
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other / Prefer not to say</option>
          </select>
        </div>
        <div class="col">
          <label>Birth Date</label>
          <div class="row" style="gap:6px">
            <input id="birthYear" type="number" min="1900" max="2025" step="1" placeholder="Year" style="flex:2">
            <select id="birthMonth" style="flex:1">
              <option value="">Month</option>
              <option value="1">Jan</option>
              <option value="2">Feb</option>
              <option value="3">Mar</option>
              <option value="4">Apr</option>
              <option value="5">May</option>
              <option value="6">Jun</option>
              <option value="7">Jul</option>
              <option value="8">Aug</option>
              <option value="9">Sep</option>
              <option value="10">Oct</option>
              <option value="11">Nov</option>
              <option value="12">Dec</option>
            </select>
            <input id="birthDay" type="number" min="1" max="31" step="1" placeholder="Day" style="flex:1">
          </div>
        </div>
        <div class="col" style="min-width:120px">
          <label>Current Age</label>
          <div id="calculatedAge" style="padding:11px 12px; border-radius:12px; border:1px solid var(--border); background:#0e141b; color:var(--accent); font-weight:bold; text-align:center">Enter birth date</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Self-reported health</label>
          <select id="health">
            <option value="good">Good</option>
            <option value="excellent">Excellent</option>
            <option value="fair">Fair</option>
            <option value="poor">Poor</option>
            <option value="na">Prefer not to say</option>
          </select>
        </div>
        <div class="col">
          <label>Units</label>
          <select id="units">
            <option value="metric" selected>Metric (cm, kg)</option>
            <option value="imperial">Imperial (ft/in, lb)</option>
          </select>
        </div>
        <div class="col metric-only">
          <label>Height (cm)</label>
          <input id="heightCm" type="number" min="80" max="250" step="0.1" placeholder="e.g., 175">
        </div>
        <div class="col metric-only">
          <label>Weight (kg)</label>
          <input id="weightKg" type="number" min="20" max="300" step="0.1" placeholder="e.g., 70">
        </div>
        <div class="col imperial-only" style="display:none">
          <label>Height (ft + in)</label>
          <div class="row" style="gap:6px">
            <input id="heightFt" type="number" min="3" max="8" step="1" placeholder="ft" style="flex:1">
            <input id="heightIn" type="number" min="0" max="11" step="1" placeholder="in" style="flex:1">
          </div>
        </div>
        <div class="col imperial-only" style="display:none">
          <label>Weight (lb)</label>
          <input id="weightLb" type="number" min="50" max="600" step="0.1" placeholder="e.g., 154">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Cash & Savings (USD)</label>
          <input id="cash" type="number" min="0" step="100" placeholder="e.g., 50000">
        </div>
        <div class="col">
          <label>Real Estate Value (USD)</label>
          <input id="realEstate" type="number" min="0" step="1000" placeholder="e.g., 300000">
        </div>
        <div class="col">
          <label>Stock/Investment Value (USD)</label>
          <input id="stocks" type="number" min="0" step="100" placeholder="e.g., 75000">
        </div>
        <div class="col">
          <label>Total Debt (USD)</label>
          <input id="debt" type="number" min="0" step="100" placeholder="e.g., 25000">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Annual Income (USD)</label>
          <input id="income" type="number" min="0" step="100" placeholder="e.g., 80000">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Education</label>
          <select id="education">
            <option value="hs">High school or below</option>
            <option value="somecollege">Some college</option>
            <option value="bachelor">Bachelor’s</option>
            <option value="master">Master’s</option>
            <option value="doctorate">Doctorate</option>
          </select>
        </div>
        <div class="col">
          <label>University (optional, display-only)</label>
          <input id="university" type="text" placeholder="e.g., University of Michigan">
        </div>
        <div class="col">
          <label>Race / Ethnicity (not used in score)</label>
          <select id="race">
            <option value="na">Prefer not to say</option>
            <option value="asian">Asian</option>
            <option value="black">Black</option>
            <option value="white">White</option>
            <option value="latino">Hispanic / Latino</option>
            <option value="mena">Middle Eastern / North African</option>
            <option value="indigenous">Indigenous</option>
            <option value="pi">Pacific Islander</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Children</label>
          <input id="children" type="number" min="0" max="12" step="1" value="0">
        </div>
        <div class="col">
          <label>Expected Life Span (years)</label>
          <input id="lifeExpectancy" type="number" min="50" max="120" step="1" placeholder="World avg: 73">
        </div>
        <div class="col">
          <label>Happiness Score (1-10)</label>
          <input id="happiness" type="number" min="1" max="10" step="0.1" placeholder="World avg: 5.4">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Father Status</label>
          <select id="fatherStatus">
            <option value="alive">Alive</option>
            <option value="deceased">Deceased</option>
          </select>
        </div>
        <div class="col" id="fatherAgeGroup">
          <label id="fatherAgeLabel">Father's Current Age</label>
          <input id="fatherAge" type="number" min="30" max="120" step="1" placeholder="e.g., 65">
        </div>
        <div class="col">
          <label>Mother Status</label>
          <select id="motherStatus">
            <option value="alive">Alive</option>
            <option value="deceased">Deceased</option>
          </select>
        </div>
        <div class="col" id="motherAgeGroup">
          <label id="motherAgeLabel">Mother's Current Age</label>
          <input id="motherAge" type="number" min="30" max="120" step="1" placeholder="e.g., 62">
        </div>
      </div>


      <div class="row" style="margin-top:12px">
        <button id="btnCalc">Calculate my global rank</button>
        <button id="btnReset" class="ghost">Reset</button>
      </div>
    </div>

    <div class="card">
      <h2>Your Global Rank 🎯</h2>
      <div id="result" class="resultBox">Enter inputs and click <span class="kbd">Calculate</span>.</div>

      <!-- Global Population Visualization -->
      <div id="populationViz" style="display:none; margin:15px 0">
        <div class="small" style="margin-bottom:8px">🌍 Global Population Visual</div>
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px">
          <div style="flex:1; height:20px; background:#1e293b; border-radius:10px; overflow:hidden; position:relative">
            <div id="rankBar" style="height:100%; background:linear-gradient(90deg,#ef4444,#f97316,#eab308,#22c55e); border-radius:10px; width:0%; transition:width 0.8s ease"></div>
            <div id="rankMarker" style="position:absolute; top:-2px; width:2px; height:24px; background:#fff; left:0%; transition:left 0.8s ease"></div>
          </div>
          <div class="small" id="rankPosition">You</div>
        </div>
        <div style="display:flex; justify-content:space-between; font-size:11px; color:var(--muted)">
          <span>👶 Poorest</span>
          <span>💰 Richest</span>
        </div>
      </div>

      <!-- Wealth Breakdown Chart -->
      <div id="wealthChart" style="display:none; margin:15px 0">
        <div class="small" style="margin-bottom:8px">💰 Your Wealth Breakdown</div>
        <div id="wealthBars"></div>
        <div class="small" style="margin-top:5px; color:var(--muted)">Net Worth: <span id="netWorthTotal">$0</span></div>
      </div>

      <!-- Comparison Charts -->
      <div id="comparisonCharts" style="display:none; margin:15px 0">
        <div class="small" style="margin-bottom:8px">📊 How You Compare</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px">
          <div>
            <div class="small" style="margin-bottom:5px">Age Distribution</div>
            <div id="ageChart" style="height:60px; background:#1e293b; border-radius:8px; position:relative; overflow:hidden"></div>
          </div>
          <div>
            <div class="small" style="margin-bottom:5px">Income Distribution</div>
            <div id="incomeChart" style="height:60px; background:#1e293b; border-radius:8px; position:relative; overflow:hidden"></div>
          </div>
        </div>
      </div>

      <!-- Fun Facts -->
      <div id="funFacts" style="display:none; margin:15px 0; padding:12px; background:#1a202c; border-radius:10px">
        <div class="small" style="margin-bottom:8px; font-weight:bold">🎉 Fun Facts About Your Rank</div>
        <div id="factsContent" style="font-size:12px; line-height:1.4"></div>
      </div>

      <!-- Life Timeline -->
      <div id="lifeTimeline" style="display:none; margin:15px 0">
        <div class="small" style="margin-bottom:8px; font-weight:bold">⏰ Your Life Timeline</div>
        <div id="timelineViz" style="background:#1a202c; border-radius:10px; padding:12px; margin-bottom:8px">
          <div style="display:flex; align-items:center; margin-bottom:8px">
            <div style="width:60px; font-size:11px">Life</div>
            <div style="flex:1; height:20px; background:#2a2a2a; border-radius:10px; overflow:hidden; position:relative; margin:0 8px">
              <div id="lifeProgress" style="height:100%; background:linear-gradient(90deg,#22c55e,#eab308,#ef4444); border-radius:10px; width:0%; transition:width 0.8s ease"></div>
              <div id="lifeMarker" style="position:absolute; top:-2px; width:2px; height:24px; background:#fff; left:0%; transition:left 0.8s ease"></div>
            </div>
            <div style="width:60px; font-size:11px; text-align:right" id="lifeYears">0 years</div>
          </div>
          <div style="display:flex; justify-content:space-between; font-size:10px; color:var(--muted)">
            <span>🍼 Birth</span>
            <span>💀 Expected End</span>
          </div>
        </div>
        <div id="parentAges" style="font-size:11px; color:var(--muted)"></div>
      </div>

      <!-- Happiness Visualization -->
      <div id="happinessViz" style="display:none; margin:15px 0">
        <div class="small" style="margin-bottom:8px; font-weight:bold">😊 Your Happiness Level</div>
        <div style="background:#1a202c; border-radius:10px; padding:12px">
          <div style="display:flex; align-items:center; margin-bottom:8px">
            <div style="width:50px; font-size:11px">😢 1</div>
            <div style="flex:1; height:24px; background:#2a2a2a; border-radius:12px; overflow:hidden; position:relative; margin:0 8px">
              <div id="happinessBar" style="height:100%; background:linear-gradient(90deg,#ef4444,#eab308,#22c55e); border-radius:12px; width:0%; transition:width 0.8s ease"></div>
              <div id="happinessMarker" style="position:absolute; top:1px; width:20px; height:22px; background:rgba(255,255,255,0.9); border-radius:11px; left:0%; transition:left 0.8s ease; display:flex; align-items:center; justify-content:center; font-size:12px">😊</div>
            </div>
            <div style="width:50px; font-size:11px; text-align:right">😄 10</div>
          </div>
          <div style="text-align:center; font-size:12px" id="happinessText">Your happiness: 0.0/10</div>
        </div>
      </div>

      <div class="row" style="margin-top:15px">
        <button id="btnCopy" class="ghost">Copy Result</button>
        <button id="btnDownload" class="ghost">Download JSON</button>
      </div>

    </div>
  </section>

  <footer style="margin-top:14px" class="small">
    Global Ranking System © 2025 - Advanced Statistical Analysis
  </footer>
</div>

<script>
// =======================
// Data (rough / playful)
// =======================
const WORLD_TOTAL_BASE = 8_246_975_554; // 2025년 9월 16일 기준 기준 세계인구 (+3000명)
const POPULATION_GROWTH_PER_SECOND = 2.5; // 초당 약 2.5명 증가 (더 부드러운 1명씩 증가)
let WORLD_TOTAL = WORLD_TOTAL_BASE; // 현재 계산용 인구수
let pageStartTime = Date.now();

// 실시간 인구 증가 계산
function updateWorldPopulation() {
  const now = Date.now();
  const secondsElapsed = (now - pageStartTime) / 1000;
  const populationIncrease = Math.floor(secondsElapsed * POPULATION_GROWTH_PER_SECOND);

  WORLD_TOTAL = WORLD_TOTAL_BASE + populationIncrease;

  // 오늘 자정부터 경과 시간 계산
  const today = new Date();
  const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const secondsSinceMidnight = (now - todayStart.getTime()) / 1000;

  // 일일 통계 (대략적인 전 세계 평균) - 더 부드러운 증가율
  const birthsPerSecond = 4.3; // 초당 약 4.3명 출생
  const deathsPerSecond = 1.8; // 초당 약 1.8명 사망 (net growth = 2.5)

  const birthsToday = Math.floor(secondsSinceMidnight * birthsPerSecond);
  const deathsToday = Math.floor(secondsSinceMidnight * deathsPerSecond);

  // 대륙별 인구 증가 (대략적인 분포)
  const continentalGrowthRates = {
    asia: 0.50,     // 아시아 50% (중국, 인도 등)
    africa: 0.30,   // 아프리카 30% (높은 출생률)
    americas: 0.12, // 아메리카 12%
    europe: 0.08    // 유럽 8% (낮은 출생률)
  };

  const totalGrowthToday = Math.floor(secondsSinceMidnight * (birthsPerSecond - deathsPerSecond));
  const asiaGrowthToday = Math.floor(totalGrowthToday * continentalGrowthRates.asia);
  const africaGrowthToday = Math.floor(totalGrowthToday * continentalGrowthRates.africa);
  const americasGrowthToday = Math.floor(totalGrowthToday * continentalGrowthRates.americas);
  const europeGrowthToday = Math.floor(totalGrowthToday * continentalGrowthRates.europe);

  // DOM 업데이트
  const popElement = document.getElementById('worldPopulation');
  const growthElement = document.getElementById('populationGrowth');
  const birthsElement = document.getElementById('birthsToday');
  const deathsElement = document.getElementById('deathsToday');
  const asiaElement = document.getElementById('asiaGrowth');
  const africaElement = document.getElementById('africaGrowth');
  const americasElement = document.getElementById('americasGrowth');
  const europeElement = document.getElementById('europeGrowth');

  if (popElement) {
    popElement.textContent = WORLD_TOTAL.toLocaleString('en-US');

    // 시각적 효과 - 숫자가 변할 때마다 깜빡임과 확대 효과
    if (populationIncrease > 0 && populationIncrease % Math.floor(POPULATION_GROWTH_PER_SECOND) === 0) {
      popElement.style.transform = 'scale(1.05)';
      popElement.style.textShadow = '0 0 10px var(--accent)';

      setTimeout(() => {
        popElement.style.transform = 'scale(1)';
        popElement.style.textShadow = 'none';
      }, 200);
    }
  }

  if (growthElement) {
    growthElement.textContent = populationIncrease > 0 ? `+${populationIncrease.toLocaleString('en-US')}` : '+0';
    growthElement.style.color = populationIncrease > 0 ? '#22c55e' : 'var(--muted)';
  }

  if (birthsElement) {
    birthsElement.textContent = `+${birthsToday.toLocaleString('en-US')}`;
  }

  if (deathsElement) {
    deathsElement.textContent = `+${deathsToday.toLocaleString('en-US')}`;
  }

  // 대륙별 증가 업데이트
  if (asiaElement) {
    asiaElement.textContent = `+${asiaGrowthToday.toLocaleString('en-US')}`;
  }
  if (africaElement) {
    africaElement.textContent = `+${africaGrowthToday.toLocaleString('en-US')}`;
  }
  if (americasElement) {
    americasElement.textContent = `+${americasGrowthToday.toLocaleString('en-US')}`;
  }
  if (europeElement) {
    europeElement.textContent = `+${europeGrowthToday.toLocaleString('en-US')}`;
  }
}

// 나이 계산 함수
function calculateAge(birthYear, birthMonth, birthDay) {
  if (!birthYear) return 0;

  const today = new Date();
  const birth = new Date(birthYear, (birthMonth || 1) - 1, birthDay || 1);

  let age = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();

  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
    age--;
  }

  return Math.max(0, age);
}

// 나이 실시간 업데이트
function updateAge() {
  const birthYear = +document.getElementById('birthYear').value;
  const birthMonth = +document.getElementById('birthMonth').value || null;
  const birthDay = +document.getElementById('birthDay').value || null;

  const age = calculateAge(birthYear, birthMonth, birthDay);
  const ageDisplay = document.getElementById('calculatedAge');

  if (birthYear && age >= 0) {
    ageDisplay.textContent = `${age} years old`;
    ageDisplay.style.color = 'var(--accent)';
  } else {
    ageDisplay.textContent = 'Enter birth date';
    ageDisplay.style.color = 'var(--muted)';
  }
}

// 생년월일 입력 이벤트 리스너
document.getElementById('birthYear').addEventListener('input', updateAge);
document.getElementById('birthMonth').addEventListener('change', updateAge);
document.getElementById('birthDay').addEventListener('input', updateAge);

// 페이지 로드 시 즉시 실행 및 타이머 시작
updateWorldPopulation(); // 즉시 실행
setInterval(updateWorldPopulation, 1000); // 1초마다 업데이트
const COUNTRY_POP = {
  "India": 1429000000, "China": 1412000000, "United States": 334000000, "Indonesia": 276000000,
  "Pakistan": 240000000, "Nigeria": 223000000, "Brazil": 203000000, "Bangladesh": 172000000,
  "Russia": 146000000, "Mexico": 128000000, "Ethiopia": 126000000, "Japan": 123000000,
  "Philippines": 117000000, "Egypt": 112000000, "DR Congo": 102000000, "Vietnam": 100000000,
  "Turkey": 85000000, "Iran": 86000000, "Germany": 84000000, "Thailand": 70000000,
  "United Kingdom": 67000000, "France": 65000000, "Tanzania": 67000000, "South Africa": 60000000,
  "Italy": 59000000, "Kenya": 56000000, "Myanmar": 55000000, "South Korea": 52000000,
  "Colombia": 52000000, "Spain": 48000000, "Argentina": 46000000, "Algeria": 45000000,
  "Iraq": 45000000, "Afghanistan": 41000000, "Saudi Arabia": 36000000, "Uzbekistan": 36000000,
  "Ukraine": 36000000, "Morocco": 37000000, "Poland": 38000000, "Canada": 40000000,
  "Malaysia": 34000000, "Angola": 36000000, "Ghana": 33000000, "Mozambique": 33000000,
  "Yemen": 34000000, "Nepal": 30000000, "Australia": 26000000, "North Korea": 26000000,
  "Taiwan": 24000000, "Netherlands": 18000000, "Romania": 19000000, "Belgium": 11700000,
  "Greece": 10400000, "Czechia": 10700000, "Portugal": 10300000, "Sweden": 10500000,
  "Hungary": 9600000, "Austria": 9100000, "Switzerland": 8800000, "Israel": 9800000,
  "Denmark": 5900000, "Finland": 5600000, "Norway": 5500000, "Ireland": 5100000,
  "New Zealand": 5200000, "Singapore": 5900000, "Hong Kong": 7500000
};
const COUNTRY_ALIASES = {
  "usa":"United States","us":"United States","u.s.":"United States","united states of america":"United States",
  "uk":"United Kingdom","great britain":"United Kingdom","britain":"United Kingdom",
  "korea":"South Korea","south korea":"South Korea","republic of korea":"South Korea",
  "russian federation":"Russia","dr congo":"DR Congo","democratic republic of the congo":"DR Congo",
  "czech republic":"Czechia"
};

// Populate country datalist
(() => {
  const dl = document.getElementById('countryList');
  Object.keys(COUNTRY_POP).sort().forEach(c=>{
    const o = document.createElement('option'); o.value = c; dl.appendChild(o);
  });
})();

// =======================
// Utils
// =======================
const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));
const fmtInt = (n) => n.toLocaleString('en-US');
const pct = (p) => Math.round(p*1000)/10; // 0..1 -> 1 decimal percent

function canonicalCountry(name){
  if(!name) return 'Other';
  const raw = name.trim();
  if(COUNTRY_POP[raw]) return raw;
  const low = raw.toLowerCase();
  if(COUNTRY_ALIASES[low]) return COUNTRY_ALIASES[low];
  const title = raw.replace(/\b\w/g, c=>c.toUpperCase());
  if(COUNTRY_POP[title]) return title;
  return 'Other';
}

function countryCDFPercentile(country){
  // 경제적 발전도를 고려한 국가별 기준값 조정
  const countryBonus = {
    'South Korea': 0.82, 'Japan': 0.85, 'United States': 0.88, 'Germany': 0.87,
    'United Kingdom': 0.86, 'France': 0.84, 'Canada': 0.85, 'Australia': 0.86,
    'Netherlands': 0.88, 'Switzerland': 0.92, 'Norway': 0.93, 'Denmark': 0.91,
    'Sweden': 0.90, 'Finland': 0.89, 'Singapore': 0.89, 'Hong Kong': 0.87,
    'Taiwan': 0.80, 'Israel': 0.83, 'China': 0.65, 'India': 0.45,
    'Brazil': 0.55, 'Russia': 0.60, 'Mexico': 0.50, 'Indonesia': 0.40
  };

  if(countryBonus[country] !== undefined){
    return countryBonus[country];
  }

  // 기존 로직으로 폴백
  const sumKnown = Object.values(COUNTRY_POP).reduce((a,b)=>a+b,0);
  const others = Math.max(0, WORLD_TOTAL - sumKnown);
  const entries = Object.entries(COUNTRY_POP).concat([['Other', others]])
    .map(([k,v])=>({k,v}))
    .sort((a,b)=>b.v-a.v);
  let acc = 0;
  for(const e of entries){
    if(e.k === country){
      const mid = acc + e.v/2;
      return clamp(mid / WORLD_TOTAL, 0, 1);
    }
    acc += e.v;
  }
  return 0.50;
}

function sexPercentile(sex){
  if(sex==='male') return 0.505;
  if(sex==='female') return 0.495;
  return 0.500;
}

function agePercentile(age){
  const a = clamp(+age||0, 0, 110);
  if(a<=14) return 0.20*(a/14);
  if(a<=24) return 0.20 + 0.15*((a-24+14)/10);
  if(a<=34) return 0.35 + 0.15*((a-24)/10);
  if(a<=44) return 0.50 + 0.15*((a-34)/10);
  if(a<=54) return 0.65 + 0.15*((a-44)/10);
  if(a<=64) return 0.80 + 0.10*((a-54)/10);
  return 0.90 + 0.10*((a-64)/46);
}

function wealthPercentile(cash, realEstate, stocks, debt){
  const netWorth = (+cash||0) + (+realEstate||0) + (+stocks||0) - (+debt||0);
  let p;
  if(netWorth < -100_000) p = 0.01;
  else if(netWorth < -50_000) p = 0.05;
  else if(netWorth < -10_000) p = 0.10;
  else if(netWorth < 0) p = 0.20;
  else if(netWorth < 1_000) p = 0.40;
  else if(netWorth < 5_000) p = 0.55;
  else if(netWorth < 10_000) p = 0.65;
  else if(netWorth < 25_000) p = 0.75;
  else if(netWorth < 50_000) p = 0.82;
  else if(netWorth < 100_000) p = 0.88;
  else if(netWorth < 200_000) p = 0.93;
  else if(netWorth < 300_000) p = 0.96;
  else if(netWorth < 400_000) p = 0.975;
  else if(netWorth < 500_000) p = 0.985;
  else if(netWorth < 1_000_000) p = 0.99;
  else if(netWorth < 5_000_000) p = 0.997;
  else if(netWorth < 10_000_000) p = 0.999;
  else p = 0.9995;
  return clamp(p, 0.001, 0.999);
}

function incomePercentile(inc){
  const x = +inc;
  if(isNaN(x)) return 0.5;
  if(x < 1000) return 0.10;
  if(x < 3000) return 0.20;
  if(x < 5000) return 0.30;
  if(x < 10000) return 0.45;
  if(x < 15000) return 0.60;
  if(x < 25000) return 0.72;
  if(x < 40000) return 0.80;
  if(x < 60000) return 0.86;
  if(x < 80000) return 0.91;
  if(x < 100000) return 0.95;
  if(x < 150000) return 0.975;
  if(x < 250000) return 0.99;
  if(x < 500000) return 0.997;
  return 0.999;
}

function healthPercentile(h){
  if(h==='excellent') return 0.80;
  if(h==='good') return 0.65;
  if(h==='fair') return 0.45;
  if(h==='poor') return 0.25;
  return 0.50; // NA
}

function bmiFromInputs(){
  const units = document.getElementById('units').value;
  if(units==='metric'){
    const hcm = +document.getElementById('heightCm').value;
    const wkg = +document.getElementById('weightKg').value;
    if(!hcm || !wkg) return null;
    const m = hcm/100;
    return wkg/(m*m);
  }else{
    const ft = +document.getElementById('heightFt').value;
    const inch = +document.getElementById('heightIn').value;
    const lb = +document.getElementById('weightLb').value;
    if(!ft && !inch || !lb) return null;
    const totalIn = (ft||0)*12 + (inch||0);
    if(totalIn<=0) return null;
    const m = totalIn*0.0254;
    const kg = lb*0.45359237;
    return kg/(m*m);
  }
}

function bmiPercentile(bmi){
  if(!bmi || !isFinite(bmi)) return 0.50;
  // Map closeness to ~22 as higher percentile; clamp to [0.3, 0.8]
  const diff = Math.abs(bmi - 22);
  const score = Math.max(0, 1 - diff/22); // 22 away -> 0
  const p = 0.3 + 0.5*score; // 0..1 -> 0.3..0.8
  return clamp(p, 0.3, 0.8);
}

function educationPercentile(level){
  switch(level){
    case 'hs': return 0.50;
    case 'somecollege': return 0.65;
    case 'bachelor': return 0.85;
    case 'master': return 0.93;
    case 'doctorate': return 0.98;
    default: return 0.50;
  }
}

// Fixed weights (sum = 1.00) - 돈 절대 우선 가중치 + 수명/행복도 추가
const W = {
  wealth:0.50, income:0.20, education:0.08, lifeExp:0.08, happiness:0.06,
  country:0.04, health:0.02, family:0.02, age:0.00, bmi:0.00, sex:0.00, race:0.00, university:0.00
};

function familyPercentile(children, parentsAlive, age){
  const k = Math.max(0, Math.min(12, Math.floor(+children || 0)));
  let childP;
  if(k===0) childP = 0.58;
  else if(k===1) childP = 0.66;
  else if(k===2) childP = 0.72;
  else if(k===3) childP = 0.62;
  else childP = 0.50;
  const a = clamp(+age||0,0,110);
  let parP;
  const pa = +parentsAlive;
  if(pa===2) parP = 0.70 - (a>40?0.12:0) - (a>60?0.12:0);
  else if(pa===1) parP = 0.52 - (a>70?0.05:0);
  else parP = 0.40 + (a>60?0.10:0);
  parP = clamp(parP, 0.25, 0.75);
  return clamp(0.65*childP + 0.35*parP, 0.25, 0.75);
}

function updatePopulationVisualization(percentile, rank){
  const viz = document.getElementById('populationViz');
  const bar = document.getElementById('rankBar');
  const marker = document.getElementById('rankMarker');
  const position = document.getElementById('rankPosition');

  viz.style.display = 'block';
  bar.style.width = (percentile * 100) + '%';
  marker.style.left = (percentile * 100) + '%';
  position.textContent = `#${fmtInt(rank)}`;
}

function updateWealthChart(cash, realEstate, stocks, debt, netWorth){
  const chart = document.getElementById('wealthChart');
  const bars = document.getElementById('wealthBars');
  const total = document.getElementById('netWorthTotal');

  chart.style.display = 'block';
  total.textContent = `$${fmtInt(netWorth)}`;

  const assets = [
    {name: 'Cash', value: cash, color: '#22c55e'},
    {name: 'Real Estate', value: realEstate, color: '#3b82f6'},
    {name: 'Stocks', value: stocks, color: '#8b5cf6'},
    {name: 'Debt', value: -debt, color: '#ef4444'}
  ];

  const maxVal = Math.max(...assets.map(a => Math.abs(a.value)));
  bars.innerHTML = assets.map(asset => {
    const width = maxVal > 0 ? (Math.abs(asset.value) / maxVal * 100) : 0;
    return `
      <div style="display:flex; align-items:center; margin:3px 0; font-size:11px">
        <div style="width:60px; min-width:60px">${asset.name}</div>
        <div style="flex:1; height:16px; background:#0b1218; border-radius:8px; overflow:hidden; margin:0 6px">
          <div style="height:100%; background:${asset.color}; width:${width}%; border-radius:8px; transition:width 0.3s ease"></div>
        </div>
        <div style="width:60px; min-width:60px; text-align:right">${asset.value >= 0 ? '$' + fmtInt(asset.value) : '-$' + fmtInt(-asset.value)}</div>
      </div>
    `;
  }).join('');
}

function updateComparisonCharts(agePercentile, incomePercentile){
  const charts = document.getElementById('comparisonCharts');
  const ageChart = document.getElementById('ageChart');
  const incomeChart = document.getElementById('incomeChart');

  charts.style.display = 'block';

  // Age distribution visualization
  ageChart.innerHTML = `
    <div style="position:absolute; bottom:0; left:0; right:0; height:100%; background:linear-gradient(0deg, #1e293b 0%, #1e293b 60%, #0ea5e9 60%, #0ea5e9 100%)"></div>
    <div style="position:absolute; bottom:0; left:${agePercentile*100}%; width:3px; height:100%; background:#22c55e; border-radius:2px"></div>
    <div style="position:absolute; top:3px; left:3px; font-size:9px; color:#94a3b8; background:rgba(0,0,0,0.5); padding:1px 4px; border-radius:4px">You: ${pct(agePercentile)}%</div>
  `;

  // Income distribution visualization - 더 강조된 스타일
  incomeChart.innerHTML = `
    <div style="position:absolute; bottom:0; left:0; right:0; height:100%; background:linear-gradient(0deg, #1e293b 0%, #1e293b 70%, #f59e0b 70%, #f59e0b 100%)"></div>
    <div style="position:absolute; bottom:0; left:${incomePercentile*100}%; width:3px; height:100%; background:#22c55e; border-radius:2px; box-shadow:0 0 8px #22c55e"></div>
    <div style="position:absolute; top:3px; left:3px; font-size:9px; color:#94a3b8; background:rgba(0,0,0,0.5); padding:1px 4px; border-radius:4px">💰 You: ${pct(incomePercentile)}%</div>
  `;
}

function updateFunFacts(rank, percentile, country, age, netWorth){
  const facts = document.getElementById('funFacts');
  const content = document.getElementById('factsContent');

  facts.style.display = 'block';

  const peopleAbove = Math.round(WORLD_TOTAL * (1 - percentile));
  const peopleBelow = Math.round(WORLD_TOTAL * percentile);
  const topPercent = pct(1 - percentile);

  const factsList = [
    `🎯 You rank higher than <b style="color:#22c55e">${fmtInt(peopleBelow)}</b> people worldwide`,
    `🏆 Only <b style="color:#f59e0b">${fmtInt(peopleAbove)}</b> people rank above you`,
    `📊 You're in the top <b style="color:#60a5fa">${topPercent}%</b> globally`,
    `💰 Your net worth of <b style="color:#22c55e">$${fmtInt(netWorth)}</b> ${netWorth > 500000 ? 'puts you in elite status' : netWorth > 100000 ? 'shows strong financial position' : 'is building towards security'}`,
    `🌟 ${percentile > 0.9 ? 'You are in the global financial elite!' : percentile > 0.8 ? 'You have achieved significant wealth!' : percentile > 0.7 ? 'You are financially well-positioned!' : 'You are building wealth steadily!'}`
  ];

  content.innerHTML = factsList.map(fact => `<div style="margin:4px 0; padding:4px 0">• ${fact}</div>`).join('');
}

function updateLifeTimeline(age, lifeExpectancy, fatherStatus, fatherAge, motherStatus, motherAge){
  const timeline = document.getElementById('lifeTimeline');
  const progress = document.getElementById('lifeProgress');
  const marker = document.getElementById('lifeMarker');
  const years = document.getElementById('lifeYears');
  const parentAges = document.getElementById('parentAges');

  timeline.style.display = 'block';

  if(lifeExpectancy && lifeExpectancy > 0){
    const lifeProgress = Math.min(age / lifeExpectancy * 100, 100);
    progress.style.width = lifeProgress + '%';
    marker.style.left = lifeProgress + '%';
    years.textContent = `${age}/${lifeExpectancy} years`;

    // 부모님 정보 표시
    let parentInfo = [];
    if(fatherAge){
      if(fatherStatus === 'deceased'){
        parentInfo.push(`👨 Father: Died at ${fatherAge}`);
      } else {
        parentInfo.push(`👨 Father: ${fatherAge} years old`);
      }
    }
    if(motherAge){
      if(motherStatus === 'deceased'){
        parentInfo.push(`👩 Mother: Died at ${motherAge}`);
      } else {
        parentInfo.push(`👩 Mother: ${motherAge} years old`);
      }
    }
    parentAges.innerHTML = parentInfo.join(' • ');
  } else {
    progress.style.width = '0%';
    marker.style.left = '0%';
    years.textContent = `${age} years`;
    parentAges.innerHTML = '';
  }
}

function updateHappinessVisualization(happiness){
  const viz = document.getElementById('happinessViz');
  const bar = document.getElementById('happinessBar');
  const marker = document.getElementById('happinessMarker');
  const text = document.getElementById('happinessText');

  viz.style.display = 'block';

  if(happiness && happiness > 0){
    const happinessPercent = (happiness - 1) / 9 * 100; // 1-10 스케일을 0-100%로 변환
    bar.style.width = happinessPercent + '%';
    marker.style.left = `calc(${happinessPercent}% - 10px)`;
    text.textContent = `Your happiness: ${happiness}/10`;

    // 이모지 변경
    if(happiness >= 8) marker.textContent = '😄';
    else if(happiness >= 6) marker.textContent = '😊';
    else if(happiness >= 4) marker.textContent = '😐';
    else marker.textContent = '😢';
  } else {
    bar.style.width = '0%';
    marker.style.left = '0%';
    text.textContent = 'Your happiness: 0.0/10';
    marker.textContent = '😐';
  }
}

function familyPercentileNew(children, fatherStatus, fatherAge, motherStatus, motherAge, age){
  const k = Math.max(0, Math.min(12, Math.floor(+children || 0)));
  let childP;
  if(k===0) childP = 0.58;
  else if(k===1) childP = 0.66;
  else if(k===2) childP = 0.72;
  else if(k===3) childP = 0.62;
  else childP = 0.50;

  const a = clamp(+age||0,0,110);
  let parP = 0.50;

  // 부모님 생존 상태에 따른 계산
  let parentsAlive = 0;
  if(fatherStatus === 'alive' && fatherAge) parentsAlive++;
  if(motherStatus === 'alive' && motherAge) parentsAlive++;

  if(parentsAlive === 2) parP = 0.70 - (a>40?0.12:0) - (a>60?0.12:0);
  else if(parentsAlive === 1) parP = 0.52 - (a>70?0.05:0);
  else parP = 0.40 + (a>60?0.10:0);

  parP = clamp(parP, 0.25, 0.75);
  return clamp(0.65*childP + 0.35*parP, 0.25, 0.75);
}

function lifeExpectancyPercentile(lifeExp, age){
  if(!lifeExp || lifeExp <= 0) return 0.50;

  // 전 세계 평균 기대수명 약 73세 기준 - 더 현실적인 분포
  if(lifeExp < 50) return 0.05;
  if(lifeExp < 60) return 0.15;
  if(lifeExp < 65) return 0.25;
  if(lifeExp < 70) return 0.40;
  if(lifeExp < 73) return 0.50; // 전세계 평균
  if(lifeExp < 76) return 0.60;
  if(lifeExp < 80) return 0.72;
  if(lifeExp < 83) return 0.82;
  if(lifeExp < 87) return 0.90;
  if(lifeExp < 92) return 0.95;
  if(lifeExp < 97) return 0.98;
  return 0.995;
}

function happinessPercentile(cash, realEstate, stocks, debt, income, health, education, country, sex){
  // 재산 기반 행복도 계산 (재산 80%, 건강 10%, 나머지 10%)
  const netWorth = (+cash||0) + (+realEstate||0) + (+stocks||0) - (+debt||0);
  const annualIncome = +income || 0;

  // 재산 행복도 (80% 가중치)
  let wealthHappiness = 0.50; // 기본값

  // 초고액 자산가 또는 고소득자 (90% 이상)
  if(netWorth >= 10_000_000 || annualIncome >= 1_000_000) {
    wealthHappiness = 0.95;
  }
  // 고액 자산가
  else if(netWorth >= 5_000_000 || annualIncome >= 500_000) {
    wealthHappiness = 0.90;
  }
  // 상당한 자산
  else if(netWorth >= 1_000_000 || annualIncome >= 200_000) {
    wealthHappiness = 0.85;
  }
  // 안정적 자산
  else if(netWorth >= 500_000 || annualIncome >= 100_000) {
    wealthHappiness = 0.75;
  }
  // 중간 수준
  else if(netWorth >= 100_000 || annualIncome >= 50_000) {
    wealthHappiness = 0.65;
  }
  // 낮은 수준
  else if(netWorth >= 10_000 || annualIncome >= 20_000) {
    wealthHappiness = 0.45;
  }
  // 매우 낮은 수준
  else if(netWorth >= 0 || annualIncome >= 5_000) {
    wealthHappiness = 0.30;
  }
  // 부채 상태
  else {
    wealthHappiness = 0.15;
  }

  // 건강 행복도 (10% 가중치)
  let healthHappiness = 0.50;
  if(health === 'excellent') {
    healthHappiness = 0.85; // 기본 0.80 + 추가 5%
  } else if(health === 'good') {
    healthHappiness = 0.70; // 기본 0.65 + 추가 5%
  } else if(health === 'fair') {
    healthHappiness = 0.45;
  } else if(health === 'poor') {
    healthHappiness = 0.25;
  }

  // 학력 행복도 (5% 가중치)
  let educationHappiness = 0.50;
  switch(education) {
    case 'doctorate': educationHappiness = 0.85; break;
    case 'master': educationHappiness = 0.75; break;
    case 'bachelor': educationHappiness = 0.65; break;
    case 'somecollege': educationHappiness = 0.55; break;
    case 'hs': educationHappiness = 0.45; break;
  }

  // 국가 행복도 (3% 가중치)
  const countryHappiness = countryCDFPercentile(country);

  // 성별 행복도 (2% 가중치)
  const sexHappiness = sexPercentile(sex);

  // 가중 평균 계산
  const totalHappiness =
    wealthHappiness * 0.80 +
    healthHappiness * 0.10 +
    educationHappiness * 0.05 +
    countryHappiness * 0.03 +
    sexHappiness * 0.02;

  return clamp(totalHappiness, 0.001, 0.999);
}

function compute(){
  const country = canonicalCountry(document.getElementById('country').value);
  const sex = document.getElementById('sex').value;
  const birthYear = +document.getElementById('birthYear').value;
  const birthMonth = +document.getElementById('birthMonth').value || null;
  const birthDay = +document.getElementById('birthDay').value || null;
  const age = calculateAge(birthYear, birthMonth, birthDay);
  const health = document.getElementById('health').value;
  const units = document.getElementById('units').value;
  const cash = +document.getElementById('cash').value || 0;
  const realEstate = +document.getElementById('realEstate').value || 0;
  const stocks = +document.getElementById('stocks').value || 0;
  const debt = +document.getElementById('debt').value || 0;
  const income = +document.getElementById('income').value || 0;
  const education = document.getElementById('education').value;
  const university = document.getElementById('university').value.trim();
  const race = document.getElementById('race').value;
  const children = +document.getElementById('children').value;
  const lifeExpectancy = +document.getElementById('lifeExpectancy').value || 0;
  const happiness = +document.getElementById('happiness').value || 0;
  const fatherStatus = document.getElementById('fatherStatus').value;
  const fatherAge = +document.getElementById('fatherAge').value || 0;
  const motherStatus = document.getElementById('motherStatus').value;
  const motherAge = +document.getElementById('motherAge').value || 0;

  const netWorth = cash + realEstate + stocks - debt;

  const pCountry = countryCDFPercentile(country);
  const pSex = sexPercentile(sex);
  const pAge = agePercentile(age);
  const pWealth = wealthPercentile(cash, realEstate, stocks, debt);
  const pIncome = incomePercentile(income);
  const pHealth = healthPercentile(health);
  const bmi = bmiFromInputs();
  const pBMI = bmiPercentile(bmi);
  const pEdu = educationPercentile(education);
  const pFamily = familyPercentileNew(children, fatherStatus, fatherAge, motherStatus, motherAge, age);
  const pLifeExp = lifeExpectancyPercentile(lifeExpectancy, age);
  const pHappiness = happinessPercentile(happiness);

  const Wsum = Object.values(W).reduce((a,b)=>a+b,0);
  const P = clamp(
    (pWealth * W.wealth + pIncome * W.income + pEdu * W.education + pLifeExp * W.lifeExp +
     pHappiness * W.happiness + pCountry * W.country + pHealth * W.health + pFamily * W.family) / Wsum,
    0.0001, 0.9999
  );
  const rank = Math.round(WORLD_TOTAL * (1 - P));
  const pctText = pct(1 - P) + '%';

  // Update main result display
  const res = document.getElementById('result');
  const bmiTxt = (bmi && isFinite(bmi)) ? bmi.toFixed(1) : 'N/A';
  res.innerHTML = `
    <div class="big">🏆 Global Rank: <b>#${fmtInt(rank)}</b> out of ~${fmtInt(WORLD_TOTAL)} people</div>
    <div style="margin:8px 0; font-size:16px">You're in the top <b style="color:var(--accent)">${pctText}</b> globally!</div>
    <div class="small" style="margin-top:10px; line-height:1.3">
      🌍 <b>${country}</b> · ${sex === 'male' ? '👨' : sex === 'female' ? '👩' : '🧑'} <b>${sex}</b> · 🎂 <b>${age}</b> years ·
      💰 Net Worth: <b>$${fmtInt(netWorth)}</b> · 💵 Income: <b>$${fmtInt(income)}</b>
    </div>
  `;

  // Show visual elements
  updatePopulationVisualization(1 - P, rank);
  updateWealthChart(cash, realEstate, stocks, debt, netWorth);
  updateComparisonCharts(pAge, pIncome);
  updateFunFacts(rank, 1 - P, country, age, netWorth);
  updateLifeTimeline(age, lifeExpectancy, fatherStatus, fatherAge, motherStatus, motherAge);
  updateHappinessVisualization(happiness);

  // Store result for export
  window.__lastResult = {
    country, sex, age, health, units,
    height_cm: units==='metric' ? +document.getElementById('heightCm').value : null,
    weight_kg: units==='metric' ? +document.getElementById('weightKg').value : null,
    height_ft: units==='imperial' ? +document.getElementById('heightFt').value : null,
    height_in: units==='imperial' ? +document.getElementById('heightIn').value : null,
    weight_lb: units==='imperial' ? +document.getElementById('weightLb').value : null,
    bmi, cash, realEstate, stocks, debt, net_worth: netWorth, income,
    education, university, race, children, parents_alive: parentsAlive,
    percentiles:{ country:pCountry, sex:pSex, age:pAge, wealth:pWealth, income:pIncome, health:pHealth, bmi:pBMI, education:pEdu, family:pFamily },
    weights: W, composite_percentile: 1 - P, world_total: WORLD_TOTAL, rank
  };
}

document.getElementById('btnCalc').addEventListener('click', compute);
document.getElementById('btnReset').addEventListener('click', ()=>{
  ['country','birthYear','birthDay','cash','realEstate','stocks','debt','income','children','lifeExpectancy','happiness','fatherAge','motherAge','university','heightCm','weightKg','heightFt','heightIn','weightLb'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
  document.getElementById('sex').value='male';
  document.getElementById('birthMonth').value='';
  document.getElementById('health').value='good';
  document.getElementById('units').value='metric';
  document.getElementById('education').value='hs';
  document.getElementById('race').value='na';
  document.getElementById('fatherStatus').value='alive';
  document.getElementById('motherStatus').value='alive';
  document.getElementById('fatherAgeLabel').textContent='Father\'s Current Age';
  document.getElementById('motherAgeLabel').textContent='Mother\'s Current Age';
  document.getElementById('calculatedAge').textContent='Enter birth date';
  document.getElementById('calculatedAge').style.color='var(--muted)';
  document.querySelectorAll('.metric-only').forEach(e=>e.style.display='block');
  document.querySelectorAll('.imperial-only').forEach(e=>e.style.display='none');
  document.getElementById('result').innerHTML='Enter inputs and click <span class="kbd">Calculate</span>.';

  // Hide visual elements
  ['populationViz','wealthChart','comparisonCharts','funFacts','lifeTimeline','happinessViz'].forEach(id=>{
    document.getElementById(id).style.display='none';
  });
});

// Units toggle
document.getElementById('units').addEventListener('change', (e)=>{
  const v = e.target.value;
  document.querySelectorAll('.metric-only').forEach(el=>el.style.display = v==='metric' ? 'block' : 'none');
  document.querySelectorAll('.imperial-only').forEach(el=>el.style.display = v==='imperial' ? 'block' : 'none');
});

// Parent status toggles
document.getElementById('fatherStatus').addEventListener('change', (e)=>{
  const label = document.getElementById('fatherAgeLabel');
  if(e.target.value === 'deceased'){
    label.textContent = 'Father\'s Age at Death';
  } else {
    label.textContent = 'Father\'s Current Age';
  }
});

document.getElementById('motherStatus').addEventListener('change', (e)=>{
  const label = document.getElementById('motherAgeLabel');
  if(e.target.value === 'deceased'){
    label.textContent = 'Mother\'s Age at Death';
  } else {
    label.textContent = 'Mother\'s Current Age';
  }
});

// Copy & Download
document.getElementById('btnCopy').addEventListener('click', ()=>{
  const R = window.__lastResult;
  if(!R){ alert('Please calculate first.'); return; }
  const txt = `Global rank: #${fmtInt(R.rank)} among ~${fmtInt(R.world_total)} (top ${pct(R.composite_percentile)}%). ` +
              `Country=${R.country}, Gender=${R.sex}, Age=${R.age}, Health=${R.health}, BMI=${R.bmi?R.bmi.toFixed(1):'N/A'}, ` +
              `Net worth=$${fmtInt(R.net_worth||0)}, Income=$${fmtInt(R.income||0)}, ` +
              `Education=${document.querySelector('#education option:checked').textContent}, University=${R.university||'-'}, Race=${document.querySelector('#race option:checked').textContent}, ` +
              `Children=${R.children}, Parents alive=${R.parents_alive}.`;
  navigator.clipboard.writeText(txt).then(()=>alert('Copied!')).catch(()=>alert('Copy failed. Check browser permissions.'));
});

document.getElementById('btnDownload').addEventListener('click', ()=>{
  const R = window.__lastResult;
  if(!R){ alert('Please calculate first.'); return; }
  const blob = new Blob([JSON.stringify(R,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'my_global_rank_extended_result.json';
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
});
</script>
</body>
</html>
