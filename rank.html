<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>My Global Rank ‚Äî Ultimate v2.0 (Enhanced)</title>
<meta name="description" content="Ultimate global ranking with enhanced features: auto-save, advanced visualizations, testing, and comprehensive personal data analysis.">
<style>
:root{
  --bg:#0b0f14; --card:#10161d; --fg:#e6edf3; --muted:#96a1ad;
  --border:#22303c; --accent:#60a5fa; --green:#22c55e; --warn:#f59e0b;
  --success:#22c55e; --error:#ef4444; --purple:#8b5cf6;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
h1{margin:0 0 10px 0;font-size:clamp(20px,4vw,32px)}
.version{background:var(--purple);color:white;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:bold;margin-left:8px}
.sub{color:var(--muted);font-size:clamp(12px,2.5vw,14px);margin-bottom:16px;line-height:1.4}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:768px){.grid{gap:16px}}
@media(min-width:1080px){.grid{grid-template-columns:1.15fr .85fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
@media(min-width:768px){.card{border-radius:16px;padding:16px}}
.card h2{margin:0 0 12px 0;font-size:clamp(16px,3vw,18px)}
label{display:block;margin:8px 0 4px 0;color:var(--muted);font-size:clamp(11px,2.5vw,12px)}
input[type="text"],input[type="number"],select{
  width:100%;padding:10px 8px;border-radius:8px;border:1px solid var(--border);background:#0e141b;color:var(--fg);font-size:14px;
}
@media(min-width:768px){
  input[type="text"],input[type="number"],select{padding:11px 12px;border-radius:12px}
}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
@media(min-width:768px){.row{gap:10px}}
.col{flex:1;min-width:160px}
@media(min-width:768px){.col{min-width:210px}}
button{appearance:none;border:none;background:var(--accent);color:#031225;padding:12px 16px;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;width:100%;margin:4px 0}
@media(min-width:768px){button{padding:10px 14px;border-radius:12px;width:auto;margin:0}}
button.ghost{background:transparent;color:var(--fg);border:1px solid var(--border)}
button.success{background:var(--success)}
button.warn{background:var(--warn)}
button.error{background:var(--error)}
.small{font-size:clamp(11px,2.5vw,12px);color:var(--muted)}
.kbd{padding:1px 6px;border:1px solid var(--border);border-radius:6px;background:#0b1218;color:var(--muted)}
.resultBox{border:1px dashed var(--border);border-radius:8px;padding:12px;margin-top:10px}
@media(min-width:768px){.resultBox{border-radius:12px;padding:14px}}
.big{font-size:clamp(18px,4vw,22px);font-weight:900;line-height:1.2}
.progress{height:12px;background:#0b1218;border:1px solid var(--border);border-radius:999px;overflow:hidden}
@media(min-width:768px){.progress{height:14px}}
.progress>div{height:100%;background:linear-gradient(90deg,#0ea5e9,#22c55e);width:0%}
.flex{display:flex;justify-content:space-between;gap:6px;align-items:center;flex-wrap:wrap}
@media(min-width:768px){.flex{gap:8px;flex-wrap:nowrap}}
.table{width:100%;border-collapse:collapse;margin-top:8px;font-size:12px}
@media(min-width:768px){.table{font-size:13px}}
.table th,.table td{border-bottom:1px solid var(--border);padding:6px 4px}
@media(min-width:768px){.table th,.table td{padding:8px 6px}}
.badge{display:inline-block;background:#0b1218;border:1px solid var(--border);padding:3px 6px;border-radius:999px;color:var(--muted);font-size:10px;margin:2px 4px 2px 0}
@media(min-width:768px){.badge{padding:4px 8px;font-size:12px;margin-right:6px}}
.note{display:inline-block;margin-top:6px;padding:6px 8px;border:1px solid var(--border);border-radius:8px;color:var(--muted);font-size:clamp(10px,2.5vw,12px)}
@media(min-width:768px){.note{padding:6px 10px;border-radius:10px}}
.section{margin-top:10px;padding-top:8px;border-top:1px dashed var(--border)}
.notification{position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:8px;color:white;font-weight:bold;z-index:1000;max-width:300px}
.notification.success{background:var(--success)}
.notification.error{background:var(--error)}
.notification.info{background:var(--accent)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>My Global Rank <span style="color:var(--accent)">‚Äî Ultimate</span> <span class="version">v2.0</span> üéØ</h1>
    <div class="sub">Calculate your precise global ranking among <b>8.25 billion</b> people with enhanced features: auto-save, advanced visualizations, and comprehensive testing.</div>

    <!-- Real-time World Population Counter -->
    <div style="background:#1a202c; border-radius:12px; padding:12px; margin:10px 0; border:1px solid var(--border)">
      <div style="text-align:center">
        <div style="font-size:clamp(11px,2.5vw,12px); color:var(--muted); margin-bottom:4px">üåç Current World Population</div>
        <div id="worldPopulation" style="font-size:clamp(18px,4vw,24px); font-weight:bold; color:var(--accent); font-family:monospace; transition:transform 0.2s ease, text-shadow 0.2s ease">8,246,975,554</div>
        <div style="font-size:clamp(10px,2vw,11px); color:var(--muted); margin-top:4px">
          <span id="populationGrowth">+0</span> people since you opened this page
        </div>
      </div>

      <!-- Population Growth Statistics -->
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:10px; font-size:clamp(9px,2vw,10px); text-align:center">
        <div style="padding:4px; background:#0e141b; border-radius:6px">
          <div style="color:var(--accent); font-weight:bold" id="birthsToday">+0</div>
          <div style="color:var(--muted)">üë∂ Births today</div>
        </div>
        <div style="padding:4px; background:#0e141b; border-radius:6px">
          <div style="color:var(--green); font-weight:bold">+4.2/sec</div>
          <div style="color:var(--muted)">üìà Growth rate</div>
        </div>
        <div style="padding:4px; background:#0e141b; border-radius:6px">
          <div style="color:var(--warn); font-weight:bold" id="deathsToday">+0</div>
          <div style="color:var(--muted)">üíÄ Deaths today</div>
        </div>
      </div>

      <!-- Continental Population Growth -->
      <div style="margin-top:12px; border-top:1px solid var(--border); padding-top:10px">
        <div style="font-size:clamp(10px,2.2vw,11px); color:var(--muted); margin-bottom:8px; text-align:center; font-weight:bold">üåè Continental Growth (today)</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; font-size:clamp(8px,1.8vw,9px)">
          <div style="padding:3px 6px; background:#0e141b; border-radius:4px; display:flex; justify-content:space-between">
            <span>üåè Asia</span>
            <span style="color:var(--accent); font-weight:bold" id="asiaGrowth">+0</span>
          </div>
          <div style="padding:3px 6px; background:#0e141b; border-radius:4px; display:flex; justify-content:space-between">
            <span>üåç Africa</span>
            <span style="color:var(--green); font-weight:bold" id="africaGrowth">+0</span>
          </div>
          <div style="padding:3px 6px; background:#0e141b; border-radius:4px; display:flex; justify-content:space-between">
            <span>üåé Americas</span>
            <span style="color:var(--warn); font-weight:bold" id="americasGrowth">+0</span>
          </div>
          <div style="padding:3px 6px; background:#0e141b; border-radius:4px; display:flex; justify-content:space-between">
            <span>üåç Europe</span>
            <span style="color:#8b5cf6; font-weight:bold" id="europeGrowth">+0</span>
          </div>
        </div>
      </div>
    </div>

    <div>
      <span class="badge">v2.0 Enhanced</span>
      <span class="badge">Auto-Save</span>
      <span class="badge">Advanced Visualizations</span>
      <span class="badge">Real-time Population</span>
    </div>
  </header>

  <section class="grid">
    <div class="card">
      <h2>Inputs</h2>

      <!-- Cache Control Panel -->
      <div style="background:#1a202c; border-radius:8px; padding:10px; margin-bottom:12px; border:1px solid var(--border)">
        <div class="small" style="margin-bottom:6px; font-weight:bold">üíæ Data Management</div>
        <div class="row">
          <button id="btnLoadCache" class="ghost" style="flex:1">Load Saved Data</button>
          <button id="btnClearCache" class="error" style="flex:1">Clear Cache</button>
          <button id="btnExportData" class="ghost" style="flex:1">Export Data</button>
        </div>
        <div id="cacheStatus" class="small" style="margin-top:4px; color:var(--muted)">Auto-save: Enabled</div>
      </div>

      <div class="row">
        <div class="col">
          <label>Country</label>
          <input id="country" list="countryList" placeholder="e.g., South Korea, United States, Japan"><datalist id="countryList"></datalist>
        </div>
        <div class="col">
          <label>Gender</label>
          <select id="sex">
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other / Prefer not to say</option>
          </select>
        </div>
        <div class="col">
          <label>Birth Date</label>
          <div class="row" style="gap:6px">
            <input id="birthYear" type="number" min="1900" max="2025" step="1" placeholder="Year" style="flex:2">
            <select id="birthMonth" style="flex:1">
              <option value="">Month</option>
              <option value="1">Jan</option>
              <option value="2">Feb</option>
              <option value="3">Mar</option>
              <option value="4">Apr</option>
              <option value="5">May</option>
              <option value="6">Jun</option>
              <option value="7">Jul</option>
              <option value="8">Aug</option>
              <option value="9">Sep</option>
              <option value="10">Oct</option>
              <option value="11">Nov</option>
              <option value="12">Dec</option>
            </select>
            <input id="birthDay" type="number" min="1" max="31" step="1" placeholder="Day" style="flex:1">
          </div>
        </div>
        <div class="col" style="min-width:120px">
          <label>Current Age</label>
          <div id="calculatedAge" style="padding:11px 12px; border-radius:12px; border:1px solid var(--border); background:#0e141b; color:var(--accent); font-weight:bold; text-align:center">Enter birth date</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Self-reported health</label>
          <select id="health">
            <option value="good">Good</option>
            <option value="excellent">Excellent</option>
            <option value="fair">Fair</option>
            <option value="poor">Poor</option>
            <option value="na">Prefer not to say</option>
          </select>
        </div>
        <div class="col">
          <label>Units</label>
          <select id="units">
            <option value="metric" selected>Metric (cm, kg)</option>
            <option value="imperial">Imperial (ft/in, lb)</option>
          </select>
        </div>
        <div class="col metric-only">
          <label>Height (cm)</label>
          <input id="heightCm" type="number" min="80" max="250" step="0.1" placeholder="e.g., 175">
        </div>
        <div class="col metric-only">
          <label>Weight (kg)</label>
          <input id="weightKg" type="number" min="20" max="300" step="0.1" placeholder="e.g., 70">
        </div>
        <div class="col imperial-only" style="display:none">
          <label>Height (ft + in)</label>
          <div class="row" style="gap:6px">
            <input id="heightFt" type="number" min="3" max="8" step="1" placeholder="ft" style="flex:1">
            <input id="heightIn" type="number" min="0" max="11" step="1" placeholder="in" style="flex:1">
          </div>
        </div>
        <div class="col imperial-only" style="display:none">
          <label>Weight (lb)</label>
          <input id="weightLb" type="number" min="50" max="600" step="0.1" placeholder="e.g., 154">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Cash & Savings (USD)</label>
          <input id="cash" type="number" min="0" step="100" placeholder="e.g., 50000">
        </div>
        <div class="col">
          <label>Real Estate Value (USD)</label>
          <input id="realEstate" type="number" min="0" step="1000" placeholder="e.g., 300000">
        </div>
        <div class="col">
          <label>Stock/Investment Value (USD)</label>
          <input id="stocks" type="number" min="0" step="100" placeholder="e.g., 75000">
        </div>
        <div class="col">
          <label>Total Debt (USD)</label>
          <input id="debt" type="number" min="0" step="100" placeholder="e.g., 25000">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Annual Income (USD)</label>
          <input id="income" type="number" min="0" step="100" placeholder="e.g., 80000">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Education</label>
          <select id="education">
            <option value="hs">High school or below</option>
            <option value="somecollege">Some college</option>
            <option value="bachelor">Bachelor's</option>
            <option value="master">Master's</option>
            <option value="doctorate">Doctorate</option>
          </select>
        </div>
        <div class="col">
          <label>University (optional, display-only)</label>
          <input id="university" type="text" placeholder="e.g., University of Michigan">
        </div>
        <div class="col">
          <label>Race / Ethnicity (not used in score)</label>
          <select id="race">
            <option value="na">Prefer not to say</option>
            <option value="asian">Asian</option>
            <option value="black">Black</option>
            <option value="white">White</option>
            <option value="latino">Hispanic / Latino</option>
            <option value="mena">Middle Eastern / North African</option>
            <option value="indigenous">Indigenous</option>
            <option value="pi">Pacific Islander</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Children</label>
          <input id="children" type="number" min="0" max="12" step="1" value="0">
        </div>
        <div class="col">
          <label>Expected Life Span (years)</label>
          <input id="lifeExpectancy" type="number" min="50" max="120" step="1" placeholder="World avg: 73">
        </div>
        <div class="col">
          <label>Happiness Score (1-10)</label>
          <input id="happiness" type="number" min="1" max="10" step="0.1" placeholder="World avg: 5.4">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Father Status</label>
          <select id="fatherStatus">
            <option value="alive">Alive</option>
            <option value="deceased">Deceased</option>
          </select>
        </div>
        <div class="col" id="fatherAgeGroup">
          <label id="fatherAgeLabel">Father's Current Age</label>
          <input id="fatherAge" type="number" min="30" max="120" step="1" placeholder="e.g., 65">
        </div>
        <div class="col">
          <label>Mother Status</label>
          <select id="motherStatus">
            <option value="alive">Alive</option>
            <option value="deceased">Deceased</option>
          </select>
        </div>
        <div class="col" id="motherAgeGroup">
          <label id="motherAgeLabel">Mother's Current Age</label>
          <input id="motherAge" type="number" min="30" max="120" step="1" placeholder="e.g., 62">
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="btnCalc">Calculate my global rank</button>
        <button id="btnReset" class="error">Complete Reset</button>
        <button id="btnTest" class="warn">Run Tests</button>
      </div>
    </div>

    <div class="card">
      <h2>Your Global Rank üéØ</h2>
      <div id="result" class="resultBox">Enter inputs and click <span class="kbd">Calculate</span>.</div>

      <!-- Enhanced Global Population Visualization -->
      <div id="populationViz" style="display:none; margin:15px 0">
        <div class="small" style="margin-bottom:8px; font-weight:bold">üåç Your Position Among 8.25 Billion People</div>
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px">
          <div style="flex:1; height:24px; background:#1e293b; border-radius:12px; overflow:hidden; position:relative; border:1px solid var(--border)">
            <div id="rankBar" style="height:100%; background:linear-gradient(90deg,#ef4444,#f97316,#eab308,#22c55e); border-radius:12px; width:0%; transition:width 0.8s ease"></div>
            <div id="rankMarker" style="position:absolute; top:-2px; width:3px; height:28px; background:#fff; left:0%; transition:left 0.8s ease; box-shadow:0 0 8px rgba(255,255,255,0.6)"></div>
          </div>
          <div class="small" id="rankPosition" style="font-weight:bold; color:var(--accent)">You</div>
        </div>
        <div style="display:flex; justify-content:space-between; font-size:11px; color:var(--muted)">
          <span>üë∂ Rank 8.25B (Bottom)</span>
          <span>üëë Rank 1 (Top)</span>
        </div>
        <div id="rankDetails" style="margin-top:8px; padding:8px; background:#1a202c; border-radius:8px; font-size:11px"></div>
      </div>

      <!-- Enhanced Wealth Breakdown Chart -->
      <div id="wealthChart" style="display:none; margin:15px 0">
        <div class="small" style="margin-bottom:8px; font-weight:bold">üí∞ Your Wealth Breakdown</div>
        <div id="wealthBars"></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px; font-size:11px">
          <div style="padding:4px 8px; background:#1a202c; border-radius:6px">
            <div class="small" style="color:var(--muted)">Net Worth</div>
            <div id="netWorthTotal" style="font-weight:bold; color:var(--green)">$0</div>
          </div>
          <div style="padding:4px 8px; background:#1a202c; border-radius:6px">
            <div class="small" style="color:var(--muted)">Wealth Rank</div>
            <div id="wealthRankDisplay" style="font-weight:bold; color:var(--accent)">-</div>
          </div>
        </div>
      </div>

      <!-- Enhanced Comparison Charts -->
      <div id="comparisonCharts" style="display:none; margin:15px 0">
        <div class="small" style="margin-bottom:8px; font-weight:bold">üìä How You Compare Globally</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:12px">
          <div>
            <div class="small" style="margin-bottom:5px">üë• Age Distribution</div>
            <div id="ageChart" style="height:60px; background:#1e293b; border-radius:8px; position:relative; overflow:hidden; border:1px solid var(--border)"></div>
          </div>
          <div>
            <div class="small" style="margin-bottom:5px">üíµ Income Distribution</div>
            <div id="incomeChart" style="height:60px; background:#1e293b; border-radius:8px; position:relative; overflow:hidden; border:1px solid var(--border)"></div>
          </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px">
          <div>
            <div class="small" style="margin-bottom:5px">üéì Education Level</div>
            <div id="educationChart" style="height:60px; background:#1e293b; border-radius:8px; position:relative; overflow:hidden; border:1px solid var(--border)"></div>
          </div>
          <div>
            <div class="small" style="margin-bottom:5px">üè• Health Status</div>
            <div id="healthChart" style="height:60px; background:#1e293b; border-radius:8px; position:relative; overflow:hidden; border:1px solid var(--border)"></div>
          </div>
        </div>
      </div>

      <!-- Enhanced Fun Facts -->
      <div id="funFacts" style="display:none; margin:15px 0; padding:12px; background:#1a202c; border-radius:10px; border:1px solid var(--border)">
        <div class="small" style="margin-bottom:8px; font-weight:bold">üéâ Amazing Facts About Your Global Position</div>
        <div id="factsContent" style="font-size:12px; line-height:1.4"></div>
        <div id="comparisonFacts" style="margin-top:8px; padding-top:8px; border-top:1px solid var(--border); font-size:11px; color:var(--muted)"></div>
      </div>

      <!-- Enhanced Life Timeline -->
      <div id="lifeTimeline" style="display:none; margin:15px 0">
        <div class="small" style="margin-bottom:8px; font-weight:bold">‚è∞ Your Life Journey</div>
        <div id="timelineViz" style="background:#1a202c; border-radius:10px; padding:12px; margin-bottom:8px; border:1px solid var(--border)">
          <div style="display:flex; align-items:center; margin-bottom:8px">
            <div style="width:60px; font-size:11px">Life</div>
            <div style="flex:1; height:24px; background:#2a2a2a; border-radius:12px; overflow:hidden; position:relative; margin:0 8px">
              <div id="lifeProgress" style="height:100%; background:linear-gradient(90deg,#22c55e,#eab308,#ef4444); border-radius:12px; width:0%; transition:width 0.8s ease"></div>
              <div id="lifeMarker" style="position:absolute; top:-2px; width:3px; height:28px; background:#fff; left:0%; transition:left 0.8s ease"></div>
            </div>
            <div style="width:80px; font-size:11px; text-align:right" id="lifeYears">0 years</div>
          </div>
          <div style="display:flex; justify-content:space-between; font-size:10px; color:var(--muted)">
            <span>üçº Birth</span>
            <span id="currentLifeStage" style="color:var(--accent); font-weight:bold">Current</span>
            <span>üíÄ Expected End</span>
          </div>
        </div>
        <div id="parentAges" style="font-size:11px; color:var(--muted)"></div>
        <div id="lifeStatsGrid" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; margin-top:8px; font-size:10px"></div>
      </div>

      <!-- Enhanced Happiness Visualization -->
      <div id="happinessViz" style="display:none; margin:15px 0">
        <div class="small" style="margin-bottom:8px; font-weight:bold">üòä Your Happiness & Well-being</div>
        <div style="background:#1a202c; border-radius:10px; padding:12px; border:1px solid var(--border)">
          <div style="display:flex; align-items:center; margin-bottom:8px">
            <div style="width:50px; font-size:11px">üò¢ 1</div>
            <div style="flex:1; height:28px; background:#2a2a2a; border-radius:14px; overflow:hidden; position:relative; margin:0 8px">
              <div id="happinessBar" style="height:100%; background:linear-gradient(90deg,#ef4444,#eab308,#22c55e); border-radius:14px; width:0%; transition:width 0.8s ease"></div>
              <div id="happinessMarker" style="position:absolute; top:2px; width:24px; height:24px; background:rgba(255,255,255,0.95); border-radius:12px; left:0%; transition:left 0.8s ease; display:flex; align-items:center; justify-content:center; font-size:14px; border:2px solid #333">üòä</div>
            </div>
            <div style="width:50px; font-size:11px; text-align:right">üòÑ 10</div>
          </div>
          <div style="text-align:center; font-size:12px; margin-bottom:6px" id="happinessText">Your happiness: 0.0/10</div>
          <div style="text-align:center; font-size:10px; color:var(--muted)" id="happinessComparison">World average: 5.4/10</div>
        </div>
      </div>

      <!-- Test Results Panel -->
      <div id="testResults" style="display:none; margin:15px 0; padding:12px; background:#1a202c; border-radius:10px; border:1px solid var(--border)">
        <div class="small" style="margin-bottom:8px; font-weight:bold">üß™ Test Results</div>
        <div id="testOutput" style="font-size:11px; line-height:1.4; font-family:monospace"></div>
      </div>

      <div class="row" style="margin-top:15px">
        <button id="btnCopy" class="ghost">Copy Result</button>
        <button id="btnDownload" class="ghost">Download JSON</button>
        <button id="btnShare" class="ghost">Share Results</button>
      </div>

    </div>
  </section>

  <footer style="margin-top:14px" class="small">
    Global Ranking System ¬© 2025 - Ultimate Edition v2.0 with Enhanced Features
  </footer>
</div>

<script>
// =======================
// Version 2.0 Enhanced Global Ranking System
// Features: Auto-save, Advanced Visualizations, Comprehensive Testing
// =======================

const VERSION = "2.0";
const CACHE_KEY = "globalRankData_v2";

// =======================
// Data (Enhanced)
// =======================
const WORLD_TOTAL_BASE = 8_246_975_554;
const POPULATION_GROWTH_PER_SECOND = 2.5;
let WORLD_TOTAL = WORLD_TOTAL_BASE;
let pageStartTime = Date.now();

// =======================
// Notification System
// =======================
function showNotification(message, type = 'info', duration = 3000) {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);

  setTimeout(() => {
    notification.style.opacity = '0';
    setTimeout(() => notification.remove(), 300);
  }, duration);
}

// =======================
// Cache Management System
// =======================
function saveToCache() {
  const data = {};
  const inputs = ['country', 'sex', 'birthYear', 'birthMonth', 'birthDay', 'health', 'units',
                 'heightCm', 'weightKg', 'heightFt', 'heightIn', 'weightLb', 'cash', 'realEstate',
                 'stocks', 'debt', 'income', 'education', 'university', 'race', 'children',
                 'lifeExpectancy', 'happiness', 'fatherStatus', 'fatherAge', 'motherStatus', 'motherAge'];

  inputs.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      data[id] = element.value;
    }
  });

  data.timestamp = Date.now();
  data.version = VERSION;

  try {
    localStorage.setItem(CACHE_KEY, JSON.stringify(data));
    updateCacheStatus('Data auto-saved successfully');
  } catch (e) {
    updateCacheStatus('Auto-save failed: ' + e.message, 'error');
  }
}

function loadFromCache() {
  try {
    const cachedData = localStorage.getItem(CACHE_KEY);
    if (!cachedData) {
      showNotification('No saved data found', 'info');
      return false;
    }

    const data = JSON.parse(cachedData);
    if (data.version !== VERSION) {
      showNotification('Saved data is from older version, loading anyway', 'info');
    }

    Object.keys(data).forEach(key => {
      if (key !== 'timestamp' && key !== 'version') {
        const element = document.getElementById(key);
        if (element && data[key] !== undefined && data[key] !== '') {
          element.value = data[key];
        }
      }
    });

    updateAge();
    updateUnitsDisplay();
    updateParentLabels();

    const date = new Date(data.timestamp);
    showNotification(`Data loaded from ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`, 'success');
    updateCacheStatus(`Loaded from ${date.toLocaleDateString()}`);
    return true;
  } catch (e) {
    showNotification('Failed to load cached data: ' + e.message, 'error');
    return false;
  }
}

function clearCache() {
  try {
    localStorage.removeItem(CACHE_KEY);
    showNotification('Cache cleared successfully', 'success');
    updateCacheStatus('Cache cleared');
  } catch (e) {
    showNotification('Failed to clear cache: ' + e.message, 'error');
  }
}

function updateCacheStatus(message, type = 'info') {
  const status = document.getElementById('cacheStatus');
  if (status) {
    status.textContent = message;
    status.style.color = type === 'error' ? 'var(--error)' : 'var(--muted)';
  }
}

// Auto-save on input changes
function setupAutoSave() {
  const inputs = document.querySelectorAll('input, select');
  inputs.forEach(input => {
    input.addEventListener('change', () => {
      setTimeout(saveToCache, 100); // Small delay to batch rapid changes
    });
  });
}

// =======================
// Enhanced Testing System
// =======================
function runComprehensiveTests() {
  const testOutput = document.getElementById('testOutput');
  const testResults = document.getElementById('testResults');
  testResults.style.display = 'block';
  testOutput.innerHTML = 'Running comprehensive tests...\n\n';

  const tests = [
    testRankingLogic,
    testCacheSystem,
    testCalculationAccuracy,
    testEdgeCases,
    testVisualizationUpdates,
    testDataValidation
  ];

  let passed = 0;
  let total = tests.length;

  tests.forEach((test, index) => {
    try {
      const result = test();
      if (result.passed) {
        testOutput.innerHTML += `‚úÖ Test ${index + 1}: ${result.name} - PASSED\n`;
        if (result.details) testOutput.innerHTML += `   ${result.details}\n`;
        passed++;
      } else {
        testOutput.innerHTML += `‚ùå Test ${index + 1}: ${result.name} - FAILED\n`;
        if (result.error) testOutput.innerHTML += `   Error: ${result.error}\n`;
      }
    } catch (e) {
      testOutput.innerHTML += `‚ùå Test ${index + 1}: ${test.name} - CRASHED\n`;
      testOutput.innerHTML += `   Exception: ${e.message}\n`;
    }
    testOutput.innerHTML += '\n';
  });

  testOutput.innerHTML += `\nüìä Test Summary: ${passed}/${total} tests passed\n`;

  if (passed === total) {
    testOutput.innerHTML += 'üéâ All tests passed! System is working correctly.\n';
    showNotification('All tests passed!', 'success');
  } else {
    testOutput.innerHTML += '‚ö†Ô∏è Some tests failed. Check results above.\n';
    showNotification(`${total - passed} tests failed`, 'error');
  }
}

function testRankingLogic() {
  // Test that higher percentiles result in better (lower) ranks
  const mockData = {
    percentile: 0.99, // Top 1%
    worldTotal: 1000000
  };

  const rank = Math.round(mockData.worldTotal * (1 - mockData.percentile));
  const expectedRank = 10000; // Should be around rank 10,000 out of 1M

  return {
    name: "Ranking Logic",
    passed: rank === expectedRank,
    details: `Rank ${rank} for top 1% of 1M people`,
    error: rank !== expectedRank ? `Expected ${expectedRank}, got ${rank}` : null
  };
}

function testCacheSystem() {
  const testData = { test: 'value', timestamp: Date.now() };

  try {
    localStorage.setItem('test_cache', JSON.stringify(testData));
    const retrieved = JSON.parse(localStorage.getItem('test_cache'));
    localStorage.removeItem('test_cache');

    return {
      name: "Cache System",
      passed: retrieved.test === 'value',
      details: "Local storage read/write successful"
    };
  } catch (e) {
    return {
      name: "Cache System",
      passed: false,
      error: e.message
    };
  }
}

function testCalculationAccuracy() {
  // Test wealth percentile calculation
  const netWorth = 100000;
  const percentile = wealthPercentile(netWorth, 0, 0, 0);
  const expectedRange = [0.85, 0.95]; // Should be in this range

  return {
    name: "Calculation Accuracy",
    passed: percentile >= expectedRange[0] && percentile <= expectedRange[1],
    details: `Wealth percentile ${(percentile * 100).toFixed(1)}% for $${netWorth}`,
    error: percentile < expectedRange[0] || percentile > expectedRange[1] ?
           `Percentile ${percentile} outside expected range` : null
  };
}

function testEdgeCases() {
  // Test extreme values
  const extremeWealth = wealthPercentile(0, 0, 0, 1000000); // Heavy debt
  const extremeAge = agePercentile(150); // Impossible age

  return {
    name: "Edge Cases",
    passed: extremeWealth >= 0 && extremeWealth <= 1 && extremeAge >= 0 && extremeAge <= 1,
    details: `Extreme debt: ${(extremeWealth * 100).toFixed(1)}%, Extreme age: ${(extremeAge * 100).toFixed(1)}%`
  };
}

function testVisualizationUpdates() {
  // Test that visualization elements exist
  const vizElements = ['populationViz', 'wealthChart', 'comparisonCharts', 'funFacts'];
  const exists = vizElements.every(id => document.getElementById(id) !== null);

  return {
    name: "Visualization Elements",
    passed: exists,
    details: `All ${vizElements.length} visualization containers found`
  };
}

function testDataValidation() {
  // Test input validation
  const validCountry = canonicalCountry('South Korea');
  const invalidCountry = canonicalCountry('');

  return {
    name: "Data Validation",
    passed: validCountry === 'South Korea' && invalidCountry === 'Other',
    details: `Valid: '${validCountry}', Invalid: '${invalidCountry}'`
  };
}

// =======================
// Population System (Same as before but enhanced)
// =======================
function updateWorldPopulation() {
  const now = Date.now();
  const secondsElapsed = (now - pageStartTime) / 1000;
  const populationIncrease = Math.floor(secondsElapsed * POPULATION_GROWTH_PER_SECOND);

  WORLD_TOTAL = WORLD_TOTAL_BASE + populationIncrease;

  const today = new Date();
  const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const secondsSinceMidnight = (now - todayStart.getTime()) / 1000;

  const birthsPerSecond = 4.3;
  const deathsPerSecond = 1.8;

  const birthsToday = Math.floor(secondsSinceMidnight * birthsPerSecond);
  const deathsToday = Math.floor(secondsSinceMidnight * deathsPerSecond);

  const continentalGrowthRates = {
    asia: 0.50,
    africa: 0.30,
    americas: 0.12,
    europe: 0.08
  };

  const totalGrowthToday = Math.floor(secondsSinceMidnight * (birthsPerSecond - deathsPerSecond));
  const asiaGrowthToday = Math.floor(totalGrowthToday * continentalGrowthRates.asia);
  const africaGrowthToday = Math.floor(totalGrowthToday * continentalGrowthRates.africa);
  const americasGrowthToday = Math.floor(totalGrowthToday * continentalGrowthRates.americas);
  const europeGrowthToday = Math.floor(totalGrowthToday * continentalGrowthRates.europe);

  const popElement = document.getElementById('worldPopulation');
  const growthElement = document.getElementById('populationGrowth');
  const birthsElement = document.getElementById('birthsToday');
  const deathsElement = document.getElementById('deathsToday');
  const asiaElement = document.getElementById('asiaGrowth');
  const africaElement = document.getElementById('africaGrowth');
  const americasElement = document.getElementById('americasGrowth');
  const europeElement = document.getElementById('europeGrowth');

  if (popElement) {
    popElement.textContent = WORLD_TOTAL.toLocaleString('en-US');

    if (populationIncrease > 0 && populationIncrease % Math.floor(POPULATION_GROWTH_PER_SECOND) === 0) {
      popElement.style.transform = 'scale(1.05)';
      popElement.style.textShadow = '0 0 10px var(--accent)';

      setTimeout(() => {
        popElement.style.transform = 'scale(1)';
        popElement.style.textShadow = 'none';
      }, 200);
    }
  }

  if (growthElement) {
    growthElement.textContent = populationIncrease > 0 ? `+${populationIncrease.toLocaleString('en-US')}` : '+0';
    growthElement.style.color = populationIncrease > 0 ? '#22c55e' : 'var(--muted)';
  }

  if (birthsElement) birthsElement.textContent = `+${birthsToday.toLocaleString('en-US')}`;
  if (deathsElement) deathsElement.textContent = `+${deathsToday.toLocaleString('en-US')}`;
  if (asiaElement) asiaElement.textContent = `+${asiaGrowthToday.toLocaleString('en-US')}`;
  if (africaElement) africaElement.textContent = `+${africaGrowthToday.toLocaleString('en-US')}`;
  if (americasElement) americasElement.textContent = `+${americasGrowthToday.toLocaleString('en-US')}`;
  if (europeElement) europeElement.textContent = `+${europeGrowthToday.toLocaleString('en-US')}`;
}

// =======================
// Country Data (Same as before)
// =======================
const COUNTRY_POP = {
  "India": 1429000000, "China": 1412000000, "United States": 334000000, "Indonesia": 276000000,
  "Pakistan": 240000000, "Nigeria": 223000000, "Brazil": 203000000, "Bangladesh": 172000000,
  "Russia": 146000000, "Mexico": 128000000, "Ethiopia": 126000000, "Japan": 123000000,
  "Philippines": 117000000, "Egypt": 112000000, "DR Congo": 102000000, "Vietnam": 100000000,
  "Turkey": 85000000, "Iran": 86000000, "Germany": 84000000, "Thailand": 70000000,
  "United Kingdom": 67000000, "France": 65000000, "Tanzania": 67000000, "South Africa": 60000000,
  "Italy": 59000000, "Kenya": 56000000, "Myanmar": 55000000, "South Korea": 52000000,
  "Colombia": 52000000, "Spain": 48000000, "Argentina": 46000000, "Algeria": 45000000,
  "Iraq": 45000000, "Afghanistan": 41000000, "Saudi Arabia": 36000000, "Uzbekistan": 36000000,
  "Ukraine": 36000000, "Morocco": 37000000, "Poland": 38000000, "Canada": 40000000,
  "Malaysia": 34000000, "Angola": 36000000, "Ghana": 33000000, "Mozambique": 33000000,
  "Yemen": 34000000, "Nepal": 30000000, "Australia": 26000000, "North Korea": 26000000,
  "Taiwan": 24000000, "Netherlands": 18000000, "Romania": 19000000, "Belgium": 11700000,
  "Greece": 10400000, "Czechia": 10700000, "Portugal": 10300000, "Sweden": 10500000,
  "Hungary": 9600000, "Austria": 9100000, "Switzerland": 8800000, "Israel": 9800000,
  "Denmark": 5900000, "Finland": 5600000, "Norway": 5500000, "Ireland": 5100000,
  "New Zealand": 5200000, "Singapore": 5900000, "Hong Kong": 7500000
};

const COUNTRY_ALIASES = {
  "usa":"United States","us":"United States","u.s.":"United States","united states of america":"United States",
  "uk":"United Kingdom","great britain":"United Kingdom","britain":"United Kingdom",
  "korea":"South Korea","south korea":"South Korea","republic of korea":"South Korea",
  "russian federation":"Russia","dr congo":"DR Congo","democratic republic of the congo":"DR Congo",
  "czech republic":"Czechia"
};

// Populate country datalist
(() => {
  const dl = document.getElementById('countryList');
  Object.keys(COUNTRY_POP).sort().forEach(c=>{
    const o = document.createElement('option'); o.value = c; dl.appendChild(o);
  });
})();

// =======================
// Utility Functions
// =======================
const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));
const fmtInt = (n) => n.toLocaleString('en-US');
const pct = (p) => Math.round(p*1000)/10;

function canonicalCountry(name){
  if(!name) return 'Other';
  const raw = name.trim();
  if(COUNTRY_POP[raw]) return raw;
  const low = raw.toLowerCase();
  if(COUNTRY_ALIASES[low]) return COUNTRY_ALIASES[low];
  const title = raw.replace(/\b\w/g, c=>c.toUpperCase());
  if(COUNTRY_POP[title]) return title;
  return 'Other';
}

function calculateAge(birthYear, birthMonth, birthDay) {
  if (!birthYear) return 0;

  const today = new Date();
  const birth = new Date(birthYear, (birthMonth || 1) - 1, birthDay || 1);

  let age = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();

  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
    age--;
  }

  return Math.max(0, age);
}

function updateAge() {
  const birthYear = +document.getElementById('birthYear').value;
  const birthMonth = +document.getElementById('birthMonth').value || null;
  const birthDay = +document.getElementById('birthDay').value || null;

  const age = calculateAge(birthYear, birthMonth, birthDay);
  const ageDisplay = document.getElementById('calculatedAge');

  if (birthYear && age >= 0) {
    ageDisplay.textContent = `${age} years old`;
    ageDisplay.style.color = 'var(--accent)';
  } else {
    ageDisplay.textContent = 'Enter birth date';
    ageDisplay.style.color = 'var(--muted)';
  }
}

function updateUnitsDisplay() {
  const units = document.getElementById('units').value;
  document.querySelectorAll('.metric-only').forEach(el=>el.style.display = units==='metric' ? 'block' : 'none');
  document.querySelectorAll('.imperial-only').forEach(el=>el.style.display = units==='imperial' ? 'block' : 'none');
}

function updateParentLabels() {
  const fatherStatus = document.getElementById('fatherStatus').value;
  const motherStatus = document.getElementById('motherStatus').value;

  document.getElementById('fatherAgeLabel').textContent =
    fatherStatus === 'deceased' ? 'Father\'s Age at Death' : 'Father\'s Current Age';
  document.getElementById('motherAgeLabel').textContent =
    motherStatus === 'deceased' ? 'Mother\'s Age at Death' : 'Mother\'s Current Age';
}

// =======================
// Percentile Calculation Functions (Enhanced)
// =======================
function countryCDFPercentile(country){
  const countryBonus = {
    'South Korea': 0.82, 'Japan': 0.85, 'United States': 0.88, 'Germany': 0.87,
    'United Kingdom': 0.86, 'France': 0.84, 'Canada': 0.85, 'Australia': 0.86,
    'Netherlands': 0.88, 'Switzerland': 0.92, 'Norway': 0.93, 'Denmark': 0.91,
    'Sweden': 0.90, 'Finland': 0.89, 'Singapore': 0.89, 'Hong Kong': 0.87,
    'Taiwan': 0.80, 'Israel': 0.83, 'China': 0.65, 'India': 0.45,
    'Brazil': 0.55, 'Russia': 0.60, 'Mexico': 0.50, 'Indonesia': 0.40
  };

  if(countryBonus[country] !== undefined){
    return countryBonus[country];
  }

  const sumKnown = Object.values(COUNTRY_POP).reduce((a,b)=>a+b,0);
  const others = Math.max(0, WORLD_TOTAL - sumKnown);
  const entries = Object.entries(COUNTRY_POP).concat([['Other', others]])
    .map(([k,v])=>({k,v}))
    .sort((a,b)=>b.v-a.v);
  let acc = 0;
  for(const e of entries){
    if(e.k === country){
      const mid = acc + e.v/2;
      return clamp(mid / WORLD_TOTAL, 0, 1);
    }
    acc += e.v;
  }
  return 0.50;
}

function sexPercentile(sex){
  if(sex==='male') return 0.505;
  if(sex==='female') return 0.495;
  return 0.500;
}

function agePercentile(age){
  const a = clamp(+age||0, 0, 110);
  if(a<=14) return 0.20*(a/14);
  if(a<=24) return 0.20 + 0.15*((a-24+14)/10);
  if(a<=34) return 0.35 + 0.15*((a-24)/10);
  if(a<=44) return 0.50 + 0.15*((a-34)/10);
  if(a<=54) return 0.65 + 0.15*((a-44)/10);
  if(a<=64) return 0.80 + 0.10*((a-54)/10);
  return 0.90 + 0.10*((a-64)/46);
}

function wealthPercentile(cash, realEstate, stocks, debt){
  const netWorth = (+cash||0) + (+realEstate||0) + (+stocks||0) - (+debt||0);
  let p;
  if(netWorth < -100_000) p = 0.01;
  else if(netWorth < -50_000) p = 0.05;
  else if(netWorth < -10_000) p = 0.10;
  else if(netWorth < 0) p = 0.20;
  else if(netWorth < 1_000) p = 0.40;
  else if(netWorth < 5_000) p = 0.55;
  else if(netWorth < 10_000) p = 0.65;
  else if(netWorth < 25_000) p = 0.75;
  else if(netWorth < 50_000) p = 0.82;
  else if(netWorth < 100_000) p = 0.88;
  else if(netWorth < 200_000) p = 0.93;
  else if(netWorth < 300_000) p = 0.96;
  else if(netWorth < 400_000) p = 0.975;
  else if(netWorth < 500_000) p = 0.985;
  else if(netWorth < 1_000_000) p = 0.99;
  else if(netWorth < 5_000_000) p = 0.997;
  else if(netWorth < 10_000_000) p = 0.999;
  else p = 0.9995;
  return clamp(p, 0.001, 0.999);
}

function incomePercentile(inc){
  const x = +inc;
  if(isNaN(x)) return 0.5;
  if(x < 1000) return 0.10;
  if(x < 3000) return 0.20;
  if(x < 5000) return 0.30;
  if(x < 10000) return 0.45;
  if(x < 15000) return 0.60;
  if(x < 25000) return 0.72;
  if(x < 40000) return 0.80;
  if(x < 60000) return 0.86;
  if(x < 80000) return 0.91;
  if(x < 100000) return 0.95;
  if(x < 150000) return 0.975;
  if(x < 250000) return 0.99;
  if(x < 500000) return 0.997;
  return 0.999;
}

function healthPercentile(h){
  if(h==='excellent') return 0.80;
  if(h==='good') return 0.65;
  if(h==='fair') return 0.45;
  if(h==='poor') return 0.25;
  return 0.50;
}

function bmiFromInputs(){
  const units = document.getElementById('units').value;
  if(units==='metric'){
    const hcm = +document.getElementById('heightCm').value;
    const wkg = +document.getElementById('weightKg').value;
    if(!hcm || !wkg) return null;
    const m = hcm/100;
    return wkg/(m*m);
  }else{
    const ft = +document.getElementById('heightFt').value;
    const inch = +document.getElementById('heightIn').value;
    const lb = +document.getElementById('weightLb').value;
    if(!ft && !inch || !lb) return null;
    const totalIn = (ft||0)*12 + (inch||0);
    if(totalIn<=0) return null;
    const m = totalIn*0.0254;
    const kg = lb*0.45359237;
    return kg/(m*m);
  }
}

function bmiPercentile(bmi){
  if(!bmi || !isFinite(bmi)) return 0.50;
  const diff = Math.abs(bmi - 22);
  const score = Math.max(0, 1 - diff/22);
  const p = 0.3 + 0.5*score;
  return clamp(p, 0.3, 0.8);
}

function educationPercentile(level){
  switch(level){
    case 'hs': return 0.50;
    case 'somecollege': return 0.65;
    case 'bachelor': return 0.85;
    case 'master': return 0.93;
    case 'doctorate': return 0.98;
    default: return 0.50;
  }
}

function familyPercentile(children, fatherStatus, fatherAge, motherStatus, motherAge, age){
  const k = Math.max(0, Math.min(12, Math.floor(+children || 0)));
  let childP;
  if(k===0) childP = 0.58;
  else if(k===1) childP = 0.66;
  else if(k===2) childP = 0.72;
  else if(k===3) childP = 0.62;
  else childP = 0.50;

  const a = clamp(+age||0,0,110);
  let parP = 0.50;

  let parentsAlive = 0;
  if(fatherStatus === 'alive' && fatherAge) parentsAlive++;
  if(motherStatus === 'alive' && motherAge) parentsAlive++;

  if(parentsAlive === 2) parP = 0.70 - (a>40?0.12:0) - (a>60?0.12:0);
  else if(parentsAlive === 1) parP = 0.52 - (a>70?0.05:0);
  else parP = 0.40 + (a>60?0.10:0);

  parP = clamp(parP, 0.25, 0.75);
  return clamp(0.65*childP + 0.35*parP, 0.25, 0.75);
}

function lifeExpectancyPercentile(lifeExp, age){
  if(!lifeExp || lifeExp <= 0) return 0.50;

  if(lifeExp < 50) return 0.05;
  if(lifeExp < 60) return 0.15;
  if(lifeExp < 65) return 0.25;
  if(lifeExp < 70) return 0.40;
  if(lifeExp < 73) return 0.50;
  if(lifeExp < 76) return 0.60;
  if(lifeExp < 80) return 0.72;
  if(lifeExp < 83) return 0.82;
  if(lifeExp < 87) return 0.90;
  if(lifeExp < 92) return 0.95;
  if(lifeExp < 97) return 0.98;
  return 0.995;
}

function happinessPercentile(happiness){
  if(!happiness || happiness <= 0) return 0.30;

  // Convert 1-10 scale to percentile
  const normalizedHappiness = (happiness - 1) / 9; // 0 to 1

  // Curve it so that higher happiness scores are more valuable
  return clamp(0.20 + normalizedHappiness * 0.75, 0.20, 0.95);
}

// Fixed weights (sum = 1.00)
const W = {
  wealth:0.50, income:0.20, education:0.08, lifeExp:0.08, happiness:0.06,
  country:0.04, health:0.02, family:0.02, age:0.00, bmi:0.00, sex:0.00, race:0.00, university:0.00
};

// =======================
// Enhanced Visualization Functions
// =======================
function updatePopulationVisualization(percentile, rank){
  const viz = document.getElementById('populationViz');
  const bar = document.getElementById('rankBar');
  const marker = document.getElementById('rankMarker');
  const position = document.getElementById('rankPosition');
  const details = document.getElementById('rankDetails');

  viz.style.display = 'block';

  // FIXED: Use percentile directly for visualization (higher percentile = better position)
  bar.style.width = (percentile * 100) + '%';
  marker.style.left = (percentile * 100) + '%';
  position.textContent = `#${fmtInt(rank)}`;

  // Enhanced details
  const topPercent = pct(percentile);
  const peopleAbove = Math.round(WORLD_TOTAL * (1 - percentile));
  const peopleBelow = Math.round(WORLD_TOTAL * percentile);

  details.innerHTML = `
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; font-size:10px; text-align:center">
      <div style="padding:4px; background:#0e141b; border-radius:4px">
        <div style="color:var(--accent); font-weight:bold">#${fmtInt(rank)}</div>
        <div style="color:var(--muted)">Your Rank</div>
      </div>
      <div style="padding:4px; background:#0e141b; border-radius:4px">
        <div style="color:var(--green); font-weight:bold">${topPercent}%</div>
        <div style="color:var(--muted)">Top Percentile</div>
      </div>
      <div style="padding:4px; background:#0e141b; border-radius:4px">
        <div style="color:var(--warn); font-weight:bold">${fmtInt(peopleAbove)}</div>
        <div style="color:var(--muted)">Above You</div>
      </div>
    </div>
  `;
}

function updateWealthChart(cash, realEstate, stocks, debt, netWorth, wealthPercentile){
  const chart = document.getElementById('wealthChart');
  const bars = document.getElementById('wealthBars');
  const total = document.getElementById('netWorthTotal');
  const wealthRank = document.getElementById('wealthRankDisplay');

  chart.style.display = 'block';
  total.textContent = `$${fmtInt(netWorth)}`;

  // Calculate wealth rank
  const wealthOnlyRank = Math.round(WORLD_TOTAL * (1 - wealthPercentile));
  wealthRank.textContent = `#${fmtInt(wealthOnlyRank)}`;

  const assets = [
    {name: 'Cash', value: cash, color: '#22c55e'},
    {name: 'Real Estate', value: realEstate, color: '#3b82f6'},
    {name: 'Stocks', value: stocks, color: '#8b5cf6'},
    {name: 'Debt', value: -debt, color: '#ef4444'}
  ];

  const maxVal = Math.max(...assets.map(a => Math.abs(a.value)));
  bars.innerHTML = assets.map(asset => {
    const width = maxVal > 0 ? (Math.abs(asset.value) / maxVal * 100) : 0;
    return `
      <div style="display:flex; align-items:center; margin:3px 0; font-size:11px">
        <div style="width:70px; min-width:70px">${asset.name}</div>
        <div style="flex:1; height:18px; background:#0b1218; border-radius:9px; overflow:hidden; margin:0 6px; border:1px solid var(--border)">
          <div style="height:100%; background:${asset.color}; width:${width}%; border-radius:9px; transition:width 0.5s ease"></div>
        </div>
        <div style="width:80px; min-width:80px; text-align:right; font-weight:bold">${asset.value >= 0 ? '$' + fmtInt(asset.value) : '-$' + fmtInt(-asset.value)}</div>
      </div>
    `;
  }).join('');
}

function updateComparisonCharts(agePercentile, incomePercentile, educationPercentile, healthPercentile){
  const charts = document.getElementById('comparisonCharts');
  const ageChart = document.getElementById('ageChart');
  const incomeChart = document.getElementById('incomeChart');
  const educationChart = document.getElementById('educationChart');
  const healthChart = document.getElementById('healthChart');

  charts.style.display = 'block';

  // Enhanced visualizations with better graphics
  ageChart.innerHTML = `
    <div style="position:absolute; bottom:0; left:0; right:0; height:100%; background:linear-gradient(0deg, #1e293b 0%, #1e293b 70%, #0ea5e9 70%, #0ea5e9 100%); border-radius:8px"></div>
    <div style="position:absolute; bottom:0; left:${agePercentile*100}%; width:4px; height:100%; background:#22c55e; border-radius:2px; box-shadow:0 0 8px #22c55e"></div>
    <div style="position:absolute; top:4px; left:4px; font-size:9px; color:#94a3b8; background:rgba(0,0,0,0.7); padding:2px 4px; border-radius:4px; font-weight:bold">üë• You: ${pct(agePercentile)}%</div>
  `;

  incomeChart.innerHTML = `
    <div style="position:absolute; bottom:0; left:0; right:0; height:100%; background:linear-gradient(0deg, #1e293b 0%, #1e293b 75%, #f59e0b 75%, #f59e0b 100%); border-radius:8px"></div>
    <div style="position:absolute; bottom:0; left:${incomePercentile*100}%; width:4px; height:100%; background:#22c55e; border-radius:2px; box-shadow:0 0 8px #22c55e"></div>
    <div style="position:absolute; top:4px; left:4px; font-size:9px; color:#94a3b8; background:rgba(0,0,0,0.7); padding:2px 4px; border-radius:4px; font-weight:bold">üíµ You: ${pct(incomePercentile)}%</div>
  `;

  educationChart.innerHTML = `
    <div style="position:absolute; bottom:0; left:0; right:0; height:100%; background:linear-gradient(0deg, #1e293b 0%, #1e293b 65%, #8b5cf6 65%, #8b5cf6 100%); border-radius:8px"></div>
    <div style="position:absolute; bottom:0; left:${educationPercentile*100}%; width:4px; height:100%; background:#22c55e; border-radius:2px; box-shadow:0 0 8px #22c55e"></div>
    <div style="position:absolute; top:4px; left:4px; font-size:9px; color:#94a3b8; background:rgba(0,0,0,0.7); padding:2px 4px; border-radius:4px; font-weight:bold">üéì You: ${pct(educationPercentile)}%</div>
  `;

  healthChart.innerHTML = `
    <div style="position:absolute; bottom:0; left:0; right:0; height:100%; background:linear-gradient(0deg, #1e293b 0%, #1e293b 60%, #22c55e 60%, #22c55e 100%); border-radius:8px"></div>
    <div style="position:absolute; bottom:0; left:${healthPercentile*100}%; width:4px; height:100%; background:#fff; border-radius:2px; box-shadow:0 0 8px #fff"></div>
    <div style="position:absolute; top:4px; left:4px; font-size:9px; color:#94a3b8; background:rgba(0,0,0,0.7); padding:2px 4px; border-radius:4px; font-weight:bold">üè• You: ${pct(healthPercentile)}%</div>
  `;
}

function updateFunFacts(rank, percentile, country, age, netWorth, income){
  const facts = document.getElementById('funFacts');
  const content = document.getElementById('factsContent');
  const comparisonFacts = document.getElementById('comparisonFacts');

  facts.style.display = 'block';

  const peopleAbove = Math.round(WORLD_TOTAL * (1 - percentile));
  const peopleBelow = Math.round(WORLD_TOTAL * percentile);
  const topPercent = pct(percentile);

  const factsList = [
    `üéØ You outrank <b style="color:#22c55e">${fmtInt(peopleBelow)}</b> people worldwide`,
    `üèÜ Only <b style="color:#f59e0b">${fmtInt(peopleAbove)}</b> people rank higher than you`,
    `üìä You're in the top <b style="color:#60a5fa">${topPercent}%</b> of all humans`,
    `üí∞ Your net worth of <b style="color:#22c55e">$${fmtInt(netWorth)}</b> ${netWorth > 500000 ? 'puts you in the global elite' : netWorth > 100000 ? 'shows strong financial health' : 'represents your economic foundation'}`,
    `üåü ${percentile > 0.95 ? 'You are among the global elite!' : percentile > 0.90 ? 'You have achieved exceptional status!' : percentile > 0.80 ? 'You are in a privileged position globally!' : percentile > 0.70 ? 'You are well above average!' : 'You are building your position!'}`
  ];

  content.innerHTML = factsList.map(fact => `<div style="margin:4px 0; padding:4px 0; border-left:3px solid var(--accent); padding-left:8px">‚Ä¢ ${fact}</div>`).join('');

  // Additional comparison facts
  const timeComparisons = [
    `‚è∞ If you lined up all ${fmtInt(WORLD_TOTAL)} people, you'd be person #${fmtInt(rank)}`,
    `üèÉ Out of every 1000 people, only ${Math.round((1-percentile)*1000)} would rank higher than you`,
    `üåé In your country (${country}), your global ranking represents top-tier status`
  ];

  comparisonFacts.innerHTML = timeComparisons.join(' ‚Ä¢ ');
}

function updateLifeTimeline(age, lifeExpectancy, fatherStatus, fatherAge, motherStatus, motherAge){
  const timeline = document.getElementById('lifeTimeline');
  const progress = document.getElementById('lifeProgress');
  const marker = document.getElementById('lifeMarker');
  const years = document.getElementById('lifeYears');
  const parentAges = document.getElementById('parentAges');
  const currentStage = document.getElementById('currentLifeStage');
  const statsGrid = document.getElementById('lifeStatsGrid');

  timeline.style.display = 'block';

  if(lifeExpectancy && lifeExpectancy > 0){
    const lifeProgress = Math.min(age / lifeExpectancy * 100, 100);
    progress.style.width = lifeProgress + '%';
    marker.style.left = lifeProgress + '%';
    years.textContent = `${age}/${lifeExpectancy} years`;

    // Determine life stage
    let stage = '';
    if(age < 13) stage = 'üë∂ Childhood';
    else if(age < 20) stage = 'üßë Adolescence';
    else if(age < 30) stage = 'üí™ Young Adult';
    else if(age < 50) stage = 'üè¢ Prime Years';
    else if(age < 65) stage = 'üåü Mature Adult';
    else stage = 'üë¥ Senior Years';

    currentStage.textContent = stage;

    // Parent information
    let parentInfo = [];
    if(fatherAge){
      if(fatherStatus === 'deceased'){
        parentInfo.push(`üë® Father: Passed at ${fatherAge}`);
      } else {
        parentInfo.push(`üë® Father: ${fatherAge} years old`);
      }
    }
    if(motherAge){
      if(motherStatus === 'deceased'){
        parentInfo.push(`üë© Mother: Passed at ${motherAge}`);
      } else {
        parentInfo.push(`üë© Mother: ${motherAge} years old`);
      }
    }
    parentAges.innerHTML = parentInfo.join(' ‚Ä¢ ');

    // Life statistics
    const remainingYears = Math.max(0, lifeExpectancy - age);
    const livedPercent = Math.round((age / lifeExpectancy) * 100);
    const statsData = [
      { label: 'Years Lived', value: `${age}`, color: 'var(--green)' },
      { label: 'Remaining', value: `${remainingYears}`, color: 'var(--warn)' },
      { label: 'Life Progress', value: `${livedPercent}%`, color: 'var(--accent)' }
    ];

    statsGrid.innerHTML = statsData.map(stat => `
      <div style="padding:4px; background:#0e141b; border-radius:4px; text-align:center">
        <div style="color:${stat.color}; font-weight:bold; font-size:11px">${stat.value}</div>
        <div style="color:var(--muted); font-size:8px">${stat.label}</div>
      </div>
    `).join('');

  } else {
    progress.style.width = '0%';
    marker.style.left = '0%';
    years.textContent = `${age} years`;
    currentStage.textContent = 'Current';
    parentAges.innerHTML = '';
    statsGrid.innerHTML = '';
  }
}

function updateHappinessVisualization(happiness){
  const viz = document.getElementById('happinessViz');
  const bar = document.getElementById('happinessBar');
  const marker = document.getElementById('happinessMarker');
  const text = document.getElementById('happinessText');
  const comparison = document.getElementById('happinessComparison');

  viz.style.display = 'block';

  if(happiness && happiness > 0){
    const happinessPercent = (happiness - 1) / 9 * 100;
    bar.style.width = happinessPercent + '%';
    marker.style.left = `calc(${happinessPercent}% - 12px)`;
    text.textContent = `Your happiness: ${happiness}/10`;

    // Dynamic emoji based on happiness level
    if(happiness >= 9) marker.textContent = 'ü§©';
    else if(happiness >= 8) marker.textContent = 'üòÑ';
    else if(happiness >= 7) marker.textContent = 'üòä';
    else if(happiness >= 6) marker.textContent = 'üôÇ';
    else if(happiness >= 5) marker.textContent = 'üòê';
    else if(happiness >= 4) marker.textContent = 'üòï';
    else if(happiness >= 3) marker.textContent = 'üòû';
    else if(happiness >= 2) marker.textContent = 'üò¢';
    else marker.textContent = 'üò≠';

    // Comparison with world average
    const diff = happiness - 5.4;
    if(diff > 0){
      comparison.textContent = `${diff.toFixed(1)} points above world average (5.4/10)`;
      comparison.style.color = 'var(--green)';
    } else if(diff < 0){
      comparison.textContent = `${Math.abs(diff).toFixed(1)} points below world average (5.4/10)`;
      comparison.style.color = 'var(--warn)';
    } else {
      comparison.textContent = 'Exactly at world average (5.4/10)';
      comparison.style.color = 'var(--muted)';
    }

  } else {
    bar.style.width = '0%';
    marker.style.left = '0%';
    text.textContent = 'Your happiness: 0.0/10';
    marker.textContent = 'üòê';
    comparison.textContent = 'World average: 5.4/10';
    comparison.style.color = 'var(--muted)';
  }
}

// =======================
// Main Calculation Function (Enhanced)
// =======================
function compute(){
  const country = canonicalCountry(document.getElementById('country').value);
  const sex = document.getElementById('sex').value;
  const birthYear = +document.getElementById('birthYear').value;
  const birthMonth = +document.getElementById('birthMonth').value || null;
  const birthDay = +document.getElementById('birthDay').value || null;
  const age = calculateAge(birthYear, birthMonth, birthDay);
  const health = document.getElementById('health').value;
  const units = document.getElementById('units').value;
  const cash = +document.getElementById('cash').value || 0;
  const realEstate = +document.getElementById('realEstate').value || 0;
  const stocks = +document.getElementById('stocks').value || 0;
  const debt = +document.getElementById('debt').value || 0;
  const income = +document.getElementById('income').value || 0;
  const education = document.getElementById('education').value;
  const university = document.getElementById('university').value.trim();
  const race = document.getElementById('race').value;
  const children = +document.getElementById('children').value;
  const lifeExpectancy = +document.getElementById('lifeExpectancy').value || 0;
  const happiness = +document.getElementById('happiness').value || 0;
  const fatherStatus = document.getElementById('fatherStatus').value;
  const fatherAge = +document.getElementById('fatherAge').value || 0;
  const motherStatus = document.getElementById('motherStatus').value;
  const motherAge = +document.getElementById('motherAge').value || 0;

  const netWorth = cash + realEstate + stocks - debt;

  // Calculate all percentiles
  const pCountry = countryCDFPercentile(country);
  const pSex = sexPercentile(sex);
  const pAge = agePercentile(age);
  const pWealth = wealthPercentile(cash, realEstate, stocks, debt);
  const pIncome = incomePercentile(income);
  const pHealth = healthPercentile(health);
  const bmi = bmiFromInputs();
  const pBMI = bmiPercentile(bmi);
  const pEdu = educationPercentile(education);
  const pFamily = familyPercentile(children, fatherStatus, fatherAge, motherStatus, motherAge, age);
  const pLifeExp = lifeExpectancyPercentile(lifeExpectancy, age);
  const pHappiness = happinessPercentile(happiness);

  // Calculate weighted percentile
  const Wsum = Object.values(W).reduce((a,b)=>a+b,0);
  const P = clamp(
    (pWealth * W.wealth + pIncome * W.income + pEdu * W.education + pLifeExp * W.lifeExp +
     pHappiness * W.happiness + pCountry * W.country + pHealth * W.health + pFamily * W.family) / Wsum,
    0.0001, 0.9999
  );

  // FIXED: Calculate rank correctly - higher percentile = better (lower) rank
  const rank = Math.round(WORLD_TOTAL * (1 - P));
  const pctText = pct(P) + '%';

  // Update main result display
  const res = document.getElementById('result');
  const bmiTxt = (bmi && isFinite(bmi)) ? bmi.toFixed(1) : 'N/A';
  res.innerHTML = `
    <div class="big">üèÜ Global Rank: <b style="color:var(--accent)">#${fmtInt(rank)}</b> out of ~${fmtInt(WORLD_TOTAL)} people</div>
    <div style="margin:8px 0; font-size:16px">You're in the top <b style="color:var(--green)">${pctText}</b> globally!</div>
    <div class="small" style="margin-top:10px; line-height:1.3; padding:8px; background:#1a202c; border-radius:8px">
      üåç <b>${country}</b> ¬∑ ${sex === 'male' ? 'üë®' : sex === 'female' ? 'üë©' : 'üßë'} <b>${sex}</b> ¬∑ üéÇ <b>${age}</b> years ¬∑
      üí∞ Net Worth: <b>$${fmtInt(netWorth)}</b> ¬∑ üíµ Income: <b>$${fmtInt(income)}</b> ¬∑ üìè BMI: <b>${bmiTxt}</b>
    </div>
  `;

  // Show all enhanced visualizations
  updatePopulationVisualization(P, rank);
  updateWealthChart(cash, realEstate, stocks, debt, netWorth, pWealth);
  updateComparisonCharts(pAge, pIncome, pEdu, pHealth);
  updateFunFacts(rank, P, country, age, netWorth, income);
  updateLifeTimeline(age, lifeExpectancy, fatherStatus, fatherAge, motherStatus, motherAge);
  updateHappinessVisualization(happiness);

  // Store result for export
  window.__lastResult = {
    version: VERSION,
    timestamp: Date.now(),
    country, sex, age, health, units,
    height_cm: units==='metric' ? +document.getElementById('heightCm').value : null,
    weight_kg: units==='metric' ? +document.getElementById('weightKg').value : null,
    height_ft: units==='imperial' ? +document.getElementById('heightFt').value : null,
    height_in: units==='imperial' ? +document.getElementById('heightIn').value : null,
    weight_lb: units==='imperial' ? +document.getElementById('weightLb').value : null,
    bmi, cash, realEstate, stocks, debt, net_worth: netWorth, income,
    education, university, race, children, life_expectancy: lifeExpectancy, happiness,
    father_status: fatherStatus, father_age: fatherAge, mother_status: motherStatus, mother_age: motherAge,
    percentiles:{ country:pCountry, sex:pSex, age:pAge, wealth:pWealth, income:pIncome, health:pHealth, bmi:pBMI, education:pEdu, family:pFamily, lifeExp:pLifeExp, happiness:pHappiness },
    weights: W, composite_percentile: P, world_total: WORLD_TOTAL, rank
  };

  // Auto-save after calculation
  saveToCache();
  showNotification('Ranking calculated and auto-saved!', 'success');
}

// =======================
// Event Listeners Setup
// =======================
function setupEventListeners() {
  // Birth date listeners for real-time age update
  document.getElementById('birthYear').addEventListener('input', updateAge);
  document.getElementById('birthMonth').addEventListener('change', updateAge);
  document.getElementById('birthDay').addEventListener('input', updateAge);

  // Units toggle
  document.getElementById('units').addEventListener('change', updateUnitsDisplay);

  // Parent status toggles
  document.getElementById('fatherStatus').addEventListener('change', updateParentLabels);
  document.getElementById('motherStatus').addEventListener('change', updateParentLabels);

  // Main buttons
  document.getElementById('btnCalc').addEventListener('click', compute);

  document.getElementById('btnReset').addEventListener('click', ()=>{
    if(confirm('This will clear ALL data including saved cache. Continue?')){
      resetAllData();
      clearCache();
      showNotification('All data reset successfully', 'info');
    }
  });

  document.getElementById('btnTest').addEventListener('click', runComprehensiveTests);

  // Cache management buttons
  document.getElementById('btnLoadCache').addEventListener('click', loadFromCache);
  document.getElementById('btnClearCache').addEventListener('click', ()=>{
    if(confirm('Clear all saved data?')){
      clearCache();
    }
  });

  document.getElementById('btnExportData').addEventListener('click', exportAllData);

  // Result buttons
  document.getElementById('btnCopy').addEventListener('click', copyResult);
  document.getElementById('btnDownload').addEventListener('click', downloadResult);
  document.getElementById('btnShare').addEventListener('click', shareResult);
}

function resetAllData(){
  ['country','birthYear','birthDay','cash','realEstate','stocks','debt','income','children','lifeExpectancy','happiness','fatherAge','motherAge','university','heightCm','weightKg','heightFt','heightIn','weightLb'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
  document.getElementById('sex').value='male';
  document.getElementById('birthMonth').value='';
  document.getElementById('health').value='good';
  document.getElementById('units').value='metric';
  document.getElementById('education').value='hs';
  document.getElementById('race').value='na';
  document.getElementById('fatherStatus').value='alive';
  document.getElementById('motherStatus').value='alive';
  updateAge();
  updateUnitsDisplay();
  updateParentLabels();
  document.getElementById('result').innerHTML='Enter inputs and click <span class="kbd">Calculate</span>.';

  // Hide all visualizations
  ['populationViz','wealthChart','comparisonCharts','funFacts','lifeTimeline','happinessViz','testResults'].forEach(id=>{
    document.getElementById(id).style.display='none';
  });
}

function exportAllData(){
  const R = window.__lastResult;
  if(!R){
    showNotification('Please calculate first', 'error');
    return;
  }

  const exportData = {
    ...R,
    exportDate: new Date().toISOString(),
    version: VERSION
  };

  const blob = new Blob([JSON.stringify(exportData, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `global_rank_ultimate_v${VERSION}_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);

  showNotification('Data exported successfully', 'success');
}

function copyResult(){
  const R = window.__lastResult;
  if(!R){
    showNotification('Please calculate first', 'error');
    return;
  }
  const txt = `üèÜ Global Rank: #${fmtInt(R.rank)} out of ${fmtInt(R.world_total)} people (top ${pct(R.composite_percentile)}%)\n` +
              `üìç ${R.country} ‚Ä¢ ${R.sex} ‚Ä¢ ${R.age} years old\n` +
              `üí∞ Net Worth: $${fmtInt(R.net_worth||0)} ‚Ä¢ Income: $${fmtInt(R.income||0)}\n` +
              `üìä Calculated with Ultimate Global Ranking System v${VERSION}`;
  navigator.clipboard.writeText(txt).then(()=>showNotification('Copied to clipboard!', 'success')).catch(()=>showNotification('Copy failed', 'error'));
}

function downloadResult(){
  const R = window.__lastResult;
  if(!R){
    showNotification('Please calculate first', 'error');
    return;
  }
  const blob = new Blob([JSON.stringify(R,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `my_global_rank_ultimate_v${VERSION}_result.json`;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  showNotification('Result downloaded', 'success');
}

function shareResult(){
  const R = window.__lastResult;
  if(!R){
    showNotification('Please calculate first', 'error');
    return;
  }

  if(navigator.share){
    navigator.share({
      title: 'My Global Ranking',
      text: `I rank #${fmtInt(R.rank)} globally out of ${fmtInt(R.world_total)} people (top ${pct(R.composite_percentile)}%)! Check your ranking too.`,
      url: window.location.href
    }).then(()=>showNotification('Shared successfully!', 'success')).catch(()=>showNotification('Share cancelled', 'info'));
  } else {
    // Fallback to copy
    copyResult();
  }
}

// =======================
// Initialization
// =======================
function initialize() {
  // Start population counter
  updateWorldPopulation();
  setInterval(updateWorldPopulation, 1000);

  // Setup event listeners
  setupEventListeners();

  // Setup auto-save
  setupAutoSave();

  // Try to load cached data on startup
  setTimeout(() => {
    const hasCache = localStorage.getItem(CACHE_KEY);
    if(hasCache){
      updateCacheStatus('Saved data available - click "Load Saved Data" to restore');
    } else {
      updateCacheStatus('Auto-save enabled - data will be saved automatically');
    }
  }, 100);

  showNotification(`Ultimate Global Ranking System v${VERSION} loaded!`, 'success');
}

// Start the application
document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>