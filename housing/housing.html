<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Housing Price Index Dashboard (Single HTML) â€” Auto CSV</title>
<meta name="description" content="Single-file HPI dashboard that auto-loads housing.csv from the same folder (with GitHub raw fallback), includes search, ranking, and downloads." />
<style>
  :root {
    --bg: #0b1220;
    --card: #121a2b;
    --text: #e6eefc;
    --muted: #9fb3d1;
    --accent: #94b9ff;
    --border: #1e2a44;
    --header-h: 72px;           /* updated in JS */
    --vhpx: 100vh;              /* updated in JS to innerHeight */
    --bottom-gap: 8px;          /* avoid desktop taskbar overlap */
  }
  * { box-sizing: border-box; }
  html, body { height:100%; }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, Apple Color Emoji, Segoe UI Emoji;
    background: var(--bg);
    color: var(--text);
    overflow: hidden; /* keep page itself from scrolling */
  }
  header {
    padding: 12px 16px calc(12px + env(safe-area-inset-top));
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(148,185,255,0.08), transparent);
  }
  header .hrow { display:flex; align-items:center; justify-content:space-between; gap: 12px; }
  header h1 { margin: 0; font-size: 20px; line-height: 1.2; }
  #mobileMenuBtn {
    display: none;
    border: 1px solid var(--border);
    background: #12203a;
    color: var(--text);
    padding: 8px 12px;
    border-radius: 10px;
    cursor: pointer;
  }
  #mobileMenuBtn:hover { background: #16274a; }

  .wrap {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 16px;
    padding: 16px;
    height: calc((var(--vhpx) - var(--header-h)) - env(safe-area-inset-bottom) - var(--bottom-gap));
    overflow: hidden;
  }
  @supports(height: 100dvh){
    .wrap {
      height: calc(100dvh - var(--header-h) - env(safe-area-inset-bottom) - var(--bottom-gap));
    }
  }

  .panel {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 14px;
    min-height: 0;
    display: flex;
    flex-direction: column;
  }
  .panel h2 { margin: 0 0 12px; font-size: 16px; color: var(--accent); }
  .controls { display: grid; gap: 12px; }
  .row { display: flex; gap: 12px; align-items: end; flex-wrap: wrap; }
  label { display: block; font-size: 12px; color: var(--muted); }
  select, input[type="number"] {
    padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border);
    background: #0e1727; color: var(--text);
  }
  .search-box input {
    width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border);
    background: #0e1727; color: var(--text);
    outline: none;
  }
  .chips { display: flex; flex-wrap: wrap; gap: 8px; max-height: 100%; overflow: auto; padding-right: 4px; }
  .chip {
    display: inline-flex; align-items: center; gap: 8px;
    border: 1px solid var(--border);
    background: #0f1a30;
    padding: 6px 10px; border-radius: 999px; font-size: 13px; cursor: pointer;
    white-space: nowrap;
  }
  .chip input { accent-color: #6ea0ff; cursor: pointer; }
  .btns { display: flex; flex-wrap: wrap; gap: 8px; }
  button {
    border: 1px solid var(--border); background: #12203a; color: var(--text);
    padding: 8px 12px; border-radius: 10px; cursor: pointer;
  }
  button:hover { background: #16274a; }
  .sidebar {
    display: grid;
    grid-template-rows: auto auto 1fr;
    gap: 12px;
    min-height: 0;
  }
  .chart-card {
    position: relative;
    flex: 1 1 auto;
    min-height: 360px;
    overflow: hidden;
  }
  canvas { width: 100% !important; height: 100% !important; }
  .table-wrap { display: none !important; } /* hide numbers under chart */

  /* ===== Mobile behaviors ===== */
  @media (max-width: 1000px) {
    .wrap { grid-template-columns: 1fr; }
    /* Hide sidebar by default on mobile to maximize chart area */
    .sidebar { display: none; }
    /* Show the header toggle button on mobile */
    #mobileMenuBtn { display: inline-flex; }
    /* Hide large-UI buttons on mobile to save space */
    #openFileBtn, #dlPng, #dlCsv { display: none !important; }
  }
  /* Sidebar becomes an overlay "drawer" when opened on mobile */
  @media (max-width: 1000px) {
    .sidebar.open {
      display: grid;
      position: fixed;
      top: calc(var(--header-h));
      left: 0;
      right: 0;
      bottom: env(safe-area-inset-bottom);
      z-index: 30;
      background: var(--card);
      border-top: 1px solid var(--border);
      padding: 14px;
      overflow: auto;
    }
    #backdrop.open {
      display: block;
      position: fixed;
      top: var(--header-h);
      left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.45);
      z-index: 25;
    }
    #backdrop { display: none; }
  }

  @media (max-width: 640px) {
    header h1 { font-size: 18px; }
    .chart-card { min-height: 300px; }
  }
</style>

<!-- Chart.js + Luxon time adapter (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
<!-- PapaParse for CSV parsing -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<header>
  <div class="hrow">
    <h1>Housing Price Index Dashboard</h1>
    <button id="mobileMenuBtn" aria-label="Toggle menu">Menu</button>
  </div>
</header>

<!-- mobile backdrop for drawer -->
<div id="backdrop" aria-hidden="true"></div>

<div class="wrap">
  <aside class="panel sidebar" aria-label="Controls sidebar">
    <h2>Controls</h2>
    <div class="controls">
      <div class="row">
        <div>
          <label for="stateSelect">State</label>
          <select id="stateSelect"></select>
        </div>
        <div class="btns" style="align-items:end;">
          <button id="selectAllBtn" type="button">Select All</button>
          <button id="selectNoneBtn" type="button">Select None</button>
        </div>
      </div>

      <div class="search-box">
        <label for="search">Search city/region</label>
        <input type="text" id="search" placeholder="Type to filter chips..." />
      </div>

      <div class="row" id="rankControls">
        <div>
          <label for="rankSide">Ranking</label>
          <div class="btns">
            <select id="rankSide">
              <option value="top" selected>Top</option>
              <option value="bottom">Bottom</option>
            </select>
            <select id="rankType">
              <option value="count" selected>Count</option>
              <option value="percentile">Percentile</option>
            </select>
            <input id="rankValue" type="number" min="1" max="100" value="10" style="max-width:110px"/>
            <button id="applyRank" type="button">Apply</button>
          </div>
        </div>
      </div>

      <div class="btns">
        <button id="openFileBtn" type="button">Select CSV File</button>
        <input type="file" id="csvFileInput" accept=".csv" style="display:none" />
        <button id="dlPng" type="button">Download PNG</button>
        <button id="dlCsv" type="button">Download CSV</button>
      </div>

      <div class="chips" id="regionChips" aria-label="Region list"></div>
    </div>
  </aside>

  <main class="panel">
    <h2>Time Series</h2>
    <div class="chart-card">
      <canvas id="chart"></canvas>
    </div>
    <div class="table-wrap">
      <table id="latestTbl">
        <thead>
          <tr><th>Region</th><th>Latest Date</th><th>Value</th><th>Series Length</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>
</div>

<!-- Optional embedded dataset. If present, put JSON like {"series":[{name,label,dates,values,state}], "defaultSelected":["..."]} -->
<script id="data-json" type="application/json">
{"series": [], "defaultSelected": []}
</script>

<script>
(function(){
  // ---------- Dynamic viewport fix (desktop taskbar + mobile URL bars) ----------
  function setViewportVars(){
    const h = window.innerHeight || document.documentElement.clientHeight || 720;
    document.documentElement.style.setProperty("--vhpx", h + "px");
    const header = document.querySelector("header");
    const hh = header ? Math.round(header.getBoundingClientRect().height) : 72;
    document.documentElement.style.setProperty("--header-h", hh + "px");
  }
  window.addEventListener("resize", setViewportVars, { passive: true });
  window.addEventListener("orientationchange", setViewportVars, { passive: true });
  document.addEventListener("DOMContentLoaded", setViewportVars);

  // ---------- Mobile menu toggle ----------
  const sidebar = document.querySelector(".sidebar");
  const backdrop = document.getElementById("backdrop");
  const mobileBtn = document.getElementById("mobileMenuBtn");
  function openMenu(){
    sidebar.classList.add("open");
    backdrop.classList.add("open");
    mobileBtn.setAttribute("aria-expanded", "true");
  }
  function closeMenu(){
    sidebar.classList.remove("open");
    backdrop.classList.remove("open");
    mobileBtn.setAttribute("aria-expanded", "false");
  }
  function toggleMenu(){
    if (sidebar.classList.contains("open")) closeMenu(); else openMenu();
  }
  mobileBtn.addEventListener("click", toggleMenu);
  backdrop.addEventListener("click", closeMenu);
  window.addEventListener("resize", ()=>{
    if (window.innerWidth > 1000) closeMenu();
  }, { passive: true });

  // ---------- Config: CSV locations ----------
  const CSV_CANDIDATES = [
    new URL("./housing.csv", location.href).href,
    "https://raw.githubusercontent.com/stberry7/stberry7.github.io/refs/heads/main/housing/housing.csv"
  ];

  // ---------- Utilities ----------
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const fmt = (n) => (n == null || isNaN(n)) ? "" : new Intl.NumberFormat("en-US",{notation:"compact",maximumFractionDigits:2}).format(n);

  // Active data accessors
  const embeddedPayload = (()=>{
    try {
      const el = document.getElementById("data-json");
      if (!el) return { series: [], defaultSelected: [] };
      const obj = JSON.parse(el.textContent || "{}");
      return { series: Array.isArray(obj.series) ? obj.series : [], defaultSelected: new Set(obj.defaultSelected||[]) };
    } catch(e){ return { series: [], defaultSelected: [] }; }
  })();

  window.userUploadedSeries = []; // filled after CSV parse
  function getSeriesRaw(){
    return (window.userUploadedSeries && window.userUploadedSeries.length) ? window.userUploadedSeries : embeddedPayload.series;
  }

  // State filter + search
  let currentSearch = "";
  function uniqueStates(series){
    const s = new Set();
    series.forEach(x => { const st = (x.state || "").trim(); if(st) s.add(st); });
    const arr = Array.from(s).sort((a,b)=>a.localeCompare(b));
    return ["All States", ...arr];
  }
  function filteredByState(series){
    const sel = $("#stateSelect");
    const st = sel ? sel.value : "All States";
    return series.filter(x => st === "All States" ? true : (x.state === st));
  }
  function filteredBySearch(series){
    const q = currentSearch.trim().toLowerCase();
    if (!q) return series;
    return series.filter(s => (s.label||s.name||"").toLowerCase().includes(q));
  }

  // ---------- Chips (selection list) ----------
  function rebuildChips(){
    const chips = $("#regionChips");
    const base = filteredBySearch(filteredByState(getSeriesRaw()));
    const prevSel = new Set($$("#regionChips input[type='checkbox']:checked").map(el=>el.dataset.name));
    chips.innerHTML = "";
    const scored = base.map(s=>({name:s.name, val:(s.values && s.values.length ? s.values[s.values.length-1] : -Infinity)}))
                      .sort((a,b)=> b.val - a.val)
                      .slice(0, Math.min(10, base.length))
                      .map(x=>x.name);
    base.forEach(s => {
      const id = "chk_" + btoa(s.label||s.name).replace(/=/g,"");
      const checked = prevSel.size ? prevSel.has(s.name) : (embeddedPayload.defaultSelected.size ? embeddedPayload.defaultSelected.has(s.name) : scored.includes(s.name));
      const div = document.createElement("label");
      div.className = "chip";
      div.innerHTML = `<input type="checkbox" id="${id}" data-name="${s.name}" ${checked ? "checked":""} /> <span>${s.label||s.name}</span>`;
      chips.appendChild(div);
    });
  }
  function selectedNames(){ return $$("#regionChips input[type='checkbox']:checked").map(el=>el.dataset.name); }
  function setSelectionByNames(names){
    const set = new Set(names);
    $$("#regionChips input[type='checkbox']").forEach(el => el.checked = set.has(el.dataset.name));
  }
  function checkAllChips(val){ $$("#regionChips input[type='checkbox']").forEach(el => el.checked = !!val); }

  // ---------- Chart ----------
  let chart;
  function palette(i){ const hue=(i*53)%360; return `hsl(${hue} 70% 60%)`; }
  function buildDatasets(series, names){
    const sel = new Set(names);
    let idx = 0;
    return series.filter(s => sel.has(s.name)).map(s => ({
      label: s.label || s.name,
      data: (s.dates||[]).map((d,i)=>({x:d,y:s.values? s.values[i] : null})),
      borderColor: palette(idx++),
      backgroundColor: palette(idx),
      borderWidth: 2,
      pointRadius: 0,
      tension: 0.18
    }));
  }
  function drawChart(){
    const ctx = $("#chart").getContext("2d");
    const series = filteredByState(getSeriesRaw());
    const ds = buildDatasets(series, selectedNames());
    const cfg = {
      type: "line",
      data: { datasets: ds },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "nearest", intersect: false },
        plugins: {
          legend: { position: "top", labels: { color: "#cfe0ff" } },
          tooltip: { callbacks: { label: (ctx)=> `${ctx.dataset.label}: ${fmt(ctx.parsed.y)}` } }
        },
        scales: {
          x: { type: "time", time: { unit: "month" }, ticks: { color: "#9fb3d1" }, grid: { color: "rgba(255,255,255,0.06)" } },
          y: { ticks: { color: "#9fb3d1", callback: (v)=>fmt(v) }, grid: { color: "rgba(255,255,255,0.06)" } }
        }
      }
    };
    if (chart){ chart.destroy(); }
    chart = new Chart(ctx, cfg);
    updateTable(series);
  }
  function updateChart(){
    if(!chart){ drawChart(); return; }
    const series = filteredByState(getSeriesRaw());
    chart.data.datasets = buildDatasets(series, selectedNames());
    chart.update();
    updateTable(series);
  }
  function updateTable(series){
    const tbody = $("#latestTbl tbody");
    if(!tbody) return;
    tbody.innerHTML="";
    const sel = new Set(selectedNames());
    series.forEach(s => {
      if(!sel.has(s.name)) return;
      const i = (s.values||[]).length-1;
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${s.label||s.name}</td><td>${(s.dates||[])[i]||""}</td><td>${fmt((s.values||[])[i])}</td><td>${(s.values||[]).length}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ---------- Ranking ----------
  function applyRank(){
    const base = filteredByState(filteredBySearch(getSeriesRaw()));
    if(!base.length) return;
    const side = ($("#rankSide")?.value || "top").toLowerCase();
    const type = ($("#rankType")?.value || "count").toLowerCase();
    const val  = parseFloat($("#rankValue")?.value || "10");
    const latest = base.map(s=>({name:s.name, value: (s.values && s.values.length ? s.values[s.values.length-1] : null)}))
                       .filter(x=>typeof x.value === "number" && !isNaN(x.value));
    if(!latest.length) return;
    let names=[];
    if(type === "count"){
      const N = Math.max(1, Math.min(latest.length, Math.round(val)));
      latest.sort((a,b)=> b.value - a.value);
      names = (side==="top" ? latest.slice(0,N) : latest.slice(-N)).map(x=>x.name);
    } else {
      const p = Math.max(1, Math.min(100, val));
      latest.sort((a,b)=> a.value - b.value);
      const idx = Math.floor((p/100) * latest.length);
      if(side === "top"){
        const start = Math.max(0, latest.length - idx);
        names = latest.slice(start).map(x=>x.name);
      } else {
        names = latest.slice(0, idx).map(x=>x.name);
      }
    }
    setSelectionByNames(names);
    updateChart();
  }

  // ---------- CSV Upload (manual override) ----------
  $("#openFileBtn").addEventListener("click", ()=> $("#csvFileInput").click());
  $("#csvFileInput").addEventListener("change", (event) => {
    const file = event.target.files[0];
    if (!file) return;
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: (res) => {
        const series = buildSeriesFromCsvRows(res.data);
        window.userUploadedSeries = series;
        initAll();
      },
      error: (err) => {
        alert("CSV load failed: " + err);
      }
    });
  });
  function buildSeriesFromCsvRows(rows){
    if(!rows || !rows.length) return [];
    const header = Object.keys(rows[0]);
    const metaCols = ["RegionID","SizeRank","RegionName","RegionType","StateName","State","City","Metro","CountyName"];
    const dateCols = header.filter(h => !metaCols.includes(h));
    function parseMdyToISO(s){const a=(s||"").split("/").map(x=>parseInt(x,10));if(a.length!==3||!a[0]||!a[1]||!a[2]) return s;return `${a[2]}-${String(a[0]).padStart(2,'0')}-${String(a[1]).padStart(2,'0')}`;}
    const dates = dateCols.map(parseMdyToISO);
    const out = [];
    rows.forEach(r => {
      const name = r["RegionName"] || r["City"] || r["Metro"] || r["CountyName"] || r["RegionID"] || "Region";
      const state = r["StateName"] || r["State"] || "";
      const values = dateCols.map(c => {
        const v = r[c];
        const num = (v === undefined || v === null || v==="") ? null : Number(String(v).replace(/[, ]/g,""));
        return isNaN(num) ? null : num;
      });
      out.push({ name, label: state ? (name + " (" + state + ")") : name, state: state || "Unknown", dates, values });
    });
    return out;
  }

  // ---------- Downloads ----------
  $("#dlPng").addEventListener("click", ()=>{
    if(!chart) return;
    const link = document.createElement("a");
    link.download = "housing_index_chart.png";
    link.href = $("#chart").toDataURL("image/png", 1.0);
    link.click();
  });
  $("#dlCsv").addEventListener("click", ()=>{
    const series = filteredByState(getSeriesRaw());
    const sel = new Set(selectedNames());
    const chosen = series.filter(s => sel.has(s.name));
    if(!chosen.length) return;
    const allDates = Array.from(new Set(chosen.flatMap(s => s.dates || []))).sort();
    const header = ["Date", ...chosen.map(s => (s.label || s.name))];
    const lines = [header.join(",")];
    allDates.forEach(d => {
      const row = [d];
      chosen.forEach(s => {
        const idx = (s.dates||[]).indexOf(d);
        row.push(idx >= 0 ? (s.values||[])[idx] ?? "" : "");
      });
      lines.push(row.join(","));
    });
    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "housing_index_selected.csv"; a.click();
    URL.revokeObjectURL(url);
  });

  // ---------- Events ----------
  document.addEventListener("change", (e)=>{
    if (e.target && e.target.id === "stateSelect"){
      rebuildChips();
      updateChart();
    }
    if (e.target && e.target.id === "rankType"){
      const rv = $("#rankValue");
      if(rv){
        if(e.target.value === "count"){ rv.min=1; rv.max=1000; rv.value = Math.min(10, Math.max(1, parseInt(rv.value||"10",10))); }
        else { rv.min=1; rv.max=100; rv.value = Math.min(25, Math.max(1, parseInt(rv.value||"25",10))); }
      }
    }
  });
  document.addEventListener("click", (e)=>{
    if (e.target && e.target.id === "selectAllBtn"){ checkAllChips(true); updateChart(); }
    if (e.target && e.target.id === "selectNoneBtn"){ checkAllChips(false); updateChart(); }
    if (e.target && e.target.id === "applyRank"){ applyRank(); }
  });
  $("#regionChips").addEventListener("change", (e)=>{
    if (e.target && e.target.matches("input[type='checkbox']")) updateChart();
  });
  $("#search").addEventListener("input", (e)=>{
    currentSearch = e.target.value || "";
    rebuildChips();
    updateChart();
  });

  // ---------- Auto-load CSV on startup ----------
  function parseCsvFromUrl(url){
    return new Promise((resolve, reject)=>{
      Papa.parse(url, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (res)=>{
          if(res && res.data && res.data.length){
            resolve(res.data);
          } else {
            reject(new Error("Empty or invalid CSV at " + url));
          }
        },
        error: (err)=> reject(err || new Error("Failed to load CSV " + url))
      });
    });
  }

  async function autoLoadCsvAndInit(){
    for (const url of CSV_CANDIDATES){
      try {
        const rows = await parseCsvFromUrl(url);
        window.userUploadedSeries = buildSeriesFromCsvRows(rows);
        initAll();
        return;
      } catch(e){
        // try next URL
      }
    }
    initAll();
  }

  // ---------- Init ----------
  function populateStates(){
    const sel = $("#stateSelect");
    const series = getSeriesRaw();
    const list = uniqueStates(series);
    sel.innerHTML = "";
    list.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s; opt.textContent = s;
      sel.appendChild(opt);
    });
    sel.value = "All States";
  }
  function initAll(){
    populateStates();
    rebuildChips();
    drawChart();
  }

  autoLoadCsvAndInit();
})();
</script>
</body>
</html>
